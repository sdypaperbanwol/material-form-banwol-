<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë“œë¡  ì§€ë„ ìŒì˜ ì‹œìŠ¤í…œ</title>
    <style>
          body {
            font-family: sans-serif;
            margin: 0;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
          }

          #header {
            text-align: center;
            margin-top: 20px;
          }

          #header img {
            height: 80px;
            margin-bottom: 10px;
          }

       #factory-selector {
        display: flex;
        flex-direction: column;         /* âœ… ì„¸ë¡œ ì •ë ¬ ìœ ì§€ */
        align-items: center;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background: #fafafa;
        margin: 40px 0;
        gap: 24px;
        font-size: 1.25rem;
        transform: scale(1.15);         /* âœ… ì „ì²´ í¬ê¸° 15% í™•ëŒ€ */
        transform-origin: center top;

        /* âœ… fade-in íš¨ê³¼ ì¤€ë¹„ */
        opacity: 0;
        transition: opacity 0.6s ease;
      }

      #factory-selector.show {
        opacity: 1; /* âœ… fade-in ëŒ€ìƒ í´ë˜ìŠ¤ */
      }

      #factory-selector button {
        width: 320px;
        padding: 16px 20px;
        font-size: 1rem;
        line-height: 1.5;
        text-align: center;
        border: 1px solid #aaa;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: 0.2s;
      }

      #factory-selector button:hover {
        background: #f0f0f0;
      }

      /* âœ… ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ê°„ê²© í‚¤ìš°ê¸° */
       @media (max-width: 600px) {
            #factory-selector button {
              margin-bottom: 20px;
              padding: 20px;
              font-size: 1.1rem;
            }
          }



          #main-app {
            display: none;
            width: 100%;
          }

          #map-container {
            position: relative;
            width: 90%;
            max-width: 1000px;
            border: 1px solid #ccc;
            margin: 20px auto 0;
          }

          #map {
            display: block;
            width: 100%;
            height: auto;
          }

          #cad {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            opacity: 0.5;
            pointer-events: none;
            z-index: 5;
          }

          #overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: auto;
          }



          #controls {
            margin: 30px auto 100px;
            width: 90%;
            max-width: 800px;
          }

          #coords {
            font-family: monospace;
            margin-bottom: 10px;
          }

          #saved {
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            background: #f8f8f8;
            border: 1px solid #ccc;
            padding: 14px;
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
          }

          #saved div {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }

          #saved div:hover {
            background: #eef;
          }

          button {
            margin-bottom: 10px;
            padding: 8px 16px;
            font-size: 15px;
          }
      #saved .entry {
        background: #eef7ff;
        border: 1px solid #bcd;
        padding: 12px 16px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #saved .entry .text {
        font-size: 14px;
        word-break: keep-all;
      }

      #saved .entry .buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      #saved .entry .buttons button {
        font-size: 13px;
        padding: 5px 10px;
      }

      #header {
        text-align: center;
        margin-top: 10px; /* ë˜ëŠ” 0 */
      }
#instruction {
  margin: 20px auto;
  font-size: 1.05rem;
  color: #333;
  text-align: center;
  background: #f9f9f9;
  border: 1px dashed #aaa;
  border-radius: 8px;
  padding: 12px;
  width: 90%;
  max-width: 800px;
}

    </style>
  </head>
  <body>
    <!-- ë¡œê·¸ì¸ ì°½ -->
    <!-- ë¡œê·¸ì¸ ì°½ -->
    <div
      id="login-screen"
      style="
  display: none;                /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  position: absolute;          /* ìœ„ì— ê³ ì •ë˜ê²Œ */
  top: 150px;                  /* ë¡œê³  ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ê²Œ ì¡°ì • */
  left: 0;
  right: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  z-index: 100;
"
    >
      <h2>ğŸ”’ ë¡œê·¸ì¸</h2>
      <input
        type="text"
        id="login-id"
        placeholder="ì•„ì´ë””"
        style="padding: 8px; font-size: 1rem;"
      /><br /><br />
      <input
        type="password"
        id="login-pw"
        placeholder="ë¹„ë°€ë²ˆí˜¸"
        style="padding: 8px; font-size: 1rem;"
      /><br /><br />
      <button id="loginBtn" style="padding: 10px 20px;">ë¡œê·¸ì¸</button>
    </div>

    <!-- âœ… ìƒë‹¨ íšŒì‚¬ ë¡œê³  + ì œëª© -->
    <div id="header">
      <img
        src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë¡œê³ .png"
        alt="íšŒì‚¬ ë¡œê³ "
      />
      <h2>ğŸ›°ï¸ ë“œë¡  ì§€ë„ ìŒì˜ ì‹œìŠ¤í…œ (Canvas)</h2>
    </div>

    <!-- âœ… ê³µì¥ ì„ íƒ ë²„íŠ¼ -->
    <!-- âœ… ê³µì¥ ì„ íƒ í™”ë©´ -->
    <div id="factory-selector" style="display: none;">
      <h3 style="margin-bottom: 30px; font-size: 1.3em;">
        ğŸ“ ê³µì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”
      </h3>

      <!-- âœ… ë³¸ê³µì¥ -->
      <div
        style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;"
      >
        <!-- ì™¼ìª½: ë²„íŠ¼ ì„¤ëª… -->
        <div style="flex: 1;">
          <button
            onclick="loadFactory(1)"
            style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;"
          >
            ğŸ­ ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” ë³¸ê³µì¥<br />
            <small style="color:gray;"
              >(ë³¸ê³µì¥ / ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ëª©ë‚´ë¡œ 29)</small
            >
          </button>
        </div>
        <!-- ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ì¸ë„¤ì¼ -->
        <img
          src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë“œë¡ 4.png"
          style="width: 240px; border-radius: 8px;"
        />
      </div>

      <!-- âœ… 2ê³µì¥ -->
      <div
        style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;"
      >
        <div style="flex: 1;">
          <button
            onclick="loadFactory(2)"
            style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;"
          >
            ğŸ­ ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” 2ê³µì¥<br />
            <small style="color:gray;"
              >(2ê³µì¥ / ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ë³„ë§ë¡œ 408)</small
            >
          </button>
        </div>
        <img
          src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë“œë¡ .png"
          style="width: 240px; border-radius: 8px;"
        />
      </div>
    </div>

    <div
      id="admin-password-panel"
      style="display: none; margin-top: 20px; text-align: center;"
    >
      <h3>ğŸ› ï¸ admin ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
      <input
        type="password"
        id="new-admin-pw"
        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
        style="padding: 8px; font-size: 1rem;"
      />
      <button
        onclick="changeAdminPassword()"
        style="padding: 8px 16px; margin-left: 10px;"
      >
        ë³€ê²½
      </button>
      <p style="font-size: 0.9rem; color: gray; margin-top: 8px;">
        â€» admin ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
      </p>
    </div>

    <!-- âœ… ë©”ì¸ ì‹œìŠ¤í…œ ì˜ì—­ -->
    <div id="main-app">
      <!-- ê³µì¥ ì´ë¦„ í‘œì‹œ -->
      <div
        id="currentFactory"
        style="margin: 0 auto 10px; text-align: center; font-weight: bold;"
      ></div>

      <!-- ì§€ë„ ë° ì˜¤ë²„ë ˆì´ ì˜ì—­ -->
      <div id="map-container">
        <img id="map" />
        <img id="cad" style="display: none;" />
        <canvas id="overlay"></canvas>
      </div>
<div id="instruction" style="margin-top: 20px; font-size: 1rem; color: #444; text-align: center;">
  ğŸ“Œ ì›í•˜ëŠ” ë¶€ë¶„ì„ <strong>ë“œë˜ê·¸</strong>í•œ ë’¤, <strong>ì¢Œí‘œ ì¶”ê°€</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
  ì—¬ëŸ¬ êµ¬ì—­ì„ ë“œë˜ê·¸í•´ì„œ ì¶”ê°€í•œ í›„ <strong>ì¢Œí‘œ ì €ì¥</strong>ì„ ëˆ„ë¥´ë©´ ê³µìœ  ë§í¬ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</div>


      <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
      <div id="controls">
        <!-- âœ… ë²„íŠ¼ 3ê°œ í•œ ì¤„ ì •ë ¬ -->
        <div
  style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;"
>
  <!-- ì™¼ìª½ ë²„íŠ¼ë“¤ -->
  <div style="display: flex; gap: 10px;">
    <button id="addTempBtn">â• ì¢Œí‘œ ì¶”ê°€</button>
    <button id="saveBtn">ğŸ“Œ ì¢Œí‘œ ì €ì¥</button>
    <button id="resetBtn">â™»ï¸ ì´ˆê¸°í™”</button>
    <button id="backBtn">ğŸ”™ ê³µì¥ ì„ íƒ</button>
  </div>

  <!-- âœ… ì˜¤ë¥¸ìª½: CAD ë²„íŠ¼ + ìŠ¬ë¼ì´ë” ë¬¶ìŒ -->
  <div style="display: flex; align-items: center; gap: 10px;">
    <button id="toggleCadBtn">ğŸ”´ CAD ë³´ê¸° ì¼œê¸°</button>
    <label style="display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
      íˆ¬ëª…ë„:
      <input type="range" id="cadOpacity" min="0" max="100" value="50" />
    </label>
  </div>
</div>


        <div id="coords">ì¢Œí‘œ:</div>
       <div id="temp-count" style="color: gray; font-size: 0.9rem;">ì„ì‹œ ì„ íƒ 0ê±´</div>


       

<div id="color-selector" style="margin: 10px 0;">
  <span>ìƒ‰ìƒ ì„ íƒ:</span>
  <button onclick="setColor('yellow')" style="background: yellow;">&nbsp;</button>
  <button onclick="setColor('blue')" style="background: lightblue;">&nbsp;</button>
  <button onclick="setColor('red')" style="background: lightcoral;">&nbsp;</button>
  <button onclick="setColor('green')" style="background: lightgreen;">&nbsp;</button>
  <button onclick="setColor('magenta')" style="background: magenta;">&nbsp;</button>
</div>



        <!-- ì €ì¥ëœ ì¢Œí‘œ ëª©ë¡ -->
        <div id="saved">ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ</div>
      </div>
    </div>

    <!-- âœ… í†µí•© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
                  function handleLogin() {
                    const id = document.getElementById("login-id").value;
                    const pw = document.getElementById("login-pw").value;
                    const savedAdminPw = localStorage.getItem("adminPw") || "1234";

                    if (id === "superadmin" && pw === "master123") {
                      localStorage.setItem("auth", "superadmin");
                      document.getElementById("login-screen").style.display = "none";
                      showFactorySelector();
                      document.getElementById("admin-password-panel").style.display = "block";
                    } else if (id === "admin" && pw === savedAdminPw) {
                      localStorage.setItem("auth", "admin");
                      document.getElementById("login-screen").style.display = "none";
                      showFactorySelector();
                      document.getElementById("admin-password-panel").style.display = "none";
                    } else {
                      alert("âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                  }

                  window.handleLogin = handleLogin;  // âœ… ê¼­ ìˆì–´ì•¼ HTMLì—ì„œ í˜¸ì¶œ ê°€ëŠ¥

                  function showFactorySelector() {
                    const selector = document.getElementById("factory-selector");
                    selector.style.display = "flex";
                    // ğŸ’¡ 1í”„ë ˆì„ ì§€ì—° í›„ í´ë˜ìŠ¤ ì¶”ê°€
                    requestAnimationFrame(() => {
                      selector.classList.add("show");
                    });
                  }


                      const FACTORY_DATA = {
                        1: {
                          map: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë“œë¡ 3.png",
                          cad: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë„ë©´3.png"
                        },
                        2: {
                          map: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë“œë¡ .png",
                          cad: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë„ë©´.png"
                        }
                      };

                  const factoryNames = {
                    1: "ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” ë³¸ê³µì¥",
                    2: "ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” 2ê³µì¥"
                  };

                      let selectedFactory = null;
                  let isInitialized = false;

                  function loadFactory(factoryNum) {
                    selectedFactory = factoryNum;
                    const factory = FACTORY_DATA[factoryNum];
                    if (!factory) return;

                    document.getElementById("factory-selector").style.display = "none";
                    document.getElementById("main-app").style.display = "block";

                    const mapEl = document.getElementById("map");
                    const cadEl = document.getElementById("cad");

                    mapEl.src = factory.map;
                    cadEl.src = factory.cad;

                    document.getElementById("currentFactory").innerText = `ğŸ­ í˜„ì¬ ê³µì¥: ${factoryNames[factoryNum]}`;

                    const finishInit = () => {
                      resizeCanvas();
                      if (!isInitialized) {
                        initSystem();
                        isInitialized = true;
                      }
                    };

                    if (mapEl.complete) {
                      finishInit();
                    } else {
                      mapEl.onload = finishInit;
                    }
                  }


                  window.loadFactory = loadFactory;


                      // âœ… ì•„ë˜ëŠ” ê¸°ì¡´ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ì‚½ì…
                      // ë‹¨, map.onloadì—ì„œ resizeCanvas()ë§Œ í˜¸ì¶œí•˜ë©´ ë¨
                      let cellSize = 20;
                      let isDragging = false;
                      let dragStartX = 0;
                      let dragStartY = 0;
                      let hasMoved = false;
                      let selections = [];
let currentColor = "yellow"; // ê¸°ë³¸ ìƒ‰ìƒ

function setColor(color) {
  currentColor = color;
}


                      const map = document.getElementById("map");
                      const canvas = document.getElementById("overlay");
                      const ctx = canvas.getContext("2d");
                      const coordsDiv = document.getElementById("coords");
                      const saveBtn = document.getElementById("saveBtn");
                      const savedDiv = document.getElementById("saved");
                      const cadImg = document.getElementById("cad");
                      const toggleCadBtn = document.getElementById("toggleCadBtn");
                      const cadOpacity = document.getElementById("cadOpacity");

                      let cadVisible = false;
                      toggleCadBtn.textContent = "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";

                      function getMetersPerPixel() {
                        return 0.15;
                      }

                      function resizeCanvas() {
                        canvas.width = map.clientWidth;
                        canvas.height = map.clientHeight;
                        drawGrid();
                      }

                      function getScale() {
                        return canvas.width / map.naturalWidth;
                      }

                      function getRelativeCoords(e) {
                        const rect = canvas.getBoundingClientRect();
                        const scale = getScale();
                        return {
                          x: (e.clientX - rect.left) / scale,
                          y: (e.clientY - rect.top) / scale
                        };
                      }

                      function drawGrid() {
                        const scale = getScale();
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.strokeStyle = "rgba(0,0,0,0.3)";
                        ctx.lineWidth = 1;

                        const step = cellSize * scale;
                        const fontSize = Math.max(14 * scale, 11);
                        ctx.font = `${fontSize}px sans-serif`;
                        ctx.fillStyle = "yellow";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "top";

                        for (let x = 0, i = 0; x <= canvas.width; x += step, i++) {
                          ctx.beginPath();
                          ctx.moveTo(x, 0);
                          ctx.lineTo(x, canvas.height);
                          ctx.stroke();
                          ctx.fillText(i, x + step / 2, 0);
                        }

                        ctx.textAlign = "left";
                        ctx.textBaseline = "middle";
                        for (let y = 0, j = 0; y <= canvas.height; y += step, j++) {
                          ctx.beginPath();
                          ctx.moveTo(0, y);
                          ctx.lineTo(canvas.width, y);
                          ctx.stroke();
                          ctx.fillText(j, 0, y + step / 2);
                        }

                        drawScaleBar();
                      }

                      function drawScaleBar() {
                        const scale = getScale();
                        const metersPerPixel = getMetersPerPixel();
                        const canvasWidth = canvas.width;

                        const maxBarPx = canvasWidth * 0.25;
                        const niceSteps = [1, 2, 5, 10, 20, 50, 100, 200];
                        const maxMeters = maxBarPx / metersPerPixel;
                        let chosen = niceSteps.find(m => m <= maxMeters) || niceSteps[niceSteps.length - 1];
                        const barPx = chosen / metersPerPixel;

                        const x = canvasWidth - barPx - 20;
                        const y = canvas.height - 20;

                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + barPx, y);
                        ctx.strokeStyle = "white";
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        ctx.fillStyle = "white";
                        ctx.font = "12px sans-serif";
                        ctx.textAlign = "center";
                        ctx.fillText(`ì•½ ${chosen} m`, x + barPx / 2, y - 10);
                      }

                      function drawMultilineLabel(x, y, lines) {
                        const scale = getScale();
                        const fontSize = Math.max(13 * scale, 11);
                        ctx.font = `bold ${fontSize}px sans-serif`;  // âœ… bold ì¶”ê°€
                  ctx.fillStyle = "black";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "top";

                        const totalHeight = lines.length * (fontSize + 2);
                        const startY = y * scale - totalHeight / 2;

                        lines.forEach((line, i) => {
                          ctx.fillText(line, x * scale, startY + i * (fontSize + 2));
                        });
                      }


function getFillRGBA(color) {
  const rgbaMap = {
    yellow: "rgba(255,255,0,0.3)",
    blue: "rgba(0,128,255,0.3)",
    red: "rgba(255,0,0,0.3)",
    green: "rgba(0,200,0,0.3)",
    magenta: "rgba(255,0,255,0.3)"
  };
  return rgbaMap[color] || "rgba(255,255,0,0.3)";
}

               function drawShadedArea(x1, y1, x2, y2, color = currentColor) {
  const scale = getScale();

  ctx.fillStyle = getFillRGBA(color);
  for (let y = y1; y < y2; y += cellSize) {
    for (let x = x1; x < x2; x += cellSize) {
      ctx.fillRect(x * scale, y * scale, cellSize * scale, cellSize * scale);
    }
  }

  const boxX = x1 * scale;
  const boxY = y1 * scale;
  const boxW = (x2 - x1) * scale;
  const boxH = (y2 - y1) * scale;

  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.strokeRect(boxX, boxY, boxW, boxH);
}




                      function formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy) {
                        const xStart = x1 / cellSize;
                        const yStart = y1 / cellSize;
                        const xEnd = xStart + cols - 1;
                        const yEnd = yStart + rows - 1;

                        return [
                          `ì…€ X=${xStart}~${xEnd}, Y=${yStart}~${yEnd}`,
                          `${cols}x${rows}ì¹¸`,
                          `${widthM.toFixed(2)}m Ã— ${heightM.toFixed(2)}m`,
                          `${areaM2.toFixed(2)}mÂ² (ì•½ ${areaPy.toFixed(2)}í‰)`
                        ];
                      }

                      function handleStart(e) {
                        const pos = getRelativeCoords(e);
                        dragStartX = pos.x;
                        dragStartY = pos.y;
                        isDragging = true;
                        hasMoved = false;
                      }

                    function handleMove(e) {
  if (!isDragging) return;
  hasMoved = true;

  const pos = getRelativeCoords(e);
  const x = Math.min(dragStartX, pos.x);
  const y = Math.min(dragStartY, pos.y);
  const w = Math.abs(dragStartX - pos.x);
  const h = Math.abs(dragStartY - pos.y);

  drawGrid();
  drawAllSelections(); // âœ… ì¶”ê°€: ê¸°ì¡´ ì„ì‹œ ì„ íƒ ë‹¤ì‹œ ê·¸ë¦¼

  ctx.fillStyle = getFillRGBA(currentColor);
ctx.fillRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());

ctx.strokeStyle = currentColor;
ctx.lineWidth = 3;
ctx.strokeRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());


  const x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
  const y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
  const x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
  const y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

  const cols = (x2 - x1) / cellSize;
  const rows = (y2 - y1) / cellSize;
  const widthM = (x2 - x1) * getMetersPerPixel();
  const heightM = (y2 - y1) * getMetersPerPixel();
  const areaM2 = widthM * heightM;
  const areaPy = areaM2 / 3.3058;

  drawMultilineLabel(
    x1 + (x2 - x1) / 2,
    y1 + (y2 - y1) / 2,
    formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
  );
}



             function handleEnd(e) {
  const pos = getRelativeCoords(e);
  let x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
  let y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
  let x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
  let y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

  if (!hasMoved) {
    x1 = Math.floor(pos.x / cellSize) * cellSize;
    y1 = Math.floor(pos.y / cellSize) * cellSize;
    x2 = x1 + cellSize;
    y2 = y1 + cellSize;
  }

  const cols = (x2 - x1) / cellSize;
  const rows = (y2 - y1) / cellSize;
  const metersPerPixel = getMetersPerPixel();
  const widthM = (x2 - x1) * metersPerPixel;
  const heightM = (y2 - y1) * metersPerPixel;
  const areaM2 = widthM * heightM;
  const areaPy = areaM2 / 3.3058;

  lastSelection = { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy, color: currentColor };

  drawGrid();
  drawAllSelections(); // âœ… ì¶”ê°€: ê¸°ì¡´ selection ìœ ì§€í•˜ë©° ë‹¤ì‹œ ê·¸ë¦¼
  drawShadedArea(x1, y1, x2, y2);
  drawMultilineLabel(
    x1 + (x2 - x1) / 2,
    y1 + (y2 - y1) / 2,
    formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
  );

  coordsDiv.innerText =
    `ì¢Œí‘œ: ì…€ X=${x1 / cellSize}, Y=${y1 / cellSize} (í”½ì…€ X=${x1}, Y=${y1})\n` +
    `í¬ê¸°: ${cols}Ã—${rows}ì¹¸, ì•½ ${widthM.toFixed(2)}m Ã— ${heightM.toFixed(2)}m`;

  isDragging = false;
  hasMoved = false;
}



                      function initSystem() {
                        map.onload = resizeCanvas;
                        window.addEventListener("resize", resizeCanvas);

                   // âœ… CAD ì´ˆê¸° ìƒíƒœ ë³´ì¥
                    cadImg.style.display = "none";
                    cadVisible = false;
                    toggleCadBtn.textContent = "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";

                        canvas.addEventListener("mousedown", handleStart);
                        canvas.addEventListener("mousemove", handleMove);
                        canvas.addEventListener("mouseup", handleEnd);

                  // âœ… ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ ì´ë²¤íŠ¸
                  canvas.addEventListener("touchstart", e => {
                    if (e.touches.length === 1) {
                      e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                      handleStart(e.touches[0]);
                    }
                  }, { passive: false });

                  canvas.addEventListener("touchmove", e => {
                    if (e.touches.length === 1) {
                      e.preventDefault();
                      handleMove(e.touches[0]);
                    }
                  }, { passive: false });

                  canvas.addEventListener("touchend", e => {
                    if (e.changedTouches.length === 1) {
                      e.preventDefault();
                      handleEnd(e.changedTouches[0]);
                    }
                  }, { passive: false });


                        cadOpacity.addEventListener("input", () => {
                          cadImg.style.opacity = cadOpacity.value / 100;
                        });

                        toggleCadBtn.addEventListener("click", () => {
                          cadVisible = !cadVisible;
                          cadImg.style.display = cadVisible ? "block" : "none";
                          toggleCadBtn.textContent = cadVisible ? "ğŸŸ¢ CAD ë³´ê¸° ë„ê¸°" : "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";
                        });

                  saveBtn.addEventListener("click", () => {
  if (selections.length === 0) return;

  const entry = document.createElement("div");
  entry.className = "entry";

  let combinedLabel = "";
  const coordsData = [];

  selections.forEach((sel, idx) => {
    const { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy } = sel;
    const lines = formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy);
    const label = `ğŸ“Œ ì˜ì—­ ${idx + 1}: ${lines.join(" / ")}`;
    combinedLabel += label + "\n";
    coordsData.push([x1, y1, x2, y2, sel.color || "yellow"].join(","));

  });

  const textDiv = document.createElement("div");
  textDiv.className = "text";
  textDiv.textContent = combinedLabel;

  const title = selections.length === 1 ? "ì˜ì—­ 1ê±´" : `ì˜ì—­ ${selections.length}ê±´`;
const encoded = btoa(coordsData.join(";") + "|" + selectedFactory + "|1|" + encodeURIComponent(title));


  const linkBtn = document.createElement("button");
  linkBtn.textContent = "ğŸ”— ë§í¬ ë³µì‚¬";
  linkBtn.onclick = () => {
    const url = new URL(location.href);
    url.searchParams.set("code", encoded);
    navigator.clipboard.writeText(url.toString());
    alert("âœ… ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
  };

  const delBtn = document.createElement("button");
  delBtn.textContent = "âŒ";
  delBtn.onclick = () => {
    savedDiv.removeChild(entry);
    if (savedDiv.childElementCount === 0) {
      savedDiv.textContent = "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ";
    }
  };

  const btnBox = document.createElement("div");
  btnBox.className = "buttons";
  btnBox.appendChild(linkBtn);
  btnBox.appendChild(delBtn);

  entry.appendChild(textDiv);
  entry.appendChild(btnBox);

  entry.onclick = () => {
  const tempSelections = coordsData.map(str => {
    const [x1, y1, x2, y2, color] = str.split(",");
    const cols = (x2 - x1) / cellSize;
    const rows = (y2 - y1) / cellSize;
    const widthM = (x2 - x1) * getMetersPerPixel();
    const heightM = (y2 - y1) * getMetersPerPixel();
    const areaM2 = widthM * heightM;
    const areaPy = areaM2 / 3.3058;

    return {
      x1: Number(x1),
      y1: Number(y1),
      x2: Number(x2),
      y2: Number(y2),
      cols, rows,
      widthM, heightM,
      areaM2, areaPy,
      color
    };
  });

  drawGrid();
  for (const sel of tempSelections) {
    drawShadedArea(sel.x1, sel.y1, sel.x2, sel.y2, sel.color);
    drawMultilineLabel(
      sel.x1 + (sel.x2 - sel.x1) / 2,
      sel.y1 + (sel.y2 - sel.y1) / 2,
      formatLabel(sel.x1, sel.y1, sel.cols, sel.rows, sel.widthM, sel.heightM, sel.areaM2, sel.areaPy)
    );
  }

  coordsDiv.innerText =
    `ì¢Œí‘œ: ì…€ X=${tempSelections[0].x1 / cellSize}, Y=${tempSelections[0].y1 / cellSize} (í”½ì…€ X=${tempSelections[0].x1}, Y=${tempSelections[0].y1})\n` +
    `í¬ê¸°: ${tempSelections[0].cols}Ã—${tempSelections[0].rows}ì¹¸, ì•½ ${tempSelections[0].widthM.toFixed(2)}m Ã— ${tempSelections[0].heightM.toFixed(2)}m`;
};


  if (savedDiv.textContent.trim() === "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ") {
    savedDiv.innerHTML = "";
  }

  savedDiv.appendChild(entry);

  // ì €ì¥ í›„ ì´ˆê¸°í™”
  selections = [];
drawAllSelections();  // ì„ íƒ ì§€ìš°ê³  ê·¸ë¦¬ê¸°
coordsDiv.innerText = "ì¢Œí‘œ: ";
updateTempCount();  // ğŸ‘ˆ ì¶”ê°€!

});


                      }

                  document.getElementById("backBtn").addEventListener("click", () => {
                    document.getElementById("main-app").style.display = "none";
                    const selectorDiv = document.getElementById("factory-selector");
                    selectorDiv.style.display = "flex";                   // âœ… í•„ìˆ˜: flex ìœ ì§€
                    selectorDiv.style.flexDirection = "column";           // âœ… ì„¸ë¡œ ì •ë ¬ ë³µêµ¬
                    selectorDiv.style.alignItems = "center";              // âœ… ì¤‘ì•™ ì •ë ¬ ë³µêµ¬

                    // ìƒíƒœ ì´ˆê¸°í™”
                    savedDiv.innerHTML = "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ";
                    coordsDiv.innerText = "ì¢Œí‘œ: ";
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    lastSelection = null;
                  });
                  document.getElementById("currentFactory").innerText = "";
document.getElementById("resetBtn").addEventListener("click", () => {
  selections = [];
  lastSelection = null;
  drawAllSelections(); // âœ… ì „ì²´ ê·¸ë¦¬ê¸° ì´ˆê¸°í™”
  coordsDiv.innerText = "ì¢Œí‘œ: ";
  updateTempCount();
  savedDiv.innerHTML = "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ";

  // âœ… CAD ë³´ê¸° ìƒíƒœë„ ì´ˆê¸°í™”
  cadVisible = false;
  cadImg.style.display = "none";
  toggleCadBtn.textContent = "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";
});



document.getElementById("addTempBtn").addEventListener("click", () => {
  if (!lastSelection) {
    alert("ë¨¼ì € ë“œë˜ê·¸í•˜ì—¬ ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  selections.push(lastSelection);
  drawAllSelections(); // ê¸°ì¡´ ì „ì²´ ê·¸ë¦¬ê¸° í˜¸ì¶œ

  // âœ… ë¸Œë¼ìš°ì € í”„ë ˆì„ ì•ˆì—ì„œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ê¹œë¹¡ì„ ë°©ì§€)
  requestAnimationFrame(() => {
    drawShadedArea(lastSelection.x1, lastSelection.y1, lastSelection.x2, lastSelection.y2);
    drawMultilineLabel(
      lastSelection.x1 + (lastSelection.x2 - lastSelection.x1) / 2,
      lastSelection.y1 + (lastSelection.y2 - lastSelection.y1) / 2,
      formatLabel(
        lastSelection.x1,
        lastSelection.y1,
        lastSelection.cols,
        lastSelection.rows,
        lastSelection.widthM,
        lastSelection.heightM,
        lastSelection.areaM2,
        lastSelection.areaPy
      )
    );

    updateTempCount();
    lastSelection = null;
  });
});




                  window.loadFactory = loadFactory;

window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const viewOnly = params.get("view") === "1";

  // âœ… ì•ˆë‚´ë¬¸ ìˆ¨ê¸°ê¸°: ê³µìœ  ë§í¬ ë˜ëŠ” ë³´ê¸° ëª¨ë“œì¸ ê²½ìš°
  const instructionDiv = document.getElementById("instruction");
  if ((code || viewOnly) && instructionDiv) {
    instructionDiv.style.display = "none";
  }

  // âœ… ê³µìœ  ë§í¬ê°€ ì•„ë‹ˆê³ , viewOnlyê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ë¡œê·¸ì¸ ìš”êµ¬
  if (!code && !viewOnly) {
    localStorage.removeItem("auth"); // ë§¤ë²ˆ ë¡œê·¸ì¸ í•˜ë„ë¡
    const isLoggedIn = localStorage.getItem("auth") === "ok";

    if (!isLoggedIn) {
      document.getElementById("login-screen").style.display = "block";

      // âœ… ë¡œê·¸ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë“±ë¡
      const loginBtn = document.getElementById("loginBtn");
      if (loginBtn) {
        loginBtn.addEventListener("click", handleLogin);
      }

      return; // ë¡œê·¸ì¸ ì°½ ë³´ì—¬ì¤€ í›„ ì¢…ë£Œ
    }
  } else {
    // âœ… ê³µìœ  ë§í¬ ë“±ìœ¼ë¡œ ì ‘ì†í•œ ê²½ìš° ë¡œê·¸ì¸ì°½ ìˆ¨ê¸°ê¸°
    document.getElementById("login-screen").style.display = "none";
  }

                    // âœ… ê³µìœ  ë§í¬ ìˆëŠ” ê²½ìš° (code íŒŒë¼ë¯¸í„° ìˆì„ ë•Œ ì²˜ë¦¬)
                    if (code) {
                      try {
                        const decoded = atob(code);
const parts = decoded.split("|");

const coordsList = parts[0].split(";").map(str => {
  const [x1, y1, x2, y2, color] = str.split(",");
  return {
    x1: Number(x1),
    y1: Number(y1),
    x2: Number(x2),
    y2: Number(y2),
    color: color || "yellow"
  };
});

const factoryParam = Number(parts[1]);
const viewFlag = Number(parts[2]);
const labelText = parts[3] ? decodeURIComponent(parts[3]) : "";

if (!coordsList.length || isNaN(factoryParam)) throw new Error("Invalid data");

loadFactory(factoryParam);

document.getElementById("map").onload = () => {
  resizeCanvas();
  if (!isInitialized) {
    initSystem();
    isInitialized = true;
  }

  setTimeout(() => {
    selections = [];

coordsList.forEach((coord, idx) => {
  const { x1, y1, x2, y2, color } = coord;
  const cols = (x2 - x1) / cellSize;
  const rows = (y2 - y1) / cellSize;
  const widthM = (x2 - x1) * getMetersPerPixel();
  const heightM = (y2 - y1) * getMetersPerPixel();
  const areaM2 = widthM * heightM;
  const areaPy = areaM2 / 3.3058;

  const selection = {
    x1, y1, x2, y2,
    cols, rows,
    widthM, heightM,
    areaM2, areaPy,
    color
  };

  selections.push(selection);
});


    drawAllSelections();
    updateTempCount();

    const first = selections[0];
    coordsDiv.innerText =
      `ì¢Œí‘œ: ì…€ X=${first.x1 / cellSize}, Y=${first.y1 / cellSize} (í”½ì…€ X=${first.x1}, Y=${first.y1})\n` +
      `í¬ê¸°: ${first.cols}Ã—${first.rows}ì¹¸, ì•½ ${first.widthM.toFixed(2)}m Ã— ${first.heightM.toFixed(2)}m`;

    if (labelText) {
      const labelDiv = document.createElement("div");
      labelDiv.innerHTML = `<span style="color:green; font-weight:bold;">ğŸ“Œ ê³µìœ  ì œëª©: ${labelText}</span>`;
      labelDiv.style.margin = "10px auto 20px";
      labelDiv.style.textAlign = "center";
      document.getElementById("main-app").insertBefore(labelDiv, document.getElementById("map-container"));
    }

    if (viewFlag === 1) {
      document.getElementById("controls").style.display = "none";
      canvas.style.pointerEvents = "none";
    }
  }, 0); // ğŸ’¡ 0msì§€ë§Œ ë‹¤ìŒ ì´ë²¤íŠ¸ ë£¨í”„ë¡œ ë°€ì–´ canvas ì´ˆê¸°í™” ì´í›„ ì‹¤í–‰
};

  updateTempCount();

  const first = selections[0];
  coordsDiv.innerText =
    `ì¢Œí‘œ: ì…€ X=${first.x1 / cellSize}, Y=${first.y1 / cellSize} (í”½ì…€ X=${first.x1}, Y=${first.y1})\n` +
    `í¬ê¸°: ${first.cols}Ã—${first.rows}ì¹¸, ì•½ ${first.widthM.toFixed(2)}m Ã— ${first.heightM.toFixed(2)}m`;

  if (labelText) {
    const labelDiv = document.createElement("div");
    labelDiv.innerHTML = `<span style="color:green; font-weight:bold;">ğŸ“Œ ê³µìœ  ì œëª©: ${labelText}</span>`;
    labelDiv.style.margin = "10px auto 20px";
    labelDiv.style.textAlign = "center";
    document.getElementById("main-app").insertBefore(labelDiv, document.getElementById("map-container"));
  }

  if (viewFlag === 1) {
    document.getElementById("controls").style.display = "none";
    canvas.style.pointerEvents = "none";
  }

                      } catch (e) {
                                                                    }
                    } else {
                      showFactorySelector(); // ê¸°ë³¸ ì§„ì…
                    }
                  });

                  function changeAdminPassword() {
                    const newPw = document.getElementById("new-admin-pw").value.trim();
                    if (!newPw) {
                      alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                      return;
                    }
                    localStorage.setItem("adminPw", newPw);
                    alert("âœ… admin ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById("new-admin-pw").value = "";
                  }

                  function drawAllSelections() {
                    drawGrid();
                    for (const sel of selections) {
                      drawShadedArea(sel.x1, sel.y1, sel.x2, sel.y2, sel.color);

                      drawMultilineLabel(
                        sel.x1 + (sel.x2 - sel.x1) / 2,
                        sel.y1 + (sel.y2 - sel.y1) / 2,
                        formatLabel(sel.x1, sel.y1, sel.cols, sel.rows, sel.widthM, sel.heightM, sel.areaM2, sel.areaPy)
                      );
                    }
                  }
function updateTempCount() {
  document.getElementById("temp-count").innerText = `ì„ì‹œ ì„ íƒ ${selections.length}ê±´`;
}
    </script>
  </body>
</html>
