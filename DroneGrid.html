<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë“œë¡  ì§€ë„ ìŒì˜ ì‹œìŠ¤í…œ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #header {
      text-align: center;
      margin-top: 20px;
    }

    #header img {
      height: 80px;
      margin-bottom: 10px;
    }

 #factory-selector {
  display: flex;
  flex-direction: column;         /* âœ… ì„¸ë¡œ ì •ë ¬ ìœ ì§€ */
  align-items: center;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: #fafafa;
  margin: 40px 0;
  gap: 24px;
  font-size: 1.15rem;
  transform: scale(1.15);         /* âœ… ì „ì²´ í¬ê¸° 15% í™•ëŒ€ */
  transform-origin: center top;

  /* âœ… fade-in íš¨ê³¼ ì¤€ë¹„ */
  opacity: 0;
  transition: opacity 0.6s ease;
}

#factory-selector.show {
  opacity: 1; /* âœ… fade-in ëŒ€ìƒ í´ë˜ìŠ¤ */
}

#factory-selector button {
  width: 320px;
  padding: 16px 20px;
  font-size: 1rem;
  line-height: 1.5;
  text-align: center;
  border: 1px solid #aaa;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: 0.2s;
}

#factory-selector button:hover {
  background: #f0f0f0;
}

/* âœ… ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ê°„ê²© í‚¤ìš°ê¸° */
 @media (max-width: 600px) {
      #factory-selector button {
        margin-bottom: 20px;
        padding: 20px;
        font-size: 1.1rem;
      }
    }



    #main-app {
      display: none;
      width: 100%;
    }

    #map-container {
      position: relative;
      width: 90%;
      max-width: 1000px;
      border: 1px solid #ccc;
      margin: 20px auto 0;
    }

    #map {
      display: block;
      width: 100%;
      height: auto;
    }

    #cad {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 0.5;
      pointer-events: none;
      z-index: 5;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: auto;
    }



    #controls {
      margin: 30px auto 100px;
      width: 90%;
      max-width: 800px;
    }

    #coords {
      font-family: monospace;
      margin-bottom: 10px;
    }

    #saved {
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      background: #f8f8f8;
      border: 1px solid #ccc;
      padding: 14px;
      min-height: 120px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.5;
    }

    #saved div {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #saved div:hover {
      background: #eef;
    }

    button {
      margin-bottom: 10px;
      padding: 8px 16px;
      font-size: 15px;
    }
#saved .entry {
  background: #eef7ff;
  border: 1px solid #bcd;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#saved .entry .text {
  font-size: 14px;
  word-break: keep-all;
}

#saved .entry .buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

#saved .entry .buttons button {
  font-size: 13px;
  padding: 5px 10px;
}

#header {
  text-align: center;
  margin-top: 10px; /* ë˜ëŠ” 0 */
}

  </style>
</head>
<body>
<!-- ë¡œê·¸ì¸ ì°½ -->
<!-- ë¡œê·¸ì¸ ì°½ -->
<div id="login-screen" style="
  display: none;                /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  position: absolute;          /* ìœ„ì— ê³ ì •ë˜ê²Œ */
  top: 150px;                  /* ë¡œê³  ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ê²Œ ì¡°ì • */
  left: 0;
  right: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  z-index: 100;
">
  <h2>ğŸ”’ ë¡œê·¸ì¸</h2>
  <input type="text" id="login-id" placeholder="ì•„ì´ë””" style="padding: 8px; font-size: 1rem;"><br><br>
  <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding: 8px; font-size: 1rem;"><br><br>
  <button onclick="handleLogin()" style="padding: 10px 20px;">ë¡œê·¸ì¸</button>
</div>



<!-- âœ… ìƒë‹¨ íšŒì‚¬ ë¡œê³  + ì œëª© -->
<div id="header">
  <img src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë¡œê³ .png" alt="íšŒì‚¬ ë¡œê³ ">
  <h2>ğŸ›°ï¸ ë“œë¡  ì§€ë„ ìŒì˜ ì‹œìŠ¤í…œ (Canvas)</h2>
</div>

<!-- âœ… ê³µì¥ ì„ íƒ ë²„íŠ¼ -->
<!-- âœ… ê³µì¥ ì„ íƒ í™”ë©´ -->
<div id="factory-selector" style="display: none;">

  <h3 style="margin-bottom: 30px; font-size: 1.3em;">ğŸ“ ê³µì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>

  <!-- âœ… ë³¸ê³µì¥ -->
  <div style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;">
    <!-- ì™¼ìª½: ë²„íŠ¼ ì„¤ëª… -->
    <div style="flex: 1;">
      <button onclick="loadFactory(1)" style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;">
        ğŸ­ ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” ë³¸ê³µì¥<br>
        <small style="color:gray;">(ë³¸ê³µì¥ / ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ëª©ë‚´ë¡œ 29)</small>
      </button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ì¸ë„¤ì¼ -->
    <img src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë“œë¡ 3.png" style="width: 240px; border-radius: 8px;">
  </div>

  <!-- âœ… 2ê³µì¥ -->
  <div style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;">
    <div style="flex: 1;">
      <button onclick="loadFactory(2)" style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;">
        ğŸ­ ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” 2ê³µì¥<br>
        <small style="color:gray;">(2ê³µì¥ / ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ë³„ë§ë¡œ 408)</small>
      </button>
    </div>
    <img src="https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë“œë¡ .png" style="width: 240px; border-radius: 8px;">
  </div>

</div>






<!-- âœ… ë©”ì¸ ì‹œìŠ¤í…œ ì˜ì—­ -->
<div id="main-app">
  <!-- ê³µì¥ ì´ë¦„ í‘œì‹œ -->
  <div id="currentFactory" style="margin: 0 auto 10px; text-align: center; font-weight: bold;"></div>

  <!-- ì§€ë„ ë° ì˜¤ë²„ë ˆì´ ì˜ì—­ -->
  <div id="map-container">
    <img id="map" />
    <img id="cad" style="display: none;" />
    <canvas id="overlay"></canvas>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div id="controls">
    <!-- âœ… ë²„íŠ¼ 3ê°œ í•œ ì¤„ ì •ë ¬ -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;">
      <div style="display: flex; gap: 10px;">
        <button id="saveBtn">ğŸ“Œ ì„ íƒ ì¢Œí‘œ ì €ì¥</button>
        <button id="toggleCadBtn">ğŸ”´ CAD ë³´ê¸° ì¼œê¸°</button>
      </div>
      <button id="backBtn">ğŸ”™ ê³µì¥ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <!-- ì¢Œí‘œ ì •ë³´ -->
    <div id="coords">ì¢Œí‘œ: </div>

    <!-- CAD íˆ¬ëª…ë„ ì¡°ì ˆ -->
    <div style="margin: 8px 0;">
      <label>CAD íˆ¬ëª…ë„:
        <input type="range" id="cadOpacity" min="0" max="100" value="50">
      </label>
    </div>

    <!-- ì €ì¥ëœ ì¢Œí‘œ ëª©ë¡ -->
    <div id="saved">ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ</div>
  </div>
</div>



  <!-- âœ… í†µí•© ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
 function handleLogin() {
  const id = document.getElementById("login-id").value;
  const pw = document.getElementById("login-pw").value;

  if (id === "admin" && pw === "1234") {
    localStorage.setItem("auth", "ok");
    document.getElementById("login-screen").style.display = "none";
    showFactorySelector();  // âœ… ë°”ë¡œ ê³µì¥ ì„ íƒí™”ë©´ìœ¼ë¡œ ì „í™˜
  } else {
    alert("âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
}


function showFactorySelector() {
  const selector = document.getElementById("factory-selector");
  selector.style.display = "flex";
  selector.classList.add("show");
}

    const FACTORY_DATA = {
      1: {
        map: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë“œë¡ 3.png",
        cad: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”_ë„ë©´3.png"
      },
      2: {
        map: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë“œë¡ .png",
        cad: "https://sdypaperbanwol.github.io/material-form-banwol-/ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›”2ê³µì¥_ë„ë©´.png"
      }
    };

const factoryNames = {
  1: "ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” ë³¸ê³µì¥",
  2: "ì‹ ëŒ€ì–‘ì œì§€ë°˜ì›” 2ê³µì¥"
};

    let selectedFactory = null;
let isInitialized = false;

function loadFactory(factoryNum) {
  selectedFactory = factoryNum;
  const factory = FACTORY_DATA[factoryNum];
  if (!factory) return;

  document.getElementById("factory-selector").style.display = "none";
  document.getElementById("main-app").style.display = "block";

  const mapEl = document.getElementById("map");
  const cadEl = document.getElementById("cad");

  mapEl.src = factory.map;
  cadEl.src = factory.cad;

  document.getElementById("currentFactory").innerText = `ğŸ­ í˜„ì¬ ê³µì¥: ${factoryNames[factoryNum]}`;

  const finishInit = () => {
    resizeCanvas();
    if (!isInitialized) {
      initSystem();
      isInitialized = true;
    }
  };

  if (mapEl.complete) {
    finishInit();
  } else {
    mapEl.onload = finishInit;
  }
}


window.loadFactory = loadFactory;


    // âœ… ì•„ë˜ëŠ” ê¸°ì¡´ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ì‚½ì…
    // ë‹¨, map.onloadì—ì„œ resizeCanvas()ë§Œ í˜¸ì¶œí•˜ë©´ ë¨
    let cellSize = 20;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let hasMoved = false;
    let lastSelection = null;

    const map = document.getElementById("map");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const coordsDiv = document.getElementById("coords");
    const saveBtn = document.getElementById("saveBtn");
    const savedDiv = document.getElementById("saved");
    const cadImg = document.getElementById("cad");
    const toggleCadBtn = document.getElementById("toggleCadBtn");
    const cadOpacity = document.getElementById("cadOpacity");

    let cadVisible = false;
    toggleCadBtn.textContent = "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";

    function getMetersPerPixel() {
      return 0.15;
    }

    function resizeCanvas() {
      canvas.width = map.clientWidth;
      canvas.height = map.clientHeight;
      drawGrid();
    }

    function getScale() {
      return canvas.width / map.naturalWidth;
    }

    function getRelativeCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scale = getScale();
      return {
        x: (e.clientX - rect.left) / scale,
        y: (e.clientY - rect.top) / scale
      };
    }

    function drawGrid() {
      const scale = getScale();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "rgba(0,0,0,0.3)";
      ctx.lineWidth = 1;

      const step = cellSize * scale;
      const fontSize = Math.max(14 * scale, 11);
      ctx.font = `${fontSize}px sans-serif`;
      ctx.fillStyle = "yellow";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";

      for (let x = 0, i = 0; x <= canvas.width; x += step, i++) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
        ctx.fillText(i, x + step / 2, 0);
      }

      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      for (let y = 0, j = 0; y <= canvas.height; y += step, j++) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
        ctx.fillText(j, 0, y + step / 2);
      }

      drawScaleBar();
    }

    function drawScaleBar() {
      const scale = getScale();
      const metersPerPixel = getMetersPerPixel();
      const canvasWidth = canvas.width;

      const maxBarPx = canvasWidth * 0.25;
      const niceSteps = [1, 2, 5, 10, 20, 50, 100, 200];
      const maxMeters = maxBarPx / metersPerPixel;
      let chosen = niceSteps.find(m => m <= maxMeters) || niceSteps[niceSteps.length - 1];
      const barPx = chosen / metersPerPixel;

      const x = canvasWidth - barPx - 20;
      const y = canvas.height - 20;

      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + barPx, y);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = "white";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(`ì•½ ${chosen} m`, x + barPx / 2, y - 10);
    }

    function drawMultilineLabel(x, y, lines) {
      const scale = getScale();
      const fontSize = Math.max(13 * scale, 11);
      ctx.font = `bold ${fontSize}px sans-serif`;  // âœ… bold ì¶”ê°€
ctx.fillStyle = "black";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";

      const totalHeight = lines.length * (fontSize + 2);
      const startY = y * scale - totalHeight / 2;

      lines.forEach((line, i) => {
        ctx.fillText(line, x * scale, startY + i * (fontSize + 2));
      });
    }

function drawShadedArea(x1, y1, x2, y2) {
  const scale = getScale();

  ctx.fillStyle = "rgba(255,255,0,0.3)";
  for (let y = y1; y < y2; y += cellSize) {
    for (let x = x1; x < x2; x += cellSize) {
      ctx.fillRect(x * scale, y * scale, cellSize * scale, cellSize * scale);
    }
  }

  // âœ… í…Œë‘ë¦¬ í•œ ë²ˆë§Œ ì „ì²´ì— ê·¸ë¦¼
  const boxX = x1 * scale;
  const boxY = y1 * scale;
  const boxW = (x2 - x1) * scale;
  const boxH = (y2 - y1) * scale;

  ctx.strokeStyle = "orange";   // í…Œë‘ë¦¬ ìƒ‰
  ctx.lineWidth = 3;            // í…Œë‘ë¦¬ ë‘ê»˜
  ctx.strokeRect(boxX, boxY, boxW, boxH);
}


    function formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy) {
      const xStart = x1 / cellSize;
      const yStart = y1 / cellSize;
      const xEnd = xStart + cols - 1;
      const yEnd = yStart + rows - 1;

      return [
        `ì…€ X=${xStart}~${xEnd}, Y=${yStart}~${yEnd}`,
        `${cols}x${rows}ì¹¸`,
        `${widthM.toFixed(2)}m Ã— ${heightM.toFixed(2)}m`,
        `${areaM2.toFixed(2)}mÂ² (ì•½ ${areaPy.toFixed(2)}í‰)`
      ];
    }

    function handleStart(e) {
      const pos = getRelativeCoords(e);
      dragStartX = pos.x;
      dragStartY = pos.y;
      isDragging = true;
      hasMoved = false;
    }

    function handleMove(e) {
  if (!isDragging) return;
  hasMoved = true;

  const pos = getRelativeCoords(e);
  const x = Math.min(dragStartX, pos.x);
  const y = Math.min(dragStartY, pos.y);
  const w = Math.abs(dragStartX - pos.x);
  const h = Math.abs(dragStartY - pos.y);

  drawGrid();

  ctx.fillStyle = "rgba(255,255,0,0.3)";
  ctx.fillRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());

  ctx.strokeStyle = "orange";
  ctx.lineWidth = 3;
  ctx.strokeRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());

  // âœ… ë“œë˜ê·¸ ì¤‘ ë¼ë²¨ í‘œì‹œ ì¶”ê°€
  const x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
  const y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
  const x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
  const y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

  const cols = (x2 - x1) / cellSize;
  const rows = (y2 - y1) / cellSize;
  const widthM = (x2 - x1) * getMetersPerPixel();
  const heightM = (y2 - y1) * getMetersPerPixel();
  const areaM2 = widthM * heightM;
  const areaPy = areaM2 / 3.3058;

  drawMultilineLabel(
    x1 + (x2 - x1) / 2,
    y1 + (y2 - y1) / 2,
    formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
  );
}


    function handleEnd(e) {
      const pos = getRelativeCoords(e);
      let x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
      let y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
      let x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
      let y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

      if (!hasMoved) {
        x1 = Math.floor(pos.x / cellSize) * cellSize;
        y1 = Math.floor(pos.y / cellSize) * cellSize;
        x2 = x1 + cellSize;
        y2 = y1 + cellSize;
      }

      const cols = (x2 - x1) / cellSize;
      const rows = (y2 - y1) / cellSize;
      const metersPerPixel = getMetersPerPixel();
      const widthM = (x2 - x1) * metersPerPixel;
      const heightM = (y2 - y1) * metersPerPixel;
      const areaM2 = widthM * heightM;
      const areaPy = areaM2 / 3.3058;

      lastSelection = { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy };

      drawGrid();
      drawShadedArea(x1, y1, x2, y2);
      drawMultilineLabel(x1 + (x2 - x1) / 2, y1 + (y2 - y1) / 2, formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy));

      coordsDiv.innerText =
        `ì¢Œí‘œ: ì…€ X=${x1 / cellSize}, Y=${y1 / cellSize} (í”½ì…€ X=${x1}, Y=${y1})\n` +
        `í¬ê¸°: ${cols}Ã—${rows}ì¹¸, ì•½ ${widthM.toFixed(2)}m Ã— ${heightM.toFixed(2)}m`;

      isDragging = false;
      hasMoved = false;
    }

    function initSystem() {
      map.onload = resizeCanvas;
      window.addEventListener("resize", resizeCanvas);

 // âœ… CAD ì´ˆê¸° ìƒíƒœ ë³´ì¥
  cadImg.style.display = "none";
  cadVisible = false;
  toggleCadBtn.textContent = "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";

      canvas.addEventListener("mousedown", handleStart);
      canvas.addEventListener("mousemove", handleMove);
      canvas.addEventListener("mouseup", handleEnd);

// âœ… ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ ì´ë²¤íŠ¸
canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
    handleStart(e.touches[0]);
  }
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  if (e.touches.length === 1) {
    e.preventDefault();
    handleMove(e.touches[0]);
  }
}, { passive: false });

canvas.addEventListener("touchend", e => {
  if (e.changedTouches.length === 1) {
    e.preventDefault();
    handleEnd(e.changedTouches[0]);
  }
}, { passive: false });


      cadOpacity.addEventListener("input", () => {
        cadImg.style.opacity = cadOpacity.value / 100;
      });

      toggleCadBtn.addEventListener("click", () => {
        cadVisible = !cadVisible;
        cadImg.style.display = cadVisible ? "block" : "none";
        toggleCadBtn.textContent = cadVisible ? "ğŸŸ¢ CAD ë³´ê¸° ë„ê¸°" : "ğŸ”´ CAD ë³´ê¸° ì¼œê¸°";
      });

      saveBtn.addEventListener("click", () => {
  if (!lastSelection) return;
  const { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy } = lastSelection;

  const labelLines = formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy); // âœ… ì •ì˜
  const labelText = labelLines.join(" / ");  // âœ… í•œ ì¤„ í…ìŠ¤íŠ¸ ìƒì„±

const entry = document.createElement("div");
entry.className = "entry";
entry.dataset.x1 = x1;
entry.dataset.y1 = y1;
entry.dataset.x2 = x2;
entry.dataset.y2 = y2;

// í…ìŠ¤íŠ¸ ë°•ìŠ¤
const textDiv = document.createElement("div");
textDiv.className = "text";
textDiv.textContent = labelText;

// ìˆ˜ì • ë²„íŠ¼
const editBtn = document.createElement("button");
editBtn.textContent = "âœï¸ ìˆ˜ì •";
editBtn.onclick = () => {
  const input = document.createElement("input");
  input.type = "text";
  input.value = textDiv.textContent;
  input.style.fontSize = "13px";
  input.style.width = "100%";

  input.onblur = () => {
    textDiv.textContent = input.value;
    textDiv.style.display = "block";
    input.remove();
  };
  input.onkeydown = e => {
    if (e.key === "Enter") input.blur();
  };

  textDiv.style.display = "none";
  entry.insertBefore(input, btnBox);
  input.focus();
};

// ì‚­ì œ ë²„íŠ¼
const delBtn = document.createElement("button");
delBtn.textContent = "âŒ";
delBtn.onclick = (e) => {
  e.stopPropagation();
  savedDiv.removeChild(entry);
  if (savedDiv.childElementCount === 0) {
    savedDiv.textContent = "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ";
  }
};

// ë§í¬ ë²„íŠ¼
const linkBtn = document.createElement("button");
linkBtn.textContent = "ğŸ”— ë§í¬ ë³µì‚¬";
linkBtn.onclick = () => {
  const url = new URL(location.href);
  const raw = [x1, y1, x2, y2, selectedFactory, 1, encodeURIComponent(textDiv.textContent.trim())].join("|");
  const encoded = btoa(raw);
  url.searchParams.set("code", encoded);
  navigator.clipboard.writeText(url.toString());
  alert("âœ… ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
};

// ë²„íŠ¼ ë°•ìŠ¤
const btnBox = document.createElement("div");
btnBox.className = "buttons";
btnBox.appendChild(editBtn);
btnBox.appendChild(delBtn);
btnBox.appendChild(linkBtn);

// ì „ì²´ ì¡°í•©
entry.appendChild(textDiv);
entry.appendChild(btnBox);


  entry.onclick = () => {
    drawGrid();
    drawShadedArea(x1, y1, x2, y2);
    drawMultilineLabel(
      x1 + (x2 - x1) / 2,
      y1 + (y2 - y1) / 2,
      labelLines  // âœ… ë°°ì—´ ì¬ì‚¬ìš©
    );
  };

  if (savedDiv.textContent.trim() === "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ") savedDiv.innerHTML = "";
  savedDiv.appendChild(entry);
});

    }

document.getElementById("backBtn").addEventListener("click", () => {
  document.getElementById("main-app").style.display = "none";
  const selectorDiv = document.getElementById("factory-selector");
  selectorDiv.style.display = "flex";                   // âœ… í•„ìˆ˜: flex ìœ ì§€
  selectorDiv.style.flexDirection = "column";           // âœ… ì„¸ë¡œ ì •ë ¬ ë³µêµ¬
  selectorDiv.style.alignItems = "center";              // âœ… ì¤‘ì•™ ì •ë ¬ ë³µêµ¬

  // ìƒíƒœ ì´ˆê¸°í™”
  savedDiv.innerHTML = "ì €ì¥ëœ ì¢Œí‘œ ì—†ìŒ";
  coordsDiv.innerText = "ì¢Œí‘œ: ";
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  lastSelection = null;
});
document.getElementById("currentFactory").innerText = "";

window.loadFactory = loadFactory;
localStorage.removeItem("auth");
window.addEventListener("DOMContentLoaded", () => {
  const isLoggedIn = localStorage.getItem("auth") === "ok";
  if (!isLoggedIn) {
    document.getElementById("login-screen").style.display = "block";
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const viewOnly = params.get("view") === "1";

  if (code) {
    try {
      const decoded = atob(code);
      const parts = decoded.split("|");
      const [x1, y1, x2, y2, factoryParam, viewFlag] = parts.slice(0, 6).map(Number);
      const labelText = parts[6] ? decodeURIComponent(parts[6]) : "";

      const isViewOnly = viewFlag === 1;

      if (
        isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) ||
        !(factoryParam === 1 || factoryParam === 2)
      ) throw new Error("Invalid data");

      loadFactory(factoryParam);

      document.getElementById("map").onload = () => {
        resizeCanvas();
        if (!isInitialized) {
          initSystem();
          isInitialized = true;
        }

        const cols = (x2 - x1) / cellSize;
        const rows = (y2 - y1) / cellSize;
        const metersPerPixel = getMetersPerPixel();
        const widthM = (x2 - x1) * metersPerPixel;
        const heightM = (y2 - y1) * metersPerPixel;
        const areaM2 = widthM * heightM;
        const areaPy = areaM2 / 3.3058;

        lastSelection = { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy };

        drawGrid();
        drawShadedArea(x1, y1, x2, y2);
        drawMultilineLabel(
          x1 + (x2 - x1) / 2,
          y1 + (y2 - y1) / 2,
          formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
        );

        document.getElementById("coords").innerText =
          `ì¢Œí‘œ: ì…€ X=${x1 / cellSize}, Y=${y1 / cellSize} (í”½ì…€ X=${x1}, Y=${y1})\n` +
          `í¬ê¸°: ${cols}Ã—${rows}ì¹¸, ì•½ ${widthM.toFixed(2)}m Ã— ${heightM.toFixed(2)}m`;

        if (labelText) {
          const labelDiv = document.createElement("div");
          labelDiv.innerHTML = `<span style="color:green; font-weight:bold;">ğŸ“Œ ê³µìœ  ì œëª©: ${labelText}</span>`;
          labelDiv.style.margin = "10px auto 20px";
          labelDiv.style.textAlign = "center";
          document.getElementById("main-app").insertBefore(labelDiv, document.getElementById("map-container"));
        }

        if (isViewOnly) {
          document.getElementById("controls").style.display = "none";
          canvas.style.pointerEvents = "none";
        }
      };
    } catch (e) {
      alert("ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.");
      showFactorySelector();  // âœ… ì˜ˆì™¸ ë°œìƒ ì‹œ ê¸°ë³¸ í™”ë©´
    }
  } else {
    showFactorySelector(); // âœ… code ì—†ì„ ë•Œ ê¸°ë³¸ í™”ë©´
  }
});


</script>
</body>
</html>
