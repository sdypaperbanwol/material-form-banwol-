<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>드론 지도 음영 시스템</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #header {
      text-align: center;
      margin-top: 20px;
    }

    #header img {
      height: 80px;
      margin-bottom: 10px;
    }

 #factory-selector {
  display: flex;
  flex-direction: column;         /* ✅ 세로 정렬 유지 */
  align-items: center;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: #fafafa;
  margin: 40px 0;
  gap: 24px;
  font-size: 1.15rem;
  transform: scale(1.15);         /* ✅ 전체 크기 15% 확대 */
  transform-origin: center top;

  /* ✅ fade-in 효과 준비 */
  opacity: 0;
  transition: opacity 0.6s ease;
}

#factory-selector.show {
  opacity: 1; /* ✅ fade-in 대상 클래스 */
}

#factory-selector button {
  width: 320px;
  padding: 16px 20px;
  font-size: 1rem;
  line-height: 1.5;
  text-align: center;
  border: 1px solid #aaa;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: 0.2s;
}

#factory-selector button:hover {
  background: #f0f0f0;
}

/* ✅ 모바일에서 버튼 간격 키우기 */
 @media (max-width: 600px) {
      #factory-selector button {
        margin-bottom: 20px;
        padding: 20px;
        font-size: 1.1rem;
      }
    }



    #main-app {
      display: none;
      width: 100%;
    }

    #map-container {
      position: relative;
      width: 90%;
      max-width: 1000px;
      border: 1px solid #ccc;
      margin: 20px auto 0;
    }

    #map {
      display: block;
      width: 100%;
      height: auto;
    }

    #cad {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 0.5;
      pointer-events: none;
      z-index: 5;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: auto;
    }



    #controls {
      margin: 30px auto 100px;
      width: 90%;
      max-width: 800px;
    }

    #coords {
      font-family: monospace;
      margin-bottom: 10px;
    }

    #saved {
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      background: #f8f8f8;
      border: 1px solid #ccc;
      padding: 14px;
      min-height: 120px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.5;
    }

    #saved div {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #saved div:hover {
      background: #eef;
    }

    button {
      margin-bottom: 10px;
      padding: 8px 16px;
      font-size: 15px;
    }
#saved .entry {
  background: #eef7ff;
  border: 1px solid #bcd;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#saved .entry .text {
  font-size: 14px;
  word-break: keep-all;
}

#saved .entry .buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

#saved .entry .buttons button {
  font-size: 13px;
  padding: 5px 10px;
}

#header {
  text-align: center;
  margin-top: 10px; /* 또는 0 */
}

  </style>
</head>
<body>
<!-- 로그인 창 -->
<!-- 로그인 창 -->
<div id="login-screen" style="
  display: none;                /* 기본은 숨김 */
  position: absolute;          /* 위에 고정되게 */
  top: 150px;                  /* 로고 아래로 내려오게 조정 */
  left: 0;
  right: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  z-index: 100;
">
  <h2>🔒 로그인</h2>
  <input type="text" id="login-id" placeholder="아이디" style="padding: 8px; font-size: 1rem;"><br><br>
  <input type="password" id="login-pw" placeholder="비밀번호" style="padding: 8px; font-size: 1rem;"><br><br>
  <button onclick="handleLogin()" style="padding: 10px 20px;">로그인</button>
</div>



<!-- ✅ 상단 회사 로고 + 제목 -->
<div id="header">
  <img src="https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월_로고.png" alt="회사 로고">
  <h2>🛰️ 드론 지도 음영 시스템 (Canvas)</h2>
</div>

<!-- ✅ 공장 선택 버튼 -->
<!-- ✅ 공장 선택 화면 -->
<div id="factory-selector" style="display: none;">

  <h3 style="margin-bottom: 30px; font-size: 1.3em;">📍 공장을 선택해주세요</h3>

  <!-- ✅ 본공장 -->
  <div style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;">
    <!-- 왼쪽: 버튼 설명 -->
    <div style="flex: 1;">
      <button onclick="loadFactory(1)" style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;">
        🏭 신대양제지반월 본공장<br>
        <small style="color:gray;">(본공장 / 경기도 안산시 단원구 목내로 29)</small>
      </button>
    </div>
    <!-- 오른쪽: 이미지 썸네일 -->
    <img src="https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월_드론3.png" style="width: 240px; border-radius: 8px;">
  </div>

  <!-- ✅ 2공장 -->
  <div style="display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 16px 24px; margin-bottom: 30px; max-width: 700px;">
    <div style="flex: 1;">
      <button onclick="loadFactory(2)" style="width: 100%; padding: 16px; border-radius: 8px; border: 1px solid #aaa; font-size: 1rem; background: #f9f9f9; cursor: pointer;">
        🏭 신대양제지반월 2공장<br>
        <small style="color:gray;">(2공장 / 경기도 안산시 단원구 별망로 408)</small>
      </button>
    </div>
    <img src="https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월2공장_드론.png" style="width: 240px; border-radius: 8px;">
  </div>

</div>






<!-- ✅ 메인 시스템 영역 -->
<div id="main-app">
  <!-- 공장 이름 표시 -->
  <div id="currentFactory" style="margin: 0 auto 10px; text-align: center; font-weight: bold;"></div>

  <!-- 지도 및 오버레이 영역 -->
  <div id="map-container">
    <img id="map" />
    <img id="cad" style="display: none;" />
    <canvas id="overlay"></canvas>
  </div>

  <!-- 컨트롤 패널 -->
  <div id="controls">
    <!-- ✅ 버튼 3개 한 줄 정렬 -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;">
      <div style="display: flex; gap: 10px;">
        <button id="saveBtn">📌 선택 좌표 저장</button>
        <button id="toggleCadBtn">🔴 CAD 보기 켜기</button>
      </div>
      <button id="backBtn">🔙 공장 선택으로 돌아가기</button>
    </div>

    <!-- 좌표 정보 -->
    <div id="coords">좌표: </div>

    <!-- CAD 투명도 조절 -->
    <div style="margin: 8px 0;">
      <label>CAD 투명도:
        <input type="range" id="cadOpacity" min="0" max="100" value="50">
      </label>
    </div>

    <!-- 저장된 좌표 목록 -->
    <div id="saved">저장된 좌표 없음</div>
  </div>
</div>



  <!-- ✅ 통합 스크립트 -->
  <script>
 function handleLogin() {
  const id = document.getElementById("login-id").value;
  const pw = document.getElementById("login-pw").value;

  if (id === "admin" && pw === "1234") {
    localStorage.setItem("auth", "ok");
    document.getElementById("login-screen").style.display = "none";
    showFactorySelector();  // ✅ 바로 공장 선택화면으로 전환
  } else {
    alert("❌ 아이디 또는 비밀번호가 잘못되었습니다.");
  }
}


function showFactorySelector() {
  const selector = document.getElementById("factory-selector");
  selector.style.display = "flex";
  selector.classList.add("show");
}

    const FACTORY_DATA = {
      1: {
        map: "https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월_드론3.png",
        cad: "https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월_도면3.png"
      },
      2: {
        map: "https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월2공장_드론.png",
        cad: "https://sdypaperbanwol.github.io/material-form-banwol-/신대양제지반월2공장_도면.png"
      }
    };

const factoryNames = {
  1: "신대양제지반월 본공장",
  2: "신대양제지반월 2공장"
};

    let selectedFactory = null;
let isInitialized = false;

function loadFactory(factoryNum) {
  selectedFactory = factoryNum;
  const factory = FACTORY_DATA[factoryNum];
  if (!factory) return;

  document.getElementById("factory-selector").style.display = "none";
  document.getElementById("main-app").style.display = "block";

  const mapEl = document.getElementById("map");
  const cadEl = document.getElementById("cad");

  mapEl.src = factory.map;
  cadEl.src = factory.cad;

  document.getElementById("currentFactory").innerText = `🏭 현재 공장: ${factoryNames[factoryNum]}`;

  const finishInit = () => {
    resizeCanvas();
    if (!isInitialized) {
      initSystem();
      isInitialized = true;
    }
  };

  if (mapEl.complete) {
    finishInit();
  } else {
    mapEl.onload = finishInit;
  }
}


window.loadFactory = loadFactory;


    // ✅ 아래는 기존 시스템 스크립트 전체 삽입
    // 단, map.onload에서 resizeCanvas()만 호출하면 됨
    let cellSize = 20;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let hasMoved = false;
    let lastSelection = null;

    const map = document.getElementById("map");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const coordsDiv = document.getElementById("coords");
    const saveBtn = document.getElementById("saveBtn");
    const savedDiv = document.getElementById("saved");
    const cadImg = document.getElementById("cad");
    const toggleCadBtn = document.getElementById("toggleCadBtn");
    const cadOpacity = document.getElementById("cadOpacity");

    let cadVisible = false;
    toggleCadBtn.textContent = "🔴 CAD 보기 켜기";

    function getMetersPerPixel() {
      return 0.15;
    }

    function resizeCanvas() {
      canvas.width = map.clientWidth;
      canvas.height = map.clientHeight;
      drawGrid();
    }

    function getScale() {
      return canvas.width / map.naturalWidth;
    }

    function getRelativeCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scale = getScale();
      return {
        x: (e.clientX - rect.left) / scale,
        y: (e.clientY - rect.top) / scale
      };
    }

    function drawGrid() {
      const scale = getScale();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "rgba(0,0,0,0.3)";
      ctx.lineWidth = 1;

      const step = cellSize * scale;
      const fontSize = Math.max(14 * scale, 11);
      ctx.font = `${fontSize}px sans-serif`;
      ctx.fillStyle = "yellow";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";

      for (let x = 0, i = 0; x <= canvas.width; x += step, i++) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
        ctx.fillText(i, x + step / 2, 0);
      }

      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      for (let y = 0, j = 0; y <= canvas.height; y += step, j++) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
        ctx.fillText(j, 0, y + step / 2);
      }

      drawScaleBar();
    }

    function drawScaleBar() {
      const scale = getScale();
      const metersPerPixel = getMetersPerPixel();
      const canvasWidth = canvas.width;

      const maxBarPx = canvasWidth * 0.25;
      const niceSteps = [1, 2, 5, 10, 20, 50, 100, 200];
      const maxMeters = maxBarPx / metersPerPixel;
      let chosen = niceSteps.find(m => m <= maxMeters) || niceSteps[niceSteps.length - 1];
      const barPx = chosen / metersPerPixel;

      const x = canvasWidth - barPx - 20;
      const y = canvas.height - 20;

      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + barPx, y);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = "white";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(`약 ${chosen} m`, x + barPx / 2, y - 10);
    }

    function drawMultilineLabel(x, y, lines) {
      const scale = getScale();
      const fontSize = Math.max(13 * scale, 11);
      ctx.font = `bold ${fontSize}px sans-serif`;  // ✅ bold 추가
ctx.fillStyle = "black";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";

      const totalHeight = lines.length * (fontSize + 2);
      const startY = y * scale - totalHeight / 2;

      lines.forEach((line, i) => {
        ctx.fillText(line, x * scale, startY + i * (fontSize + 2));
      });
    }

function drawShadedArea(x1, y1, x2, y2) {
  const scale = getScale();

  ctx.fillStyle = "rgba(255,255,0,0.3)";
  for (let y = y1; y < y2; y += cellSize) {
    for (let x = x1; x < x2; x += cellSize) {
      ctx.fillRect(x * scale, y * scale, cellSize * scale, cellSize * scale);
    }
  }

  // ✅ 테두리 한 번만 전체에 그림
  const boxX = x1 * scale;
  const boxY = y1 * scale;
  const boxW = (x2 - x1) * scale;
  const boxH = (y2 - y1) * scale;

  ctx.strokeStyle = "orange";   // 테두리 색
  ctx.lineWidth = 3;            // 테두리 두께
  ctx.strokeRect(boxX, boxY, boxW, boxH);
}


    function formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy) {
      const xStart = x1 / cellSize;
      const yStart = y1 / cellSize;
      const xEnd = xStart + cols - 1;
      const yEnd = yStart + rows - 1;

      return [
        `셀 X=${xStart}~${xEnd}, Y=${yStart}~${yEnd}`,
        `${cols}x${rows}칸`,
        `${widthM.toFixed(2)}m × ${heightM.toFixed(2)}m`,
        `${areaM2.toFixed(2)}m² (약 ${areaPy.toFixed(2)}평)`
      ];
    }

    function handleStart(e) {
      const pos = getRelativeCoords(e);
      dragStartX = pos.x;
      dragStartY = pos.y;
      isDragging = true;
      hasMoved = false;
    }

    function handleMove(e) {
  if (!isDragging) return;
  hasMoved = true;

  const pos = getRelativeCoords(e);
  const x = Math.min(dragStartX, pos.x);
  const y = Math.min(dragStartY, pos.y);
  const w = Math.abs(dragStartX - pos.x);
  const h = Math.abs(dragStartY - pos.y);

  drawGrid();

  ctx.fillStyle = "rgba(255,255,0,0.3)";
  ctx.fillRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());

  ctx.strokeStyle = "orange";
  ctx.lineWidth = 3;
  ctx.strokeRect(x * getScale(), y * getScale(), w * getScale(), h * getScale());

  // ✅ 드래그 중 라벨 표시 추가
  const x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
  const y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
  const x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
  const y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

  const cols = (x2 - x1) / cellSize;
  const rows = (y2 - y1) / cellSize;
  const widthM = (x2 - x1) * getMetersPerPixel();
  const heightM = (y2 - y1) * getMetersPerPixel();
  const areaM2 = widthM * heightM;
  const areaPy = areaM2 / 3.3058;

  drawMultilineLabel(
    x1 + (x2 - x1) / 2,
    y1 + (y2 - y1) / 2,
    formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
  );
}


    function handleEnd(e) {
      const pos = getRelativeCoords(e);
      let x1 = Math.floor(Math.min(dragStartX, pos.x) / cellSize) * cellSize;
      let y1 = Math.floor(Math.min(dragStartY, pos.y) / cellSize) * cellSize;
      let x2 = Math.ceil(Math.max(dragStartX, pos.x) / cellSize) * cellSize;
      let y2 = Math.ceil(Math.max(dragStartY, pos.y) / cellSize) * cellSize;

      if (!hasMoved) {
        x1 = Math.floor(pos.x / cellSize) * cellSize;
        y1 = Math.floor(pos.y / cellSize) * cellSize;
        x2 = x1 + cellSize;
        y2 = y1 + cellSize;
      }

      const cols = (x2 - x1) / cellSize;
      const rows = (y2 - y1) / cellSize;
      const metersPerPixel = getMetersPerPixel();
      const widthM = (x2 - x1) * metersPerPixel;
      const heightM = (y2 - y1) * metersPerPixel;
      const areaM2 = widthM * heightM;
      const areaPy = areaM2 / 3.3058;

      lastSelection = { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy };

      drawGrid();
      drawShadedArea(x1, y1, x2, y2);
      drawMultilineLabel(x1 + (x2 - x1) / 2, y1 + (y2 - y1) / 2, formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy));

      coordsDiv.innerText =
        `좌표: 셀 X=${x1 / cellSize}, Y=${y1 / cellSize} (픽셀 X=${x1}, Y=${y1})\n` +
        `크기: ${cols}×${rows}칸, 약 ${widthM.toFixed(2)}m × ${heightM.toFixed(2)}m`;

      isDragging = false;
      hasMoved = false;
    }

    function initSystem() {
      map.onload = resizeCanvas;
      window.addEventListener("resize", resizeCanvas);

 // ✅ CAD 초기 상태 보장
  cadImg.style.display = "none";
  cadVisible = false;
  toggleCadBtn.textContent = "🔴 CAD 보기 켜기";

      canvas.addEventListener("mousedown", handleStart);
      canvas.addEventListener("mousemove", handleMove);
      canvas.addEventListener("mouseup", handleEnd);

// ✅ 모바일 터치 대응 이벤트
canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    e.preventDefault(); // 스크롤 방지
    handleStart(e.touches[0]);
  }
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  if (e.touches.length === 1) {
    e.preventDefault();
    handleMove(e.touches[0]);
  }
}, { passive: false });

canvas.addEventListener("touchend", e => {
  if (e.changedTouches.length === 1) {
    e.preventDefault();
    handleEnd(e.changedTouches[0]);
  }
}, { passive: false });


      cadOpacity.addEventListener("input", () => {
        cadImg.style.opacity = cadOpacity.value / 100;
      });

      toggleCadBtn.addEventListener("click", () => {
        cadVisible = !cadVisible;
        cadImg.style.display = cadVisible ? "block" : "none";
        toggleCadBtn.textContent = cadVisible ? "🟢 CAD 보기 끄기" : "🔴 CAD 보기 켜기";
      });

      saveBtn.addEventListener("click", () => {
  if (!lastSelection) return;
  const { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy } = lastSelection;

  const labelLines = formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy); // ✅ 정의
  const labelText = labelLines.join(" / ");  // ✅ 한 줄 텍스트 생성

const entry = document.createElement("div");
entry.className = "entry";
entry.dataset.x1 = x1;
entry.dataset.y1 = y1;
entry.dataset.x2 = x2;
entry.dataset.y2 = y2;

// 텍스트 박스
const textDiv = document.createElement("div");
textDiv.className = "text";
textDiv.textContent = labelText;

// 수정 버튼
const editBtn = document.createElement("button");
editBtn.textContent = "✏️ 수정";
editBtn.onclick = () => {
  const input = document.createElement("input");
  input.type = "text";
  input.value = textDiv.textContent;
  input.style.fontSize = "13px";
  input.style.width = "100%";

  input.onblur = () => {
    textDiv.textContent = input.value;
    textDiv.style.display = "block";
    input.remove();
  };
  input.onkeydown = e => {
    if (e.key === "Enter") input.blur();
  };

  textDiv.style.display = "none";
  entry.insertBefore(input, btnBox);
  input.focus();
};

// 삭제 버튼
const delBtn = document.createElement("button");
delBtn.textContent = "❌";
delBtn.onclick = (e) => {
  e.stopPropagation();
  savedDiv.removeChild(entry);
  if (savedDiv.childElementCount === 0) {
    savedDiv.textContent = "저장된 좌표 없음";
  }
};

// 링크 버튼
const linkBtn = document.createElement("button");
linkBtn.textContent = "🔗 링크 복사";
linkBtn.onclick = () => {
  const url = new URL(location.href);
  const raw = [x1, y1, x2, y2, selectedFactory, 1, encodeURIComponent(textDiv.textContent.trim())].join("|");
  const encoded = btoa(raw);
  url.searchParams.set("code", encoded);
  navigator.clipboard.writeText(url.toString());
  alert("✅ 공유 링크가 복사되었습니다!");
};

// 버튼 박스
const btnBox = document.createElement("div");
btnBox.className = "buttons";
btnBox.appendChild(editBtn);
btnBox.appendChild(delBtn);
btnBox.appendChild(linkBtn);

// 전체 조합
entry.appendChild(textDiv);
entry.appendChild(btnBox);


  entry.onclick = () => {
    drawGrid();
    drawShadedArea(x1, y1, x2, y2);
    drawMultilineLabel(
      x1 + (x2 - x1) / 2,
      y1 + (y2 - y1) / 2,
      labelLines  // ✅ 배열 재사용
    );
  };

  if (savedDiv.textContent.trim() === "저장된 좌표 없음") savedDiv.innerHTML = "";
  savedDiv.appendChild(entry);
});

    }

document.getElementById("backBtn").addEventListener("click", () => {
  document.getElementById("main-app").style.display = "none";
  const selectorDiv = document.getElementById("factory-selector");
  selectorDiv.style.display = "flex";                   // ✅ 필수: flex 유지
  selectorDiv.style.flexDirection = "column";           // ✅ 세로 정렬 복구
  selectorDiv.style.alignItems = "center";              // ✅ 중앙 정렬 복구

  // 상태 초기화
  savedDiv.innerHTML = "저장된 좌표 없음";
  coordsDiv.innerText = "좌표: ";
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  lastSelection = null;
});
document.getElementById("currentFactory").innerText = "";

window.loadFactory = loadFactory;
localStorage.removeItem("auth");
window.addEventListener("DOMContentLoaded", () => {
  const isLoggedIn = localStorage.getItem("auth") === "ok";
  if (!isLoggedIn) {
    document.getElementById("login-screen").style.display = "block";
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const viewOnly = params.get("view") === "1";

  if (code) {
    try {
      const decoded = atob(code);
      const parts = decoded.split("|");
      const [x1, y1, x2, y2, factoryParam, viewFlag] = parts.slice(0, 6).map(Number);
      const labelText = parts[6] ? decodeURIComponent(parts[6]) : "";

      const isViewOnly = viewFlag === 1;

      if (
        isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) ||
        !(factoryParam === 1 || factoryParam === 2)
      ) throw new Error("Invalid data");

      loadFactory(factoryParam);

      document.getElementById("map").onload = () => {
        resizeCanvas();
        if (!isInitialized) {
          initSystem();
          isInitialized = true;
        }

        const cols = (x2 - x1) / cellSize;
        const rows = (y2 - y1) / cellSize;
        const metersPerPixel = getMetersPerPixel();
        const widthM = (x2 - x1) * metersPerPixel;
        const heightM = (y2 - y1) * metersPerPixel;
        const areaM2 = widthM * heightM;
        const areaPy = areaM2 / 3.3058;

        lastSelection = { x1, y1, x2, y2, cols, rows, widthM, heightM, areaM2, areaPy };

        drawGrid();
        drawShadedArea(x1, y1, x2, y2);
        drawMultilineLabel(
          x1 + (x2 - x1) / 2,
          y1 + (y2 - y1) / 2,
          formatLabel(x1, y1, cols, rows, widthM, heightM, areaM2, areaPy)
        );

        document.getElementById("coords").innerText =
          `좌표: 셀 X=${x1 / cellSize}, Y=${y1 / cellSize} (픽셀 X=${x1}, Y=${y1})\n` +
          `크기: ${cols}×${rows}칸, 약 ${widthM.toFixed(2)}m × ${heightM.toFixed(2)}m`;

        if (labelText) {
          const labelDiv = document.createElement("div");
          labelDiv.innerHTML = `<span style="color:green; font-weight:bold;">📌 공유 제목: ${labelText}</span>`;
          labelDiv.style.margin = "10px auto 20px";
          labelDiv.style.textAlign = "center";
          document.getElementById("main-app").insertBefore(labelDiv, document.getElementById("map-container"));
        }

        if (isViewOnly) {
          document.getElementById("controls").style.display = "none";
          canvas.style.pointerEvents = "none";
        }
      };
    } catch (e) {
      alert("잘못된 링크입니다.");
      showFactorySelector();  // ✅ 예외 발생 시 기본 화면
    }
  } else {
    showFactorySelector(); // ✅ code 없을 때 기본 화면
  }
});


</script>
</body>
</html>
