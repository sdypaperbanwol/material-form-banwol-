<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìì¬ ì‹ ì²­</title>
  <style>
  body {
    font-family: 'sans-serif';
    background: #f7f7f7;
    text-align: center;
    padding: 1rem;
    margin: 0;
  }

  .hidden {
  display: none !important;}

  .step { margin-top: 1.5rem; }

  .button-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  button {
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background-color: #ddd;
    cursor: pointer;
    width: 70%;
    max-width: 300px;
  }

  button:hover {
    background-color: #4CAF50 !important;
    color: white;
  }

  .selected {
    background-color: #4CAF50 !important;
    color: white;
    font-weight: bold;
  }

  button:disabled {
    background-color: #ccc;
    color: #777;
    cursor: not-allowed;
  }

  /* ìˆ˜ëŸ‰ í‘œì‹œ */
  #quantity-display {
    font-size: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
  }

#viewPhotos,
#goToTypeBtn {
  display: none;
}
#record-buttons:not(.hidden) {
  display: flex;
  justify-content: center;
  gap: 0.8rem;
  margin: 0.5rem 0 1rem 0;
  flex-wrap: wrap;
}
#loadingOverlay {
  z-index: 10000; /* ê¸°ì¡´ 9999ì—ì„œ í•œ ë‹¨ê³„ ë†’ì„ */
}



  /* ìˆ˜ëŸ‰ ì…ë ¥ - í‚¤íŒ¨ë“œ + ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
  .quantity-flex-wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1.5rem;
    margin: 2rem 0;
  }

 .numpad-container,
.list-preview-container {
  border: 2px solid #ccc; /* âœ… ê¸°ë³¸ì€ íšŒìƒ‰ ë˜ëŠ” ì—°í•œ íšŒìƒ‰ */
  background: white;
  padding: 1rem;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  flex: 1 1 300px;
  max-width: 400px;
  min-width: 280px;
}

 .numpad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.6rem;
  margin: 1rem auto; /* âœ… ì¤‘ì•™ ì •ë ¬ */
  width: fit-content;
}

  .numpad-grid button {
    padding: 1rem;
    font-size: 1.5rem;
    border-radius: 10px;
    background: #e0e0e0;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }

  .numpad-grid button:hover {
    background: #ccc;
  }

  /* ë¹„ê³  ì…ë ¥ */
 #remarks {
  width: 100%;
  max-width: 400px;
  margin: 1.5rem auto 1rem auto;
  padding: 0.6rem;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  display: block;
  resize: none;
}

  /* í•˜ë‹¨ ë²„íŠ¼ ì •ë¦¬ */
  .step button {
    margin: 0.25rem;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    background: #ddd;
    cursor: pointer;
  }

  .step button:hover {
    background: #4CAF50;
    color: white;
  }

  button.back-btn {
    margin-top: 1.5rem;
  }

  /* ë¡œë”© ë©”ì‹œì§€ë“¤ */
  #loadingText,
  #loginLoadingText,
  #submitLoadingText {
    margin-top: 1rem;
    font-size: 1.1rem;
    color: #444;
  }
#submitOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#submitOverlay span {
  background: white;
  padding: 20px 40px;
  border-radius: 12px;
  font-size: 1.3rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}


  /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  input {
    padding: 0.5rem;
    font-size: 1rem;
    margin: 0.5rem auto;
    width: 80%;
    max-width: 300px;
    display: block;
  }

  /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
  .list-preview-container {
    max-height: 300px;
    overflow-y: auto;
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 10px;
    font-size: 0.95rem;
  }

  .list-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid #e0e0e0;
  }

  .list-item-text {
    flex: 1;
    text-align: left;
    word-break: break-word;
    padding-right: 0.5rem;
  }

 .delete-btn {
  font-size: 0.8rem;
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  width: 22px;
  height: 22px;
  display: flex;               /* ì¤‘ìš”! ì¤‘ì•™ ì •ë ¬ */
  align-items: center;         /* ìˆ˜ì§ ì •ë ¬ */
  justify-content: center;     /* ìˆ˜í‰ ì •ë ¬ */
  border-radius: 50%;
  transition: background 0.2s;
  padding: 0;                  /* ì•ˆìª½ ì—¬ë°± ì œê±° */
  box-sizing: border-box;
}

#login-section input {
  padding: 1.00rem; /* âœ… ë†’ì´ ì•½ê°„ ì¦ê°€ */
  font-size: 1.05rem;
  margin: 0.8rem auto; /* âœ… ê°„ê²© ì•½ê°„ ì¦ê°€ */
  width: 80%;
  max-width: 300px;
  display: block;
  border-radius: 6px;
  border: 1px solid #ccc;
}

#login-section button {
  padding: 1.0rem 1.2rem; /* âœ… ë†’ì´ ì‚´ì§ ì¦ê°€ */
  font-size: 1.05rem;
  margin-top: 1rem;        /* âœ… ìœ„ìª½ ê°„ê²© ë„ì›€ */
  border-radius: 8px;
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
}


.delete-btn:hover {
  background: #ffe5e5;
  color: #d00;
}

.button-row {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 1rem auto;
  flex-wrap: wrap;
}

.half-btn {
  flex: 1 1 30%;
  max-width: 180px;
  min-width: 140px;
  padding: 0.6rem 0.8rem;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  background: #ddd;
  cursor: pointer;
}

.half-btn:hover {
  background: #4CAF50;
  color: white;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.pulse {
  animation: pulse 0.6s ease-in-out 2;
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 0px rgba(255, 0, 0, 0.3); }
  50% { box-shadow: 0 0 12px rgba(255, 0, 0, 0.7); }
}

.glow {
  animation: glow 1.2s ease-in-out 2;
  border: 2px solid #ff4444 !important;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}

.bounce {
  animation: bounce 0.4s ease-in-out 2;
}

</style>

</head>
<body>
<!-- ìµœìƒë‹¨ì— ìœ„ì¹˜ -->
<div id="initialLoadingOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-size: 1.4rem;
">
  â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
</div>
<!-- âœ… ê¸°ì¡´ ìœ„ì¹˜ (ë§¨ ì•„ë˜)ì—ì„œ ì´ìª½ìœ¼ë¡œ ì´ë™ -->



<h2 id="title">ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ</h2>
<div id="record-buttons" class="hidden">


  <button onclick="openMyRecords()" style="
    font-size: 0.9rem;
    font-weight: bold;
    background-color: #fff;
    color: #007bff;
    border: 1px solid #007bff;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  " onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='#fff'">ğŸ“„ ë‚´ ì‹ ì²­ ë‚´ì—­</button>

  <button onclick="openTeamRecords()" style="
    font-size: 0.9rem;
    font-weight: bold;
    background-color: #fff;
    color: #28a745;
    border: 1px solid #28a745;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  " onmouseover="this.style.background='#eaffea'" onmouseout="this.style.background='#fff'">ğŸ‘¥ íŒ€ ì‹ ì²­ ë‚´ì—­</button>
</div>
<!-- ë¡œê·¸ì¸ ì˜ì—­ -->
<div id="login-section">
<!-- âœ… ê³µì§€ì‚¬í•­ ì˜ì—­ -->
  <div id="inlineNoticeBox" style="
    background: #fff3cd;
    border: 1px solid #ffeeba;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    color: #856404;
    font-size: 0.9rem;
    display: none;
    white-space: pre-wrap;
  "></div>

  

  <p>ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>

  <input id="empId" placeholder="ì‚¬ë²ˆ" />
  <input id="empName" placeholder="ì´ë¦„" />

  <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
  <div id="loginMsg"></div>

  <div id="loginLoadingText" class="hidden">ğŸ” ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>


<!-- ì‹ ì²­ í¼ ì‹œì‘ -->
<div id="form-section" class="hidden">

  <!-- ëŒ€ë¶„ë¥˜ ì„ íƒ ì˜ì—­ -->
<div id="step-category" class="step">
  <h3>1ë‹¨ê³„: ëŒ€ë¶„ë¥˜ ì„ íƒ</h3>
  <div id="category-buttons" class="button-list"></div>
<!-- ëŒ€ë¶„ë¥˜ìš© í•­ëª© ì‚¬ì§„ ë³´ê¸° ë²„íŠ¼ -->


  

  <!-- âœ… ë‹¤ìŒ ë‹¨ê³„ ì´ë™ ë²„íŠ¼ ì¶”ê°€ ìœ„ì¹˜ ì—¬ê¸°!! -->
  <button type="button" id="goToTypeBtn" onclick="goToTypeStep()" style="margin-top: 8px;">
  â¡ ë‹¤ìŒ ì´ë™
</button>
</div>

<div id="photoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999;overflow:auto;">
  <div style="background:white;margin:40px auto;padding:20px;border-radius:10px;max-width:600px;">
    <span id="closeModal" style="position:fixed;top:20px;right:20px;font-size:28px;cursor:pointer;z-index:1000;background:white;padding:4px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">âœ–</span>
    <div id="photoContent"></div>
  </div>
</div>


  <div id="step-type" class="step hidden">
  <h3>2ë‹¨ê³„: ì¤‘ë¶„ë¥˜ ì„ íƒ</h3>
  <div id="type-buttons" class="button-list"></div>
  
<button type="button" id="viewPhotosType"
  style="background:#007bff;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:6px;">
  í•­ëª© ì‚¬ì§„ ë³´ê¸°
</button>


  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('category')">â¬… ë’¤ë¡œê°€ê¸°</button>
    <button class="half-btn" onclick="goToSizeStep()">â¡ ë‹¤ìŒ ì´ë™</button>
  </div>
</div>



  <div id="step-size" class="step hidden">
  <h3>3ë‹¨ê³„: ì†Œë¶„ë¥˜ ì„ íƒ</h3>
  <div id="size-buttons" class="button-list"></div>

  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('type')">â¬… ë’¤ë¡œê°€ê¸°</button>
    <button class="half-btn" onclick="goToQuantityStep()">â¡ ë‹¤ìŒ ì´ë™</button>
  </div>
</div>


<div id="step-quantity" class="step hidden">
  <h3>4ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥</h3>

  <!-- ìˆ«ì í‚¤íŒ¨ë“œ -->
  <div class="numpad-container" style="margin: 0 auto;">
    <div id="quantity-display">0</div>
    <div id="numpad" class="numpad-grid">
      <button onclick="appendQuantity('1')">1</button>
      <button onclick="appendQuantity('2')">2</button>
      <button onclick="appendQuantity('3')">3</button>
      <button onclick="appendQuantity('4')">4</button>
      <button onclick="appendQuantity('5')">5</button>
      <button onclick="appendQuantity('6')">6</button>
      <button onclick="appendQuantity('7')">7</button>
      <button onclick="appendQuantity('8')">8</button>
      <button onclick="appendQuantity('9')">9</button>
      <button onclick="clearQuantity()">C</button>
      <button onclick="appendQuantity('0')">0</button>
      <button onclick="backspaceQuantity()">â†</button>
    </div>
  </div>

    <!-- ë¹„ê³  ì…ë ¥ -->
  <textarea id="remarks" placeholder="ë¹„ê³  (ìš”ì²­ì‚¬í•­)" rows="2" style="
  width: 100%;
  max-width: 400px;
  margin: 1.5rem auto 1rem auto;
  padding: 0.6rem;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  display: block;
  resize: none;
"></textarea>

  
  <!-- í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
  <div class="button-row">
    <button class="half-btn" onclick="addItemToList()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
  </div>


  <!-- ì¶”ê°€ëœ í•­ëª© ë¦¬ìŠ¤íŠ¸ -->
  <div class="list-preview-container" style="margin: 0 auto; text-align: center;">
  <ul id="itemListPreview" style="display: inline-block; text-align: left; font-size: 0.9rem;"></ul>
</div>

  <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
ğŸ› ë‹´ì€ í•­ëª©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ <b>ì „ì²´ ì‹ ì²­í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
</p>

  <!-- ì‹ ì²­ -->
  <div class="button-row">
    <button class="half-btn" onclick="submitAllRequests()">âœ… ì „ì²´ ì‹ ì²­í•˜ê¸°</button>
  </div>

  <!-- ë‹¤ë¥¸ ë¬¼í’ˆ ì¶”ê°€ -->
  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('category')">ğŸ“¦ ë‹¤ë¥¸ ë¬¼í’ˆ ì¶”ê°€</button>
  </div>

  <!-- ë’¤ë¡œê°€ê¸° -->
  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('size')">â¬… ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>



<!-- âœ… ì„ íƒëœ í•­ëª© ë¦¬ìŠ¤íŠ¸ í‘œì‹œ -->
<div id="selectedItems" class="step hidden">
  <h3>ğŸ“ ì„ íƒëœ í•­ëª© ë¦¬ìŠ¤íŠ¸</h3>
  <ul id="itemListDisplay"></ul>
</div>

<div id="myRecordsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;">
  <button onclick="closeMyRecords()" style="
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 22px;
    font-weight: bold;
    border: none;
    background: none;
    cursor: pointer;
    color: white;
    z-index: 10000;
  ">âœ–</button>
  <div style="
    position: relative;
    margin: 60px auto 0;
    background: white;
    padding: 20px 24px 30px;
    border-radius: 10px;
    max-width: 800px;
    width: 95%;
    max-height: 80vh;
    overflow: auto;
  ">
    <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ“„ ì‹ ì²­ ë‚´ì—­</h3>
    <table id="myRecordsTable" style="width:100%; font-size: 14px; border-collapse: collapse;">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<script>
  const endpoint = 'https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec'; // ì‹¤ì œ Web App ì£¼ì†Œë¡œ êµì²´

  let loginInfo = { empId: '', empName: '' };
  let itemData = {};
  let selected = { category: '', type: '', size: '' };

  function handleLogin() {
  const empId = document.getElementById('empId').value.trim();
  const empName = document.getElementById('empName').value.trim();
  if (!empId || !empName) return alert("ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

  // âœ… ë¡œê·¸ì¸ ì¤‘ ë¬¸êµ¬ í‘œì‹œ
  document.getElementById('loginLoadingText').classList.remove('hidden');

  // âœ… ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  document.querySelector('#login-section button').style.display = 'none';

  fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ empId, empName })
  })
  .then(res => res.json())
  .then(data => {
    // âœ… ë¡œë”© ë¬¸êµ¬ ìˆ¨ê¹€
    document.getElementById('loginLoadingText').classList.add('hidden');

    if (data.result === 'success') {
      loginInfo = { empId, empName };
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('form-section').classList.remove('hidden');
      document.getElementById('title').innerText = "ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ";
      document.getElementById('record-buttons').classList.remove('hidden');
      document.getElementById('loadingOverlay').style.display = 'flex';

      loadItems();
    } else {
      document.getElementById('loginMsg').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ';
      // âœ… ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ
      document.querySelector('#login-section button').style.display = 'inline-block';

    }
  })
  .catch(error => {
    document.getElementById('loginLoadingText').classList.add('hidden');
    document.getElementById('loginMsg').innerText = 'ì„œë²„ ì˜¤ë¥˜: ' + error.message;
    // âœ… ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ
    document.querySelector('#login-section button').style.display = 'block';
  });
}


function loadItems() {
  fetch(endpoint)
    .then(res => res.json())
    .then(data => {
      itemData = data;
      const container = document.getElementById('category-buttons');
      container.innerHTML = '';

      Object.keys(data).forEach(cat => {
        const btn = document.createElement('button');
        btn.innerText = cat;
        btn.onclick = () => {
          selected.category = cat;
          updateSelection(container, btn);

          // âœ… ë‹¤ìŒ ì´ë™ ë²„íŠ¼ì— bounce + glow + ìŠ¤í¬ë¡¤ + í¬ì»¤ìŠ¤
          const nextBtn = document.getElementById('goToTypeBtn');
          nextBtn.classList.add('bounce', 'glow');
          nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
          nextBtn.focus();
          setTimeout(() => nextBtn.classList.remove('bounce', 'glow'), 1200);
        };
        container.appendChild(btn);
      });

      document.getElementById('goToTypeBtn').style.display = 'inline-block';
      document.getElementById('loadingOverlay').style.display = 'none';
    })
    .catch(error => {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert('âŒ í•­ëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
    });
}


function selectCategory(cat) {
  const types = itemData[cat].types;
  const container = document.getElementById('type-buttons');
  container.innerHTML = '';

  types.forEach(type => {
    const btn = document.createElement('button');
    btn.innerText = type;
    btn.onclick = () => {
      selected.type = type;
      updateSelection(container, btn);

      // âœ… ë‹¤ìŒ ì´ë™ ë²„íŠ¼ ê°•ì¡° + ìŠ¤í¬ë¡¤ + í¬ì»¤ìŠ¤
      const nextBtn = document.querySelector('#step-type .half-btn:nth-child(2)');
      nextBtn.classList.add('bounce', 'glow');
      nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      nextBtn.focus();
      setTimeout(() => nextBtn.classList.remove('bounce', 'glow'), 1200);
    };
    container.appendChild(btn);
  });

  showStep('type');
}





 function selectType(type) {
  const container = document.getElementById('size-buttons');
  container.innerHTML = '';
  const stockMap = itemData[selected.category].stockMap;
  const sizeKeys = Object.keys(stockMap).filter(k => k.startsWith(type + '__'));

  sizeKeys.forEach(k => {
    const size = k.split('__')[1];
    const stock = stockMap[k];
    const btn = document.createElement('button');
    btn.innerText = `${size} (ì¬ê³ : ${stock})`;
    btn.onclick = () => {
      selected.size = size;
      updateSelection(container, btn);

      // âœ… ë‹¤ìŒ ì´ë™ ë²„íŠ¼ ê°•ì¡° + ìŠ¤í¬ë¡¤ + í¬ì»¤ìŠ¤
      const nextBtn = document.querySelector('#step-size .half-btn:nth-child(2)');
      nextBtn.classList.add('bounce', 'glow');
      nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      nextBtn.focus();
      setTimeout(() => nextBtn.classList.remove('bounce', 'glow'), 1200);
    };
    container.appendChild(btn);
  });

  showStep('size');
}




 function selectSize(size) {
  showStep('quantity');
  const quantityBox = document.querySelector('.numpad-container');
  if (quantityBox) {
    quantityBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // âœ… ê°•ì¡° ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    quantityBox.classList.add('glow');
    setTimeout(() => quantityBox.classList.remove('glow'), 1200);
  }

  document.getElementById("viewPhotos").style.display = "inline-block";
}



 function showStep(step) {
  ['category', 'type', 'size', 'quantity'].forEach(s => {
    document.getElementById('step-' + s).classList.add('hidden');
  });
  document.getElementById('step-' + step).classList.remove('hidden');

  // âœ… ëŒ€ë¶„ë¥˜ ë‹¨ê³„ì—ì„œë§Œ ë²„íŠ¼ ë³´ì´ê¸°
  const recordButtons = document.getElementById('record-buttons');
  if (step === 'category') {
    recordButtons.classList.remove('hidden');
  } else {
    recordButtons.classList.add('hidden');
  }
}


  function goBackTo(step) {
    showStep(step);
  }

  let itemList = [];

function addItemToList() {
  const quantity = quantityValue;
  const remarks = document.getElementById('remarks').value;

  if (!quantity || parseInt(quantity) <= 0) {
    alert("ì‹ ì²­ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const stockKey = `${selected.type}__${selected.size}`;
  const currentStock = parseInt(itemData[selected.category]?.stockMap?.[stockKey] || "0", 10);
  const requestedQty = parseInt(quantity, 10);

  const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(requestedQty, currentStock);
  const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(0, requestedQty - currentStock);

  // ğŸ”” ì¬ê³  ë¶€ì¡± ì•Œë¦¼
  if (êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ > 0) {
    if (currentStock > 0) {
      alert(`âš ï¸ í˜„ì¬ ${currentStock}ê°œë§Œ ì§€ê¸‰ ê°€ëŠ¥í•˜ë©°, ë‚˜ë¨¸ì§€ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œëŠ” êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
    } else {
      alert(`âš ï¸ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œ ì „ëŸ‰ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
    }
  }

  const item = {
    name: `${loginInfo.empId} ${loginInfo.empName}`,
    category: selected.category,
    subcategory: selected.type,
    size: selected.size,
    quantity: requestedQty,
    remarks
  };

  itemList.push(item);
  renderItemList();

  quantityValue = "";
  updateQuantityDisplay();
  document.getElementById('remarks').value = '';

  const listBox = document.querySelector('.list-preview-container');
  listBox.classList.add('glow');
  setTimeout(() => listBox.classList.remove('glow'), 1200);

  const submitBtn = document.querySelector("button[onclick='submitAllRequests()']");
  setTimeout(() => {
    submitBtn.classList.add('glow');
    setTimeout(() => submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
    setTimeout(() => submitBtn.classList.remove('glow'), 1200);
  }, 1300);
}




function renderItemList() {
  const previewContainer = document.getElementById('itemListPreview');
  previewContainer.innerHTML = '';

  if (itemList.length === 0) {
    const empty = document.createElement('div');
    empty.innerText = "â• í•­ëª©ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
    empty.style.textAlign = "center";
    empty.style.color = "#aaa";
    empty.style.padding = "1rem";
    previewContainer.appendChild(empty);
    return;
  }

  itemList.forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'list-item-row';

    const text = document.createElement('div');
    text.className = 'list-item-text';
    text.innerText = `${item.category} > ${item.subcategory} > ${item.size} - ${item.quantity}ê°œ`
      + (item.remarks ? ` (${item.remarks})` : '');

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.innerText = 'âœ•';
    delBtn.onclick = () => {
      itemList.splice(index, 1);
      renderItemList();
    };

    row.appendChild(text);
    row.appendChild(delBtn);
    previewContainer.appendChild(row);
  });
}




function resetSteps() {
  quantityValue = "";
  updateQuantityDisplay();
  document.getElementById('remarks').value = '';
  showStep('category');
}

async function submitAllRequests() {
  if (itemList.length === 0) {
    alert("ì‹ ì²­ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… í™”ë©´ ì¤‘ì•™ ë¡œë”© í‘œì‹œ
  document.getElementById('submitOverlay').style.display = 'flex';

  try {
    for (const item of itemList) {
      const stockKey = `${item.subcategory}__${item.size}`;
      const stockMap = itemData[item.category]?.stockMap || {};
      const currentStock = parseInt(stockMap[stockKey]) || 0;
      const quantity = parseInt(item.quantity);
      const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(quantity, currentStock);
      const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(quantity - currentStock, 0);

      const payload = {
        name: item.name,
        category: item.category,
        subcategory: item.subcategory,
        size: item.size,
        quantity,
        remarks: item.remarks,
        ì§€ê¸‰ìˆ˜ëŸ‰,
        êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰
      };

      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(payload)
      });
    }

    alert("âœ… ëª¨ë“  í•­ëª©ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
    location.reload();
  } catch (error) {
    alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
  } finally {
    // âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
    document.getElementById('submitOverlay').style.display = 'none';
  }
}





let quantityValue = "";





function appendQuantity(num) {
  if (quantityValue.length < 4) {
    quantityValue += num;
    updateQuantityDisplay();

    // âœ… í‚¤íŒ¨ë“œ í…Œë‘ë¦¬ ì œê±°
    document.querySelector('.numpad-container').classList.remove('glow');

    // âœ… í•­ëª©ì¶”ê°€ ë²„íŠ¼ ê°•ì¡°
    const addBtn = document.querySelector("button[onclick='addItemToList()']");
    addBtn.classList.add('glow');
    setTimeout(() => addBtn.classList.remove('glow'), 1200);
  }
}



function clearQuantity() {
  quantityValue = "";
  updateQuantityDisplay();
}

function backspaceQuantity() {
  quantityValue = quantityValue.slice(0, -1);
  updateQuantityDisplay();
}
// ğŸ”½ í•­ëª© ì‚¬ì§„ ë³´ê¸° ë²„íŠ¼ ë™ì‘
document.getElementById("viewPhotosType").addEventListener("click", () => {
  const category = selected.category;
  if (!category) {
    alert("ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  // âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
  document.getElementById("loadingOverlay").style.display = "flex";

  fetch("https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec?mode=photo")
    .then(res => res.json())
    .then(photoMap => {
      const urls = photoMap[category];
      const container = document.getElementById("photoContent");
      container.innerHTML = "";

      if (!urls || urls.length === 0) {
        container.innerHTML = "<p>í•´ë‹¹ í•­ëª©ì˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      } else {
        urls.forEach(url => {
          const fileName = url.split("/").pop().split(".")[0];
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "20px";
          wrapper.innerHTML = `
            <div style="font-weight:bold;margin-bottom:5px;">${fileName}</div>
            <img src="${url}" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" />
          `;
          container.appendChild(wrapper);
        });
      }

      // âœ… ì‚¬ì§„ í‘œì‹œ í›„ ëª¨ë‹¬ ì—´ê¸°
      document.getElementById("photoModal").style.display = "block";
    })
    .catch(err => {
      alert("âŒ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
    })
    .finally(() => {
      // âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ ë‹«ê¸°
      document.getElementById("loadingOverlay").style.display = "none";
    });
});




// ğŸ”½ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("photoModal").style.display = "none";
});

function goToTypeStep() {
  if (!selected.category) {
    alert("ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  selectCategory(selected.category);
}
function goToSizeStep() {
  if (!selected.type) {
    alert("ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  selectType(selected.type);
}
function goToQuantityStep() {
  if (!selected.size) {
    alert("ì†Œë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  selectSize(selected.size);
}

document.addEventListener("DOMContentLoaded", () => {
  const box = document.getElementById("inlineNoticeBox");
  const loading = document.getElementById("initialLoadingOverlay");

  // ê³µì§€ì‚¬í•­ fetch
  fetch("https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec?mode=notice")
    .then(res => res.json())
    .then(data => {
      const notice = data.notice?.trim();
      if (notice) {
        box.textContent = notice;
        box.style.display = "block";  // âœ… ê³µì§€ ë°•ìŠ¤ í‘œì‹œ
      }
    })
    .catch(err => {
      console.warn("ê³µì§€ì‚¬í•­ ë¡œë”© ì‹¤íŒ¨:", err);
      // ì‹¤íŒ¨í•´ë„ ê·¸ëƒ¥ ë„˜ì–´ê°
    })
    .finally(() => {
      loading.style.display = 'none';  // âœ… ì˜¤ë²„ë ˆì´ ì œê±°
    });
});

function openMyRecords() {
  const empId = loginInfo.empId;
  document.getElementById('loadingOverlay').style.display = 'flex';

  fetch(`${endpoint}?mode=myrecords&empId=${encodeURIComponent(empId)}`)
    .then(res => res.json())
    .then(data => {
      if (data.result !== "success") {
        document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ë¨¼ì € ë„ê³ 
        alert("âŒ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10, 8]);
    })
    .catch(err => {
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ì˜¤ë¥˜ ì‹œë„ ë¯¸ë¦¬ ë„ê¸°
      alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
    })
    .finally(() => {
      // ì´ê±´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì˜ë¯¸ê°€ ìˆìŒ. ì´ë¯¸ ë„ê³  return í–ˆìœ¼ë©´ ì¤‘ë³µë˜ë”ë¼ë„ ë¬´í•´.
      document.getElementById('loadingOverlay').style.display = 'none';
    });
}


function openTeamRecords() {
  const empId = loginInfo.empId;
  document.getElementById('loadingOverlay').style.display = 'flex'; // âœ… ë¡œë”© í‘œì‹œ

  fetch(`${endpoint}?mode=teamrecords&empId=${encodeURIComponent(empId)}`)
    .then(res => res.json())
    .then(data => {
      if (data.result === "forbidden") {
        document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ë¨¼ì € ë„ê³ 
        alert("âš ï¸ íŒ€ ë‚´ì—­ ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      if (data.result !== "success") {
        document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ë¨¼ì € ë„ê³ 
        alert("âŒ íŒ€ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10]); // âœ… ì •ìƒ í‘œì‹œ
    })
    .catch(err => {
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ë¨¼ì € ë„ê³ 
      alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
    })
    .finally(() => {
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… ë¡œë”© ë§ˆë¬´ë¦¬
    });
}



function renderRecordsTable(data, colIndexes) {
  const thead = document.querySelector("#myRecordsTable thead");
  const tbody = document.querySelector("#myRecordsTable tbody");
  thead.innerHTML = "<tr>" + colIndexes.map(i =>
    `<th style="border:1px solid #ccc; background:#f0f0f0; padding:4px; text-align:center;">${data.header[i]}</th>`
  ).join("") + "</tr>";

  tbody.innerHTML = data.records.map(row => {
    return "<tr>" + colIndexes.map(i =>
      `<td style="border:1px solid #ccc; padding:6px; text-align:center;">${i === 0 ? formatDate(row[i]) : row[i]}</td>`
    ).join("") + "</tr>";
  }).join("");

  document.getElementById("myRecordsModal").style.display = "flex";
}

function closeMyRecords() {
  document.getElementById("myRecordsModal").style.display = "none";
}

function formatDate(raw) {
  const d = new Date(raw);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}


function updateQuantityDisplay() {
  document.getElementById("quantity-display").innerText = quantityValue || "0";
}


function updateSelection(container, selectedBtn) {
  Array.from(container.children).forEach(btn => btn.classList.remove('selected'));
  selectedBtn.classList.add('selected');

  // ğŸ”½ ë‹¤ìŒ ë²„íŠ¼ ê°•ì¡°
  const nextBtn = document.getElementById('goToTypeBtn');
  if (nextBtn) {
    nextBtn.classList.add('pulse');
    setTimeout(() => nextBtn.classList.remove('pulse'), 1000);
  }
}

</script>
<!-- âœ… ì‹ ì²­ ì¤‘ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="submitOverlay">
  <span>ğŸ“¤ ì‹ ì²­ ì¤‘ì…ë‹ˆë‹¤...</span>
</div>
<div id="loadingOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-size: 1.4rem;
">
  â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
</div>

</body>
</html>
