<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>자재 신청</title>
  <style>
  body {
    font-family: 'sans-serif';
    background: #f7f7f7;
    text-align: center;
    padding: 1rem;
    margin: 0;
  }

  .hidden { display: none; }
  .step { margin-top: 1.5rem; }

  .button-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  button {
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background-color: #ddd;
    cursor: pointer;
    width: 70%;
    max-width: 300px;
  }

  button:hover {
    background-color: #4CAF50 !important;
    color: white;
  }

  .selected {
    background-color: #4CAF50 !important;
    color: white;
    font-weight: bold;
  }

  button:disabled {
    background-color: #ccc;
    color: #777;
    cursor: not-allowed;
  }

  /* 수량 표시 */
  #quantity-display {
    font-size: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
  }
#viewPhotos,
#goToTypeBtn {
  display: none;
}


  /* 수량 입력 - 키패드 + 리스트 영역 */
  .quantity-flex-wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1.5rem;
    margin: 2rem 0;
  }

  .numpad-container,
  .list-preview-container {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    flex: 1 1 300px;
    max-width: 400px;
    min-width: 280px;
  }

  .numpad-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.6rem;
    margin-top: 1rem;
  }

  .numpad-grid button {
    padding: 1rem;
    font-size: 1.5rem;
    border-radius: 10px;
    background: #e0e0e0;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }

  .numpad-grid button:hover {
    background: #ccc;
  }

  /* 비고 입력 */
  #remarks {
    display: block;
    margin: 1.5rem auto 1rem auto;
    padding: 0.6rem;
    font-size: 1rem;
    width: 80%;
    max-width: 300px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  /* 하단 버튼 정리 */
  .step button {
    margin: 0.25rem;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    background: #ddd;
    cursor: pointer;
  }

  .step button:hover {
    background: #4CAF50;
    color: white;
  }

  button.back-btn {
    margin-top: 1.5rem;
  }

  /* 로딩 메시지들 */
  #loadingText,
  #loginLoadingText,
  #submitLoadingText {
    margin-top: 1rem;
    font-size: 1.1rem;
    color: #444;
  }
#submitOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#submitOverlay span {
  background: white;
  padding: 20px 40px;
  border-radius: 12px;
  font-size: 1.3rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}


  /* 입력 필드 기본 스타일 */
  input {
    padding: 0.5rem;
    font-size: 1rem;
    margin: 0.5rem auto;
    width: 80%;
    max-width: 300px;
    display: block;
  }

  /* 리스트 영역 */
  .list-preview-container {
    max-height: 300px;
    overflow-y: auto;
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 10px;
    font-size: 0.95rem;
  }

  .list-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid #e0e0e0;
  }

  .list-item-text {
    flex: 1;
    text-align: left;
    word-break: break-word;
    padding-right: 0.5rem;
  }

 .delete-btn {
  font-size: 0.8rem;
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  width: 22px;
  height: 22px;
  display: flex;               /* 중요! 중앙 정렬 */
  align-items: center;         /* 수직 정렬 */
  justify-content: center;     /* 수평 정렬 */
  border-radius: 50%;
  transition: background 0.2s;
  padding: 0;                  /* 안쪽 여백 제거 */
  box-sizing: border-box;
}

.delete-btn:hover {
  background: #ffe5e5;
  color: #d00;
}

.button-row {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 1rem auto;
  flex-wrap: wrap;
}

.half-btn {
  flex: 1 1 30%;
  max-width: 180px;
  min-width: 140px;
  padding: 0.6rem 0.8rem;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  background: #ddd;
  cursor: pointer;
}

.half-btn:hover {
  background: #4CAF50;
  color: white;
}

</style>

</head>
<body>
<!-- 최상단에 위치 -->
<div id="initialLoadingOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-size: 1.4rem;
">
  ⏳ 로딩 중입니다...
</div>
<!-- ✅ 기존 위치 (맨 아래)에서 이쪽으로 이동 -->
<div id="loadingOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-size: 1.4rem;
">
  ⏳ 로딩 중입니다...
</div>


<h2 id="title">🔐 로그인</h2>

<!-- 로그인 영역 -->
<div id="login-section">
<!-- ✅ 공지사항 영역 -->
  <div id="inlineNoticeBox" style="
    background: #fff3cd;
    border: 1px solid #ffeeba;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    color: #856404;
    font-size: 0.9rem;
    display: none;
    white-space: pre-wrap;
  "></div>

  

  <p>사번과 이름을 입력하세요</p>

  <input id="empId" placeholder="사번" />
  <input id="empName" placeholder="이름" />

  <button onclick="handleLogin()">로그인</button>
  <div id="loginMsg"></div>

  <div id="loginLoadingText" class="hidden">🔐 로그인 중입니다...</div>
</div>


<!-- 신청 폼 시작 -->
<div id="form-section" class="hidden">

  <!-- 대분류 선택 영역 -->
<div id="step-category" class="step">
  <h3>1단계: 대분류 선택</h3>
  <div id="category-buttons" class="button-list"></div>
<!-- 대분류용 항목 사진 보기 버튼 -->
<button type="button" id="viewPhotosCategory"
    style="background:#007bff;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:6px;">
    항목 사진 보기
</button>

  

  <!-- ✅ 다음 단계 이동 버튼 추가 위치 여기!! -->
  <button type="button" id="goToTypeBtn" onclick="goToTypeStep()" style="margin-top: 8px;">
  ➡ 다음 이동
</button>
</div>

<div id="photoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999;overflow:auto;">
  <div style="background:white;margin:40px auto;padding:20px;border-radius:10px;max-width:600px;">
    <span id="closeModal" style="position:fixed;top:20px;right:20px;font-size:28px;cursor:pointer;z-index:1000;background:white;padding:4px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">✖</span>
    <div id="photoContent"></div>
  </div>
</div>


  <div id="step-type" class="step hidden">
  <h3>2단계: 중분류 선택</h3>
  <div id="type-buttons" class="button-list"></div>
  
  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('category')">⬅ 뒤로가기</button>
    <button class="half-btn" onclick="goToSizeStep()">➡ 다음 이동</button>
  </div>
</div>



  <div id="step-size" class="step hidden">
  <h3>3단계: 소분류 선택</h3>
  <div id="size-buttons" class="button-list"></div>

  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('type')">⬅ 뒤로가기</button>
    <button class="half-btn" onclick="goToQuantityStep()">➡ 다음 이동</button>
  </div>
</div>


<div id="step-quantity" class="step hidden">
  <h3>4단계: 수량 입력</h3>

  <!-- 숫자 키패드 -->
  <div class="numpad-container" style="margin: 0 auto;">
    <div id="quantity-display">0</div>
    <div id="numpad" class="numpad-grid">
      <button onclick="appendQuantity('1')">1</button>
      <button onclick="appendQuantity('2')">2</button>
      <button onclick="appendQuantity('3')">3</button>
      <button onclick="appendQuantity('4')">4</button>
      <button onclick="appendQuantity('5')">5</button>
      <button onclick="appendQuantity('6')">6</button>
      <button onclick="appendQuantity('7')">7</button>
      <button onclick="appendQuantity('8')">8</button>
      <button onclick="appendQuantity('9')">9</button>
      <button onclick="clearQuantity()">C</button>
      <button onclick="appendQuantity('0')">0</button>
      <button onclick="backspaceQuantity()">←</button>
    </div>
  </div>

    <!-- 비고 입력 -->
  <input id="remarks" placeholder="비고 (선택)" />

  
  <!-- 항목 추가 버튼 -->
  <div class="button-row">
    <button class="half-btn" onclick="addItemToList()">➕ 항목 추가</button>
  </div>


  <!-- 추가된 항목 리스트 -->
  <div class="list-preview-container" style="margin: 0 auto; text-align: center;">
  <ul id="itemListPreview" style="display: inline-block; text-align: left; font-size: 0.9rem;"></ul>
</div>


  <!-- 전체 신청 -->
  <div class="button-row">
    <button class="half-btn" onclick="submitAllRequests()">✅ 전체 신청</button>
  </div>

  <!-- 다른 물품 추가 -->
  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('category')">📦 다른 물품 추가</button>
  </div>

  <!-- 뒤로가기 -->
  <div class="button-row">
    <button class="half-btn" onclick="goBackTo('size')">⬅ 뒤로가기</button>
  </div>
</div>



<!-- ✅ 선택된 항목 리스트 표시 -->
<div id="selectedItems" class="step hidden">
  <h3>📝 선택된 항목 리스트</h3>
  <ul id="itemListDisplay"></ul>
</div>




<script>
  const endpoint = 'https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec'; // 실제 Web App 주소로 교체

  let loginInfo = { empId: '', empName: '' };
  let itemData = {};
  let selected = { category: '', type: '', size: '' };

  function handleLogin() {
  const empId = document.getElementById('empId').value.trim();
  const empName = document.getElementById('empName').value.trim();
  if (!empId || !empName) return alert("사번과 이름을 입력해주세요.");

  // ✅ 로그인 중 문구 표시
  document.getElementById('loginLoadingText').classList.remove('hidden');

  // ✅ 로그인 버튼 숨기기
  document.querySelector('#login-section button').style.display = 'none';

  fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ empId, empName })
  })
  .then(res => res.json())
  .then(data => {
    // ✅ 로딩 문구 숨김
    document.getElementById('loginLoadingText').classList.add('hidden');

    if (data.result === 'success') {
      loginInfo = { empId, empName };
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('form-section').classList.remove('hidden');
      document.getElementById('title').innerText = "📦 자재 신청";

      document.getElementById('loadingOverlay').style.display = 'flex';

      loadItems();
    } else {
      document.getElementById('loginMsg').innerText = '로그인 실패 또는 권한 없음';
      // ✅ 실패 시 버튼 다시 보이게
      document.querySelector('#login-section button').style.display = 'block';
    }
  })
  .catch(error => {
    document.getElementById('loginLoadingText').classList.add('hidden');
    document.getElementById('loginMsg').innerText = '서버 오류: ' + error.message;
    // ✅ 오류 시 버튼 다시 보이게
    document.querySelector('#login-section button').style.display = 'block';
  });
}


function loadItems() {
  fetch(endpoint)
    .then(res => res.json())
    .then(data => {
      itemData = data;
      const container = document.getElementById('category-buttons');
      container.innerHTML = '';

      Object.keys(data).forEach(cat => {
        const btn = document.createElement('button');
        btn.innerText = cat;
        btn.onclick = () => {
          selected.category = cat;
          updateSelection(container, btn);
        };
        container.appendChild(btn);
      });

      document.getElementById('goToTypeBtn').style.display = 'inline-block';

      // ✅ ✅ ✅ 이 시점에만 로딩 오버레이를 끄세요
      document.getElementById('loadingOverlay').style.display = 'none';
    })
    .catch(error => {
      document.getElementById('loadingOverlay').style.display = 'none'; // 실패해도 꺼야 함
      alert('❌ 항목 목록 불러오기 실패: ' + error.message);
    });
}




 function selectCategory(cat) {
  const types = itemData[cat].types;
  const container = document.getElementById('type-buttons');
  container.innerHTML = '';
  types.forEach(type => {
    const btn = document.createElement('button');
    btn.innerText = type;
    btn.onclick = () => {
      selected.type = type;
      updateSelection(container, btn);
      // 다음 단계는 버튼으로 진행
    };
    container.appendChild(btn);
  });
  showStep('type');
}


  function selectType(type) {
    const container = document.getElementById('size-buttons');
    container.innerHTML = '';
    const stockMap = itemData[selected.category].stockMap;
    const sizeKeys = Object.keys(stockMap).filter(k => k.startsWith(type + '__'));
    sizeKeys.forEach(k => {
      const size = k.split('__')[1];
      const stock = stockMap[k];
      const btn = document.createElement('button');
      btn.innerText = `${size} (재고: ${stock})`;
      btn.onclick = () => {
        selected.size = size;
        updateSelection(container, btn);
              };
      container.appendChild(btn);
    });
    showStep('size');
  }

  function selectSize(size) {
  showStep('quantity');
  document.getElementById("viewPhotos").style.display = "inline-block"; // ✅ 여기 추가
}


  function showStep(step) {
    ['category', 'type', 'size', 'quantity'].forEach(s => {
      document.getElementById('step-' + s).classList.add('hidden');
    });
    document.getElementById('step-' + step).classList.remove('hidden');
  }

  function goBackTo(step) {
    showStep(step);
  }

  function updateSelection(container, selectedBtn) {
    Array.from(container.children).forEach(btn => btn.classList.remove('selected'));
    selectedBtn.classList.add('selected');
  }

  let itemList = [];

function addItemToList() {
  const quantity = quantityValue;
  const remarks = document.getElementById('remarks').value;

  if (!quantity || parseInt(quantity) <= 0) {
    alert("신청 수량을 입력해주세요.");
    return;
  }

  const item = {
    name: `${loginInfo.empId} ${loginInfo.empName}`,
    category: selected.category,
    subcategory: selected.type,
    size: selected.size,
    quantity,
    remarks
  };

  itemList.push(item);
  renderItemList();

  // ✅ 수량, 비고 입력만 초기화 (화면은 유지)
  quantityValue = "";
  updateQuantityDisplay();
  document.getElementById('remarks').value = '';
}


function renderItemList() {
  const previewContainer = document.getElementById('itemListPreview');
  previewContainer.innerHTML = '';

  if (itemList.length === 0) {
    const empty = document.createElement('div');
    empty.innerText = "➕ 항목을 추가하면 여기에 표시됩니다.";
    empty.style.textAlign = "center";
    empty.style.color = "#aaa";
    empty.style.padding = "1rem";
    previewContainer.appendChild(empty);
    return;
  }

  itemList.forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'list-item-row';

    const text = document.createElement('div');
    text.className = 'list-item-text';
    text.innerText = `${item.category} > ${item.subcategory} > ${item.size} - ${item.quantity}개`
      + (item.remarks ? ` (${item.remarks})` : '');

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.innerText = '✕';
    delBtn.onclick = () => {
      itemList.splice(index, 1);
      renderItemList();
    };

    row.appendChild(text);
    row.appendChild(delBtn);
    previewContainer.appendChild(row);
  });
}




function resetSteps() {
  quantityValue = "";
  updateQuantityDisplay();
  document.getElementById('remarks').value = '';
  showStep('category');
}

async function submitAllRequests() {
  if (itemList.length === 0) {
    alert("신청 항목이 없습니다.");
    return;
  }

  // ✅ 화면 중앙 로딩 표시
  document.getElementById('submitOverlay').style.display = 'flex';

  try {
    for (const item of itemList) {
      const stockKey = `${item.subcategory}__${item.size}`;
      const stockMap = itemData[item.category]?.stockMap || {};
      const currentStock = parseInt(stockMap[stockKey]) || 0;
      const quantity = parseInt(item.quantity);
      const 지급수량 = Math.min(quantity, currentStock);
      const 구매요청수량 = Math.max(quantity - currentStock, 0);

      const payload = {
        name: item.name,
        category: item.category,
        subcategory: item.subcategory,
        size: item.size,
        quantity,
        remarks: item.remarks,
        지급수량,
        구매요청수량
      };

      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(payload)
      });
    }

    alert("✅ 모든 항목이 신청되었습니다.");
    location.reload();
  } catch (error) {
    alert("❌ 네트워크 오류: " + error.message);
  } finally {
    // ✅ 로딩 오버레이 숨김
    document.getElementById('submitOverlay').style.display = 'none';
  }
}





let quantityValue = "";

function updateQuantityDisplay() {
  document.getElementById("quantity-display").innerText = quantityValue || "0";
}

function appendQuantity(num) {
  if (quantityValue.length < 4) {
    quantityValue += num;
    updateQuantityDisplay();
  }
}

function clearQuantity() {
  quantityValue = "";
  updateQuantityDisplay();
}

function backspaceQuantity() {
  quantityValue = quantityValue.slice(0, -1);
  updateQuantityDisplay();
}
// 🔽 항목 사진 보기 버튼 동작
document.getElementById("viewPhotosCategory").addEventListener("click", () => {
  const category = selected.category;
  if (!category) {
    alert("먼저 항목 분류를 선택해주세요.");
    return;
  }

  fetch("https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec?mode=photo")
    .then(res => res.json())
    .then(photoMap => {
      const urls = photoMap[category];
      const container = document.getElementById("photoContent");
      container.innerHTML = "";

      if (!urls || urls.length === 0) {
        container.innerHTML = "<p>해당 항목의 사진이 없습니다.</p>";
      } else {
        urls.forEach(url => {
          const fileName = url.split("/").pop().split(".")[0];
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "20px";
          wrapper.innerHTML = `
            <div style="font-weight:bold;margin-bottom:5px;">${fileName}</div>
            <img src="${url}" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" />
          `;
          container.appendChild(wrapper);
        });
      }

      document.getElementById("photoModal").style.display = "block";
    });
});


// 🔽 모달 닫기 버튼
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("photoModal").style.display = "none";
});

function goToTypeStep() {
  if (!selected.category) {
    alert("대분류를 먼저 선택해주세요.");
    return;
  }
  selectCategory(selected.category);
}
function goToSizeStep() {
  if (!selected.type) {
    alert("중분류를 선택해주세요.");
    return;
  }
  selectType(selected.type);
}
function goToQuantityStep() {
  if (!selected.size) {
    alert("소분류를 선택해주세요.");
    return;
  }
  selectSize(selected.size);
}

document.addEventListener("DOMContentLoaded", () => {
  const box = document.getElementById("inlineNoticeBox");
  const loading = document.getElementById("initialLoadingOverlay");

  // 공지사항 fetch
  fetch("https://script.google.com/macros/s/AKfycbwyHAXzsq1MXMLEe3HCD11FBqWG6awZlktuKcIOR2CPDNru-GcShGKoMT564PpB_6so/exec?mode=notice")
    .then(res => res.json())
    .then(data => {
      const notice = data.notice?.trim();
      if (notice) {
        box.textContent = notice;
        box.style.display = "block";  // ✅ 공지 박스 표시
      }
    })
    .catch(err => {
      console.warn("공지사항 로딩 실패:", err);
      // 실패해도 그냥 넘어감
    })
    .finally(() => {
      loading.style.display = 'none';  // ✅ 오버레이 제거
    });
});


</script>
<!-- ✅ 신청 중 로딩 오버레이 -->
<div id="submitOverlay">
  <span>📤 신청 중입니다...</span>
</div>
<div id="loadingOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-size: 1.4rem;
">
  ⏳ 로딩 중입니다...
</div>

</body>
</html>
