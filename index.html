<!-- HTML 파일 (GitHub Pages용) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>자재창고 신청 (Google 로그인)</title>
  <style>
    form { display: flex; flex-direction: column; gap: 12px; max-width: 320px; margin: 20px auto; font-family: Arial; }
    label { font-weight: bold; }
    select, input, textarea { padding: 6px 8px; font-size: 14px; }
    textarea { resize: vertical; min-height: 60px; }
    button { padding: 10px; font-size: 16px; cursor: pointer; }
    .message { margin-top: 10px; font-weight: bold; color: green; }
    #login-box { text-align: center; margin-top: 20px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="login-box">
    <div id="g_id_onload"
         data-client_id="159728592887-b8hpip80pqk30qlj6eur2kf1l86nuhrr.apps.googleusercontent.com"
         data-login_uri="https://script.google.com/macros/s/AKfycbxG80T2GYLXADjDEIHCIdZhFpvHuElUJGBeLD16n71YVbwUtJ1U4oEyKmFP-qLEahj-/exec"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <form id="materialForm" style="display: none;">
    <label for="category">물품 종류</label>
    <select id="category" name="category" required><option value="">-- 선택하세요 --</option></select>

    <label for="subcategory">세부 종류</label>
    <select id="subcategory" name="subcategory" required><option value="">-- 선택하세요 --</option></select>

    <label for="size">사이즈</label>
    <select id="size" name="size" required><option value="">-- 선택하세요 --</option></select>

    <label for="name">이름</label>
    <input type="text" id="name" name="name" placeholder="이름을 입력하세요" required />

    <label for="quantity">수량</label>
    <input type="number" id="quantity" name="quantity" min="1" required />

    <label for="remarks">비고</label>
    <textarea id="remarks" name="remarks" placeholder="비고를 입력하세요 (없을 경우 생략)" rows="4"></textarea>

    <button type="submit">신청</button>
    <div class="message" id="msg"></div>
  </form>

<script>
let userEmail = "";
function handleCredentialResponse(response) {
  const token = response.credential;
  fetch("https://script.google.com/macros/s/AKfycbxG80T2GYLXADjDEIHCIdZhFpvHuElUJGBeLD16n71YVbwUtJ1U4oEyKmFP-qLEahj-/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token })
  })
  .then(res => res.json())
  .then(data => {
    if (data.email) {
      userEmail = data.email;
      document.getElementById("login-box").style.display = "none";
      document.getElementById("materialForm").style.display = "block";
      loadItems();
    } else {
      alert("인증 실패");
    }
  });
}

const categorySelect = document.getElementById("category");
const subSelect = document.getElementById("subcategory");
const sizeSelect = document.getElementById("size");
const msgDiv = document.getElementById("msg");

let items = {};

function loadItems() {
  fetch("https://script.google.com/macros/s/AKfycbxG80T2GYLXADjDEIHCIdZhFpvHuElUJGBeLD16n71YVbwUtJ1U4oEyKmFP-qLEahj-/exec")
    .then(res => res.json())
    .then(data => {
      items = data;
      populateCategory();
    });
}

function populateCategory() {
  categorySelect.innerHTML = '<option value="">-- 선택하세요 --</option>';
  Object.keys(items).forEach(cat => {
    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}

categorySelect.addEventListener("change", () => {
  const cat = categorySelect.value;
  subSelect.innerHTML = "<option value=''>-- 선택하세요 --</option>";
  sizeSelect.innerHTML = "<option value=''>-- 선택하세요 --</option>";
  if (items[cat]) {
    items[cat].types.forEach(type => {
      subSelect.innerHTML += `<option value="${type}">${type}</option>`;
    });
  }
});

subSelect.addEventListener("change", () => {
  const cat = categorySelect.value;
  const type = subSelect.value;
  sizeSelect.innerHTML = "<option value=''>-- 선택하세요 --</option>";
  const stockMap = items[cat].stockMap;
  Object.entries(stockMap).forEach(([key, stock]) => {
    const [t, size] = key.split("__");
    if (t === type) {
      const label = `${size} (재고: ${stock === 0 ? "X" : stock})`;
      sizeSelect.innerHTML += `<option value="${size}" data-stock="${stock}">${label}</option>`;
    }
  });
});

sizeSelect.addEventListener("change", () => {
  const stock = parseInt(sizeSelect.selectedOptions[0]?.dataset.stock || 0);
  msgDiv.textContent = stock === 0 ? "⚠️ 재고 없음, 구매 요청으로 처리됩니다." : "";
});

document.getElementById("materialForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const selectedStock = parseInt(sizeSelect.selectedOptions[0]?.dataset.stock || 0);
  const remarksInput = document.getElementById("remarks");
  if (selectedStock === 0 && !remarksInput.value.includes("구매 요청")) {
    remarksInput.value += (remarksInput.value ? " / " : "") + "구매 요청";
  }
  formData.append("email", userEmail);
  fetch("https://script.google.com/macros/s/AKfycbxG80T2GYLXADjDEIHCIdZhFpvHuElUJGBeLD16n71YVbwUtJ1U4oEyKmFP-qLEahj-/exec", {
    method: "POST",
    body: new URLSearchParams(formData)
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert("✅ 신청 완료");
      this.reset();
    } else {
      alert("❌ 오류 발생");
    }
  });
});
</script>
</body>
</html>
