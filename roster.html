<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>연휴 출근 조사</title>

<style>
:root { --primary:#2563eb; --bg:#f3f4f6; --text:#111827; --card:#fff; --muted:#6b7280; }
body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); }
.wrap { max-width:760px; margin:0 auto; padding:18px 14px 40px; }
.card { background:var(--card); border-radius:16px; padding:18px; box-shadow:0 4px 18px rgba(0,0,0,.08); }
h1 { font-size:20px; margin:0 0 8px; }
.desc { white-space:pre-wrap; color:var(--muted); line-height:1.4; margin-bottom:14px; }
label { font-size:13px; color:var(--muted); display:block; margin:14px 0 6px; }
input, select, textarea, button {
  width:100%; border-radius:12px; border:1px solid #e5e7eb;
  padding:12px; font-size:14px; box-sizing:border-box;
}
textarea { min-height:90px; resize:vertical; }
.dateRow { border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0; background:#fff; }
.dateTop { display:flex; align-items:center; gap:10px; }
.dateText { font-weight:800; }
.shiftBox { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; padding-left:28px; }
.shiftItem { display:flex; align-items:center; gap:6px; opacity:.45; }
.shiftItem.enabled { opacity:1; }
button { background:var(--primary); color:#fff; border:none; font-weight:900; cursor:pointer; margin-top:16px; }
button:disabled { opacity:.5; cursor:not-allowed; }
.status { margin-top:12px; font-size:13px; color:var(--muted); white-space:pre-wrap; }
.ok { color:#047857; font-weight:800; }
.err { color:#b91c1c; font-weight:800; }
#submitFrame { width:0; height:0; border:0; position:absolute; left:-9999px; top:-9999px; }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">연휴 출근 조사</h1>
    <div class="desc" id="desc"></div>

    <label>부서</label>
    <select id="deptSelect">
      <option value="">부서를 선택하세요</option>
    </select>

    <label>이름</label>
    <input type="text" id="nameInput" placeholder="이름을 입력하세요" />

    <label>날짜 선택 (날짜 체크 → 오전/오후/야간 선택 가능)</label>
    <div id="dateList"></div>

    <label>업무내용 (공통)</label>
    <textarea id="commonWork" placeholder="업무내용을 입력하세요 (공통)"></textarea>

    <button id="submitBtn">제출</button>
    <div class="status" id="status"></div>
  </div>
</div>

<iframe id="submitFrame" name="submitFrame"></iframe>
<form id="submitForm" method="POST" target="submitFrame" style="display:none;">
  <input type="hidden" name="payload" id="payloadField" />
</form>

<script>
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxh-dbfkDt1kVgMv5GW8zPWoaSDJOpBV37Zxsdr8d137ihrUo4SYgj110FApwiIAOs/exec";

const elTitle = document.getElementById("title");
const elDesc = document.getElementById("desc");
const elDept = document.getElementById("deptSelect");
const elName = document.getElementById("nameInput");
const elList = document.getElementById("dateList");
const elWork = document.getElementById("commonWork");
const elBtn = document.getElementById("submitBtn");
const elStatus = document.getElementById("status");

const submitForm = document.getElementById("submitForm");
const payloadField = document.getElementById("payloadField");
const submitFrame = document.getElementById("submitFrame");

function setStatus(msg, type){
  elStatus.className="status";
  if(type==="ok") elStatus.classList.add("ok");
  if(type==="err") elStatus.classList.add("err");
  elStatus.textContent = msg || "";
}

/* JSONP 설정 로딩 */
function loadConfigJSONP(){
  setStatus("설정 불러오는 중...");
  const cb="cfg_"+Date.now();
  window[cb]=(json)=>{
    try{
      if(!json.ok) throw new Error(json.error);
      elTitle.textContent=json.title||"연휴 출근 조사";
      elDesc.textContent=json.desc||"";

      elDept.innerHTML=`<option value="">부서를 선택하세요</option>`;
      json.depts.forEach(d=>{
        const o=document.createElement("option");
        o.value=d; o.textContent=d;
        elDept.appendChild(o);
      });

      elList.innerHTML="";
      json.dates.forEach(dt=>elList.appendChild(createDateRow(dt)));
      setStatus("");
    }catch(e){
      setStatus(e.message,"err");
    }
    delete window[cb];
  };
  const s=document.createElement("script");
  s.src=`${GAS_WEBAPP_URL}?mode=config&callback=${cb}&_ts=${Date.now()}`;
  s.onerror=()=>setStatus("설정 로딩 실패","err");
  document.head.appendChild(s);
}

/* 날짜 UI */
function createDateRow(date){
  const w=document.createElement("div"); w.className="dateRow"; w.dataset.date=date;
  const top=document.createElement("div"); top.className="dateTop";
  const dchk=document.createElement("input"); dchk.type="checkbox";
  const txt=document.createElement("div"); txt.className="dateText"; txt.textContent=date;
  top.appendChild(dchk); top.appendChild(txt);

  const box=document.createElement("div"); box.className="shiftBox";
  ["오전","오후","야간"].forEach(s=>{
    const l=document.createElement("label"); l.className="shiftItem";
    const c=document.createElement("input"); c.type="checkbox"; c.value=s; c.disabled=true;
    l.appendChild(c); l.appendChild(document.createTextNode(s));
    box.appendChild(l);
  });

  dchk.onchange=()=>{
    box.querySelectorAll("input").forEach(c=>{ c.disabled=!dchk.checked; if(!dchk.checked) c.checked=false; });
    box.querySelectorAll(".shiftItem").forEach(i=>i.classList.toggle("enabled",dchk.checked));
  };

  w.appendChild(top); w.appendChild(box);
  return w;
}

/* 제출 */
function submit(){
  try{
    if(!elDept.value) throw new Error("부서를 선택하세요.");
    if(!elName.value.trim()) throw new Error("이름을 입력하세요.");

    const items=[];
    document.querySelectorAll(".dateRow").forEach(r=>{
      if(!r.querySelector("input[type=checkbox]").checked) return;
      const shifts=[...r.querySelectorAll(".shiftBox input:checked")].map(c=>c.value);
      if(shifts.length===0) throw new Error(`${r.dataset.date} 구분 선택 필요`);
      items.push({date:r.dataset.date, shifts});
    });
    if(items.length===0) throw new Error("날짜를 선택하세요.");

    payloadField.value=JSON.stringify({
      dept:elDept.value,
      name:elName.value.trim(),
      work:elWork.value.trim(),
      items,
      userAgent:navigator.userAgent
    });

    submitForm.action=GAS_WEBAPP_URL;
    submitForm.submit();
    setStatus("제출 완료 ✅","ok");
  }catch(e){
    setStatus(e.message,"err");
  }
}

elBtn.onclick=submit;
loadConfigJSONP();
</script>
</body>
</html>
