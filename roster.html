<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>연휴 출근 조사</title>
  <style>
    :root { --primary:#2563eb; --bg:#f3f4f6; --text:#111827; --card:#fff; --muted:#6b7280; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:760px; margin:0 auto; padding:18px 14px 40px; }
    .card { background:var(--card); border-radius:16px; padding:18px; box-shadow:0 4px 18px rgba(0,0,0,.08); }
    h1 { font-size:20px; margin:0 0 8px; }
    .desc { white-space:pre-wrap; color:var(--muted); line-height:1.4; margin-bottom:14px; }
    label { font-size:13px; color:var(--muted); display:block; margin:14px 0 6px; }
    select, textarea, button { width:100%; border-radius:12px; border:1px solid #e5e7eb; padding:12px; font-size:14px; box-sizing:border-box; }
    textarea { min-height:90px; resize:vertical; }
    .dateRow { border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0; background:#fff; }
    .dateTop { display:flex; align-items:center; gap:10px; }
    .dateText { font-weight:800; }
    .shiftBox { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; padding-left:28px; }
    .shiftItem { display:flex; align-items:center; gap:6px; opacity:.45; }
    .shiftItem.enabled { opacity:1; }
    .workBox { margin-top:10px; padding-left:28px; opacity:.45; }
    .workBox.enabled { opacity:1; }
    .mini { font-size:12px; color:var(--muted); margin-top:6px; }
    button { background:var(--primary); color:#fff; border:none; font-weight:900; cursor:pointer; margin-top:16px; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .status { margin-top:12px; font-size:13px; color:var(--muted); white-space:pre-wrap; }
    .ok { color:#047857; font-weight:800; }
    .err { color:#b91c1c; font-weight:800; }

    /* iframe 숨김 */
    #submitFrame { width:0; height:0; border:0; position:absolute; left:-9999px; top:-9999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">연휴 출근 조사</h1>
      <div class="desc" id="desc"></div>

      <label>부서</label>
      <select id="deptSelect">
        <option value="">부서를 선택하세요</option>
      </select>

      <label>날짜 선택 (먼저 날짜 체크 → 해당 날짜의 오전/오후/야간 선택 가능)</label>
      <div id="dateList"></div>

      <div class="mini">※ 업무내용은 날짜별로 다르게 적어도 되고, 비워도 됩니다.</div>

      <button id="submitBtn">제출</button>
      <div class="status" id="status"></div>
    </div>
  </div>

  <!-- ✅ CORS 회피: iframe + form submit -->
  <iframe id="submitFrame" name="submitFrame"></iframe>
  <form id="submitForm" method="POST" target="submitFrame" style="display:none;">
    <input type="hidden" name="payload" id="payloadField" />
  </form>

<script>
  // ✅ 네 GAS 웹앱 /exec URL로 교체
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxQhM5PcXpUTrh5k7enmu8S73XRSWqRU7TSGmxJSD5KQ5TfznghRUe7rJDI9Bdb-ccr/exec";

  const elTitle = document.getElementById("title");
  const elDesc  = document.getElementById("desc");
  const elDept  = document.getElementById("deptSelect");
  const elList  = document.getElementById("dateList");
  const elBtn   = document.getElementById("submitBtn");
  const elStatus= document.getElementById("status");

  const submitForm   = document.getElementById("submitForm");
  const payloadField = document.getElementById("payloadField");
  const submitFrame  = document.getElementById("submitFrame");

  let CONFIG = null;
  let submitInFlight = false;
  let submitTimer = null;

  function setStatus(msg, type) {
    elStatus.className = "status";
    if (type === "ok") elStatus.classList.add("ok");
    if (type === "err") elStatus.classList.add("err");
    elStatus.textContent = msg || "";
  }

  // ---------- JSONP 로 config 로딩 ----------
  function loadConfigJSONP() {
    setStatus("설정 불러오는 중...");
    const cbName = "__cfg_cb_" + Date.now();
    window[cbName] = function(json) {
      try {
        if (!json || !json.ok) throw new Error((json && json.error) ? json.error : "config load failed");
        CONFIG = json;

        elTitle.textContent = json.title || "연휴 출근 조사";
        elDesc.textContent  = json.desc || "";

        // 부서
        elDept.innerHTML = `<option value="">부서를 선택하세요</option>`;
        (json.depts || []).forEach(d => {
          const opt = document.createElement("option");
          opt.value = d; opt.textContent = d;
          elDept.appendChild(opt);
        });

        // 날짜
        elList.innerHTML = "";
        (json.dates || []).forEach(dt => elList.appendChild(createDateRow(dt)));

        setStatus("");
      } catch (e) {
        setStatus("설정 로딩 실패:\n" + (e?.message || e), "err");
      } finally {
        // cleanup
        try { delete window[cbName]; } catch(_) {}
      }
    };

    const s = document.createElement("script");
    s.src = `${GAS_WEBAPP_URL}?mode=config&callback=${encodeURIComponent(cbName)}&_ts=${Date.now()}`;
    s.onerror = () => setStatus("설정 로딩 실패:\n네트워크 또는 배포 URL 확인 필요", "err");
    document.head.appendChild(s);
  }

  // ---------- UI 생성 ----------
  function createDateRow(dateStr) {
    const wrap = document.createElement("div");
    wrap.className = "dateRow";
    wrap.dataset.date = dateStr;

    const top = document.createElement("div");
    top.className = "dateTop";

    const dateChk = document.createElement("input");
    dateChk.type = "checkbox";
    dateChk.className = "dateChk";

    const dateText = document.createElement("div");
    dateText.className = "dateText";
    dateText.textContent = dateStr;

    top.appendChild(dateChk);
    top.appendChild(dateText);

    const shiftBox = document.createElement("div");
    shiftBox.className = "shiftBox";

    ["오전","오후","야간"].forEach(s => {
      const item = document.createElement("label");
      item.className = "shiftItem";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "shiftChk";
      chk.value = s;
      chk.disabled = true;

      const t = document.createElement("span");
      t.textContent = s;

      item.appendChild(chk);
      item.appendChild(t);
      shiftBox.appendChild(item);
    });

    const workBox = document.createElement("div");
    workBox.className = "workBox";

    const workInput = document.createElement("textarea");
    workInput.className = "workInput";
    workInput.placeholder = "업무내용(자유 서술) - 이 날짜에 해당하는 내용";
    workInput.disabled = true;

    workBox.appendChild(workInput);

    dateChk.addEventListener("change", () => {
      const enabled = dateChk.checked;

      shiftBox.querySelectorAll(".shiftChk").forEach(chk => {
        chk.disabled = !enabled;
        if (!enabled) chk.checked = false;
      });
      shiftBox.querySelectorAll(".shiftItem").forEach(lab => {
        lab.classList.toggle("enabled", enabled);
      });

      workInput.disabled = !enabled;
      if (!enabled) workInput.value = "";
      workBox.classList.toggle("enabled", enabled);
    });

    wrap.appendChild(top);
    wrap.appendChild(shiftBox);
    wrap.appendChild(workBox);
    return wrap;
  }

  // ---------- payload 수집 ----------
  function collectPayload() {
    const dept = (elDept.value || "").trim();
    if (!dept) throw new Error("부서를 선택하세요.");

    const items = [];
    elList.querySelectorAll(".dateRow").forEach(row => {
      const date = row.dataset.date;
      const dateChecked = row.querySelector(".dateChk").checked;
      if (!dateChecked) return;

      const shifts = Array.from(row.querySelectorAll(".shiftChk"))
        .filter(c => c.checked)
        .map(c => c.value);

      if (shifts.length === 0) throw new Error(`${date} 날짜의 구분(오전/오후/야간)을 최소 1개 선택하세요.`);

      const work = (row.querySelector(".workInput").value || "").trim();
      items.push({ date, shifts, work });
    });

    if (items.length === 0) throw new Error("날짜를 최소 1개 선택하세요.");

    return {
      dept,
      items,
      userAgent: navigator.userAgent
    };
  }

  // ---------- 제출 (iframe + form) ----------
  function submitViaForm() {
    if (submitInFlight) return;

    try {
      setStatus("");
      elBtn.disabled = true;

      const payload = collectPayload();

      // 폼 action 지정
      submitForm.action = GAS_WEBAPP_URL;

      // hidden field에 JSON string 저장
      payloadField.value = JSON.stringify(payload);

      submitInFlight = true;
      setStatus("제출 중...");

      // iframe load 이벤트로 성공 판정 (CORS 영향 없음)
      const onLoad = () => {
        submitFrame.removeEventListener("load", onLoad);

        // 너무 빠른 로드(캐시/중간페이지) 대비 최소 지연
        clearTimeout(submitTimer);
        submitTimer = setTimeout(() => {
          submitInFlight = false;
          elBtn.disabled = false;

          setStatus("제출 완료 ✅ (저장됨)", "ok");

          // 초기화(원하면 제거)
          elDept.value = "";
          elList.querySelectorAll(".dateRow").forEach(row => {
            const d = row.querySelector(".dateChk");
            d.checked = false;
            d.dispatchEvent(new Event("change"));
          });
        }, 150);
      };

      submitFrame.addEventListener("load", onLoad);

      // 실제 전송
      submitForm.submit();

      // 혹시 iframe load가 안 잡히는 특수 케이스 대비 타임아웃(전송은 되었을 가능성이 큼)
      clearTimeout(submitTimer);
      submitTimer = setTimeout(() => {
        if (!submitInFlight) return;
        submitInFlight = false;
        elBtn.disabled = false;
        setStatus("제출은 전송됨. (네트워크 환경상 완료 확인이 지연될 수 있음)\n시트 저장 여부를 확인하세요.", "ok");
      }, 6000);

    } catch (err) {
      submitInFlight = false;
      elBtn.disabled = false;
      setStatus("제출 실패:\n" + (err?.message || err), "err");
    }
  }

  elBtn.addEventListener("click", submitViaForm);
  loadConfigJSONP();
</script>
</body>
</html>
