<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>연휴 출근 취합</title>
  <style>
    /* (기존 CSS와 동일하되 모바일 가독성을 위해 폰트 크기 유지) */
    :root { --primary: #2563eb; --bg: #f3f4f6; --text: #1f2937; }
    body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
    .wrap { max-width: 600px; margin: 0 auto; padding: 15px; }
    .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { font-size: 20px; margin-bottom: 10px; }
    .desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
    .input-group { margin-bottom: 15px; }
    label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
    .date-card { border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
    .shift-container { display: flex; gap: 8px; margin-top: 10px; padding-left: 30px; }
    .shift-chip { padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; cursor: pointer; }
    .shift-chip.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn { width: 100%; padding: 15px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 20px; }
    .status { text-align: center; margin-top: 10px; font-size: 12px; color: #888; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1 id="pageTitle">데이터 로딩 중...</h1>
    <p class="desc" id="pageDesc">잠시만 기다려 주세요.</p>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;" class="input-group">
      <div><label>사업장</label><select id="site"><option>시화</option><option>반월</option><option>대양</option></select></div>
      <div><label>성명</label><input id="name" type="text" placeholder="이름" /></div>
    </div>

    <div class="input-group">
      <label>부서</label>
      <select id="dept"><option value="">로딩 중...</option></select>
    </div>

    <div id="dateList"></div>

    <div class="input-group" style="margin-top:15px;">
      <label>업무내용</label>
      <textarea id="work" rows="2"></textarea>
    </div>

    <button class="btn" id="submitBtn">제출하기</button>
    <div class="status" id="status"></div>
  </div>
</div>

<script>
  // ★ 본인의 최신 배포 URL로 교체하세요 ★
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyN7e4o-tHYtQZojAzWJ0C2ck6Qx-rdRvBHhXfGj1xwqsh9VKxFWY9baJncLEWtcI6x/exec";

  function callGAS(params) {
    return new Promise((resolve, reject) => {
      const callbackName = 'cb_' + Math.random().toString(36).substring(7);
      const script = document.createElement('script');
      
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("응답 시간 초과 (네트워크 상태 확인)"));
      }, 20000);

      window[callbackName] = (res) => {
        cleanup();
        resolve(res);
      };

      function cleanup() {
        clearTimeout(timeout);
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[callbackName];
      }

      const qs = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
      script.src = `${GAS_URL}?callback=${callbackName}&${qs}&ts=${Date.now()}`;
      
      // 모바일 에러 핸들링 강화
      script.onerror = () => {
        cleanup();
        reject(new Error("스크립트 로드 실패. (GAS 배포 설정에서 '액세스 권한: 모든 사용자'인지 확인하세요)"));
      };
      
      document.body.appendChild(script);
    });
  }

  async function init() {
    try {
      const res = await callGAS({ action: 'settings' });
      if (!res.ok) throw new Error(res.error);

      document.getElementById('pageTitle').innerText = res.title || "연휴 출근 조사";
      document.getElementById('pageDesc').innerText = res.desc || "";
      
      const depts = [...new Set(res.rows.map(r => r.dept))].filter(Boolean);
      document.getElementById('dept').innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');

      const dates = [...new Set(res.rows.map(r => r.date))].sort();
      document.getElementById('dateList').innerHTML = dates.map((d, i) => `
        <div class="date-card">
          <label style="display:flex; align-items:center;">
            <input type="checkbox" id="chk_${i}" data-date="${d}" style="width:20px; height:20px; margin-right:10px;" onchange="document.getElementById('shift_${i}').style.display = this.checked ? 'flex' : 'none'">
            ${d}
          </label>
          <div class="shift-container" id="shift_${i}" style="display:none;">
            ${['오전','오후','야간'].map(s => `<div class="shift-chip" onclick="this.classList.toggle('selected')">${s}</div>`).join('')}
          </div>
        </div>
      `).join('');
    } catch (e) {
      alert(e.message);
      document.getElementById('status').innerText = "에러: " + e.message;
    }
  }

  document.getElementById('submitBtn').onclick = async () => {
    const name = document.getElementById('name').value.trim();
    const dept = document.getElementById('dept').value;
    if (!name || !dept) return alert("성함과 부서를 입력하세요.");

    const selections = [];
    document.querySelectorAll('#dateList .date-card').forEach(card => {
      const chk = card.querySelector('input[type="checkbox"]');
      if (chk.checked) {
        const shifts = Array.from(card.querySelectorAll('.shift-chip.selected')).map(el => el.innerText);
        if (shifts.length > 0) selections.push({ date: chk.dataset.date, shifts });
      }
    });

    if (selections.length === 0) return alert("날짜와 근무 시간을 선택하세요.");

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    document.getElementById('status').innerText = "제출 중...";

    try {
      const payload = {
        site: document.getElementById('site').value,
        name, dept, work: document.getElementById('work').value,
        selections
      };
      const res = await callGAS({ action: 'submit', payload: encodeURIComponent(JSON.stringify(payload)) });
      if (res.ok) {
        alert("제출 완료!");
        location.reload();
      } else throw new Error(res.error);
    } catch (e) {
      alert(e.message);
      btn.disabled = false;
      document.getElementById('status').innerText = "제출 실패";
    }
  };

  init();
</script>
</body>
</html>
