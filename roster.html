<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연휴 출근 취합</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; margin:0; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 14px; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .desc { font-size: 12px; color:#4b5563; white-space: pre-wrap; line-height: 1.5; }

    label { display:block; font-size: 13px; margin-top: 10px; color:#111827; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box;
      padding: 10px; border:1px solid #d1d5db; border-radius: 10px;
      font-size: 14px; background:#fff;
    }
    textarea { resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint { font-size:12px; color:#6b7280; margin-top:8px; white-space: pre-wrap; line-height: 1.5; }
    .hr { height:1px; background:#eef2f7; margin: 12px 0; }

    .summaryBox {
      margin-top: 10px; border: 1px solid #e5e7eb; background: #f9fafb;
      border-radius: 12px; padding: 10px 12px; font-size: 12px; color: #374151;
      line-height: 1.5; white-space: pre-wrap;
    }
    .summaryBox b { color:#111827; }
    .summaryEmpty { color:#6b7280; }

    .dateList { margin-top: 10px; display:flex; flex-direction: column; gap: 10px; }
    .dateCard { border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; background:#fff; transition: background .15s ease, border-color .15s ease; }
    .dateCard.active { border-color: #2563eb; background: #eff6ff; }

    .dateTop { display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .dateTop input { width: 18px; height: 18px; margin:0; }
    .dateTitle { font-weight: 700; font-size: 14px; }

    .chips { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip { display:flex; align-items:center; gap:8px; padding: 8px 10px; border:1px solid #e5e7eb; border-radius: 10px; background:#fff; cursor:pointer; transition: border-color .15s ease, background .15s ease; }
    .chip input { width: 18px; height: 18px; margin:0; padding:0; }
    .chip span { font-size: 13px; }

    .chip.checked { border-color:#2563eb; background:#dbeafe; }
    .chip.checked span { font-weight: 700; color:#111827; }

    .btn { margin-top: 12px; background:#2563eb; color:#fff; border:none; cursor:pointer; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }

    .overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(17,24,39,0.35); z-index: 9999; padding: 24px; }
    .overlay.show { display: flex; }
    .overlayCard {
      width: min(360px, 92vw); background: #fff; border: 1px solid #e5e7eb; border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18); padding: 16px 16px 14px; text-align: center;
    }
    .spinner { width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: #2563eb; border-radius: 999px; margin: 0 auto 10px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlayTitle { font-weight: 800; font-size: 15px; color:#111827; }
    .overlayDesc { margin-top: 6px; font-size: 12px; color:#4b5563; line-height: 1.4; white-space: pre-wrap; }

    .radioGrid { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .radioItem { width:auto; display:flex; align-items:center; gap:8px; padding: 8px 10px; border:1px solid #e5e7eb; border-radius: 10px; background:#fff; cursor:pointer; user-select:none; }
    .radioItem input { width: 18px; height: 18px; margin:0; padding:0; }

    /* ✅ 목록 화면 */
    .listHeader { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border:1px solid #e5e7eb; border-radius: 999px; font-size: 12px; color:#374151; background:#f9fafb; }
    .formList { margin-top: 10px; display:flex; flex-direction: column; gap: 10px; }
    .formItem {
      border:1px solid #e5e7eb; border-radius: 12px; padding: 12px;
      background:#fff; cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .formItem:hover { border-color:#93c5fd; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    .formTitle { font-weight: 800; font-size: 14px; color:#111827; }
    .formNote  { margin-top:6px; font-size:12px; color:#6b7280; white-space: pre-wrap; line-height: 1.4; }
    .formMeta  { margin-top:8px; font-size:11px; color:#9ca3af; }
    .topActions { margin-top: 10px; display:flex; gap:10px; }
    .btnGhost { background:#fff; color:#111827; border:1px solid #d1d5db; cursor:pointer; }
    .btnSmall { padding: 10px; font-size: 13px; border-radius: 10px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <div class="overlay" id="overlay">
    <div class="overlayCard">
      <div class="spinner"></div>
      <div class="overlayTitle" id="overlayTitle">로딩중…</div>
      <div class="overlayDesc" id="overlayDesc">잠시만 기다려 주세요.</div>
    </div>
  </div>

  <div class="wrap">

    <!-- ✅ 1) 목록 화면 -->
    <div class="card" id="screenList">
      <div class="listHeader">
        <div>
          <h1 style="margin:0;">설문 목록</h1>
          <div class="desc" id="listDesc" style="margin-top:6px;">진행 중인 설문을 선택하세요.</div>
        </div>
        <div class="pill" id="listCountPill">0건</div>
      </div>

      <div class="topActions">
        <button class="btn btnSmall" id="btnReloadList" type="button">목록 새로고침</button>
      </div>

      <div class="formList" id="formList">
        <div class="hint">불러오는 중…</div>
      </div>

      <div class="hint" id="listStatus"></div>
    </div>

    <!-- ✅ 2) 설문 화면(기존 화면) -->
    <div class="card hidden" id="screenForm">
      <div class="topActions" style="margin-top:0; margin-bottom:8px;">
        <button class="btnGhost btnSmall" id="btnBackToList" type="button">← 목록으로</button>
      </div>

      <h1 id="pageTitle">불러오는 중…</h1>
      <div class="desc" id="pageDesc"></div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label id="siteLabel">구분(사업장)</label>
          <select id="site"><option value="">불러오는 중…</option></select>
        </div>
        <div>
          <label>성명</label>
          <input id="name" type="text" placeholder="이름" autocomplete="name" />
        </div>
      </div>

      <label id="deptLabel">부서</label>
      <div id="deptContainer"><div class="hint">불러오는 중…</div></div>

      <div class="hr"></div>

      <label id="dateShiftLabel">날짜별 구분 선택</label>
      <div class="hint" id="dateShiftHint">※ 날짜/구분을 선택하세요.</div>

      <div class="summaryBox" id="selectionSummary">
        <span class="summaryEmpty">아직 선택된 항목이 없습니다.</span>
      </div>

      <div class="dateList" id="dateList">
        <div class="hint">데이터를 불러오는 중…</div>
      </div>

      <label style="margin-top:14px;">업무내용(자유기입)</label>
      <textarea id="work" rows="3" placeholder="예: 공정점검, 안전 점검 등"></textarea>

      <button class="btn" id="submitBtn" type="button">제출</button>
      <div class="hint" id="status"></div>
    </div>

  </div>

  <script>
  // ✅ 멀티 설문: list → settings(no) → submitOne(no)
  var GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbyCp8dr9jbqV4BtzWiSP3VtdRdcrM3iUgKP3kHUqv4SUrp_SoXCa104Rb-PtuG6-ZCa/exec";

  // 선택된 설문 no
  var CURRENT_NO = "";
  var SETTINGS = {};

  // 상태: dateOnMap[date]=true/false, selectedMap["date|shift"]=true/false
  var dateOnMap = {};
  var selectedMap = {};

  function showOverlay(title, desc) {
    document.getElementById("overlayTitle").textContent = title || "로딩중…";
    document.getElementById("overlayDesc").textContent  = desc  || "잠시만 기다려 주세요.";
    document.getElementById("overlay").classList.add("show");
  }
  function hideOverlay() {
    document.getElementById("overlay").classList.remove("show");
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, function (m) {
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]);
    });
  }

  function buildQuery(obj) {
    var parts = [];
    for (var k in obj) {
      if (!obj.hasOwnProperty(k)) continue;
      parts.push(encodeURIComponent(k) + "=" + encodeURIComponent(String(obj[k] == null ? "" : obj[k])));
    }
    return parts.join("&");
  }

  function jsonpCall(url, cbPrefix, timeoutMs) {
    return new Promise(function (resolve, reject) {
      var cbName = (cbPrefix || "cb") + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      var done = false, timer = null, scriptEl = null;

      function cleanup() {
        if (timer) { clearTimeout(timer); timer = null; }
        if (scriptEl && scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl);
        scriptEl = null;
        try { delete window[cbName]; } catch (e) { window[cbName] = undefined; }
      }

      window[cbName] = function (res) {
        if (done) return;
        done = true; cleanup();
        resolve(res);
      };

      timer = setTimeout(function () {
        if (done) return;
        done = true; cleanup();
        reject(new Error("타임아웃(콜백 없음)"));
      }, timeoutMs || 12000);

      scriptEl = document.createElement("script");
      scriptEl.async = true;
      scriptEl.src = url + (url.indexOf("?") >= 0 ? "&" : "?") +
        "callback=" + encodeURIComponent(cbName) +
        "&ts=" + Date.now();

      scriptEl.onerror = function () {
        if (done) return;
        done = true; cleanup();
        reject(new Error("JSONP script 로드 실패"));
      };

      document.body.appendChild(scriptEl);
    });
  }

  function formatKoreanDate(ymd) {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return ymd || "";
    var parts = ymd.split("-");
    var y = parseInt(parts[0], 10);
    var m = parseInt(parts[1], 10);
    var d = parseInt(parts[2], 10);
    var dt = new Date(y, m - 1, d);
    var w = ["일","월","화","수","목","금","토"][dt.getDay()];
    return y + "년 " + m + "월 " + d + "일(" + w + ")";
  }

  function keyOf(date, shift) { return String(date||"") + "|" + String(shift||""); }

  function clearSelectionsForDate(date) {
    var prefix = String(date || "") + "|";
    for (var k in selectedMap) {
      if (Object.prototype.hasOwnProperty.call(selectedMap, k) && k.indexOf(prefix) === 0) delete selectedMap[k];
    }
  }

  function hasAnyShiftForDate(date) {
    var prefix = String(date || "") + "|";
    for (var k in selectedMap) {
      if (Object.prototype.hasOwnProperty.call(selectedMap, k) && k.indexOf(prefix) === 0) return true;
    }
    return false;
  }

  function applyChipCheckedClass(inputEl) {
    var chip = inputEl ? inputEl.closest(".chip") : null;
    if (!chip) return;
    if (inputEl.checked) chip.classList.add("checked");
    else chip.classList.remove("checked");
  }

  function setCardActiveState(card) {
    if (!card) return;
    var date = card.getAttribute("data-date") || "";
    var on = !!dateOnMap[date] || hasAnyShiftForDate(date);
    if (on) card.classList.add("active");
    else card.classList.remove("active");
  }

  function enableChipsByDate(card, enabled) {
    var chips = card ? card.querySelector(".chips") : null;
    if (!chips) return;

    if (enabled) {
      chips.style.opacity = "1";
      chips.style.pointerEvents = "auto";
    } else {
      var date = card.getAttribute("data-date") || "";
      clearSelectionsForDate(date);

      var inputs = chips.querySelectorAll('input');
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].checked = false;
        applyChipCheckedClass(inputs[i]);
      }
      chips.style.opacity = ".5";
      chips.style.pointerEvents = "none";
    }
  }

  function updateSelectionSummary() {
    var box = document.getElementById("selectionSummary");
    var lines = [];
    var dates = Object.keys(dateOnMap).filter(function(d){ return !!dateOnMap[d]; });

    // ✅ dates는 "설정 순서" 유지: SETTINGS.dates 기준으로 정렬
    if (SETTINGS && Array.isArray(SETTINGS.dates) && SETTINGS.dates.length) {
      dates.sort(function(a,b){
        return SETTINGS.dates.indexOf(a) - SETTINGS.dates.indexOf(b);
      });
    } else {
      dates.sort();
    }

    for (var i = 0; i < dates.length; i++) {
      var date = dates[i];
      var prefix = date + "|";
      var shifts = [];

      for (var k in selectedMap) {
        if (Object.prototype.hasOwnProperty.call(selectedMap, k) && k.indexOf(prefix) === 0) {
          shifts.push(k.split("|")[1] || "");
        }
      }

      // shift도 "설정 순서" 유지
      if (SETTINGS && Array.isArray(SETTINGS.shifts) && SETTINGS.shifts.length) {
        shifts.sort(function(a,b){
          return SETTINGS.shifts.indexOf(a) - SETTINGS.shifts.indexOf(b);
        });
      } else {
        shifts.sort();
      }

      if (shifts.length > 0) lines.push("- " + formatKoreanDate(date) + " : " + shifts.join(", "));
      else lines.push("- " + formatKoreanDate(date) + " : (구분 미선택)");
    }

    if (lines.length === 0) box.innerHTML = '<span class="summaryEmpty">아직 선택된 항목이 없습니다.</span>';
    else box.innerHTML = "<b>선택됨</b>\n" + lines.join("\n");
  }

  function applyDomFromState_() {
    var cards = document.querySelectorAll("#dateList .dateCard");
    for (var c = 0; c < cards.length; c++) {
      var card = cards[c];
      var date = card.getAttribute("data-date") || "";
      var topInput = card.querySelector('.dateTop input');

      if (topInput) topInput.checked = !!dateOnMap[date];
      enableChipsByDate(card, !!dateOnMap[date]);
      setCardActiveState(card);
    }

    var inputs = document.querySelectorAll('#dateList .chips input');
    for (var i = 0; i < inputs.length; i++) {
      var el = inputs[i];
      var date2 = el.getAttribute("data-date") || "";
      var shift2 = el.value || "";
      var k2 = keyOf(date2, shift2);

      el.checked = !!selectedMap[k2];
      applyChipCheckedClass(el);
    }

    updateSelectionSummary();
  }

  // ---------- 동적 렌더: site / dept ----------
  function renderSite_(s) {
    var fields = s.fields || {};
    var label = (fields.siteLabel && fields.siteLabel.value) ? String(fields.siteLabel.value) : "구분(사업장)";
    document.getElementById("siteLabel").textContent = label;

    var sites = Array.isArray(s.sites) ? s.sites : [];
    var siteSel = document.getElementById("site");
    siteSel.innerHTML = sites.length
      ? ('<option value="">사업장 선택</option>' + sites.map(function(x){ return '<option value="' + escapeHtml(x) + '">' + escapeHtml(x) + '</option>'; }).join(""))
      : '<option value="">(사업장 설정 없음)</option>';
  }

  function renderDeptUI(settings) {
    var wrap = document.getElementById("deptContainer");
    if (!wrap) return;

    var fields = settings.fields || {};
    var deptField = fields.depts || { type:"dropdown", options:[] };
    var type = (deptField.type || "dropdown").toLowerCase();
    var options = Array.isArray(settings.depts) ? settings.depts : [];

    if (!options.length) {
      wrap.innerHTML = '<div class="hint">(설정에 부서가 없습니다)</div>';
      return;
    }

    if (type === "radio") {
      wrap.innerHTML =
        '<div class="radioGrid">' +
          options.map(function(opt, i){
            var id = "dept_r_" + i;
            return (
              '<label class="radioItem" for="' + escapeHtml(id) + '">' +
                '<input type="radio" name="dept" id="' + escapeHtml(id) + '" value="' + escapeHtml(opt) + '">' +
                '<span>' + escapeHtml(opt) + '</span>' +
              '</label>'
            );
          }).join("") +
        '</div>';
    } else {
      wrap.innerHTML =
        '<select id="deptSelect">' +
          '<option value="">부서를 선택하세요</option>' +
          options.map(function(opt){
            return '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>';
          }).join("") +
        '</select>';
    }
  }

  function getSelectedDept(settings) {
    var fields = settings.fields || {};
    var deptField = fields.depts || { type:"dropdown" };
    var type = (deptField.type || "dropdown").toLowerCase();

    if (type === "radio") {
      var checked = document.querySelector('input[name="dept"]:checked');
      return checked ? checked.value : "";
    } else {
      var sel = document.getElementById("deptSelect");
      return sel ? sel.value : "";
    }
  }

  // ---------- 핵심 UI ----------
  function buildUI(s) {
    var fields = s.fields || {};
    var datesField  = fields.dates  || { type:"checklist" };
    var shiftsField = fields.shifts || { type:"checklist" };

    var datesType  = String(datesField.type  || "checklist").toLowerCase(); // radio | checklist
    var shiftsType = String(shiftsField.type || "checklist").toLowerCase(); // radio | checklist

    var dates  = Array.isArray(s.dates)  ? s.dates  : [];
    var shifts = Array.isArray(s.shifts) ? s.shifts : ["오전","오후","야간"];

    renderSite_(s);
    renderDeptUI(s);

    document.getElementById("dateShiftHint").textContent =
      "※ 날짜는 " + (datesType === "radio" ? "1개만" : "여러 개") +
      " 선택 가능 / 구분은 " + (shiftsType === "radio" ? "1개만" : "여러 개") +
      " 선택 가능합니다.";

    var box = document.getElementById("dateList");
    if (!dates.length) {
      box.innerHTML = '<div class="hint">날짜 데이터가 없습니다. (설정 시트 dates 확인)</div>';
      return;
    }

    box.innerHTML = dates.map(function (ymd, idx) {
      var idBase = "d_" + idx;
      var title = formatKoreanDate(ymd);

      var dateInputType = (datesType === "radio") ? "radio" : "checkbox";
      var dateNameAttr  = (datesType === "radio") ? ' name="datePick" ' : "";

      var shiftHtml = shifts.map(function (sh) {
        var inputType = (shiftsType === "radio") ? "radio" : "checkbox";
        var nameAttr  = (shiftsType === "radio") ? (' name="shift_' + escapeHtml(ymd) + '" ') : "";
        return (
          '<label class="chip">' +
            '<input type="' + inputType + '" ' + nameAttr +
                   'value="' + escapeHtml(sh) + '" data-date="' + escapeHtml(ymd) + '">' +
            '<span>' + escapeHtml(sh) + '</span>' +
          '</label>'
        );
      }).join("");

      return (
        '<div class="dateCard" data-date="' + escapeHtml(ymd) + '">' +
          '<div class="dateTop">' +
            '<input type="' + dateInputType + '" ' + dateNameAttr +
                   'id="' + idBase + '_on" data-date="' + escapeHtml(ymd) + '">' +
            '<div class="dateTitle">' + escapeHtml(title) + '</div>' +
          '</div>' +
          '<div class="chips" id="' + idBase + '_shifts" style="opacity:.5; pointer-events:none;">' +
            shiftHtml +
          '</div>' +
        '</div>'
      );
    }).join("");

    dateOnMap = {};
    selectedMap = {};
    applyDomFromState_();
  }

  function submitOneViaJsonp(params) {
    var url = GAS_EXEC_URL + "?" + buildQuery({
      action: "submitOne",
      no:    CURRENT_NO,
      site:  params.site  || "",
      name:  params.name  || "",
      dept:  params.dept  || "",
      work:  params.work  || "",
      date:  params.date  || "",
      shift: params.shift || ""
    });
    return jsonpCall(url, "cb_one", 12000);
  }

  function sleep(ms) { return new Promise(function (r) { setTimeout(r, ms); }); }

  function collectJobsOrAlert_() {
    var onDates = Object.keys(dateOnMap).filter(function(d){ return !!dateOnMap[d]; });

    if (onDates.length === 0) { alert("날짜를 먼저 선택하세요."); return null; }

    // ON된 날짜 중 shift 미선택이면 막음(기존 규칙 유지)
    var missing = [];
    for (var i = 0; i < onDates.length; i++) {
      if (!hasAnyShiftForDate(onDates[i])) missing.push(onDates[i]);
    }
    if (missing.length > 0) {
      alert(
        "아래 날짜는 '구분'이 선택되지 않았습니다.\n\n" +
        missing.map(function(d){ return "- " + formatKoreanDate(d); }).join("\n") +
        "\n\n해당 날짜의 구분을 선택한 뒤 제출해 주세요."
      );
      return null;
    }

    var keys = Object.keys(selectedMap);
    var jobs = [];
    for (var k = 0; k < keys.length; k++) {
      var p = keys[k].split("|");
      var date2 = p[0], shift2 = p[1];
      if (!dateOnMap[date2]) continue;
      jobs.push({ date: date2, shift: shift2 });
    }

    if (jobs.length === 0) { alert("구분을 선택하세요."); return null; }
    return jobs;
  }

  async function submitData() {
    if (!CURRENT_NO) { alert("설문 번호(no)가 없습니다. 목록에서 설문을 선택하세요."); return; }

    var site = document.getElementById("site").value.trim();
    var name = document.getElementById("name").value.trim();
    var dept = getSelectedDept(SETTINGS);
    var work = document.getElementById("work").value.trim();

    var btn = document.getElementById("submitBtn");
    var status = document.getElementById("status");

    if (!site || !name) { alert("사업장/성명을 입력하세요."); return; }
    if (!dept) { alert("부서를 선택하세요."); return; }

    var jobs = collectJobsOrAlert_();
    if (!jobs) return;

    btn.disabled = true;
    status.textContent = "";
    showOverlay("제출중…", "저장 중입니다.\n창을 닫지 말아 주세요.");

    try {
      for (var i = 0; i < jobs.length; i++) {
        document.getElementById("overlayDesc").textContent = "저장 중입니다.\n(" + (i+1) + "/" + jobs.length + ")";

        var res = await submitOneViaJsonp({
          site: site, name: name, dept: dept, work: work,
          date: jobs[i].date, shift: jobs[i].shift
        });

        if (!res || !res.ok) throw new Error(res && res.error ? res.error : "저장 실패");
        await sleep(120);
      }

      showOverlay("완료", "제출이 완료되었습니다.\n잠시 후 목록으로 돌아갑니다…");
      setTimeout(function(){
        // ✅ 제출 후: 목록 화면으로 복귀 + URL no 제거
        history.replaceState(null, "", location.pathname + "?ts=" + Date.now());
        showListScreen_();
        loadList_();
      }, 450);

    } catch (e) {
      hideOverlay();
      alert("오류: " + (e.message || e));
      status.textContent = "오류 발생";
    } finally {
      btn.disabled = false;
    }
  }

  document.getElementById("submitBtn").addEventListener("click", submitData);

  // 날짜/shift 선택 핸들러(완전 동적: checkbox/radio 모두 처리)
  document.addEventListener("change", function (ev) {
    var t = ev.target;
    if (!t) return;

    // 날짜 ON/OFF (radio/checkbox 모두)
    if (t.matches && t.matches('#dateList .dateTop input')) {
      var date = t.getAttribute("data-date") || "";

      // 날짜가 radio면: 다른 날짜 OFF 처리
      if (t.type === "radio") {
        dateOnMap = {};
        selectedMap = {};
      }

      dateOnMap[date] = !!t.checked;
      if (!t.checked) clearSelectionsForDate(date);
      applyDomFromState_();
      return;
    }

    // shift 선택(checkbox/radio 모두)
    if (t.matches && t.matches('#dateList .chips input')) {
      var date2 = t.getAttribute("data-date") || "";
      var shift2 = t.value || "";
      var k2 = keyOf(date2, shift2);

      if (!dateOnMap[date2]) {
        t.checked = false;
        applyChipCheckedClass(t);
        alert("날짜를 먼저 선택하세요.");
        return;
      }

      if (t.type === "radio") {
        clearSelectionsForDate(date2);
        if (t.checked) selectedMap[k2] = true;
      } else {
        if (t.checked) selectedMap[k2] = true;
        else delete selectedMap[k2];
      }

      applyDomFromState_();
      return;
    }
  });

  /* ==========================
   * ✅ 목록 화면 로직
   * ========================== */

  function showListScreen_() {
    document.getElementById("screenList").classList.remove("hidden");
    document.getElementById("screenForm").classList.add("hidden");
    CURRENT_NO = "";
    SETTINGS = {};
  }

  function showFormScreen_() {
    document.getElementById("screenList").classList.add("hidden");
    document.getElementById("screenForm").classList.remove("hidden");
  }

  function setListStatus_(msg) {
    document.getElementById("listStatus").textContent = msg || "";
  }

  function renderList_(list) {
    var wrap = document.getElementById("formList");
    var pill = document.getElementById("listCountPill");
    var n = Array.isArray(list) ? list.length : 0;
    pill.textContent = n + "건";

    if (!n) {
      wrap.innerHTML = '<div class="hint">진행 중인 설문이 없습니다. (목록 시트 enabled=Y 확인)</div>';
      return;
    }

    wrap.innerHTML = list.map(function(item){
      var no = String(item.no || "").trim();
      var title = String(item.title || "").trim();
      var note = String(item.note || "").trim();
      return (
        '<div class="formItem" role="button" tabindex="0" data-no="' + escapeHtml(no) + '">' +
          '<div class="formTitle">' + escapeHtml(title) + '</div>' +
          (note ? '<div class="formNote">' + escapeHtml(note) + '</div>' : '') +
          '<div class="formMeta">no: ' + escapeHtml(no) + '</div>' +
        '</div>'
      );
    }).join("");
  }

  function loadList_() {
    setListStatus_("");
    showOverlay("로딩중…", "설문 목록을 불러오는 중입니다…");

    var url = GAS_EXEC_URL + "?" + buildQuery({ action:"list" });
    jsonpCall(url, "cb_list", 12000).then(function(res){
      if (!res || !res.ok) throw new Error(res && res.error ? res.error : "list 응답 오류");
      renderList_(res.list || []);
      hideOverlay();
    }).catch(function(e){
      hideOverlay();
      setListStatus_("목록 불러오기 실패: " + (e.message || e));
      document.getElementById("formList").innerHTML =
        '<div class="hint">불러오기 실패: ' + escapeHtml(e.message || e) + '</div>';
    });
  }

  function loadSettingsByNo_(no) {
    CURRENT_NO = String(no || "").trim();
    if (!CURRENT_NO) { alert("no가 비었습니다."); return; }

    showOverlay("로딩중…", "설문을 불러오는 중입니다…");

    var url = GAS_EXEC_URL + "?" + buildQuery({ action:"settings", no: CURRENT_NO });
    jsonpCall(url, "cb_set", 12000).then(function(res){
      if (!res || !res.ok) throw new Error(res && res.error ? res.error : "settings 응답 오류");

      SETTINGS = res.settings || {};
      document.getElementById("pageTitle").textContent = (SETTINGS.title || "연휴 출근 조사");
      document.getElementById("pageDesc").textContent  = (SETTINGS.desc  || "");

      buildUI(SETTINGS);

      hideOverlay();
      showFormScreen_();

      // URL에 no 표시(선택)
      try {
        var q = new URLSearchParams(location.search);
        q.set("no", CURRENT_NO);
        history.replaceState(null, "", location.pathname + "?" + q.toString());
      } catch (e) {}
    }).catch(function(e){
      hideOverlay();
      alert("설문 불러오기 실패: " + (e.message || e));
    });
  }

  // 목록 클릭
  document.getElementById("formList").addEventListener("click", function(ev){
    var el = ev.target;
    var item = el && el.closest ? el.closest(".formItem") : null;
    if (!item) return;
    var no = item.getAttribute("data-no") || "";
    loadSettingsByNo_(no);
  });

  // 목록 새로고침
  document.getElementById("btnReloadList").addEventListener("click", function(){
    loadList_();
  });

  // 목록으로
  document.getElementById("btnBackToList").addEventListener("click", function(){
    showListScreen_();
    loadList_();
    try {
      var q = new URLSearchParams(location.search);
      q.delete("no");
      history.replaceState(null, "", location.pathname + (q.toString() ? ("?" + q.toString()) : ""));
    } catch (e) {}
  });

  // ✅ 초기 진입: URL ?no= 가 있으면 바로 설문 로딩, 없으면 목록
  (function init(){
    showListScreen_();

    var noParam = "";
    try {
      var q = new URLSearchParams(location.search);
      noParam = String(q.get("no") || "").trim();
    } catch (e) {}

    if (noParam) {
      loadSettingsByNo_(noParam);
    } else {
      loadList_();
    }
  })();

  </script>
</body>
</html>
