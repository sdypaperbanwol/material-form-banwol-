<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연휴 출근 취합</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; margin:0; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 14px; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .desc { font-size: 12px; color:#4b5563; white-space: pre-wrap; line-height: 1.5; }
    label { display:block; font-size: 13px; margin-top: 10px; color:#111827; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box;
      padding: 10px; border:1px solid #d1d5db; border-radius: 10px;
      font-size: 14px; background:#fff;
    }
    textarea { resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint { font-size:12px; color:#6b7280; margin-top:8px; white-space: pre-wrap; }
    .hr { height:1px; background:#eef2f7; margin: 12px 0; }
    .dateList { margin-top: 10px; display:flex; flex-direction: column; gap: 10px; }
    .dateCard { border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; background:#fff; }
    .dateTop { display:flex; align-items:center; gap:10px; }
    .dateTop input[type="checkbox"] { width: 18px; height: 18px; margin:0; }
    .dateTitle { font-weight: 700; font-size: 14px; }
    .chips { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip { display:flex; align-items:center; gap:8px; padding: 8px 10px; border:1px solid #e5e7eb; border-radius: 10px; background:#fff; }
    .chip input { width: 18px; height: 18px; margin:0; padding:0; }
    .chip span { font-size: 13px; }
    .btn { margin-top: 12px; background:#2563eb; color:#fff; border:none; cursor:pointer; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .smallbtn { margin-top: 10px; background:#111827; color:#fff; border:none; cursor:pointer; }
    .foot { margin-top:10px; font-size:11px; color:#9ca3af; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="pageTitle">불러오는 중…</h1>
      <div class="desc" id="pageDesc"></div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>구분(사업장)</label>
          <select id="site">
            <option value="시화">시화</option>
            <option value="반월">반월</option>
            <option value="대양">대양</option>
          </select>
        </div>
        <div>
          <label>성명</label>
          <input id="name" type="text" placeholder="이름" autocomplete="name" />
        </div>
      </div>

      <label>부서</label>
      <select id="dept">
        <option value="">불러오는 중…</option>
      </select>

      <div class="hr"></div>

      <label>날짜별 구분 선택</label>
      <div class="hint">※ 날짜를 체크하고, 그 날짜의 구분을 선택하세요.</div>
      <div class="dateList" id="dateList">
        <div class="hint">데이터를 불러오는 중…</div>
      </div>

      <label style="margin-top:14px;">업무내용(자유기입)</label>
      <textarea id="work" rows="3" placeholder="예: 공정점검, 안전 점검 등"></textarea>

      <button class="btn" id="submitBtn">제출</button>
      <div class="hint" id="status"></div>
      <div class="foot" id="ver"></div>
    </div>
  </div>

  <script>
    // ✅ 네 GAS 웹앱 exec URL로 교체 (반드시 /exec)
    var GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxJLZZHgCCUuB1FaHZ6SDKBgx9RkGfwMFG00GUQMIBCQdtMSeR2DfbbEA-USDRJCZ0H/exec";

    // ====== (인앱/구형 브라우저 대비) matches/closest 폴리필 ======
    (function () {
      if (!Element.prototype.matches) {
        Element.prototype.matches =
          Element.prototype.msMatchesSelector ||
          Element.prototype.webkitMatchesSelector ||
          function (s) {
            var matches = (this.document || this.ownerDocument).querySelectorAll(s);
            var i = matches.length;
            while (--i >= 0 && matches.item(i) !== this) {}
            return i > -1;
          };
      }
      if (!Element.prototype.closest) {
        Element.prototype.closest = function (s) {
          var el = this;
          while (el && el.nodeType === 1) {
            if (el.matches(s)) return el;
            el = el.parentElement || el.parentNode;
          }
          return null;
        };
      }
    })();

    // settings (GAS에서 내려오는 구조)
    var SETTINGS = null;

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, function (m) {
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]);
      });
    }

    // ✅ URLSearchParams 대신 수동 빌드(구형/인앱 대비)
    function buildQuery(obj) {
      var parts = [];
      for (var k in obj) {
        if (!obj.hasOwnProperty(k)) continue;
        parts.push(encodeURIComponent(k) + "=" + encodeURIComponent(String(obj[k] == null ? "" : obj[k])));
      }
      return parts.join("&");
    }

    // ✅ JSONP 공통 호출
    function jsonpCall(url, cbPrefix, timeoutMs) {
      return new Promise(function (resolve, reject) {
        var cbName = (cbPrefix || "cb") + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        var done = false;
        var timer = null;
        var scriptEl = null;

        function cleanup() {
          if (timer) { clearTimeout(timer); timer = null; }
          if (scriptEl && scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl);
          scriptEl = null;
          try { delete window[cbName]; } catch (e) { window[cbName] = undefined; }
        }

        window[cbName] = function (res) {
          if (done) return;
          done = true;
          cleanup();
          resolve(res);
        };

        timer = setTimeout(function () {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("타임아웃(콜백 없음)"));
        }, timeoutMs || 12000);

        scriptEl = document.createElement("script");
        scriptEl.async = true;
        scriptEl.src = url + (url.indexOf("?") >= 0 ? "&" : "?") +
          "callback=" + encodeURIComponent(cbName) +
          "&ts=" + Date.now(); // 캐시 방지

        scriptEl.onerror = function () {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP script 로드 실패"));
        };

        document.body.appendChild(scriptEl);
      });
    }

    // iOS/사내브라우저 안전 요일 계산: new Date(y,m-1,d)
    function formatKoreanDate(ymd) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return ymd || "";
      var parts = ymd.split("-");
      var y = parseInt(parts[0], 10);
      var m = parseInt(parts[1], 10);
      var d = parseInt(parts[2], 10);
      var dt = new Date(y, m - 1, d);
      var w = ["일","월","화","수","목","금","토"][dt.getDay()];
      return y + "년 " + m + "월 " + d + "일(" + w + ")";
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function loadSettings() {
      var url = GAS_EXEC_URL + "?" + buildQuery({ action: "settings" });
      jsonpCall(url, "cb_set", 12000).then(function (res) {
        if (!res || !res.ok) throw new Error(res && res.error ? res.error : "settings 응답 오류");
        var s = res.settings || {};
        SETTINGS = s;

        document.getElementById("pageTitle").textContent = (s.title || "연휴 출근 조사");
        document.getElementById("pageDesc").textContent  = (s.desc  || "");

        buildUI(s);

        document.getElementById("ver").textContent = "loaded: " + new Date().toLocaleString();
      }).catch(function (e) {
        document.getElementById("dateList").innerHTML =
          '<div class="hint">불러오기 실패: ' + escapeHtml(e.message || e) + '</div>';
        setStatus("설정 불러오기 실패");
      });
    }

    function buildUI(s) {
      var deptList = Array.isArray(s.depts) ? s.depts : [];
      var dates    = Array.isArray(s.dates) ? s.dates : [];
      var shifts   = Array.isArray(s.shifts) ? s.shifts : ["오전","오후","야간"];

      // 부서 드롭다운
      var deptSel = document.getElementById("dept");
      if (!deptList.length) {
        deptSel.innerHTML = '<option value="">(설정에 부서가 없습니다)</option>';
      } else {
        deptSel.innerHTML =
          '<option value="">부서를 선택하세요</option>' +
          deptList.map(function (d) {
            return '<option value="' + escapeHtml(d) + '">' + escapeHtml(d) + '</option>';
          }).join("");
      }

      // 날짜 카드
      var box = document.getElementById("dateList");
      if (!dates.length) {
        box.innerHTML = '<div class="hint">날짜 데이터가 없습니다. (설정 시트 dates 확인)</div>';
        return;
      }

      box.innerHTML = dates.map(function (ymd, idx) {
        var idBase = "d_" + idx;
        var title = formatKoreanDate(ymd);

        var shiftHtml = shifts.map(function (sh) {
          return (
            '<label class="chip">' +
              '<input type="checkbox" value="' + escapeHtml(sh) + '" data-date="' + escapeHtml(ymd) + '">' +
              '<span>' + escapeHtml(sh) + '</span>' +
            '</label>'
          );
        }).join("");

        return (
          '<div class="dateCard">' +
            '<div class="dateTop">' +
              '<input type="checkbox" id="' + idBase + '_on" data-date="' + escapeHtml(ymd) + '">' +
              '<div class="dateTitle">' + escapeHtml(title) + '</div>' +
            '</div>' +
            '<div class="chips" id="' + idBase + '_shifts" style="opacity:.5; pointer-events:none;">' +
              shiftHtml +
            '</div>' +
          '</div>'
        );
      }).join("");
    }

    function toggleDateByEl(chkEl) {
      var card = chkEl.closest(".dateCard");
      var chips = card ? card.querySelector(".chips") : null;
      if (!chips) return;

      if (chkEl.checked) {
        chips.style.opacity = "1";
        chips.style.pointerEvents = "auto";
      } else {
        var inputs = chips.querySelectorAll('input[type="checkbox"]');
        for (var i = 0; i < inputs.length; i++) inputs[i].checked = false;
        chips.style.opacity = ".5";
        chips.style.pointerEvents = "none";
      }
    }

    function submitOneViaJsonp(params) {
      var url = GAS_EXEC_URL + "?" + buildQuery({
        action: "submitOne",
        site:  params.site  || "",
        name:  params.name  || "",
        dept:  params.dept  || "",
        work:  params.work  || "",
        date:  params.date  || "",
        shift: params.shift || "",
        ua: (navigator.userAgent || "")
      });
      return jsonpCall(url, "cb_one", 12000);
    }

    function sleep(ms) {
      return new Promise(function (r) { setTimeout(r, ms); });
    }

    async function submitData() {
      var site = document.getElementById("site").value.trim();
      var name = document.getElementById("name").value.trim();
      var dept = document.getElementById("dept").value.trim();
      var work = document.getElementById("work").value.trim();

      var status = document.getElementById("status");
      var btn = document.getElementById("submitBtn");

      if (!site || !name) { alert("사업장/성명을 입력하세요."); return; }
      if (!dept) { alert("부서를 선택하세요."); return; }

      var dateOn = Array.prototype.slice.call(
        document.querySelectorAll('#dateList .dateTop input[type="checkbox"]:checked')
      );
      if (dateOn.length === 0) { alert("날짜를 최소 1개 선택하세요."); return; }

      var jobs = [];
      for (var i = 0; i < dateOn.length; i++) {
        var chk = dateOn[i];
        var date = chk.getAttribute("data-date");
        var card = chk.closest(".dateCard");
        var checkedShifts = Array.prototype.slice.call(card.querySelectorAll('.chips input[type="checkbox"]:checked'))
          .map(function (x) { return x.value; });

        if (checkedShifts.length === 0) { alert(date + "의 구분을 최소 1개 선택하세요."); return; }

        for (var j = 0; j < checkedShifts.length; j++) {
          jobs.push({ date: date, shift: checkedShifts[j] });
        }
      }

      btn.disabled = true;
      status.textContent = "저장 중…";

      try {
        for (var k = 0; k < jobs.length; k++) {
          status.textContent = "저장 중… (" + (k + 1) + "/" + jobs.length + ")";
          var res = await submitOneViaJsonp({
            site: site, name: name, dept: dept, work: work,
            date: jobs[k].date,
            shift: jobs[k].shift
          });

          if (!res || !res.ok) throw new Error(res && res.error ? res.error : "저장 실패");
          await sleep(120);
        }

        alert("제출되었습니다!");

        // 초기화
        var tops = document.querySelectorAll('#dateList .dateTop input[type="checkbox"]');
        for (var a = 0; a < tops.length; a++) tops[a].checked = false;

        var chipsAll = document.querySelectorAll('#dateList .chips');
        for (var b = 0; b < chipsAll.length; b++) {
          chipsAll[b].style.opacity = ".5";
          chipsAll[b].style.pointerEvents = "none";
        }

        var allShiftChecks = document.querySelectorAll('#dateList .chips input[type="checkbox"]');
        for (var c = 0; c < allShiftChecks.length; c++) allShiftChecks[c].checked = false;

        document.getElementById("work").value = "";
        setStatus("저장 완료");
      } catch (e) {
        alert("오류: " + (e.message || e));
        setStatus("오류 발생");
      } finally {
        btn.disabled = false;
      }
    }

    // 이벤트 바인딩
    document.getElementById("submitBtn").addEventListener("click", function () {
      submitData();
    });

    // 날짜 토글: 이벤트 위임
    document.addEventListener("change", function (ev) {
      var t = ev.target;
      if (!t) return;
      if (t.matches && t.matches('#dateList .dateTop input[type="checkbox"]')) {
        toggleDateByEl(t);
      }
    });

    loadSettings();
  </script>
</body>
</html>
