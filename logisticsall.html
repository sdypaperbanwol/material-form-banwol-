<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신대양제지 반월·시화 공장 내 실시간 차량 현황</title>
  <meta name="description" content="신대양제지 반월·시화 공장 내 실시간 차량 현황 – GitHub Pages용 logistics.html">
  <style>
    :root{
      --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
      --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
      --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}

    .header{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 18px;margin-bottom:16px}
    .title{margin:0;font-size:20px;letter-spacing:-.2px}
    .subtitle{margin:4px 0 0 0;color:var(--muted);font-size:12.5px;display:flex;align-items:center;gap:6px}
    .mini-spinner{display:inline-block;width:12px;height:12px;border:2px solid #cfd8ff;border-top-color:var(--brand);border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .badge{background:var(--badge);border:1px solid #d9e2ff;border-radius:999px;padding:3px 8px;font-size:12px}
    .badges .btn{margin-left:6px}

    .toolbar{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}

    /* === 2-베이 레이아웃 === */
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .col{display:grid;gap:14px}
    @media (min-width:900px){
      .grid{grid-template-columns:1fr 1fr}
    }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .card .head h3{margin:0;font-size:15px}
    .stripe{height:4px;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .stripe.cyan{background:var(--cyan)}
    .stripe.green{background:var(--green)}

    .summary{padding:8px 14px;color:var(--muted);border-bottom:1px solid var(--line);font-size:12.5px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fafbfd;border-bottom:1px solid var(--line);color:#333;font-weight:600}
    th,td{padding:8px 10px;text-align:center}
    tbody tr:nth-child(odd){background:#fcfcfe}
    tbody td{border-bottom:1px solid #f1f1f4}

    .empty{padding:18px 14px;color:var(--muted)}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}

    /* 로딩 오버레이 */
    .overlay{position:fixed;inset:0;background:rgba(17,24,39,.35);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s}
    .overlay.show{opacity:1;pointer-events:auto}
    .overlay .panel{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:18px 20px;display:flex;align-items:center;gap:10px;min-width:220px;justify-content:center}
    .overlay .spinner{width:28px;height:28px;border:3px solid #e5e7eb;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}

    @media print{
      body{background:#fff}
      .btn,.toast,.overlay{display:none}
      .wrap{max-width:1000px;margin:0;padding:0}
      .header{box-shadow:none;border:none}
      .grid{grid-template-columns:1fr 1fr}
    }
    /* 반월→시화 구간 구분선 */
    tbody tr.plant-sep td{ border-top: 2px solid #ff6b6b; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">신대양제지 반월·시화 공장 내 실시간 차량 현황</h1>
      <p class="subtitle" id="updated">업데이트 준비 중…</p>

      <div class="badges">
        <span class="badge">범위: 공장 내</span>
        <span class="badge">입·하차 전체(5섹션)</span>
        <span class="badge">계근/입차 기준</span>
        <a class="btn" href="https://t.me/Logistics_Vehicle_List_bot" target="_blank" rel="noopener">텔레그램 열기</a>
      </div>

      <div class="toolbar">
        <select id="interval" class="btn" title="새로고침 간격">
          <option value="30">30초</option>
          <option value="60" selected>60초</option>
          <option value="120">120초</option>
        </select>
        <button class="btn" id="btnRefresh">새로고침</button>
        <button class="btn primary" id="btnPrint">인쇄/PDF</button>
      </div>
    </section>

    <section class="grid" id="sections">
      <!-- JS가 채움 -->
    </section>
  </div>

  <!-- 중앙 로딩 오버레이 -->
  <div class="overlay" id="loadingOverlay" aria-hidden="true">
    <div class="panel" role="status" aria-live="polite">
      <div class="spinner" aria-label="로딩 중"></div>
      <div><strong>새로고침 중…</strong><br><span style="color:#666;font-size:12px">잠시만 기다려주세요</span></div>
    </div>
  </div>

  <div class="toast" id="toast">업데이트됨</div>

  <script>
    // =============================
    //  설정: GAS 스냅샷 엔드포인트
    // =============================
    const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbzg_d3WwuHIbDH826MQVimmOnPMI8vaGAlkKnGE7kdxrIWkToaZ1xZqyo_DT44XyGOqxw/exec?api=snapshot';
    const USE_JSONP_FALLBACK = true;

    const elUpdated  = document.getElementById('updated');
    const elSections = document.getElementById('sections');
    const elInterval = document.getElementById('interval');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnPrint   = document.getElementById('btnPrint');
    const toast      = document.getElementById('toast');
    const overlay    = document.getElementById('loadingOverlay');

    // 중복 호출 방지 플래그
    let __loading = false;
    let __timer   = null;

    // ===== 새 섹션 순서(백엔드 타이틀 그대로 사용) =====
    const DESIRED_ORDER = [
      '원료 대기',
      '원료 하차중',
      '제품 상차중',
      '부자재 입차중',
      '컨테이너 입차중'
    ];

    function timeLabelFromTitle(title){
      return /대기/.test(title) ? '등록시간' : '입차시간';
    }

    function showToast(msg){
      toast.textContent = msg || '완료';
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    function stripeClass(color){
      const c = String(color||'').toLowerCase();
      return c.includes('00ff00') ? 'green' : 'cyan';
    }

    // 로딩 상태 토글 (manual은 오버레이, auto는 헤더 스피너만)
    function setLoading(on, source){
      __loading = !!on;
      btnRefresh.disabled = on;
      elInterval.disabled = on;
      if(on){
        if(source === 'manual'){
          overlay.classList.add('show');
          overlay.setAttribute('aria-hidden','false');
        }
        elUpdated.innerHTML = '<span class="mini-spinner" aria-hidden="true"></span>업데이트 중…';
      }else{
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }
    }

    // 카드 렌더(반월→시화, 시화 첫 줄에 구분선)
    function renderSectionCardGrouped(sec){
      const title  = sec.title || '-';
      const color  = sec.color || '#00FFFF';
      const groups = Array.isArray(sec.groups) ? sec.groups : [];
      const timeLabel = sec.timeLabel || timeLabelFromTitle(title);

      const ban = groups.find(g => g.plant === '반월')?.rows || [];
      const sih = groups.find(g => g.plant === '시화')?.rows || [];

      const bcnt = ban.length, scnt = sih.length, total = bcnt + scnt;

      let seq = 1;
      const rowHTML = (r, plant, sep) => `
        <tr${sep ? ' class="plant-sep"' : ''}>
          <td>${seq++}</td>
          <td>${r.car ?? ''}</td>
          <td>${r.time ?? ''}</td>
          <td>${plant}</td>
        </tr>`;

      const rowsHTML =
        ban.map(r => rowHTML(r, '반월', false)).join('') +
        sih.map((r, i) => rowHTML(r, '시화', !!ban.length && i === 0)).join('');

      const table = `
        <table>
          <thead>
            <tr>
              <th style="width:44px">No</th>
              <th style="width:96px">차량</th>
              <th style="width:74px">${timeLabel}</th>
              <th style="width:56px">공장</th>
            </tr>
          </thead>
          <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(없음)</td></tr>' }</tbody>
        </table>`;

      return `
        <article class="card">
          <div class="stripe ${stripeClass(color)}"></div>
          <div class="head"><h3>${title}</h3></div>
          <div class="summary">총 ${total}건 (반월 ${bcnt}, 시화 ${scnt})</div>
          ${table}
        </article>`;
    }

    // 섹션 정렬: DESIRED_ORDER 우선, 없으면 원본 순서 유지
    function orderSections(sections){
      const byTitle = Object.fromEntries(sections.map(s => [s.title, s]));
      const ordered = DESIRED_ORDER.map(t => byTitle[t]).filter(Boolean);
      const rest = sections.filter(s => !DESIRED_ORDER.includes(s.title));
      return ordered.concat(rest);
    }

    function render(data){
      try{
        const ts = data && data.updatedAt ? data.updatedAt : '';
        elUpdated.textContent = ts ? `업데이트: ${ts} (KST)` : '업데이트 시간 없음';

        const raw = Array.isArray(data && data.sections) ? data.sections : [];
        if(!raw.length){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터 없음</div></div></div>';
          return;
        }

        const sections = orderSections(raw);

        // 2열 분배: 0,2,4... → 왼쪽 / 1,3,5... → 오른쪽
        const left  = [], right = [];
        sections.forEach((s, i) => (i % 2 === 0 ? left : right).push(s));

        const leftHTML  = left.map(renderSectionCardGrouped).join('');
        const rightHTML = right.map(renderSectionCardGrouped).join('');

        elSections.innerHTML = `
          <div class="col col-left">${ leftHTML || '<div class="card"><div class="empty">좌측 섹션 없음</div></div>' }</div>
          <div class="col col-right">${ rightHTML || '<div class="card"><div class="empty">우측 섹션 없음</div></div>' }</div>
        `;
      }catch(err){
        console.error(err);
        elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">렌더링 중 오류</div></div></div>';
      }
    }

    async function loadSnapshotFetch(){
      const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now(); // 캐시 회피
      const res = await fetch(url, { method:'GET', credentials:'omit' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function loadSnapshotJSONP(){
      return new Promise((resolve, reject)=>{
        const cbName = 'CB_' + Math.random().toString(36).slice(2);
        const cleanup = (s)=>{ try{ delete window[cbName]; s && s.remove(); }catch(e){} };
        window[cbName] = (data)=>{ cleanup(script); resolve(data); };
        const script = document.createElement('script');
        const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + 'callback=' + cbName + '&_ts=' + Date.now();
        script.src = url;
        script.onerror = ()=>{ cleanup(script); reject(new Error('JSONP load error')); };
        document.body.appendChild(script);
      });
    }

    // source: 'manual' | 'auto'
    async function loadSnapshot(opts = {source:'auto'}){
      const source = opts.source || 'auto';

      if(__loading){
        if(source === 'manual') showToast('이미 새로고침 중…');
        return;
      }

      try{
        setLoading(true, source);
        let data = await loadSnapshotFetch();
        render(data);
        showToast('업데이트됨');
      }catch(err){
        console.warn('fetch 실패, JSONP 시도:', err);
        if (!USE_JSONP_FALLBACK){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (CORS/권한 확인)</div></div></div>';
          return;
        }
        try{
          const data = await loadSnapshotJSONP();
          render(data);
          showToast('업데이트됨');
        }catch(e){
          console.error(e);
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (JSONP 실패)</div></div></div>';
        }
      }finally{
        setLoading(false);
      }
    }

    function startInterval(){
      if(__timer) clearInterval(__timer);
      const sec = Number(elInterval.value || 60);
      __timer = setInterval(()=>loadSnapshot({source:'auto'}), sec * 1000);
    }

    elInterval.addEventListener('change', startInterval);
    btnRefresh.addEventListener('click', ()=> loadSnapshot({source:'manual'}));
    btnPrint.addEventListener('click', ()=> window.print());

    // init
    (function(){
      loadSnapshot({source:'auto'});
      startInterval();
    })();
  </script>
</body>
</html>
