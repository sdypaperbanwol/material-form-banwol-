<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>실시간 차량현황(시트 뷰)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 16px; --card: #ddd; --muted:#777; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .topbar strong { font-size:18px; }
    .timestamp { color: var(--muted); }
    .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .plant { display:flex; flex-direction:column; gap: var(--gap); }
    .plant-title { font-weight:700; margin: 4px 0; }
    .section { border:1px solid var(--card); border-radius:10px; padding:12px; }
    .section h3 { margin:0 0 8px 0; font-size:16px; display:flex; gap:8px; align-items:baseline; }
    .muted { color: var(--muted); font-weight:500; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td { border:1px solid #ccc; text-align:center; vertical-align:middle; padding:6px; }
    th { font-weight:700; }
    /* 번호/차량번호/시간 = 3열, 스프레드시트와 비슷하게 */
    colgroup col:nth-child(1) { width: 80px; }
    colgroup col:nth-child(2) { width: 120px; }
    colgroup col:nth-child(3) { width: 100px; }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
    button { padding:6px 10px; border:1px solid #bbb; background:#fff; border-radius:8px; cursor:pointer; }
    button:hover { background:#f5f5f5; }
    input[type="number"] { width:80px; padding:6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>실시간 차량현황(시트 뷰)</strong>
    <span class="timestamp" id="ts"></span>
    <div class="controls">
      <label class="muted">자동새로고침(초)</label>
      <input type="number" id="autoSec" min="0" step="5" placeholder="0=끄기" />
      <button id="btnRefresh">새로고침</button>
    </div>
  </div>

  <div class="grid">
    <div class="plant">
      <div class="plant-title">반월</div>
      <div id="left"></div>
    </div>
    <div class="plant">
      <div class="plant-title">시화</div>
      <div id="right"></div>
    </div>
  </div>

 <script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxlQLPPpvsWc-OmbHYAfeVfvKyqznP-XkH8aNYsVAC_QHuevc2BGMLmIVMkYkx_Bu-0/exec";
  const SECTIONS = ["제품 입차중","원료 하차중","원료 도착","부자재 입차중","컨테이너 입차중"];

  function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function tableHTML(rows) {
    const hdr = `<tr><th>번호</th><th>차량번호</th><th>시간</th></tr>`;
    const body = rows && rows.length
      ? rows.map(r => `<tr><td>${esc(r[0])}</td><td>${esc(r[1])}</td><td>${esc(r[2])}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">데이터 없음</td></tr>`;
    return `<table>
      <colgroup><col><col><col></colgroup>
      <thead>${hdr}</thead><tbody>${body}</tbody></table>`;
  }

  function sectionHTML(title, data) {
    const count = data?.count || 0;
    const rows = data?.rows || [];
    return `<div class="section">
      <h3>${esc(title)} <span class="muted">(${count}대)</span></h3>
      ${tableHTML(rows)}
    </div>`;
  }

  function renderSide(container, side) {
    container.innerHTML = SECTIONS.map(t => sectionHTML(t, side?.[t])).join("");
  }

  async function load() {
    const tsEl = document.getElementById('ts');
    tsEl.textContent = "불러오는 중…";
    try {
      // 1차: 표준 fetch(JSON)
      const res = await fetch(WEBAPP_URL, { cache: "no-store", mode: "cors" });
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      applyData(data);
    } catch (e) {
      // 2차: JSONP 폴백 (CORS 우회)
      loadJSONP().catch(err => {
        tsEl.textContent = "불러오기 실패";
        alert("스냅샷 로드 실패: " + (err?.message || err || e.message));
      });
    }
  }

  function applyData(data){
    document.getElementById('ts').textContent = data.stamp ? `기준일: ${data.stamp}` : "";
    renderSide(document.getElementById('left'),  data.left);
    renderSide(document.getElementById('right'), data.right);
  }

  // JSONP 로더
  function loadJSONP() {
    return new Promise((resolve, reject) => {
      const cbName = "__dy_cb_" + Date.now();
      const url = `${WEBAPP_URL}?callback=${cbName}&t=${Date.now()}`; // 캐시 방지 t=
      const script = document.createElement('script');
      script.src = url;
      script.async = true;

      let done = false;
      window[cbName] = (data) => {
        if (done) return;
        done = true;
        try {
          delete window[cbName];
          document.body.removeChild(script);
        } catch {}
        if (data && !data.error) {
          applyData(data);
          resolve();
        } else {
          reject(new Error(data?.error || "JSONP 응답 오류"));
        }
      };

      script.onerror = () => {
        if (done) return;
        done = true;
        try {
          delete window[cbName];
          document.body.removeChild(script);
        } catch {}
        reject(new Error("JSONP 스크립트 로드 실패"));
      };

      document.body.appendChild(script);
    });
  }

  // 버튼/자동새로고침 로직은 기존 그대로...
  document.getElementById('btnRefresh').addEventListener('click', load);
  let timer=null;
  const autoEl = document.getElementById('autoSec');
  autoEl.addEventListener('change', ()=>{
    if (timer) { clearInterval(timer); timer=null; }
    const sec = parseInt(autoEl.value,10);
    if (!isNaN(sec) && sec>0) timer = setInterval(load, sec*1000);
  });
  (function initAuto(){
    const params = new URLSearchParams(location.search);
    const v = parseInt(params.get('auto')||'0',10);
    if (v>0) { autoEl.value=v; autoEl.dispatchEvent(new Event('change')); }
  })();

  load();
</script>

</body>
</html>
