<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>신대양제지 반월·시화 공장 내 실시간 차량 현황</title>
  <meta name="description" content="DY Group Scale / 반월·시화 실시간 차량 현황 대시보드">
  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; --card:#ffffff;
      --brand:#0f62fe; --green:#00FF00; --cyan:#00FFFF; --mark:#FFF2CC;
      --chip:#f3f6fb; --chip-bd:#e5ecf6;
      --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.58 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1280px;margin:16px auto;padding:0 14px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 14px}
    .brand{display:flex;flex-direction:column;gap:4px}
    .title{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .input, select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:760px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (min-width:1100px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--line)}
    .card .head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
    .head-left{display:flex;align-items:center;gap:8px}
    .stripe{display:inline-block;width:10px;height:10px;border-radius:999px}
    .head-acts{display:flex;gap:6px;align-items:center}
    .toggle{appearance:none;width:36px;height:22px;border-radius:999px;background:#e5e7eb;position:relative;outline:none;border:none;cursor:pointer}
    .toggle:checked{background:#22c55e}
    .toggle:before{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:999px;background:#fff;transition:all .18s}
    .toggle:checked:before{left:17px}
    .body{padding:10px 12px}
    .sum{font-weight:700}
    .tbl{width:100%;border-collapse:separate;border-spacing:0}
    .tbl th,.tbl td{border:1px solid var(--line);padding:6px 8px;text-align:center}
    .tbl th{background:#fafbfd;font-weight:700}
    .tbl tr.hit td{background:var(--mark)}
    .search-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:0 0 8px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-bd);font:13px/1 ui-monospace,Consolas,monospace}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .footer{margin:18px 0 8px;text-align:center;color:var(--muted);font-size:12px}

    /* 모달 */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999}
    .modal .panel{width:min(820px,92%);margin:5vh auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 18px 48px rgba(0,0,0,.25);border:1px solid var(--line)}
    .modal .ph{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .modal .pc{padding:14px}
    textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;resize:vertical;font:14px/1.5 ui-monospace,Consolas,monospace}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}

    /* 로딩 오버레이 */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.65);z-index:999}
    .spinner{width:44px;height:44px;border:4px solid #e5e7eb;border-top-color:#0f62fe;border-radius:999px;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* 인쇄 */
    @media print{
      .controls,.modal,.overlay,.footer{display:none !important}
      body{background:#fff}
      .wrap{max-width:none}
      .card{box-shadow:none;border-color:#ddd}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="title">신대양제지 반월·시화 공장 내 실시간 차량 현황</div>
        <div class="muted" id="updatedAt">업데이트: -</div>
      </div>
      <div class="controls">
        <select id="plantFilter" title="공장 필터">
          <option value="all">전체</option>
          <option value="banwol">반월만</option>
          <option value="sihwa">시화만</option>
        </select>
        <input id="searchInput" class="input" placeholder="차량번호 검색 (부분 일치)" />
        <label class="row" style="gap:6px">
          <input id="autoRefresh" type="checkbox" class="toggle" />
          <span class="muted" style="min-width:80px">자동 새로고침</span>
        </label>
        <select id="refreshSec" title="간격(초)">
          <option value="15">15s</option>
          <option value="30" selected>30s</option>
          <option value="60">60s</option>
          <option value="120">120s</option>
        </select>
        <button class="btn" id="btnRefresh">새로고침</button>
        <button class="btn" id="btnOpenHitList">통운차량 관리</button>
        <button class="btn" id="btnSettings">설정</button>
        <a class="btn primary" href="https://t.me/Logistics_Vehicle_List_bot" target="_blank" rel="noopener">텔레그램</a>
        <button class="btn" onclick="window.print()">인쇄</button>
      </div>
    </div>

    <div id="cards" class="grid"></div>

    <div class="footer">Powered by GAS Web App + JSONP · © DY Group</div>
  </div>

  <!-- 로딩 -->
  <div class="overlay" id="overlay"><div class="spinner" aria-label="Loading"></div></div>

  <!-- 통운차량 리스트 모달 -->
  <div id="hitListModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="hitListTitle">
    <div class="panel">
      <div class="ph">
        <strong id="hitListTitle">통운차량 리스트 (last4)</strong>
        <div class="row">
          <button class="btn" id="btnHitNormalize">정규화·정렬</button>
          <button class="btn" id="btnHitReload">서버에서 다시 불러오기</button>
          <button class="btn primary" id="btnSaveHitList">서버에 저장</button>
          <button class="btn" id="btnCloseHitList">닫기</button>
        </div>
      </div>
      <div class="pc">
        <p class="muted" style="margin-top:0">쉼표/엔터/공백 아무거나로 구분해서 입력하세요. (숫자만 인식, 마지막 4자리로 정규화) · 제품 섹션은 음영 제외</p>
        <textarea id="hitListInput" rows="7" placeholder="예) 1076 1938 5851 4521 2717 ..."></textarea>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div style="font-weight:700">서버에 저장된 목록</div>
          <div class="muted" id="hitListCount"></div>
        </div>
        <div id="hitListBody" class="row"></div>
      </div>
    </div>
  </div>

  <!-- 설정/진단 모달 -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="panel">
      <div class="ph">
        <strong id="settingsTitle">설정 · 진단</strong>
        <div class="row">
          <button class="btn" id="btnTestHealth">헬스체크</button>
          <button class="btn" id="btnTestWho">WHO(스크립트/시트/마커)</button>
          <button class="btn" id="btnSaveSettings">저장</button>
          <button class="btn" id="btnCloseSettings">닫기</button>
        </div>
      </div>
      <div class="pc">
        <div class="row">
          <label class="muted" style="min-width:140px">GAS EXEC URL</label>
          <input id="cfgExec" class="input grow" placeholder="https://script.google.com/macros/s/.../exec" />
        </div>
        <div class="row" style="margin-top:8px">
          <label class="muted" style="min-width:140px">API SECRET</label>
          <input id="cfgSecret" class="input grow" placeholder="CHANGE_ME_1234" />
        </div>
        <div class="sep"></div>
        <pre id="diagOut" style="white-space:pre-wrap;background:#0b1020;color:#d1d5db;padding:12px;border-radius:12px;overflow:auto;max-height:40vh;font:12px/1.5 ui-monospace,Consolas,monospace"></pre>
      </div>
    </div>
  </div>

  <script>
  // ========================== 기본 설정 (변경 가능) ==========================
  const DEFAULT_EXEC   = 'https://script.google.com/macros/s/AKfycbx7p5Tca9_tTvOZGpGBrwl2p8VIsnZFvGnm63JVpKtCg5xE9uZgbYkfiCsE-BGFlbDWew/exec';
  const DEFAULT_SECRET = 'CHANGE_ME_1234';

  // 제품 섹션은 음영 제외
  const EXCLUDE_MARK_ON = new Set(['제품 상차중']);

  // 저장 키
  const LS_KEYS = {
    exec: 'cfg.exec',
    secret: 'cfg.secret',
    auto: 'ui.auto',
    sec: 'ui.auto.sec',
    plant: 'ui.plant',
    q: 'ui.q',
    collapse: 'ui.collapse', // 섹션별 접기 상태 { '제품 상차중': true, ... }
    cacheSnapshot: 'cache.snapshot' // 마지막 스냅샷
  };

  // ========================== JSONP 유틸 (CORS 회피) ==========================
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = (data) => { try { resolve(data); } finally { delete window[cb]; script.remove(); } };
      const script = document.createElement('script');
      script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // ========================== 서버 API ==========================
  function getExec(){ return localStorage.getItem(LS_KEYS.exec) || DEFAULT_EXEC; }
  function getSecret(){ return localStorage.getItem(LS_KEYS.secret) || DEFAULT_SECRET; }

  async function apiSnapshot   (){ return await jsonp(getExec() + '?api=snapshot'); }
  async function apiHitGet     (){ return await jsonp(getExec() + '?api=hit_get'); }
  async function apiHitSet(list){
    const url = getExec() + '?api=hit_set&secret=' + encodeURIComponent(getSecret()) +
                '&list=' + encodeURIComponent((list||[]).join(','));
    return await jsonp(url);
  }
  async function apiHealth()    { return await jsonp(getExec() + '?test=1'); }
  async function apiWho(){
    return await jsonp(getExec() + '?api=who&secret=' + encodeURIComponent(getSecret()));
  }

  // ========================== 상태/유틸 ==========================
  function showOverlay(on){ document.getElementById('overlay').style.display = on ? 'flex' : 'none'; }
  function toast(msg){ console.log('[INFO]', msg); alert(msg); }
  function errToast(e){ console.error(e); alert('오류: ' + (e?.message || e)); }

  function last4(s){
    const d = String(s||'').replace(/\D+/g,'');
    return d.length >= 4 ? d.slice(-4) : '';
  }

  function normalizeToLast4List(inputStr) {
    const raw = String(inputStr || '').split(/[\s,]+/).filter(Boolean);
    const set = new Set();
    for (const x of raw) {
      const l4 = last4(x);
      if (l4) set.add(l4);
    }
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  function saveCollapse(title, val){
    const map = JSON.parse(localStorage.getItem(LS_KEYS.collapse) || '{}');
    map[title] = !!val;
    localStorage.setItem(LS_KEYS.collapse, JSON.stringify(map));
  }
  function readCollapse(title){
    const map = JSON.parse(localStorage.getItem(LS_KEYS.collapse) || '{}');
    return !!map[title];
  }

  // ========================== 렌더: 카드/표 ==========================
  function renderSnapshot(data){
    // 캐시
    try{ localStorage.setItem(LS_KEYS.cacheSnapshot, JSON.stringify(data)); }catch(_){}

    const updatedAt = document.getElementById('updatedAt');
    updatedAt.textContent = '업데이트: ' + (data?.updatedAt || '-');

    const cards = document.getElementById('cards');
    cards.innerHTML = '';

    const q = (document.getElementById('searchInput').value || '').trim();
    const plantFilter = document.getElementById('plantFilter').value; // all|banwol|sihwa

    (data?.sections || []).forEach(sec => {
      // 카드
      const card = document.createElement('div');
      card.className = 'card';

      // 헤더
      const head = document.createElement('div');
      head.className = 'head';
      const left = document.createElement('div');
      left.className = 'head-left';
      const dot = document.createElement('span');
      dot.className = 'stripe';
      dot.style.background = sec.color || '#eee';
      const ttl = document.createElement('span');
      ttl.textContent = sec.title || '';
      ttl.style.fontWeight = '800';
      left.append(dot, ttl);

      // 요약
      const total = (sec.groups?.[0]?.rows?.length || 0) + (sec.groups?.[1]?.rows?.length || 0);
      const bcnt = sec.groups?.find(g=>g.plant==='반월')?.rows?.length || 0;
      const scnt = sec.groups?.find(g=>g.plant==='시화')?.rows?.length || 0;
      const sum = document.createElement('div'); sum.className='sum'; sum.textContent = `총 ${total}건 (반월 ${bcnt}, 시화 ${scnt})`;

      // 액션들: 접기/펼치기
      const acts = document.createElement('div');
      acts.className = 'head-acts';
      const btnCollapse = document.createElement('button');
      btnCollapse.className = 'btn ghost'; btnCollapse.textContent = readCollapse(sec.title) ? '펼치기' : '접기';
      btnCollapse.addEventListener('click', ()=>{
        const body = card.querySelector('.body');
        const now = body.style.display !== 'none';
        body.style.display = now ? 'none' : '';
        btnCollapse.textContent = now ? '펼치기' : '접기';
        saveCollapse(sec.title, now);
      });

      acts.append(sum, btnCollapse);
      head.append(left, acts);

      // 본문
      const body = document.createElement('div'); body.className = 'body';

      // 그룹 머지: 반월 → 시화, 테이블 필터 적용
      const groups = Array.isArray(sec.groups) ? sec.groups : [];
      const ban = groups.find(g => g.plant === '반월') || { rows: [] };
      const sih = groups.find(g => g.plant === '시화') || { rows: [] };
      let merged = [
        ...ban.rows.map(r => ({...r, plant:'반월'})),
        ...sih.rows.map(r => ({...r, plant:'시화'}))
      ];

      // plantFilter
      if (plantFilter === 'banwol') merged = merged.filter(r => r.plant === '반월');
      if (plantFilter === 'sihwa')  merged = merged.filter(r => r.plant === '시화');

      // 검색
      if (q) {
        const qq = q.replace(/\s+/g,'');
        merged = merged.filter(r => String(r.car||'').includes(qq));
      }

      // 표
      const tbl = document.createElement('table');
      tbl.className = 'tbl';
      tbl.innerHTML = `
        <thead><tr>
          <th style="width:56px">No</th>
          <th style="width:140px">차량</th>
          <th style="width:90px">${sec.timeLabel || '시간'}</th>
          <th style="width:70px">공장</th>
        </tr></thead>
        <tbody></tbody>
      `;
      const tbody = tbl.querySelector('tbody');

      if (!merged.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4; td.className='muted'; td.textContent='(없음)';
        tr.appendChild(td); tbody.appendChild(tr);
      } else {
        merged.forEach((r, i) => {
          const tr = document.createElement('tr');

          // 제품 섹션은 음영 제외
          const markable = !EXCLUDE_MARK_ON.has(sec.title || '');
          if (markable && r.hit) tr.classList.add('hit');

          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${r.car ?? ''}</td>
            <td>${r.time ?? ''}</td>
            <td>${r.plant ?? ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      body.appendChild(tbl);
      card.append(head, body);

      if (readCollapse(sec.title)) body.style.display = 'none';
      document.getElementById('cards').appendChild(card);
    });
  }

  // ========================== 데이터 흐름 ==========================
  async function refreshAll(){
    try{
      showOverlay(true);
      const snap = await apiSnapshot();
      renderSnapshot(snap);
    }catch(e){
      console.warn('스냅샷 로드 실패, 캐시 폴백 시도', e);
      const cached = localStorage.getItem(LS_KEYS.cacheSnapshot);
      if (cached){
        try{ renderSnapshot(JSON.parse(cached)); }catch(_){ throw e; }
      }else{
        throw e;
      }
    }finally{
      showOverlay(false);
    }
  }

  // 자동 새로고침
  let timer = null;
  function applyAutoRefresh(){
    const on = document.getElementById('autoRefresh').checked;
    const sec = +document.getElementById('refreshSec').value || 30;
    localStorage.setItem(LS_KEYS.auto, on ? '1':'0');
    localStorage.setItem(LS_KEYS.sec, String(sec));
    if (timer){ clearInterval(timer); timer = null; }
    if (on){
      timer = setInterval(()=>{ refreshAll().catch(console.error); }, sec*1000);
    }
  }

  // ========================== 통운차량 리스트 UI ==========================
  async function loadHitListUI(){
    try{
      showOverlay(true);
      const res = await apiHitGet();
      const list = Array.isArray(res?.markers) ? res.markers : [];
      renderHitList(list);
      document.getElementById('hitListCount').textContent = `총 ${list.length}건`;
      // 입력창에도 반영
      document.getElementById('hitListInput').value = list.join('\n');
      // 캐시
      localStorage.setItem('hitListCache', JSON.stringify(list));
    }catch(e){
      console.warn('서버 목록 로드 실패, 캐시 사용', e);
      const cache = JSON.parse(localStorage.getItem('hitListCache') || '[]');
      renderHitList(cache);
      document.getElementById('hitListCount').textContent = `총 ${cache.length}건 (캐시)`;
      document.getElementById('hitListInput').value = cache.join('\n');
    }finally{
      showOverlay(false);
    }
  }

  function renderHitList(list){
    const body = document.getElementById('hitListBody');
    body.innerHTML = '';
    if (!Array.isArray(list) || !list.length){
      const span = document.createElement('span');
      span.className = 'muted'; span.textContent = '저장된 항목 없음';
      body.appendChild(span); return;
    }
    list.forEach(l4 => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = l4;
      body.appendChild(chip);
    });
  }

  async function saveHitListFromTextarea(){
    const ta = document.getElementById('hitListInput');
    const list = normalizeToLast4List(ta.value);
    const res = await apiHitSet(list);
    if (res?.ok){
      renderHitList(res.markers || []);
      document.getElementById('hitListCount').textContent = `총 ${(res.count||0)}건`;
      localStorage.setItem('hitListCache', JSON.stringify(res.markers || []));
      toast('저장 완료 (' + (res.count||0) + '건)');
      // 저장 직후 스냅샷도 새로고침하여 음영 즉시 반영
      refreshAll().catch(console.error);
    }else{
      errToast(res?.error || '저장 실패');
    }
  }

  // ========================== 설정/진단 ==========================
  function openSettings(){
    document.getElementById('cfgExec').value = getExec();
    document.getElementById('cfgSecret').value = getSecret();
    document.getElementById('diagOut').textContent = '';
    document.getElementById('settingsModal').style.display = 'block';
  }
  function saveSettings(){
    const ex = document.getElementById('cfgExec').value.trim();
    const sc = document.getElementById('cfgSecret').value.trim();
    if (ex) localStorage.setItem(LS_KEYS.exec, ex);
    if (sc) localStorage.setItem(LS_KEYS.secret, sc);
    toast('설정 저장됨');
  }

  // ========================== 내보내기 (CSV) ==========================
  function exportCSV(){
    const data = JSON.parse(localStorage.getItem(LS_KEYS.cacheSnapshot) || '{}');
    const rows = [['섹션','No','차량','시간','공장']];
    (data.sections || []).forEach(sec => {
      const groups = sec.groups || [];
      const ban = groups.find(g=>g.plant==='반월') || {rows:[]};
      const sih = groups.find(g=>g.plant==='시화') || {rows:[]};
      const merged = [
        ...ban.rows.map((r,i)=>({no:i+1,...r,plant:'반월'})),
        ...sih.rows.map((r,i)=>({no:ban.rows.length + i + 1,...r,plant:'시화'})),
      ];
      merged.forEach(r => {
        rows.push([sec.title, r.no, r.car||'', r.time||'', r.plant||'']);
      });
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'vehicle_snapshot.csv';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  // ========================== 초기화/바인딩 ==========================
  document.addEventListener('DOMContentLoaded', () => {
    // UI 초기 상태 복구
    document.getElementById('autoRefresh').checked = (localStorage.getItem(LS_KEYS.auto) === '1');
    document.getElementById('refreshSec').value = localStorage.getItem(LS_KEYS.sec) || '30';
    document.getElementById('plantFilter').value = localStorage.getItem(LS_KEYS.plant) || 'all';
    document.getElementById('searchInput').value = localStorage.getItem(LS_KEYS.q) || '';

    // 이벤트
    document.getElementById('btnRefresh').addEventListener('click', ()=>refreshAll().catch(errToast));
    document.getElementById('autoRefresh').addEventListener('change', applyAutoRefresh);
    document.getElementById('refreshSec').addEventListener('change', applyAutoRefresh);
    document.getElementById('plantFilter').addEventListener('change', e=>{
      localStorage.setItem(LS_KEYS.plant, e.target.value);
      refreshAll().catch(console.error);
    });
    document.getElementById('searchInput').addEventListener('input', e=>{
      localStorage.setItem(LS_KEYS.q, e.target.value);
      // 캐시로 빠르게 필터링만 다시 그림
      const snap = localStorage.getItem(LS_KEYS.cacheSnapshot);
      if (snap){ try{ renderSnapshot(JSON.parse(snap)); }catch(_){/*noop*/} }
    });

    // 통운차량 관리
    document.getElementById('btnOpenHitList').addEventListener('click', ()=>{
      document.getElementById('hitListModal').style.display = 'block';
      loadHitListUI().catch(errToast);
    });
    document.getElementById('btnCloseHitList').addEventListener('click', ()=>{ document.getElementById('hitListModal').style.display='none'; });
    document.getElementById('hitListModal').addEventListener('click', (e)=>{ if (e.target.id === 'hitListModal') e.currentTarget.style.display='none'; });
    document.getElementById('btnHitNormalize').addEventListener('click', ()=>{
      const ta = document.getElementById('hitListInput');
      ta.value = normalizeToLast4List(ta.value).join('\n');
    });
    document.getElementById('btnHitReload').addEventListener('click', ()=>loadHitListUI().catch(errToast));
    document.getElementById('btnSaveHitList').addEventListener('click', ()=>saveHitListFromTextarea().catch(errToast));

    // 설정/진단
    document.getElementById('btnSettings').addEventListener('click', openSettings);
    document.getElementById('btnCloseSettings').addEventListener('click', ()=>{ document.getElementById('settingsModal').style.display='none'; });
    document.getElementById('settingsModal').addEventListener('click', (e)=>{ if (e.target.id === 'settingsModal') e.currentTarget.style.display='none'; });
    document.getElementById('btnSaveSettings').addEventListener('click', saveSettings);
    document.getElementById('btnTestHealth').addEventListener('click', async ()=>{
      try{ const r = await apiHealth(); document.getElementById('diagOut').textContent = '헬스체크 응답: ' + r; }
      catch(e){ document.getElementById('diagOut').textContent = '헬스체크 실패: ' + (e?.message || e); }
    });
    document.getElementById('btnTestWho').addEventListener('click', async ()=>{
      try{ const r = await apiWho(); document.getElementById('diagOut').textContent = JSON.stringify(r, null, 2); }
      catch(e){ document.getElementById('diagOut').textContent = 'WHO 실패: ' + (e?.message || e); }
    });

    // 단축키
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'r' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); refreshAll().catch(console.error); }
      if (e.key === '/' && !e.metaKey && !e.ctrlKey){ e.preventDefault(); document.getElementById('searchInput').focus(); }
      if (e.key === 'e' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); exportCSV(); }
    });

    // 우클릭 내보내기 메뉴(선택)
    document.addEventListener('contextmenu', (e)=>{
      if (e.target.closest('#cards')) {
        e.preventDefault();
        if (confirm('현재 스냅샷을 CSV로 저장할까요?')) exportCSV();
      }
    });

    // 최초 로드
    applyAutoRefresh();
    refreshAll().catch(errToast);
  });
  </script>
</body>
</html>
