<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>실시간 차량현황(시트 뷰)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 16px; --card: #ddd; --muted:#777; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .topbar strong { font-size:18px; }
    .timestamp { color: var(--muted); }

    /* ===== 페어(반월/시화) 그리드: 두 칼럼 좁게 + 가운데 정렬 ===== */
    .grid { 
      display: grid;
      grid-template-columns: 520px 520px; /* 필요시 숫자만 조정 */
      justify-content: center;            /* 가운데 정렬 */
      gap: var(--gap);
      margin-inline: auto;
    }
    .pair-title { font-weight:700; margin: 4px 0 8px; }

    .section { border:1px solid var(--card); border-radius:10px; padding:12px; }
    .section h3 { margin:0 0 8px 0; font-size:16px; display:flex; gap:8px; align-items:baseline; }
    .muted { color: var(--muted); font-weight:500; }

    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td { border:1px solid #ccc; text-align:center; vertical-align:middle; padding:6px; }
    th { font-weight:700; }
    colgroup col:nth-child(1) { width: 80px; }
    colgroup col:nth-child(2) { width: 120px; }
    colgroup col:nth-child(3) { width: 100px; }

    /* 모바일/좁은 화면에서는 1열로 */
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }

    button { padding:6px 10px; border:1px solid #bbb; background:#fff; border-radius:8px; cursor:pointer; }
    button:hover { background:#f5f5f5; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>실시간 차량현황(시트 뷰)</strong>
    <span class="timestamp" id="ts"></span>
    <button id="btnRefresh">새로고침</button>
  </div>

  <!-- 페어 렌더링 컨테이너 -->
  <div class="grid" id="pairs"></div>

  <script>
    // ==== 본인 GAS 웹앱 exec URL ====
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxlQLPPpvsWc-OmbHYAfeVfvKyqznP-XkH8aNYsVAC_QHuevc2BGMLmIVMkYkx_Bu-0/exec";

    // 섹션 순서 고정 (시트와 동일)
    const SECTIONS = ["제품 입차중","원료 하차중","원료 도착","부자재 입차중","컨테이너 입차중"];

    // 섹션별 시간 모드: (요청 기준) 모두 HH:MM
    // 필요하면 여기서 특정 섹션만 "HMS"(HH:MM:SS)로 바꿔도 됨.
    const TIME_MODE_BY_SECTION = {
      "제품 입차중":   "HM",
      "원료 하차중":   "HM",
      "원료 도착":     "HM",
      "부자재 입차중": "HM",
      "컨테이너 입차중":"HM"
    };
    function timeModeFor(title){ return TIME_MODE_BY_SECTION[title] ?? "HM"; }

    // 안전 이스케이프
    function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    // 시간 포맷터: HM/HMS/MS 지원 + KST 보정(시트가 ISO로 내려올 때)
    function formatTime(val, mode){
      if (val == null || val === "") return "";
      const s = String(val).trim();
      if (/^0+$/.test(s.replace(/\D/g,""))) return "";

      // ISO/Date → KST
      if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
        const d = new Date(s);
        if (!isNaN(d.getTime())) {
          const parts = new Intl.DateTimeFormat('ko-KR', {
            timeZone: 'Asia/Seoul', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
          }).formatToParts(d);
          const HH = parts.find(x=>x.type==='hour')?.value ?? '00';
          const MM = parts.find(x=>x.type==='minute')?.value ?? '00';
          const SS = parts.find(x=>x.type==='second')?.value ?? '00';
          if (mode === 'HM')  return `${HH}:${MM}`;
          if (mode === 'MS')  return `${MM}:${SS}`;
          /* HMS */           return `${HH}:${MM}:${SS}`;
        }
      }

      // HH:MM[:SS]
      let m = s.match(/(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (m){
        const HH=m[1], MM=m[2], SS=m[3]||"00";
        if (mode === 'HM')  return `${HH}:${MM}`;
        if (mode === 'MS')  return `${MM}:${SS}`;
        /* HMS */           return `${HH}:${MM}:${SS}`;
      }

      // 숫자만: HHMMSS / HHMM / MMSS
      const digits = s.replace(/\D/g,"");
      if (digits.length >= 6){
        const t6 = digits.slice(-6);
        const HH=t6.slice(0,2), MM=t6.slice(2,4), SS=t6.slice(4,6);
        if (mode === 'HM')  return `${HH}:${MM}`;
        if (mode === 'MS')  return `${MM}:${SS}`;
        /* HMS */           return `${HH}:${MM}:${SS}`;
      }
      if (digits.length === 4){
        const A=digits.slice(0,2), B=digits.slice(2,4);
        // 관례상 HHMM로 간주
        if (mode === 'HM')  return `${A}:${B}`;
        if (mode === 'MS')  return `${A}:${B}`;        // 모호하지만 그대로
        /* HMS */           return `${A}:${B}:00`;
      }
      return s;
    }

    function tableHTML(title, rows) {
      const mode = timeModeFor(title);
      const hdr = `<tr><th>번호</th><th>차량번호</th><th>시간</th></tr>`;
      const body = rows && rows.length
        ? rows.map(r => {
            const no = esc(r[0]);
            const car = esc(r[1]);
            const t  = esc(formatTime(r[2], mode));
            return `<tr><td>${no}</td><td>${car}</td><td>${t}</td></tr>`;
          }).join("")
        : `<tr><td colspan="3" class="muted">데이터 없음</td></tr>`;
      return `<table>
        <colgroup><col><col><col></colgroup>
        <thead>${hdr}</thead><tbody>${body}</tbody></table>`;
    }

    function sectionHTML(title, data) {
      const count = data?.count || 0;
      const rows = data?.rows || [];
      return `<div class="section">
        <h3>${esc(title)} <span class="muted">(${count}대)</span></h3>
        ${tableHTML(title, rows)}
      </div>`;
    }

    // ===== 페어 렌더링: 같은 행에 [반월/시화] 섹션 쌍 배치 =====
    function renderPairs(left, right) {
      const host = document.getElementById('pairs');
      const rows = [];

      // 첫 행: 타이틀(반월 / 시화)
      rows.push(`<div class="pair-title">반월</div>`, `<div class="pair-title">시화</div>`);

      // 이후: 각 섹션을 좌/우 같은 행에
      for (const t of SECTIONS) {
        rows.push(sectionHTML(t, left?.[t]), sectionHTML(t, right?.[t]));
      }
      host.innerHTML = rows.join("");
    }

    // ===== 데이터 로드 (fetch → 실패 시 JSONP 폴백) =====
    async function load() {
      const tsEl = document.getElementById('ts');
      tsEl.textContent = "불러오는 중…";
      try {
        const res = await fetch(WEBAPP_URL, { cache: "no-store", mode: "cors" });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        applyData(data);
      } catch (e) {
        loadJSONP().catch(err => {
          tsEl.textContent = "불러오기 실패";
          alert("스냅샷 로드 실패: " + (err?.message || err || e.message));
        });
      }
    }

    function applyData(data){
      document.getElementById('ts').textContent = data.stamp ? `기준일: ${data.stamp}` : "";
      renderPairs(data.left, data.right);
    }

    function loadJSONP() {
      return new Promise((resolve, reject) => {
        const cbName = "__dy_cb_" + Date.now();
        const url = `${WEBAPP_URL}?callback=${cbName}&t=${Date.now()}`;
        const script = document.createElement('script');
        script.src = url;
        script.async = true;

        let done = false;
        window[cbName] = (data) => {
          if (done) return;
          done = true;
          try { delete window[cbName]; document.body.removeChild(script); } catch {}
          if (data && !data.error) { applyData(data); resolve(); }
          else { reject(new Error(data?.error || "JSONP 응답 오류")); }
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          try { delete window[cbName]; document.body.removeChild(script); } catch {}
          reject(new Error("JSONP 스크립트 로드 실패"));
        };

        document.body.appendChild(script);
      });
    }

    // 수동 새로고침만
    document.getElementById('btnRefresh').addEventListener('click', load);

    // 최초 로드
    load();
  </script>
</body>
</html>
