<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>실시간 차량현황(시트 뷰)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 16px; --card: #ddd; --muted:#777; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .topbar strong { font-size:18px; }
    .timestamp { color: var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .plant { display:flex; flex-direction:column; gap: var(--gap); }
    .plant-title { font-weight:700; margin: 4px 0; }
    .section { border:1px solid var(--card); border-radius:10px; padding:12px; }
    .section h3 { margin:0 0 8px 0; font-size:16px; display:flex; gap:8px; align-items:baseline; }
    .muted { color: var(--muted); font-weight:500; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td { border:1px solid #ccc; text-align:center; vertical-align:middle; padding:6px; }
    th { font-weight:700; }
    colgroup col:nth-child(1) { width: 80px; }
    colgroup col:nth-child(2) { width: 120px; }
    colgroup col:nth-child(3) { width: 100px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    button { padding:6px 10px; border:1px solid #bbb; background:#fff; border-radius:8px; cursor:pointer; }
    button:hover { background:#f5f5f5; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>실시간 차량현황(시트 뷰)</strong>
    <span class="timestamp" id="ts"></span>
    <button id="btnRefresh">새로고침</button>
  </div>

  <div class="grid">
    <div class="plant">
      <div class="plant-title">반월</div>
      <div id="left"></div>
    </div>
    <div class="plant">
      <div class="plant-title">시화</div>
      <div id="right"></div>
    </div>
  </div>

  <script>
    // ==== 본인 GAS 웹앱 exec URL로 교체 ====
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxlQLPPpvsWc-OmbHYAfeVfvKyqznP-XkH8aNYsVAC_QHuevc2BGMLmIVMkYkx_Bu-0/exec";

    const SECTIONS = ["제품 입차중","원료 하차중","원료 도착","부자재 입차중","컨테이너 입차중"];

    // 섹션별 시간 모드
    function timeModeFor(title){
      return (title === "원료 도착") ? "MS" : "HM";
    }

    // 시간 포맷터: 다양한 입력을 HH:MM 또는 MM:SS로 정리
    function formatTime(val, mode){
      if (val == null || val === "") return "";
      const s = String(val);

      // 1) HH:MM[:SS]
      let m = s.match(/(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (m){
        const HH=m[1], MM=m[2], SS=m[3]||"00";
        return mode==="MS" ? `${MM}:${SS}` : `${HH}:${MM}`;
      }

      // 2) ISO-like ...THH:MM[:SS]Z  (시트 날짜객체 직렬화)
      m = s.match(/T(\d{2}):(\d{2})(?::(\d{2}))?Z?$/);
      if (m){
        const HH=m[1], MM=m[2], SS=m[3]||"00";
        return mode==="MS" ? `${MM}:${SS}` : `${HH}:${MM}`;
      }

      // 3) 숫자만 (HHMMSS / HHMM / MMSS)
      const digits = s.replace(/\D/g, "");
      if (digits.length >= 6){
        const t6 = digits.slice(-6); // HHMMSS
        const HH=t6.slice(0,2), MM=t6.slice(2,4), SS=t6.slice(4,6);
        return mode==="MS" ? `${MM}:${SS}` : `${HH}:${MM}`;
      }
      if (digits.length === 4){
        const A=digits.slice(0,2), B=digits.slice(2,4);
        return `${A}:${B}`; // mode에 상관없이 두 자리:두 자리
      }
      return s;
    }

    function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    function tableHTML(title, rows) {
      const mode = timeModeFor(title);
      const hdr = `<tr><th>번호</th><th>차량번호</th><th>시간</th></tr>`;
      const body = rows && rows.length
        ? rows.map(r => {
            const no = esc(r[0]);
            const car = esc(r[1]);
            const t  = esc(formatTime(r[2], mode));
            return `<tr><td>${no}</td><td>${car}</td><td>${t}</td></tr>`;
          }).join("")
        : `<tr><td colspan="3" class="muted">데이터 없음</td></tr>`;
      return `<table>
        <colgroup><col><col><col></colgroup>
        <thead>${hdr}</thead><tbody>${body}</tbody></table>`;
    }

    function sectionHTML(title, data) {
      const count = data?.count || 0;
      const rows = data?.rows || [];
      return `<div class="section">
        <h3>${esc(title)} <span class="muted">(${count}대)</span></h3>
        ${tableHTML(title, rows)}
      </div>`;
    }

    function renderSide(container, side) {
      container.innerHTML = SECTIONS.map(t => sectionHTML(t, side?.[t])).join("");
    }

    async function load() {
      const tsEl = document.getElementById('ts');
      tsEl.textContent = "불러오는 중…";
      try {
        // 1차: fetch(JSON)
        const res = await fetch(WEBAPP_URL, { cache: "no-store", mode: "cors" });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        applyData(data);
      } catch (e) {
        // 2차: JSONP 폴백
        loadJSONP().catch(err => {
          tsEl.textContent = "불러오기 실패";
          alert("스냅샷 로드 실패: " + (err?.message || err || e.message));
        });
      }
    }

    function applyData(data){
      document.getElementById('ts').textContent = data.stamp ? `기준일: ${data.stamp}` : "";
      renderSide(document.getElementById('left'),  data.left);
      renderSide(document.getElementById('right'), data.right);
    }

    // JSONP 로더 (CORS 우회)
    function loadJSONP() {
      return new Promise((resolve, reject) => {
        const cbName = "__dy_cb_" + Date.now();
        const url = `${WEBAPP_URL}?callback=${cbName}&t=${Date.now()}`;
        const script = document.createElement('script');
        script.src = url;
        script.async = true;

        let done = false;
        window[cbName] = (data) => {
          if (done) return;
          done = true;
          try { delete window[cbName]; document.body.removeChild(script); } catch {}
          if (data && !data.error) { applyData(data); resolve(); }
          else { reject(new Error(data?.error || "JSONP 응답 오류")); }
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          try { delete window[cbName]; document.body.removeChild(script); } catch {}
          reject(new Error("JSONP 스크립트 로드 실패"));
        };

        document.body.appendChild(script);
      });
    }

    // 수동 새로고침만
    document.getElementById('btnRefresh').addEventListener('click', load);

    // 첫 로드
    load();
  </script>
</body>
</html>
