<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìì¬ ì‹ ì²­</title>
  <style>
  body { font-family: 'sans-serif'; background: #f7f7f7; text-align: center; padding: 1rem; margin: 0; }
  .hidden { display: none !important; }
  .step { margin-top: 1.5rem; }
  .button-list { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-bottom: 2rem; }
  button { padding: 0.6rem 1.2rem; font-size: 1rem; border-radius: 6px; border: none; background-color: #ddd; cursor: pointer; width: 70%; max-width: 300px; }
  button:hover { background-color: #4CAF50 !important; color: white; }
  .selected { background-color: #4CAF50 !important; color: white; font-weight: bold; }
  button:disabled { background-color: #ccc; color: #777; cursor: not-allowed; }
  .has-stock { background-color: #c8e6c9 !important; color: #1b5e20 !important; font-weight: bold; }
  .no-stock { background-color: #eeeeee !important; color: #777 !important; cursor: not-allowed; }
  #quantity-display { font-size: 2rem; margin-bottom: 1rem; font-weight: bold; }
  #viewPhotos, #goToTypeBtn { display: none; }
  #record-buttons:not(.hidden) { display: flex; justify-content: center; gap: 0.8rem; margin: 0.5rem 0 1rem 0; flex-wrap: wrap; }
  #loadingOverlay { z-index: 9999; }
  .quantity-flex-wrapper { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin: 2rem 0; }
  .numpad-container, .list-preview-container { border: 2px solid #ccc; background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex: 1 1 300px; max-width: 400px; min-width: 280px; }
  .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; margin: 1rem auto; width: fit-content; }
  .numpad-grid button { padding: 1rem; font-size: 1.5rem; border-radius: 10px; background: #e0e0e0; border: none; cursor: pointer; transition: background 0.2s; }
  .numpad-grid button:hover { background: #ccc; }
  #remarks { width: 100%; max-width: 400px; margin: 1.5rem auto 1rem auto; padding: 0.6rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; display: block; resize: none; }
  .step button { margin: 0.25rem; padding: 0.6rem 1rem; font-size: 1rem; border-radius: 8px; border: none; background: #ddd; cursor: pointer; }
  .step button:hover { background: #4CAF50; color: white; }
  button.back-btn { margin-top: 1.5rem; }
  #loadingText, #loginLoadingText, #submitLoadingText { margin-top: 1rem; font-size: 1.1rem; color: #444; }
  #submitOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 10001; }
  #submitOverlay span { background: white; padding: 20px 40px; border-radius: 12px; font-size: 1.3rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
  input { padding: 0.5rem; font-size: 1rem; margin: 0.5rem auto; width: 80%; max-width: 300px; display: block; }
  .list-preview-container { max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 1rem; border-radius: 10px; font-size: 0.95rem; }
  .list-item-row { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #e0e0e0; }
  .list-item-text { flex: 1; text-align: left; word-break: break-word; padding-right: 0.5rem; }
  .delete-btn { font-size: 0.8rem; background: transparent; border: none; color: #888; cursor: pointer; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; padding: 0; box-sizing: border-box; }
  #login-section input { padding: 1.00rem; font-size: 1.05rem; margin: 0.8rem auto; width: 80%; max-width: 300px; display: block; border-radius: 6px; border: 1px solid #ccc; }
  #login-section button { padding: 1.0rem 1.2rem; font-size: 1.05rem; margin-top: 1rem; border-radius: 8px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
  .delete-btn:hover { background: #ffe5e5; color: #d00; }
  .button-row { display: flex; justify-content: center; gap: 1rem; margin: 1rem auto; flex-wrap: wrap; }
  .half-btn { flex: 1 1 30%; max-width: 180px; min-width: 140px; padding: 0.6rem 0.8rem; font-size: 1rem; border: none; border-radius: 8px; background: #ddd; cursor: pointer; }
  .half-btn:hover { background: #4CAF50; color: white; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  .pulse { animation: pulse 0.6s ease-in-out 2; }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 0px rgba(255, 0, 0, 0.3); } 50% { box-shadow: 0 0 12px rgba(255, 0, 0, 0.7); } }
  .glow { animation: glow 1.2s ease-in-out 2; border: 2px solid #ff4444 !important; }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
  .bounce { animation: bounce 0.4s ease-in-out 2; }
  </style>
</head>
<body>
<!-- ì´ˆê¸° ë¡œë”© -->
<div id="initialLoadingOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:9999;color:white;font-size:1.4rem;">
  â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
</div>

<h2 id="title">ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ</h2>

<div id="record-buttons" class="hidden">
  <button onclick="openMyRecords()" style="font-size:0.9rem;font-weight:bold;background-color:#fff;color:#007bff;border:1px solid #007bff;border-radius:6px;padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='#fff'">ğŸ“„ ë‚´ ì‹ ì²­ ë‚´ì—­</button>
  <button onclick="openTeamRecords()" style="font-size:0.9rem;font-weight:bold;background-color:#fff;color:#28a745;border:1px solid #28a745;border-radius:6px;padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#eaffea'" onmouseout="this.style.background='#fff'">ğŸ‘¥ íŒ€ ì‹ ì²­ ë‚´ì—­</button>
</div>

<!-- ë¡œê·¸ì¸ -->
<div id="login-section">
  <div id="inlineNoticeBox" style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;margin:10px 0;border-radius:6px;color:#856404;font-size:0.9rem;display:none;white-space:pre-wrap;"></div>
  <p>ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
  <input id="empId" placeholder="ì‚¬ë²ˆ" />
  <input id="empName" placeholder="ì´ë¦„" />
  <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
  <div id="loginMsg"></div>
  <div id="loginLoadingText" class="hidden">ğŸ” ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<!-- ì‹ ì²­ í¼ -->
<div id="form-section" class="hidden">
  <!-- 1ë‹¨ê³„ -->
  <div id="step-category" class="step">
    <h3>1ë‹¨ê³„: ëŒ€ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="category-buttons" class="button-list"></div>
  </div>

  <!-- ì‚¬ì§„ ëª¨ë‹¬ -->
  <div id="photoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999;overflow:auto;">
    <div style="background:white;margin:40px auto;padding:20px;border-radius:10px;max-width:600px;">
      <span id="closeModal" style="position:fixed;top:20px;right:20px;font-size:28px;cursor:pointer;z-index:1000;background:white;padding:4px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">âœ–</span>
      <div id="photoContent"></div>
    </div>
  </div>

  <!-- 2ë‹¨ê³„ -->
  <div id="step-type" class="step hidden">
    <h3>2ë‹¨ê³„: ì¤‘ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="type-buttons" class="button-list"></div>
    <button type="button" id="viewPhotosType" style="background:#007bff;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:6px;">í•­ëª© ì‚¬ì§„ ë³´ê¸°</button>
    <div class="button-row">
      <button class="half-btn" onclick="goBackTo('category')">â¬… ë’¤ë¡œê°€ê¸°</button>
    </div>
  </div>

  <!-- 3ë‹¨ê³„ -->
  <div id="step-size" class="step hidden">
    <h3>3ë‹¨ê³„: ì†Œë¶„ë¥˜ ì„ íƒ</h3>
    <p style="font-size:0.85rem;color:#666;margin:0.5rem 0;">âš ï¸ ì¬ê³ ê°€ ì—†ë”ë¼ë„ ì„ íƒ í›„ ì‹ ì²­í•˜ì‹œë©´ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    <div id="size-buttons" class="button-list"></div>
    <div class="button-row">
      <button class="half-btn" onclick="goBackTo('type')">â¬… ë’¤ë¡œê°€ê¸°</button>
    </div>
  </div>

  <!-- 4ë‹¨ê³„ -->
  <div id="step-quantity" class="step hidden">
    <h3>4ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥</h3>
    <div class="numpad-container" style="margin:0 auto;">
      <div id="quantity-display">0</div>
      <div id="numpad" class="numpad-grid">
        <button onclick="appendQuantity('1')">1</button><button onclick="appendQuantity('2')">2</button><button onclick="appendQuantity('3')">3</button>
        <button onclick="appendQuantity('4')">4</button><button onclick="appendQuantity('5')">5</button><button onclick="appendQuantity('6')">6</button>
        <button onclick="appendQuantity('7')">7</button><button onclick="appendQuantity('8')">8</button><button onclick="appendQuantity('9')">9</button>
        <button onclick="clearQuantity()">C</button><button onclick="appendQuantity('0')">0</button><button onclick="backspaceQuantity()">â†</button>
      </div>
    </div>

    <textarea id="remarks" placeholder="ë¹„ê³  (ìš”ì²­ì‚¬í•­)" rows="2" style="width:100%;max-width:400px;margin:1.5rem auto 1rem auto;padding:0.6rem;font-size:1rem;border-radius:6px;border:1px solid #ccc;display:block;resize:none;"></textarea>

    <div class="button-row"><button class="half-btn" onclick="addItemToList()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button></div>

    <div class="list-preview-container" style="margin:0 auto;text-align:center;">
      <ul id="itemListPreview" style="display:inline-block;text-align:left;font-size:0.9rem;"></ul>
    </div>

    <p style="font-size:0.9rem;color:#666;margin-top:0.5rem;">ğŸ› ë‹´ì€ í•­ëª©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ <b>ì „ì²´ ì‹ ì²­í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

    <div class="button-row"><button class="half-btn" onclick="submitAllRequests()">âœ… ì „ì²´ ì‹ ì²­í•˜ê¸°</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('category')">ğŸ“¦ ë‹¤ë¥¸ ë¬¼í’ˆ ì¶”ê°€</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('size')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- ì„ íƒëœ í•­ëª© ë¦¬ìŠ¤íŠ¸ (ë¯¸ì‚¬ìš© í‘œì‹œìš©) -->
  <div id="selectedItems" class="step hidden">
    <h3>ğŸ“ ì„ íƒëœ í•­ëª© ë¦¬ìŠ¤íŠ¸</h3>
    <ul id="itemListDisplay"></ul>
  </div>

  <!-- ë‚´ì—­ ëª¨ë‹¬ -->
  <div id="myRecordsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
    <button onclick="closeMyRecords()" style="position:fixed;top:20px;right:20px;font-size:22px;font-weight:bold;border:none;background:none;cursor:pointer;color:white;z-index:10000;">âœ–</button>
    <div style="position:relative;margin:60px auto 0;background:white;padding:20px 24px 30px;border-radius:10px;max-width:800px;width:95%;max-height:80vh;overflow:auto;">
      <h3 style="margin-top:0;margin-bottom:15px;">ğŸ“„ ì‹ ì²­ ë‚´ì—­</h3>
      <table id="myRecordsTable" style="width:100%;font-size:14px;border-collapse:collapse;">
        <thead><tr></tr></thead><tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ========= ì„¤ì • =========
  const endpoint = 'https://script.google.com/macros/s/AKfycbyLCqxqnZCgVJAkLror-Cl5uG7CbJXgcB2gGc31WaxuS6s3Ur_nxKJpkdygKipn7clH/exec';

  // ========= ì „ì—­ ìƒíƒœ =========
  let loginInfo = { empId: '', empName: '' };
  let itemData = {};
  let zMeta = {}; // â˜… Z1 ë©”íƒ€ í†µì¼ë³¸ ì €ì¥
  let itemList = [];
  let selected = { category: '', type: '', size: '', zcode: '' }; // â˜… zcode ì €ì¥

  // ========= ë¡œê·¸ì¸ =========
  function handleLogin() {
    const empId = document.getElementById('empId').value.trim();
    const empName = document.getElementById('empName').value.trim();
    if (!empId || !empName) return alert("ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    document.getElementById('loginLoadingText').classList.remove('hidden');
    document.querySelector('#login-section button').style.display = 'none';

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ empId, empName })
    })
    .then(res => res.json())
    .then(async data => {
      document.getElementById('loginLoadingText').classList.add('hidden');

      if (data.result === 'success') {
        loginInfo = { empId, empName };
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        document.getElementById('title').innerText = "ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ";
        document.getElementById('record-buttons').classList.remove('hidden');
        document.getElementById('loadingOverlay').style.display = 'flex';

        // â˜… Z1 ë©”íƒ€(í†µì¼) ë°›ì•„ë‘ê¸°
        try {
          const meta = await fetch(`${endpoint}?mode=zinfo`).then(r=>r.json());
          zMeta = meta || {};
        } catch(e) { console.warn('zinfo ë¡œë“œ ì‹¤íŒ¨', e); }

        loadItems();
      } else {
        document.getElementById('loginMsg').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ';
        document.querySelector('#login-section button').style.display = 'inline-block';
      }
    })
    .catch(error => {
      document.getElementById('loginLoadingText').classList.add('hidden');
      document.getElementById('loginMsg').innerText = 'ì„œë²„ ì˜¤ë¥˜: ' + error.message;
      document.querySelector('#login-section button').style.display = 'block';
    });
  }

  // ========= ëª©ë¡ ë¡œë“œ =========
  function loadItems() {
    fetch(endpoint)
      .then(res => res.json())
      .then(data => {
        itemData = data;
        const container = document.getElementById('category-buttons');
        container.innerHTML = '';

        Object.keys(data).forEach(cat => {
          const btn = document.createElement('button');
          const activationCode = data[cat].activation; // Y / Z1 / Z2 / Z3

          // â˜… ë²„íŠ¼ ë¼ë²¨: Zê³„ì—´ì´ë©´ Z1 ì œëª© ê°•ì œ
          btn.innerText = (activationCode && activationCode.startsWith('Z'))
            ? (zMeta?.Z1?.title || cat)
            : cat;

          // ê°•ì¡° ìŠ¤íƒ€ì¼
          if (activationCode?.startsWith("Z")) {
            btn.style.backgroundColor = "#fff9c4";
            btn.style.color = "#f57f17";
            btn.style.fontWeight = "bold";
            btn.style.border = "1px solid #fbc02d";
          }

          btn.onclick = () => {
            selected.category = cat;            // í™”ë©´ í‚¤
            selected.zcode = activationCode || ''; // â˜… ë°±ì—”ë“œ ì „ì†¡ìš©

            if (activationCode?.startsWith("Z")) {
              // â˜… Z2/Z3ë„ Z1 ëª¨ë‹¬ë¡œ ë™ì¼ ë™ì‘
              openZ1Modal();
            } else {
              updateSelection(container, btn);
              selectCategory(cat);
            }
          };

          container.appendChild(btn);
        });

        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
      })
      .catch(error => {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
        alert('âŒ í•­ëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
      });
  }

  // ========= ë‹¨ê³„ ì´ë™ =========
  function selectCategory(cat) {
    const types = itemData[cat].types;
    const container = document.getElementById('type-buttons');
    container.innerHTML = '';
    types.forEach(type => {
      const btn = document.createElement('button');
      btn.innerText = type;
      btn.onclick = () => {
        selected.type = type;
        updateSelection(container, btn);
        selectType(type);
      };
      container.appendChild(btn);
    });
    showStep('type');
  }

  function selectType(type) {
    const container = document.getElementById('size-buttons');
    container.innerHTML = '';
    const stockMap = itemData[selected.category].stockMap;
    const sizeKeys = Object.keys(stockMap).filter(k => k.startsWith(type + '__'));

    sizeKeys.forEach(k => {
      const size = k.split('__')[1];
      const stock = stockMap[k];
      const btn = document.createElement('button');
      btn.innerText = `${size} (ì¬ê³ : ${stock})`;
      if (stock > 0) btn.classList.add('has-stock'); else btn.classList.add('no-stock');
      btn.onclick = () => {
        selected.size = size;
        updateSelection(container, btn);
        selectSize(size);
      };
      container.appendChild(btn);
    });

    showStep('size');
  }

  function selectSize(size) {
    showStep('quantity');
    const quantityBox = document.querySelector('.numpad-container');
    if (quantityBox) {
      quantityBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
      quantityBox.classList.add('glow');
      setTimeout(() => quantityBox.classList.remove('glow'), 1200);
    }
    const vp = document.getElementById("viewPhotos");
    if (vp) vp.style.display = "inline-block";
  }

  function showStep(step) {
    ['category','type','size','quantity'].forEach(s => document.getElementById('step-'+s).classList.add('hidden'));
    document.getElementById('step-'+step).classList.remove('hidden');
    const recordButtons = document.getElementById('record-buttons');
    if (step === 'category') recordButtons.classList.remove('hidden'); else recordButtons.classList.add('hidden');
  }
  function goBackTo(step) { showStep(step); }

  // ========= ì¥ë°”êµ¬ë‹ˆ =========
  function addItemToList() {
    const quantity = quantityValue;
    const remarks = document.getElementById('remarks').value;
    if (!quantity || parseInt(quantity) <= 0) return alert("ì‹ ì²­ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const stockKey = `${selected.type}__${selected.size}`;
    const currentStock = parseInt(itemData[selected.category]?.stockMap?.[stockKey] || "0", 10);
    const requestedQty = parseInt(quantity, 10);
    const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(requestedQty, currentStock);
    const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(0, requestedQty - currentStock);

    if (êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ > 0) {
      if (currentStock > 0) alert(`âš ï¸ í˜„ì¬ ${currentStock}ê°œë§Œ ì§€ê¸‰ ê°€ëŠ¥í•˜ë©°, ë‚˜ë¨¸ì§€ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œëŠ” êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
      else alert(`âš ï¸ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œ ì „ëŸ‰ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
    }

    const item = {
      name: `${loginInfo.empId} ${loginInfo.empName}`,
      category: selected.category,   // ì¼ë°˜í’ˆëª©ì€ ì¹´í…Œê³ ë¦¬ í‚¤(ì‹œíŠ¸ Bì—´)
      subcategory: selected.type,
      size: selected.size,
      quantity: requestedQty,
      remarks
    };

    itemList.push(item);
    renderItemList();

    quantityValue = "";
    updateQuantityDisplay();
    document.getElementById('remarks').value = '';

    const listBox = document.querySelector('.list-preview-container');
    listBox.classList.add('glow');
    setTimeout(() => listBox.classList.remove('glow'), 1200);

    const submitBtn = document.querySelector("button[onclick='submitAllRequests()']");
    setTimeout(() => {
      submitBtn.classList.add('glow');
      setTimeout(() => submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
      setTimeout(() => submitBtn.classList.remove('glow'), 1200);
    }, 1300);
  }

  function renderItemList() {
    const previewContainer = document.getElementById('itemListPreview');
    previewContainer.innerHTML = '';
    if (itemList.length === 0) {
      const empty = document.createElement('div');
      empty.innerText = "â• í•­ëª©ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      empty.style.textAlign = "center"; empty.style.color = "#aaa"; empty.style.padding = "1rem";
      previewContainer.appendChild(empty);
      return;
    }
    itemList.forEach((item, index) => {
      const row = document.createElement('div'); row.className = 'list-item-row';
      const text = document.createElement('div'); text.className = 'list-item-text';
      text.innerText = `${item.category} > ${item.subcategory} > ${item.size} - ${item.quantity}ê°œ` + (item.remarks ? ` (${item.remarks})` : '');
      const delBtn = document.createElement('button'); delBtn.className = 'delete-btn'; delBtn.innerText = 'âœ•';
      delBtn.onclick = () => { itemList.splice(index, 1); renderItemList(); };
      row.appendChild(text); row.appendChild(delBtn); previewContainer.appendChild(row);
    });
  }

  // ========= ì¼ê´„ ì‹ ì²­ =========
  async function submitAllRequests() {
    if (itemList.length === 0) return alert("ì‹ ì²­ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      for (const item of itemList) {
        const stockKey = `${item.subcategory}__${item.size}`;
        const stockMap = itemData[item.category]?.stockMap || {};
        const currentStock = parseInt(stockMap[stockKey]) || 0;
        const quantity = parseInt(item.quantity);
        const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(quantity, currentStock);
        const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(quantity - currentStock, 0);

        const payload = {
          name: item.name,
          category: item.category, // ì¼ë°˜í’ˆëª©(ë¹„Z)ì€ ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ë¡œ ì „ì†¡
          subcategory: item.subcategory,
          size: item.size,
          quantity,
          remarks: item.remarks,
          ì§€ê¸‰ìˆ˜ëŸ‰,
          êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰
        };

        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(payload)
        });
      }
      alert("âœ… ëª¨ë“  í•­ëª©ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } catch (error) {
      alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // ========= ìˆ«ì í‚¤íŒ¨ë“œ =========
  let quantityValue = "";
  function appendQuantity(num) {
    if (quantityValue.length < 4) {
      quantityValue += num; updateQuantityDisplay();
      document.querySelector('.numpad-container').classList.remove('glow');
      const addBtn = document.querySelector("button[onclick='addItemToList()']");
      addBtn.classList.add('glow'); setTimeout(() => addBtn.classList.remove('glow'), 1200);
    }
  }
  function clearQuantity() { quantityValue = ""; updateQuantityDisplay(); }
  function backspaceQuantity() { quantityValue = quantityValue.slice(0, -1); updateQuantityDisplay(); }
  function updateQuantityDisplay() { document.getElementById("quantity-display").innerText = quantityValue || "0"; }

  // ========= ì‚¬ì§„ ëª¨ë‹¬ =========
  document.getElementById("viewPhotosType").addEventListener("click", () => {
    const category = selected.category;
    if (!category) return alert("ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    document.getElementById("loadingOverlay").style.display = "flex";
    fetch(`${endpoint}?mode=photo`)
      .then(res => res.json())
      .then(photoMap => {
        const urls = photoMap[category];
        const container = document.getElementById("photoContent");
        container.innerHTML = "";
        if (!urls || urls.length === 0) container.innerHTML = "<p>í•´ë‹¹ í•­ëª©ì˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        else urls.forEach(url => {
          const fileName = url.split("/").pop().split(".")[0];
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "20px";
          wrapper.innerHTML = `<div style="font-weight:bold;margin-bottom:5px;">${fileName}</div><img src="${url}" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" />`;
          container.appendChild(wrapper);
        });
        document.getElementById("photoModal").style.display = "block";
      })
      .catch(err => alert("âŒ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message))
      .finally(() => document.getElementById("loadingOverlay").style.display = "none");
  });
  document.getElementById("closeModal").addEventListener("click", () => { document.getElementById("photoModal").style.display = "none"; });

  // ========= ê³µì§€ ë¡œë”© =========
  document.addEventListener("DOMContentLoaded", () => {
    const box = document.getElementById("inlineNoticeBox");
    const loading = document.getElementById("initialLoadingOverlay");
    fetch(`${endpoint}?mode=notice`)
      .then(res => res.json())
      .then(data => {
        const notice = data.notice?.trim();
        if (notice) { box.textContent = notice; box.style.display = "block"; }
      })
      .catch(err => console.warn("ê³µì§€ì‚¬í•­ ë¡œë”© ì‹¤íŒ¨:", err))
      .finally(() => { loading.style.display = 'none'; });
  });

  // ========= ë‚´ì—­ ë³´ê¸° =========
  function openMyRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';
    fetch(`${endpoint}?mode=myrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result !== "success") { document.getElementById('loadingOverlay').style.display = 'none'; alert("âŒ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10, 8]);
      })
      .catch(err => { document.getElementById('loadingOverlay').style.display = 'none'; alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message); })
      .finally(() => { document.getElementById('loadingOverlay').style.display = 'none'; });
  }

  function openTeamRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';
    fetch(`${endpoint}?mode=teamrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result === "forbidden") { document.getElementById('loadingOverlay').style.display = 'none'; alert("âš ï¸ íŒ€ ë‚´ì—­ ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (data.result !== "success") { document.getElementById('loadingOverlay').style.display = 'none'; alert("âŒ íŒ€ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10]);
      })
      .catch(err => { document.getElementById('loadingOverlay').style.display = 'none'; alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message); })
      .finally(() => { document.getElementById('loadingOverlay').style.display = 'none'; });
  }

  function renderRecordsTable(data, colIndexes) {
    const thead = document.querySelector("#myRecordsTable thead");
    const tbody = document.querySelector("#myRecordsTable tbody");
    thead.innerHTML = "<tr>" + colIndexes.map(i =>
      `<th style="border:1px solid #ccc; background:#f0f0f0; padding:4px; text-align:center;">${data.header[i]}</th>`
    ).join("") + "</tr>";

    tbody.innerHTML = data.records.map(row => {
      return "<tr>" + colIndexes.map(i =>
        `<td style="border:1px solid #ccc; padding:6px; text-align:center;">${i === 0 ? formatDate(row[i]) : row[i]}</td>`
      ).join("") + "</tr>";
    }).join("");

    document.getElementById("myRecordsModal").style.display = "flex";
  }
  function closeMyRecords() { document.getElementById("myRecordsModal").style.display = "none"; }
  function formatDate(raw) { const d = new Date(raw); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  function updateSelection(container, selectedBtn) {
    Array.from(container.children).forEach(btn => btn.classList.remove('selected'));
    selectedBtn.classList.add('selected');
    const nextBtn = document.getElementById('goToTypeBtn');
    if (nextBtn) { nextBtn.classList.add('pulse'); setTimeout(() => nextBtn.classList.remove('pulse'), 1000); }
  }

  // ========= Z1 ëª¨ë‹¬ =========
  function openZ1Modal() {
    const listContainer = document.getElementById("z1-item-list");
    listContainer.innerHTML = "";
    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v,i,self)=>self.indexOf(v)===i);
    if (names.length === 0) { listContainer.innerHTML = "<p>ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

    names.forEach(name => {
      const row = document.createElement("div");
      row.style.display = "flex"; row.style.alignItems = "center"; row.style.justifyContent = "space-between"; row.style.marginBottom = "10px";
      const inputId = `z1_qty_${name}`;
      row.innerHTML = `
        <div style="flex:1;">${name}</div>
        <input type="number" id="${inputId}" placeholder="ìˆ˜ëŸ‰" min="0" max="2" value="1"
               style="width:80px; text-align:center; border:1px solid #ccc; border-radius:6px; padding:4px;"
               onchange="adjustZ1Counts('${name}')">
      `;
      listContainer.appendChild(row);
    });

    document.getElementById("modalZ1").style.display = "block";
  }
  function closeZ1Modal() { document.getElementById("modalZ1").style.display = "none"; }

  // â˜… Z1 ì¦‰ì‹œ ì „ì†¡: categoryë¥¼ ë°˜ë“œì‹œ Zì½”ë“œë¡œ!
  async function submitZ1() {
    const remarks = document.getElementById("z1-remarks").value;
    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v,i,self)=>self.indexOf(v)===i);
    const itemsToSubmit = [];

    names.forEach(name => {
      const qtyInput = document.getElementById("z1_qty_" + name);
      const qty = parseInt(qtyInput?.value || "0");
      if (qty > 0) {
        itemsToSubmit.push({
          name: `${loginInfo.empId} ${loginInfo.empName}`,
          category: selected.zcode || 'Z1', // â˜… Z1/Z2/Z3 ì½”ë“œë¡œ ì „ì†¡
          subcategory: name,
          size: "ê°œ",
          quantity: qty,
          remarks
        });
      }
    });

    if (itemsToSubmit.length === 0) return alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      for (const item of itemsToSubmit) {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            name: item.name,
            category: item.category, // â˜… Zì½”ë“œ
            subcategory: item.subcategory,
            size: item.size,
            quantity: item.quantity,
            remarks: item.remarks,
            ì§€ê¸‰ìˆ˜ëŸ‰: item.quantity,
            êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
          })
        });
      }
      alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ1Modal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // Z1 ìˆ˜ëŸ‰ ì œí•œ ë¡œì§ (ì˜ˆì‹œ)
  function adjustZ1Counts(changedName) {
    const wall = document.getElementById("z1_qty_ë²½ê±¸ì´ ë‹¬ë ¥");
    const desk = document.getElementById("z1_qty_íƒìƒ ë‹¬ë ¥");
    const diary = document.getElementById("z1_qty_ë‹¤ì´ì–´ë¦¬");

    let wallVal = parseInt(wall?.value || "0");
    let deskVal = parseInt(desk?.value || "0");
    let diaryVal = parseInt(diary?.value || "0");

    wallVal = isNaN(wallVal) ? 0 : Math.max(0, wallVal);
    deskVal = isNaN(deskVal) ? 0 : Math.max(0, deskVal);
    diaryVal = isNaN(diaryVal) ? 0 : Math.max(0, diaryVal);

    if (diaryVal > 1) { diaryVal = 1; diary.value = 1; }
    if (wallVal + deskVal > 2) {
      if (changedName === "ë²½ê±¸ì´ ë‹¬ë ¥") { wallVal = Math.min(2, wallVal); deskVal = 2 - wallVal; desk.value = deskVal; wall.value = wallVal; }
      else if (changedName === "íƒìƒ ë‹¬ë ¥") { deskVal = Math.min(2, deskVal); wallVal = 2 - deskVal; wall.value = wallVal; desk.value = deskVal; }
    } else {
      if (wallVal > 2) { wallVal = 2; wall.value = 2; }
      if (deskVal > 2) { deskVal = 2; desk.value = 2; }
    }
  }
</script>

<!-- ì‹ ì²­ ì¤‘ ë¡œë”© -->
<div id="submitOverlay"><span>ğŸ“¤ ì‹ ì²­ ì¤‘ì…ë‹ˆë‹¤...</span></div>
<div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:9999;color:white;font-size:1.4rem;">â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>

<!-- Z1 ëª¨ë‹¬ -->
<div id="modalZ1" class="z-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:600px;width:90%;position:relative;">
    <button onclick="closeZ1Modal()" style="position:absolute;top:10px;right:10px;font-size:22px;background:none;border:none;cursor:pointer;line-height:1;">âœ–</button>
    <h3>ğŸ“… ì •ê¸° ì‹ ì²­ (Z ê³„ì—´)</h3>
    <p style="background:#fff3cd;padding:10px;border:1px solid #ffeeba;border-radius:6px;color:#856404;font-size:0.85rem;margin-bottom:10px;">
      <b>ğŸ“Œ ì‹ ì²­ ì•ˆë‚´</b><br/>
      ë²½ê±¸ì´ + íƒìƒ = ìµœëŒ€ 2ê°œ<br/>ë‹¤ì´ì–´ë¦¬ = 0ê°œ ë˜ëŠ” 1ê°œ ì‹ ì²­ ê°€ëŠ¥
    </p>
    <div id="z1-item-list"></div>
    <textarea id="z1-remarks" placeholder="ê³µí†µ ë¹„ê³  ì…ë ¥ (ì„ íƒ)" rows="2" style="width:100%;margin-top:10px;"></textarea>
    <button onclick="submitZ1()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

<!-- (Z2/Z3 ëª¨ë‹¬ì€ ì‚¬ìš© ì•ˆ í•¨. ë‚¨ê²¨ë‘¬ë„ ì—´ë¦¬ì§€ ì•ŠìŒ) -->

</body>
</html>
