<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìì¬ ì‹ ì²­</title>
  <style>
  body {
    font-family: 'sans-serif';
    background: #f7f7f7;
    text-align: center;
    padding: 1rem;
    margin: 0;
  }

  .hidden { display: none !important; }
  .step { margin-top: 1.5rem; }

  .button-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  button {
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background-color: #ddd;
    cursor: pointer;
    width: 70%;
    max-width: 300px;
  }
  button:hover { background-color: #4CAF50 !important; color: white; }
  .selected { background-color: #4CAF50 !important; color: white; font-weight: bold; }
  button:disabled { background-color: #ccc; color: #777; cursor: not-allowed; }

  .has-stock { background-color: #c8e6c9 !important; color: #1b5e20 !important; font-weight: bold; }
  .no-stock  { background-color: #eeeeee !important; color: #777 !important; }

  #quantity-display { font-size: 2rem; margin-bottom: 1rem; font-weight: bold; }

  #viewPhotos, #goToTypeBtn { display: none; }

  #record-buttons:not(.hidden) {
    display: flex;
    justify-content: center;
    gap: 0.8rem;
    margin: 0.5rem 0 1rem 0;
    flex-wrap: wrap;
  }

  /* ===== ë¡œê·¸ì¸ ë ˆì´ì•„ì›ƒ ë³µì› (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ì„¸ë¡œ ìŠ¤íƒ) ===== */
  #login-section { display: block; }
  #login-section input {
    padding: 1.00rem;
    font-size: 1.05rem;
    margin: 0.8rem auto;
    width: 80%;
    max-width: 300px;
    display: block;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #login-section button {
    padding: 1.0rem 1.2rem;
    font-size: 1.05rem;
    margin-top: 1rem;
    border-radius: 8px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    width: 80%;
    max-width: 300px;
  }

  #loadingOverlay { z-index: 9999; }
  #submitOverlay {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: rgba(0,0,0,0.4); display: none; justify-content: center;
    align-items: center; z-index: 10001;
  }
  #submitOverlay span {
    background: white; padding: 20px 40px; border-radius: 12px;
    font-size: 1.3rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .quantity-flex-wrapper {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin: 2rem 0;
  }
  .numpad-container, .list-preview-container {
    border: 2px solid #ccc; background: white; padding: 1rem; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex: 1 1 300px; max-width: 400px; min-width: 280px;
  }
  .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; margin: 1rem auto; width: fit-content; }
  .numpad-grid button { padding: 1rem; font-size: 1.5rem; border-radius: 10px; background: #e0e0e0; border: none; cursor: pointer; transition: background 0.2s; }
  .numpad-grid button:hover { background: #ccc; }

  #remarks {
    width: 100%; max-width: 400px; margin: 1.5rem auto 1rem auto; padding: 0.6rem;
    font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; display: block; resize: none;
  }

  .list-preview-container { max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 1rem; border-radius: 10px; font-size: 0.95rem; }
  .list-item-row { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #e0e0e0; }
  .list-item-text { flex: 1; text-align: left; word-break: break-word; padding-right: 0.5rem; }
  .delete-btn { font-size: 0.8rem; background: transparent; border: none; color: #888; cursor: pointer; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; padding: 0; box-sizing: border-box; }
  .delete-btn:hover { background: #ffe5e5; color: #d00; }

  .button-row { display: flex; justify-content: center; gap: 1rem; margin: 1rem auto; flex-wrap: wrap; }
  .half-btn { flex: 1 1 30%; max-width: 180px; min-width: 140px; padding: 0.6rem 0.8rem; font-size: 1rem; border: none; border-radius: 8px; background: #ddd; cursor: pointer; }
  .half-btn:hover { background: #4CAF50; color: white; }
  </style>
</head>
<body>

<!-- ì´ˆê¸° ë¡œë”© -->
<div id="initialLoadingOverlay" style="
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
  z-index: 9999; color: white; font-size: 1.4rem;">
  â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
</div>

<h2 id="title">ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ</h2>

<div id="record-buttons" class="hidden">
  <button onclick="openMyRecords()" style="
    font-size: 0.9rem; font-weight: bold; background-color: #fff; color: #007bff;
    border: 1px solid #007bff; border-radius: 6px; padding: 6px 12px; cursor: pointer;
    display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  " onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='#fff'">ğŸ“„ ë‚´ ì‹ ì²­ ë‚´ì—­</button>

  <button onclick="openTeamRecords()" style="
    font-size: 0.9rem; font-weight: bold; background-color: #fff; color: #28a745;
    border: 1px solid #28a745; border-radius: 6px; padding: 6px 12px; cursor: pointer;
    display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  " onmouseover="this.style.background='#eaffea'" onmouseout="this.style.background='#fff'">ğŸ‘¥ íŒ€ ì‹ ì²­ ë‚´ì—­</button>
</div>

<!-- ë¡œê·¸ì¸ -->
<div id="login-section">
  <div id="inlineNoticeBox" style="
    background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; margin: 10px 0;
    border-radius: 6px; color: #856404; font-size: 0.9rem; display: none; white-space: pre-wrap;"></div>

  <p>ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>

  <input id="empId" placeholder="ì‚¬ë²ˆ" />
  <input id="empName" placeholder="ì´ë¦„" />

  <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
  <div id="loginMsg"></div>

  <div id="loginLoadingText" class="hidden">ğŸ” ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<!-- í¼ -->
<div id="form-section" class="hidden">
  <!-- 1ë‹¨ê³„ -->
  <div id="step-category" class="step">
    <h3>1ë‹¨ê³„: ëŒ€ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="category-buttons" class="button-list"></div>
  </div>

  <!-- ì‚¬ì§„ ëª¨ë‹¬ -->
  <div id="photoModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:999;overflow:auto;">
    <div style="background:white;margin:40px auto;padding:20px;border-radius:10px;max-width:600px;">
      <span id="closeModal" style="position:fixed;top:20px;right:20px;font-size:28px;cursor:pointer;z-index:1000;background:white;padding:4px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">âœ–</span>
      <div id="photoContent"></div>
    </div>
  </div>

  <!-- 2ë‹¨ê³„ -->
  <div id="step-type" class="step hidden">
    <h3>2ë‹¨ê³„: ì¤‘ë¶„ë¥˜ ì„ íƒ</h3>
    <div id="type-buttons" class="button-list"></div>
    <button type="button" id="viewPhotosType" style="background:#007bff;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:6px;">í•­ëª© ì‚¬ì§„ ë³´ê¸°</button>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('category')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- 3ë‹¨ê³„ -->
  <div id="step-size" class="step hidden">
    <h3>3ë‹¨ê³„: ì†Œë¶„ë¥˜ ì„ íƒ</h3>
    <p style="font-size: 0.85rem; color: #666; margin: 0.5rem 0;">âš ï¸ ì¬ê³ ê°€ ì—†ë”ë¼ë„ ì„ íƒ í›„ ì‹ ì²­í•˜ì‹œë©´ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    <div id="size-buttons" class="button-list"></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('type')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- 4ë‹¨ê³„ -->
  <div id="step-quantity" class="step hidden">
    <h3>4ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥</h3>
    <div class="numpad-container" style="margin: 0 auto;">
      <div id="quantity-display">0</div>
      <div id="numpad" class="numpad-grid">
        <button onclick="appendQuantity('1')">1</button>
        <button onclick="appendQuantity('2')">2</button>
        <button onclick="appendQuantity('3')">3</button>
        <button onclick="appendQuantity('4')">4</button>
        <button onclick="appendQuantity('5')">5</button>
        <button onclick="appendQuantity('6')">6</button>
        <button onclick="appendQuantity('7')">7</button>
        <button onclick="appendQuantity('8')">8</button>
        <button onclick="appendQuantity('9')">9</button>
        <button onclick="clearQuantity()">C</button>
        <button onclick="appendQuantity('0')">0</button>
        <button onclick="backspaceQuantity()">â†</button>
      </div>
    </div>

    <textarea id="remarks" placeholder="ë¹„ê³  (ìš”ì²­ì‚¬í•­)" rows="2"></textarea>

    <div class="button-row"><button class="half-btn" onclick="addItemToList()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button></div>

    <div class="list-preview-container" style="margin: 0 auto; text-align: center;">
      <ul id="itemListPreview" style="display: inline-block; text-align: left; font-size: 0.9rem;"></ul>
    </div>

    <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">ğŸ› ë‹´ì€ í•­ëª©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ <b>ì „ì²´ ì‹ ì²­í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

    <div class="button-row"><button class="half-btn" onclick="submitAllRequests()">âœ… ì „ì²´ ì‹ ì²­í•˜ê¸°</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('category')">ğŸ“¦ ë‹¤ë¥¸ ë¬¼í’ˆ ì¶”ê°€</button></div>
    <div class="button-row"><button class="half-btn" onclick="goBackTo('size')">â¬… ë’¤ë¡œê°€ê¸°</button></div>
  </div>

  <!-- ì‹ ì²­ ë‚´ì—­ ëª¨ë‹¬ -->
  <div id="myRecordsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;">
    <button onclick="closeMyRecords()" style="position: fixed; top: 20px; right: 20px; font-size: 22px; font-weight: bold; border: none; background: none; cursor: pointer; color: white; z-index: 10000;">âœ–</button>
    <div style="position: relative; margin: 60px auto 0; background: white; padding: 20px 24px 30px; border-radius: 10px; max-width: 800px; width: 95%; max-height: 80vh; overflow: auto;">
      <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ“„ ì‹ ì²­ ë‚´ì—­</h3>
      <table id="myRecordsTable" style="width:100%; font-size: 14px; border-collapse: collapse;">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ì§„í–‰/ì €ì¥ ì¤‘ ì˜¤ë²„ë ˆì´ (ê³µí†µ) -->
<div id="submitOverlay"><span>ğŸ“¤ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</span></div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" style="
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.5); display: none; justify-content: center;
  align-items: center; z-index: 9999; color: white; font-size: 1.4rem;">
  â³ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
</div>

<!-- Z1 ëª¨ë‹¬ -->
<div id="modalZ1" class="z-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:600px;width:90%;position:relative;">
    <button onclick="closeZ1Modal()" style="position:absolute;top:10px;right:10px;font-size:22px;border:none;background:none;cursor:pointer;">âœ–</button>
    <h3>ğŸ“… ë‹¬ë ¥ / ë‹¤ì´ì–´ë¦¬ ì‹ ì²­</h3>
    <p style="background: #fff3cd; padding: 10px; border: 1px solid #ffeeba; border-radius: 6px; color: #856404; font-size: 0.85rem; margin-bottom: 10px;">
      <b>ğŸ“Œ ì‹ ì²­ ì•ˆë‚´</b><br />
      ë²½ê±¸ì´ + íƒìƒ = ìµœëŒ€ 2ê°œ<br />
      ë‹¤ì´ì–´ë¦¬ = 0ê°œ ë˜ëŠ” 1ê°œ ì‹ ì²­ ê°€ëŠ¥
    </p>
    <div id="z1-item-list"></div>
    <textarea id="z1-remarks" placeholder="ê³µí†µ ë¹„ê³  ì…ë ¥ (ì„ íƒ)" rows="2" style="width:100%; margin-top:10px;"></textarea>
    <button onclick="submitZ1()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

<!-- Z2 ëª…í•¨ ëª¨ë‹¬ (ê¸°ì¡´ UI ê·¸ëŒ€ë¡œ) -->
<div id="modalZ2" class="z-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:500px;position:relative;">
    <button onclick="closeZ2Modal()" style="position:absolute;top:10px;right:10px;font-size:20px;border:none;background:none;cursor:pointer;">âœ–</button>
    <h3>ğŸ“‡ ëª…í•¨ ì‹ ì²­</h3>
    <input id="z2-name"  placeholder="ì´ë¦„ (í‘œê¸°)" />
    <input id="z2-role"  placeholder="ì§ì±…" />
    <input id="z2-phone" placeholder="ì „í™”ë²ˆí˜¸" />
    <textarea id="z2-remarks" placeholder="ê¸°íƒ€ ìš”ì²­ì‚¬í•­" rows="2" style="width:100%;margin-top:10px;"></textarea>
    <button id="z2SubmitBtn" onclick="submitZ2()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

<!-- Z3 ëª¨ë‹¬ (ê¸°ì¡´ UI ê·¸ëŒ€ë¡œ) -->
<div id="modalZ3" class="z-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="background:white;margin:60px auto;padding:20px;border-radius:10px;max-width:500px;position:relative;">
    <button onclick="closeZ3Modal()" style="position:absolute;top:10px;right:10px;font-size:20px;border:none;background:none;cursor:pointer;">âœ–</button>
    <h3>ğŸ¦º ì•ˆì „ì¥ë¹„ ì‹ ì²­</h3>
    <select id="z3-item" style="width:100%;">
      <option value="">-- ì¥ë¹„ ì„ íƒ --</option>
      <option>ì•ˆì „í™”</option>
      <option>ê·€ë§ˆê°œ</option>
      <option>ë°©ì§„ë§ˆìŠ¤í¬</option>
    </select>
    <input id="z3-qty" type="number" placeholder="ìˆ˜ëŸ‰" />
    <textarea id="z3-remarks" placeholder="ë¹„ê³ " rows="2" style="width:100%;margin-top:10px;"></textarea>
    <button onclick="submitZ3()" style="margin-top:10px;">âœ… ì‹ ì²­í•˜ê¸°</button>
  </div>
</div>

<script>
  const endpoint = 'https://script.google.com/macros/s/AKfycbyLCqxqnZCgVJAkLror-Cl5uG7CbJXgcB2gGc31WaxuS6s3Ur_nxKJpkdygKipn7clH/exec';

  let loginInfo = { empId: '', empName: '' };
  let itemData = {};
  let selected = { category: '', type: '', size: '', zcode: '' };
  let itemList = [];
  let quantityValue = "";

  function handleLogin() {
    const empId = document.getElementById('empId').value.trim();
    const empName = document.getElementById('empName').value.trim();
    if (!empId || !empName) return alert("ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    document.getElementById('loginLoadingText').classList.remove('hidden');
    document.querySelector('#login-section button').style.display = 'none';

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ empId, empName })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('loginLoadingText').classList.add('hidden');

      if (data.result === 'success') {
        loginInfo = { empId, empName };
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        document.getElementById('title').innerText = "ğŸ” ì‹ ì²­Â·ì¡°ì‚¬ ì‹œìŠ¤í…œ";
        document.getElementById('record-buttons').classList.remove('hidden');
        document.getElementById('loadingOverlay').style.display = 'flex';

        loadItems();
      } else {
        document.getElementById('loginMsg').innerText = 'ë¡œê·¸ì¸ ì‹¤íŒ¨ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ';
        document.querySelector('#login-section button').style.display = 'inline-block';
      }
    })
    .catch(error => {
      document.getElementById('loginLoadingText').classList.add('hidden');
      document.getElementById('loginMsg').innerText = 'ì„œë²„ ì˜¤ë¥˜: ' + error.message;
      document.querySelector('#login-section button').style.display = 'block';
    });
  }

  function loadItems() {
    fetch(endpoint)
      .then(res => res.json())
      .then(data => {
        itemData = data;
        const container = document.getElementById('category-buttons');
        container.innerHTML = '';

        Object.keys(data).forEach(cat => {
          const btn = document.createElement('button');
          btn.innerText = cat;

          const activationCode = data[cat].activation; // Y/Z1/Z2/Z3
          if (activationCode?.startsWith("Z")) {
            btn.style.backgroundColor = "#fff9c4";
            btn.style.color = "#f57f17";
            btn.style.fontWeight = "bold";
            btn.style.border = "1px solid #fbc02d";
          }

          btn.onclick = () => {
            selected.category = cat;
            selected.zcode = activationCode || '';

            if (activationCode === "Z1") openZ1Modal();
            else if (activationCode === "Z2") openZ2Modal();
            else if (activationCode === "Z3") openZ3Modal();
            else {
              updateSelection(container, btn);
              selectCategory(cat);
            }
          };

          container.appendChild(btn);
        });

        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
      })
      .catch(error => {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
        alert('âŒ í•­ëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
      });
  }

  function selectCategory(cat) {
    const types = itemData[cat].types;
    const container = document.getElementById('type-buttons');
    container.innerHTML = '';

    types.forEach(type => {
      const btn = document.createElement('button');
      btn.innerText = type;
      btn.onclick = () => {
        selected.type = type;
        updateSelection(container, btn);
        selectType(type);
      };
      container.appendChild(btn);
    });

    showStep('type');
  }

  function selectType(type) {
    const container = document.getElementById('size-buttons');
    container.innerHTML = '';
    const stockMap = itemData[selected.category].stockMap;
    const sizeKeys = Object.keys(stockMap).filter(k => k.startsWith(type + '__'));

    sizeKeys.forEach(k => {
      const size = k.split('__')[1];
      const stock = stockMap[k];
      const btn = document.createElement('button');
      btn.innerText = `${size} (ì¬ê³ : ${stock})`;

      if (stock > 0) btn.classList.add('has-stock');
      else btn.classList.add('no-stock');

      btn.onclick = () => {
        selected.size = size;
        updateSelection(container, btn);
        selectSize(size);
      };

      container.appendChild(btn);
    });

    showStep('size');
  }

  function selectSize() { showStep('quantity'); }

  function showStep(step) {
    ['category', 'type', 'size', 'quantity'].forEach(s => {
      document.getElementById('step-' + s).classList.add('hidden');
    });
    document.getElementById('step-' + step).classList.remove('hidden');

    const recordButtons = document.getElementById('record-buttons');
    if (step === 'category') recordButtons.classList.remove('hidden');
    else recordButtons.classList.add('hidden');
  }

  function goBackTo(step) { showStep(step); }

  function addItemToList() {
    const quantity = quantityValue;
    const remarks = document.getElementById('remarks').value;

    if (!quantity || parseInt(quantity) <= 0) {
      alert("ì‹ ì²­ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const stockKey = `${selected.type}__${selected.size}`;
    const currentStock = parseInt(itemData[selected.category]?.stockMap?.[stockKey] || "0", 10);
    const requestedQty = parseInt(quantity, 10);

    const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(requestedQty, currentStock);
    const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(0, requestedQty - currentStock);

    if (êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ > 0) {
      if (currentStock > 0) alert(`âš ï¸ í˜„ì¬ ${currentStock}ê°œë§Œ ì§€ê¸‰ ê°€ëŠ¥í•˜ë©°, ë‚˜ë¨¸ì§€ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œëŠ” êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
      else alert(`âš ï¸ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ ${êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰}ê°œ ì „ëŸ‰ êµ¬ë§¤ ìš”ì²­ìœ¼ë¡œ ì ‘ìˆ˜ë©ë‹ˆë‹¤.`);
    }

    const item = {
      name: `${loginInfo.empId} ${loginInfo.empName}`,
      category: selected.category,
      subcategory: selected.type,
      size: selected.size,
      quantity: requestedQty,
      remarks
    };

    itemList.push(item);
    renderItemList();

    quantityValue = "";
    updateQuantityDisplay();
    document.getElementById('remarks').value = '';
  }

  function renderItemList() {
    const previewContainer = document.getElementById('itemListPreview');
    previewContainer.innerHTML = '';

    if (itemList.length === 0) {
      const empty = document.createElement('div');
      empty.innerText = "â• í•­ëª©ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      empty.style.textAlign = "center";
      empty.style.color = "#aaa";
      empty.style.padding = "1rem";
      previewContainer.appendChild(empty);
      return;
    }

    itemList.forEach((item, index) => {
      const row = document.createElement('div');
      row.className = 'list-item-row';

      const text = document.createElement('div');
      text.className = 'list-item-text';
      text.innerText = `${item.category} > ${item.subcategory} > ${item.size} - ${item.quantity}ê°œ` + (item.remarks ? ` (${item.remarks})` : '');

      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.innerText = 'âœ•';
      delBtn.onclick = () => { itemList.splice(index, 1); renderItemList(); };

      row.appendChild(text);
      row.appendChild(delBtn);
      previewContainer.appendChild(row);
    });
  }

  async function submitAllRequests() {
    if (itemList.length === 0) {
      alert("ì‹ ì²­ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      for (const item of itemList) {
        const stockKey = `${item.subcategory}__${item.size}`;
        const stockMap = itemData[item.category]?.stockMap || {};
        const currentStock = parseInt(stockMap[stockKey]) || 0;
        const quantity = parseInt(item.quantity);
        const ì§€ê¸‰ìˆ˜ëŸ‰ = Math.min(quantity, currentStock);
        const êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰ = Math.max(quantity - currentStock, 0);

        const payload = {
          name: item.name,
          category: item.category, // ë¼ë²¨
          subcategory: item.subcategory,
          size: item.size,
          quantity,
          remarks: item.remarks,
          ì§€ê¸‰ìˆ˜ëŸ‰,
          êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰
        };

        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(payload)
        });
      }

      alert("âœ… ëª¨ë“  í•­ëª©ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } catch (error) {
      alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  let isSubmittingZ2 = false; // â˜… Z2 ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸

  // ===== Z1 =====
  function openZ1Modal() {
    const listContainer = document.getElementById("z1-item-list");
    listContainer.innerHTML = "";

    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v, i, self) => self.indexOf(v) === i);

    if (names.length === 0) {
      listContainer.innerHTML = "<p>ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }

    names.forEach(name => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.marginBottom = "10px";

      const inputId = `z1_qty_${name}`;
      row.innerHTML = `
        <div style="flex:1;">${name}</div>
        <input type="number" id="${inputId}" placeholder="ìˆ˜ëŸ‰" min="0" max="2" value="1"
               style="width:80px; text-align:center; border:1px solid #ccc; border-radius:6px; padding:4px;">
      `;
      listContainer.appendChild(row);
    });

    document.getElementById("modalZ1").style.display = "block";
  }
  function closeZ1Modal() { document.getElementById("modalZ1").style.display = "none"; }

  async function submitZ1() {
    const remarks = document.getElementById("z1-remarks").value;
    const stockMap = itemData[selected.category]?.stockMap || {};
    const names = Object.keys(stockMap).map(k => k.split("__")[0]).filter((v,i,self)=>self.indexOf(v)===i);
    const itemsToSubmit = [];

    names.forEach(name => {
      const qtyInput = document.getElementById("z1_qty_" + name);
      const qty = parseInt(qtyInput?.value || "0");
      if (qty > 0) {
        itemsToSubmit.push({
          name: `${loginInfo.empId} ${loginInfo.empName}`,
          category: selected.category,           // ë¼ë²¨
          subcategory: name,
          size: "ê°œ",
          quantity: qty,
          remarks
        });
      }
    });

    if (itemsToSubmit.length === 0) return alert("ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      for (const item of itemsToSubmit) {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            name: item.name,
            category: item.category, // ë¼ë²¨
            subcategory: item.subcategory,
            size: item.size,
            quantity: item.quantity,
            remarks: item.remarks,
            ì§€ê¸‰ìˆ˜ëŸ‰: item.quantity,
            êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
          })
        });
      }
      alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ1Modal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // ===== Z2 (ëª…í•¨) â€” ì¤‘ë³µ í´ë¦­ ë°©ì§€ + ì¤‘ì•™ ì˜¤ë²„ë ˆì´ í‘œì‹œ =====
  function openZ2Modal() { document.getElementById("modalZ2").style.display = "block"; }
  function closeZ2Modal() { document.getElementById("modalZ2").style.display = "none"; }

  async function submitZ2() {
    if (isSubmittingZ2) return; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
    const subcategory = document.getElementById("z2-name").value;
    const size = document.getElementById("z2-role").value;
    const phone = document.getElementById("z2-phone").value;
    const remarks = document.getElementById("z2-remarks").value;

    if (!subcategory || !size || !phone) {
      alert("ì´ë¦„, ì§ì±…, ì „í™”ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const item = {
      name: `${loginInfo.empId} ${loginInfo.empName}`,
      category: selected.category,  // ë¼ë²¨
      subcategory,
      size,
      quantity: 1,
      remarks: `ì „í™”: ${phone}, ${remarks}`
    };

    const btn = document.getElementById('z2SubmitBtn');
    isSubmittingZ2 = true;
    if (btn) btn.disabled = true;
    document.getElementById('submitOverlay').style.display = 'flex'; // â˜… ì¤‘ì•™ ì˜¤ë²„ë ˆì´

    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          name: item.name,
          category: item.category,  // ë¼ë²¨
          subcategory: item.subcategory,
          size: item.size,
          quantity: item.quantity,
          remarks: item.remarks,
          ì§€ê¸‰ìˆ˜ëŸ‰: item.quantity,
          êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
        })
      });

      alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ2Modal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
      if (btn) btn.disabled = false;
      isSubmittingZ2 = false;
    }
  }

  // ===== Z3 (ê¸°ì¡´ UI) =====
  function openZ3Modal() { document.getElementById("modalZ3").style.display = "block"; }
  function closeZ3Modal() { document.getElementById("modalZ3").style.display = "none"; }

  async function submitZ3() {
    const subcategory = document.getElementById("z3-item").value;
    const quantity = document.getElementById("z3-qty").value;
    const remarks = document.getElementById("z3-remarks").value;

    if (!subcategory || !quantity) {
      alert("ì¥ë¹„ëª…ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    document.getElementById('submitOverlay').style.display = 'flex';

    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          name: `${loginInfo.empId} ${loginInfo.empName}`,
          category: selected.category,     // ë¼ë²¨
          subcategory: subcategory,
          size: "ê¸°ë³¸",
          quantity,
          remarks,
          ì§€ê¸‰ìˆ˜ëŸ‰: quantity,
          êµ¬ë§¤ìš”ì²­ìˆ˜ëŸ‰: 0
        })
      });

      alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeZ3Modal();
    } catch (err) {
      alert("âŒ ì‹ ì²­ ì‹¤íŒ¨: " + err.message);
    } finally {
      document.getElementById('submitOverlay').style.display = 'none';
    }
  }

  // ê³µí†µ ë¶€ê°€ê¸°ëŠ¥
  document.getElementById("viewPhotosType").addEventListener("click", () => {
    const category = selected.category;
    if (!category) return alert("ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

    document.getElementById("loadingOverlay").style.display = "flex";
    fetch(`${endpoint}?mode=photo`)
      .then(res => res.json())
      .then(photoMap => {
        const urls = photoMap[category];
        const container = document.getElementById("photoContent");
        container.innerHTML = "";

        if (!urls || urls.length === 0) {
          container.innerHTML = "<p>í•´ë‹¹ í•­ëª©ì˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        } else {
          urls.forEach(url => {
            const fileName = url.split("/").pop().split(".")[0];
            const wrapper = document.createElement("div");
            wrapper.style.marginBottom = "20px";
            wrapper.innerHTML = `
              <div style="font-weight:bold;margin-bottom:5px;">${fileName}</div>
              <img src="${url}" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" />
            `;
            container.appendChild(wrapper);
          });
        }

        document.getElementById("photoModal").style.display = "block";
      })
      .catch(err => { alert("âŒ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message); })
      .finally(() => { document.getElementById("loadingOverlay").style.display = "none"; });
  });
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("photoModal").style.display = "none";
  });

  document.addEventListener("DOMContentLoaded", () => {
    const box = document.getElementById("inlineNoticeBox");
    const loading = document.getElementById("initialLoadingOverlay");

    fetch(`${endpoint}?mode=notice`)
      .then(res => res.json())
      .then(data => {
        const notice = data.notice?.trim();
        if (notice) { box.textContent = notice; box.style.display = "block"; }
      })
      .catch(() => {})  // ê³µì§€ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
      .finally(() => { loading.style.display = 'none'; });
  });

  function openMyRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';

    fetch(`${endpoint}?mode=myrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result !== "success") {
          document.getElementById('loadingOverlay').style.display = 'none';
          alert("âŒ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10, 8]);
      })
      .catch(err => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
      })
      .finally(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      });
  }

  function openTeamRecords() {
    const empId = loginInfo.empId;
    document.getElementById('loadingOverlay').style.display = 'flex';

    fetch(`${endpoint}?mode=teamrecords&empId=${encodeURIComponent(empId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.result === "forbidden") {
          document.getElementById('loadingOverlay').style.display = 'none';
          alert("âš ï¸ íŒ€ ë‚´ì—­ ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (data.result !== "success") {
          document.getElementById('loadingOverlay').style.display = 'none';
          alert("âŒ íŒ€ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        renderRecordsTable(data, [0, 2, 4, 5, 6, 9, 10]);
      })
      .catch(err => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
      })
      .finally(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      });
  }

  function renderRecordsTable(data, colIndexes) {
    const thead = document.querySelector("#myRecordsTable thead");
    const tbody = document.querySelector("#myRecordsTable tbody");
    thead.innerHTML = "<tr>" + colIndexes.map(i =>
      `<th style="border:1px solid #ccc; background:#f0f0f0; padding:4px; text-align:center;">${data.header[i]}</th>`
    ).join("") + "</tr>";

    tbody.innerHTML = data.records.map(row => {
      return "<tr>" + colIndexes.map(i =>
        `<td style="border:1px solid #ccc; padding:6px; text-align:center;">${i === 0 ? formatDate(row[i]) : row[i]}</td>`
      ).join("") + "</tr>";
    }).join("");

    document.getElementById("myRecordsModal").style.display = "flex";
  }

  function closeMyRecords() { document.getElementById("myRecordsModal").style.display = "none"; }
  function formatDate(raw) { const d = new Date(raw); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function updateQuantityDisplay() { document.getElementById("quantity-display").innerText = quantityValue || "0"; }
  function appendQuantity(num) { if (quantityValue.length < 4) { quantityValue += num; updateQuantityDisplay(); } }
  function clearQuantity() { quantityValue = ""; updateQuantityDisplay(); }
  function backspaceQuantity() { quantityValue = quantityValue.slice(0, -1); updateQuantityDisplay(); }
  function updateSelection(container, selectedBtn) { Array.from(container.children).forEach(btn => btn.classList.remove('selected')); selectedBtn.classList.add('selected'); }
</script>

</body>
</html>
