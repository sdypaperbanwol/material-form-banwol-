<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1
<title>개인 근태 조회</title>
<style>
:root{--ink:#222;--muted:#666;--line:#e5e7eb;--bg:#f7f8fa;--card:#fff;--shadow:0 6px 18px rgba(0,0,0,.06)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.err{padding:14px 16px;border-left:4px solid #ef4444;background:#fff0f0;color:#991b1b;margin-bottom:12px}
.top{display:grid;gap:12px;margin-bottom:16px}
.zcard{padding:12px 14px}
.profile{padding:16px;display:flex;justify-content:space-between;gap:16px}
.h1{margin:0 0 4px;font-size:18px}
.meta{color:var(--muted);font-size:13px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3ff;color:#2651ff;font-weight:600;font-size:12px;margin-left:8px}
.right{color:#666;font-size:12px}
.tblwrap{overflow:auto;margin-top:16px}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{background:#fbfbfd;font-weight:700;white-space:pre-line;border-top:1px solid var(--line);border-bottom:1px solid var(--line);border-left:1px solid var(--line);padding:10px 8px}
thead th:last-child{border-right:1px solid var(--line)}
thead tr.thead1 th{position:sticky;top:0;z-index:2}
thead tr.thead2 th{position:sticky;top:38px;z-index:2}
.subsum{display:block;font-weight:600;color:#3b82f6;margin-top:2px}
tbody td{padding:8px 8px;white-space:pre-line;border-bottom:1px solid var(--line);border-left:1px solid var(--line)}
tbody td:last-child{border-right:1px solid var(--line)}
tbody tr:nth-child(odd) td{background:#fcfcff}
th.center,td.center{text-align:center}
/* === 모바일에서만 세로 헤더 & 특이사항 넓게 === */
/* 모바일에서만: 메트릭 헤더 두 줄 표기 + 특이사항은 가로로 넓게 */
/* 모바일: 메트릭 헤더 무조건 두 줄 + 칸 폭 고정 + 합계/숫자 크기 축소 */
@media (max-width: 640px) {
  /* 헤더 두 줄 강제 */
  th.metric .full { display: none !important; }
  th.metric .two  { display: inline-grid !important; grid-auto-rows: auto; gap: 2px; line-height: 1; text-align: center; }
  th.metric .two .t, th.metric .two .b { display: block; }

  /* 칸 폭/여백 살짝 타이트하게 */
  th.metric { min-width: 34px; max-width: 38px; padding-top: 8px; padding-bottom: 8px; }

  /* 합계 숫자(파란 괄호) 조금 작게 */
  th.metric .subsum { display:block; margin-top:4px; font-weight:600; font-size: 11px; }

  /* 본문 숫자도 작게 */
  td.metric { font-size: 12px; padding: 6px 4px; }

  /* 특이사항은 가로로 넓게 유지 */
  th.note, td.note { writing-mode: horizontal-tb; min-width: 240px; }
}

/* 데스크톱 기본: 전체 표시는 원래대로 */
th.metric .full { display: inline; }
th.metric .two  { display: none; }



  
</style>
</head>
<body>
  <div class="wrap">
    <div id="error" class="card err" style="display:none"></div>
    <div class="top" id="zbox"></div>
    <div class="card profile" id="pbox" style="display:none">
      <div>
        <div class="h1" id="pname"></div>
        <div class="meta" id="pmeta"></div>
      </div>
      <div class="right" id="pupdated"></div>
    </div>
    <div class="card tblwrap" id="tblwrap"></div>
  </div>

<script>
  // 최신 exec로 교체
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgBGe31WtHQV8iLkr2q8zYU_zwY6eycnkFi75K2XjuttE6durflslQeDkzpXB0c_Gwbw/exec';

  const q   = new URLSearchParams(location.search);
  const emp = q.get('emp') || '';
  const sig = q.get('sig') || '';

  const COL = {
    DATE: 1, TYPE: 4, W_IN: 5, W_OUT: 6, M_IN: 7, M_OUT: 8,
    J: 9, K: 10, L: 11, M: 12, N: 13, O: 14, P: 15, NOTE_U: 20
  };

  (async function load(){
    if(!emp){ return showError('잘못된 접근(emp 누락)'); }
    try{
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action:'workhour_read', emp, sig })
      });
      const data = await res.json();
      if (!data || !data.ok) throw new Error(data && data.error || 'BAD_PAYLOAD');
      render(data);
    }catch(e){
      const map = {
        'BAD_SIGNATURE':'서명 오류(BAD_SIGNATURE)',
        'NOT_FOUND':'대상자 없음(NOT_FOUND)',
        'BAD_PAYLOAD':'데이터 로드 실패'
      };
      showError(map[e.message] || ('네트워크 오류: ' + e.message));
    }
  })();

  function render(res){
    const z = (res.zHeader||[]).filter(v => !looksLikeSecret(v));
    document.getElementById('zbox').innerHTML = z.map(v => '<div class="zcard">'+esc(v||'')+'</div>').join('');

    const p = res.person||{};
    document.getElementById('pname').innerHTML =
      `${esc(p.name||'-')} <span class="badge">사번 ${esc(p.emp||'-')}</span>`;
    document.getElementById('pmeta').textContent =
      `연락처: ${p.tel||'-'} · 파트: ${p.part||'-'} · 직책: ${p.role||'-'}`;
    document.getElementById('pupdated').textContent = res.updated || '';
    document.getElementById('pbox').style.display = '';

    buildTable(res.rows||[]);
  }

  function buildTable(rows){
    const box = document.getElementById('tblwrap');
    if(!rows.length){
      box.innerHTML = '<div style="padding:28px;color:#666">표시할 데이터 없음</div>';
      return;
    }
    const sorted = [...rows].sort((a,b) =>
      String(a[COL.DATE]||'2100-12-31').localeCompare(String(b[COL.DATE]||'2100-12-31'))
    );
    const sum = {J:0,K:0,L:0,M:0,N:0,O:0,P:0};
    sorted.forEach(r=>{
      sum.J+=toNum(r[COL.J]); sum.K+=toNum(r[COL.K]); sum.L+=toNum(r[COL.L]);
      sum.M+=toNum(r[COL.M]); sum.N+=toNum(r[COL.N]); sum.O+=toNum(r[COL.O]); sum.P+=toNum(r[COL.P]);
    });

const headRow1 =
  '<tr class="thead1">' +
    '<th class="center" rowspan="2">날짜</th>' +
    '<th rowspan="2">근무 형태</th>' +

    // ▼ 메트릭 7칸을 먼저 배치
    `<th class="center metric" rowspan="2">
       <span class="full">정규</span>
       <span class="two"><span class="t">정</span><span class="b">규</span></span>
       <span class="subsum">(${fmt(sum.J)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">연장</span>
       <span class="two"><span class="t">연</span><span class="b">장</span></span>
       <span class="subsum">(${fmt(sum.K)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">야근</span>
       <span class="two"><span class="t">야</span><span class="b">근</span></span>
       <span class="subsum">(${fmt(sum.L)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">휴일</span>
       <span class="two"><span class="t">휴</span><span class="b">일</span></span>
       <span class="subsum">(${fmt(sum.M)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">휴연</span>
       <span class="two"><span class="t">휴</span><span class="b">연</span></span>
       <span class="subsum">(${fmt(sum.N)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">유급</span>
       <span class="two"><span class="t">유</span><span class="b">급</span></span>
       <span class="subsum">(${fmt(sum.O)})</span>
     </th>` +
    `<th class="center metric" rowspan="2">
       <span class="full">주휴</span>
       <span class="two"><span class="t">주</span><span class="b">휴</span></span>
       <span class="subsum">(${fmt(sum.P)})</span>
     </th>` +

    // ▼ 출퇴근 그룹을 뒤로
    '<th class="center" colspan="2">비콘</th>' +
    '<th class="center" colspan="2">수정</th>' +

    '<th class="note" rowspan="2">특이사항</th>' +
  '</tr>';

const headRow2 =
  '<tr class="thead2">' +
    '<th class="center">출근</th><th class="center">퇴근</th>' +
    '<th class="center">출근</th><th class="center">퇴근</th>' +
  '</tr>';


  
 const body = sorted.map(r=>{
  const cells = [
    safe(r[COL.DATE]), safe(r[COL.TYPE]),
    safe(r[COL.W_IN]), safe(r[COL.W_OUT]),
    safe(r[COL.M_IN]), safe(r[COL.M_OUT]),
    hideZero(r[COL.J]), hideZero(r[COL.K]), hideZero(r[COL.L]),
    hideZero(r[COL.M]), hideZero(r[COL.N]), hideZero(r[COL.O]), hideZero(r[COL.P]),
    safe(r[COL.NOTE_U])
  ];
  return (
    '<tr>' +
      // 기본
      `<td class="center">${esc(cells[0])}</td>` +
      `<td>${esc(cells[1])}</td>` +

      // ▼ 메트릭 7칸(J~P)을 먼저
      `<td class="center metric">${esc(cells[6])}</td>` +
      `<td class="center metric">${esc(cells[7])}</td>` +
      `<td class="center metric">${esc(cells[8])}</td>` +
      `<td class="center metric">${esc(cells[9])}</td>` +
      `<td class="center metric">${esc(cells[10])}</td>` +
      `<td class="center metric">${esc(cells[11])}</td>` +
      `<td class="center metric">${esc(cells[12])}</td>` +

      // ▼ 출퇴근(비콘 F,G → 수정 H,I)
      `<td class="center">${esc(cells[2])}</td>` +  // 비콘 출근
      `<td class="center">${esc(cells[3])}</td>` +  // 비콘 퇴근
      `<td class="center">${esc(cells[4])}</td>` +  // 수정 출근
      `<td class="center">${esc(cells[5])}</td>` +  // 수정 퇴근

      // 특이사항
      `<td class="note">${linkify(cells[13])}</td>` +
    '</tr>'
  );
}).join('');




    document.getElementById('tblwrap').innerHTML =
      '<table><thead>'+ headRow1 + headRow2 +'</thead><tbody>'+ body +'</tbody></table>';
  }

  // 유틸
  function toNum(v){ const t=String(v??'').replace(/[,. ]/g,'').trim(); return (t===''||isNaN(Number(t)))?0:Number(t); }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function hideZero(v){ const t=String(v??'').trim(); return (t===''||/^0+(\.0+)?$/.test(t))?'':t; }
  function safe(v){ return (v==null)?'':String(v); }
  function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function looksLikeSecret(v){
    if(!v) return false;
    const t=String(v).trim();
    if(t.includes('::')) return true;
    if(/^[A-Fa-f0-9]{32,}$/.test(t)) return true;
    if(/^[A-Za-z0-9_-]{28,}$/.test(t)) return true;
    return false;
  }
  function showError(m){ const e=document.getElementById('error'); e.textContent=m; e.style.display='block'; }
  function linkify(v){
    const t=(v||'').trim();
    if(!t) return '';
    try{
      const u=new URL(t);
      return `<a href="${esc(u.href)}" target="_blank" rel="noopener">${esc(u.href)}</a>`;
    }catch(_){ return esc(t); }
  }
</script>
</body>
</html>
