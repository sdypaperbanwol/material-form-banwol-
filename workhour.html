<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover">
<title>파트별 근태(일자별)</title>
<style>
:root{--ink:#222;--muted:#666;--line:#e5e7eb;--bg:#f7f8fa;--card:#fff;--shadow:0 6px 18px rgba(0,0,0,.06)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.h1{margin:0;font-size:18px}
.meta{color:var(--muted);font-size:13px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
select{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#f9fafb;cursor:pointer}
.btn:hover{background:#f3f4f6}
.actions{display:flex;gap:8px;align-items:center}

.err{padding:12px;border-left:4px solid #ef4444;background:#fff0f0;color:#991b1b;margin-bottom:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3ff;color:#2651ff;font-weight:600;font-size:12px;margin-left:8px}
.stat{color:#374151;font-size:12px}

.tblwrap{overflow:auto;-webkit-overflow-scrolling:touch;max-height:75vh;margin-top:12px}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th,tbody td{border-bottom:1px solid var(--line);border-left:1px solid var(--line);padding:8px 8px;white-space:nowrap;background:#fff}
thead th{position:sticky;top:0;background:#fbfbfd;font-weight:700;z-index:5}
thead th:last-child,tbody td:last-child{border-right:1px solid var(--line)}
tfoot td{font-weight:700;background:#fcfcff}

.loading{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:saturate(180%) blur(2px)}
.loading.show{display:flex}
.spinner{width:44px;height:44px;border-radius:50%;border:3px solid #dbeafe;border-top-color:#2563eb;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <div id="error" class="card err" style="display:none"></div>

  <div class="card" style="padding:14px">
    <div class="top">
      <div>
        <div class="h1" id="title">파트별 근태 <span class="badge">일자별</span></div>
        <div class="meta" id="subtitle">일자를 선택해 해당 파트 인원의 근태를 조회합니다.</div>
      </div>
      <div class="row">
        <select id="partSel" title="파트 선택"></select>
        <select id="dateSel" title="일자 선택(최근 45일)"></select>
        <div class="actions">
          <button class="btn" id="btnGo">조회</button>
          <button class="btn" id="btnToday">오늘</button>
          <button class="btn" id="btnCSV">CSV</button>
        </div>
      </div>
    </div>
    <div class="stat" id="stat"></div>
    <div class="tblwrap card" id="tblwrap" style="border:none;box-shadow:none"></div>
  </div>
</div>

<div class="loading" id="loading"><div><div class="spinner"></div></div></div>

<script>
  /* ====== 설정 ====== */
  // ★ 여기만 네 GAS 웹앱 /exec URL로 교체하세요.
  const GAS_URL='https://script.google.com/macros/s/AKfycbzkpl0LmRcuN8GETjxpUy72_UQqOaPmjnKp5z9X3Tg83lR0W4MEHIIJqn9CschnNsDeig/exec';

  const ALLOWED_PARTS=[
    '반월 초지파트','반월 원질파트','반월 공무파트',
    '반월 소각파트','반월 환경파트','반월 전기파트'
  ];

  /* ====== 엘리먼트 ====== */
  const selPart = document.getElementById('partSel');
  const selDate = document.getElementById('dateSel');
  const btnGo   = document.getElementById('btnGo');
  const btnToday= document.getElementById('btnToday');
  const btnCSV  = document.getElementById('btnCSV');
  const statEl  = document.getElementById('stat');

  // 파트 셀렉트 구성
  const q=new URLSearchParams(location.search);
  const urlPart=q.get('part')||'';
  selPart.innerHTML = ALLOWED_PARTS.map(p=>`<option value="${esc(p)}"${p===urlPart?' selected':''}>${esc(p)}</option>`).join('');
  if(!urlPart && ALLOWED_PARTS.length) selPart.value = ALLOWED_PARTS[0];

  // 일자 드롭다운(최근 45일)
  selDate.innerHTML = buildRecentDaysOptions(45);

  // 초기 선택: URL에 date 있으면 그걸로, 없으면 오늘
  const urlDate=q.get('date');
  if(urlDate && /^\d{4}-\d{2}-\d{2}$/.test(urlDate)){
    selectDateIfExists(urlDate);
  }else{
    selectDateIfExists(todayYMD());
  }

  btnGo.addEventListener('click', load);
  btnToday.addEventListener('click', ()=>{
    selectDateIfExists(todayYMD());
    load();
  });
  btnCSV.addEventListener('click', exportCSV);

  window.addEventListener('load', load);

  let lastData = null; // CSV 내보내기용 캐시

  async function load(){
    const part = selPart.value;
    const ymd  = selDate.value;
    if(!part){ return showError('파트를 선택하세요.'); }
    if(!/^\d{4}-\d{2}-\d{2}$/.test(ymd)){ return showError('날짜 형식이 올바르지 않습니다.'); }

    showError('', false);
    statEl.textContent = '';
    showLoading(true);
    try{
      const res = await fetch(GAS_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ action:'part_daily', part, date: ymd })
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'BAD_RESPONSE');
      lastData = data;
      renderTable(data);
      statEl.textContent = `파트: ${part} · 날짜: ${ymd} · 인원 ${data.rows?.length||0}명`;
    }catch(e){
      showError('조회 실패: '+e.message);
      console.error(e);
    }finally{
      showLoading(false);
    }
  }

  function renderTable(data){
    const rows = data.rows || [];
    const C = data.colmap || { DATE:1, TYPE:4, W_IN:5, W_OUT:6, M_IN:7, M_OUT:8,
      J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,NOTE_U:20 };

    // 합계 계산
    const sum = {J:0,K:0,L:0,M:0,N:0,O:0,P:0};
    rows.forEach(r=>{
      sum.J+=toNum(r[C.J]); sum.K+=toNum(r[C.K]); sum.L+=toNum(r[C.L]);
      sum.M+=toNum(r[C.M]); sum.N+=toNum(r[C.N]); sum.O+=toNum(r[C.O]); sum.P+=toNum(r[C.P]);
    });
    const fmt = n => (Math.round(n*100)/100).toString();

    // 테이블 렌더
    const cols = [
      { key:'name',  label:'이름',      get:r=>safe(r[3]) }, // D열 이름
      { key:'type',  label:'근무형태',  get:r=>safe(r[C.TYPE]) },
      { key:'j',     label:'정규',      get:r=>nz(r[C.J]) },
      { key:'k',     label:'연장',      get:r=>nz(r[C.K]) },
      { key:'l',     label:'야근',      get:r=>nz(r[C.L]) },
      { key:'m',     label:'휴일',      get:r=>nz(r[C.M]) },
      { key:'n',     label:'휴연',      get:r=>nz(r[C.N]) },
      { key:'p',     label:'주휴',      get:r=>nz(r[C.P]) },
      { key:'o',     label:'유급',      get:r=>nz(r[C.O]) },
      { key:'wIn',   label:'근무 출근', get:r=>safe(r[C.W_IN]) },
      { key:'wOut',  label:'근무 퇴근', get:r=>safe(r[C.W_OUT]) },
      { key:'qIn',   label:'비콘 출근', get:r=>safe(r[C.Q]) },
      { key:'qOut',  label:'비콘 퇴근', get:r=>safe(r[C.R]) },
      { key:'mIn',   label:'수정 출근', get:r=>safe(r[C.M_IN]) },
      { key:'mOut',  label:'수정 퇴근', get:r=>safe(r[C.M_OUT]) },
      { key:'note',  label:'특이사항',  get:r=>linkify(r[C.NOTE_U]) }
    ];

    const th = cols.map(c=>`<th>${esc(c.label)}</th>`).join('');
    const tr = rows.map(r=>`<tr>${cols.map(c=>`<td>${c.get(r)}</td>`).join('')}</tr>`).join('');
    const tfoot =
      `<tfoot><tr>
         <td colspan="2" style="text-align:right">합계</td>
         <td>${esc(fmt(sum.J))}</td>
         <td>${esc(fmt(sum.K))}</td>
         <td>${esc(fmt(sum.L))}</td>
         <td>${esc(fmt(sum.M))}</td>
         <td>${esc(fmt(sum.N))}</td>
         <td>${esc(fmt(sum.P))}</td>
         <td>${esc(fmt(sum.O))}</td>
         <td colspan="6"></td>
       </tr></tfoot>`;

    const html = `
      <table>
        <thead><tr>${th}</tr></thead>
        <tbody>${rows.length?tr:`<tr><td colspan="${cols.length}" style="color:#666;padding:18px">해당 날짜의 데이터가 없습니다.</td></tr>`}</tbody>
        ${rows.length?tfoot:''}
      </table>`;
    document.getElementById('tblwrap').innerHTML = html;
  }

  function exportCSV(){
    if(!lastData){ showError('먼저 조회를 해주세요.'); return; }
    const rows = lastData.rows || [];
    const C = lastData.colmap || { DATE:1, TYPE:4, W_IN:5, W_OUT:6, M_IN:7, M_OUT:8,
      J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,NOTE_U:20 };

    const header = ['이름','근무형태','정규','연장','야근','휴일','휴연','주휴','유급','근무출근','근무퇴근','비콘출근','비콘퇴근','수정출근','수정퇴근','특이사항'];
    const lines = [header.join(',')];

    rows.forEach(r=>{
      const line = [
        csvSafe(safe(r[3])),
        csvSafe(safe(r[C.TYPE])),
        csvSafe(nz(r[C.J])), csvSafe(nz(r[C.K])), csvSafe(nz(r[C.L])),
        csvSafe(nz(r[C.M])), csvSafe(nz(r[C.N])), csvSafe(nz(r[C.P])),
        csvSafe(nz(r[C.O])),
        csvSafe(safe(r[C.W_IN])), csvSafe(safe(r[C.W_OUT])),
        csvSafe(safe(r[C.Q])),    csvSafe(safe(r[C.R])),
        csvSafe(safe(r[C.M_IN])), csvSafe(safe(r[C.M_OUT])),
        csvSafe(stripTags(safe(r[C.NOTE_U])))
      ];
      lines.push(line.join(','));
    });

    const blob = new Blob([`\uFEFF${lines.join('\n')}`], {type:'text/csv;charset=utf-8;'});
    const part = selPart.value;
    const ymd  = selDate.value;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `파트별근태_${part}_${ymd}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  /* ====== 헬퍼 ====== */
  function buildRecentDaysOptions(days){
    const opts=[];
    const today = new Date(); today.setHours(0,0,0,0);
    for(let i=0;i<days;i++){
      const d = new Date(today); d.setDate(today.getDate()-i);
      const ymd = toYMD(d);
      const label = `${ymd} (${['일','월','화','수','목','금','토'][d.getDay()]})`;
      opts.push(`<option value="${ymd}">${label}</option>`);
    }
    return opts.join('');
  }
  function selectDateIfExists(ymd){
    const opt = Array.from(selDate.options).find(o=>o.value===ymd);
    selDate.value = opt ? ymd : selDate.options[0]?.value || todayYMD();
  }
  function todayYMD(){ return toYMD(new Date()); }
  function toYMD(d){
    const z = n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }
  function showLoading(on){ document.getElementById('loading').classList.toggle('show', !!on); }
  function showError(msg, show=true){
    const el=document.getElementById('error');
    if(show===false || !msg){ el.style.display='none'; el.textContent=''; return; }
    el.style.display='block'; el.textContent=msg;
  }
  function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function stripTags(s){ return String(s).replace(/<[^>]*>/g,''); }
  function linkify(v){
    const t=(v||'').toString().trim();
    if(!t) return '';
    try{ const u=new URL(t); return `<a href="${esc(u.href)}" target="_blank" rel="noopener">${esc(u.href)}</a>`; }
    catch(_){ return esc(t); }
  }
  function safe(v){ return (v==null)?'':String(v); }
  function nz(v){ const t=String(v??'').trim(); return (t===''||/^0+(\.0+)?$/.test(t))?'':t; }
  function toNum(v){
    let s = String(v ?? '').trim();
    if (!s) return 0;
    s = s.replace(/\s+/g, '');
    if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
    s = s.replace(/,/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function csvSafe(s){
    const t = String(s??'');
    if (/[",\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
    return t;
  }
</script>
</body>
</html>
