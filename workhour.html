<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover">
<title>개인/파트 근태 조회</title>
<style>
:root{--ink:#222;--muted:#666;--line:#e5e7eb;--bg:#f7f8fa;--card:#fff;--shadow:0 6px 18px rgba(0,0,0,.06)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.err{padding:14px 16px;border-left:4px solid #ef4444;background:#fff0f0;color:#991b1b;margin-bottom:12px}
.top{display:grid;gap:12px;margin-bottom:16px}
.zcard{padding:12px 14px}
.profile{padding:16px;display:flex;justify-content:space-between;gap:16px;align-items:center}
.h1{margin:0 0 4px;font-size:18px}
.meta{color:var(--muted);font-size:13px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3ff;color:#2651ff;font-weight:600;font-size:12px;margin-left:8px}
.right{color:#666;font-size:12px}

/* 컨트롤 바 (파트 날짜 드롭다운) */
.controls{padding:12px 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--line)}
.select{appearance:none;border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:#fff;min-width:160px}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn:hover{background:#f7f8fc}

/* 표 컨테이너 */
.tblwrap{
  position:relative;
  overflow:auto; -webkit-overflow-scrolling:touch;
  max-height:75vh;
  --head1h:28px;
}
table{width:100%;border-collapse:separate;border-spacing:0}

/* 스티키 헤더 */
thead th{
  position:-webkit-sticky; position:sticky;
  background:#fbfbfd; background-clip:padding-box;
  font-weight:700; white-space:pre-line;
  border-top:1px solid var(--line);
  border-bottom:1px solid var(--line);
  border-left:1px solid var(--line);
  padding:6px 6px; line-height:1.1; font-size:13px;
  z-index:12;
}
thead th:last-child{border-right:1px solid var(--line)}
thead tr.thead1 th{top:0; z-index:14}
thead tr.thead2 th{top:var(--head1h); z-index:14}

/* 바디 */
tbody td{
  padding:8px 8px; white-space:pre-line;
  border-bottom:1px solid var(--line);
  border-left:1px solid var(--line);
  background:#fff;
}
tbody td:last-child{border-right:1px solid var(--line)}
tbody tr:nth-child(odd) td{background:#fcfcff}

th.center,td.center{text-align:center}

/* 메트릭 반응형 */
@media (max-width:640px){
  th.metric .full{display:none!important}
  th.metric .two{display:inline-grid!important;grid-auto-rows:auto;gap:2px;line-height:1;text-align:center}
  th.metric{min-width:34px;max-width:38px;padding-top:8px;padding-bottom:8px}
  th.metric .subsum{font-size:10px;margin-top:2px}
  td.metric{font-size:12px;padding:6px 4px}
}
th.metric .full{display:inline}
th.metric .two{display:none}
.subsum{display:block;font-weight:600;color:#3b82f6;margin-top:2px}

/* 근무형태(E열) */
th.type-col .t-full{display:inline}
th.type-col .t-two{display:none}
@media (max-width:640px){
  th.type-col .t-full{display:none}
  th.type-col .t-two{display:inline-block;line-height:1.05;text-align:center}
}
td.type-cell{font-size:13px;line-height:1.2;text-align:center}
td.type-cell .type-full{display:inline}
td.type-cell .type-two{display:none}
@media (max-width:640px){
  td.type-cell{font-size:11px;line-height:1.1;padding:5px 4px;text-align:center}
  td.type-cell .type-two{
    display:inline-grid;grid-auto-rows:auto;gap:1px;line-height:1.0;
    white-space:normal;text-align:center
  }
}

/* 칸 폭 */
th.type-col,td.type-cell{min-width:110px}
@media (max-width:640px){
  th.type-col, td.type-cell { min-width:60px; }
}
th.time-col,td.time-col{min-width:50px;width:50px;text-align:center}
@media (max-width:640px){
  th.time-col,td.time-col{min-width:44px;width:44px;padding:4px 2px;font-size:11px;white-space:nowrap}
}

/* 특이사항 모바일 폭 */
@media (max-width:640px){
  th.note,td.note{min-width:320px!important;white-space:normal!important;word-break:break-word}
}

/* 로딩 오버레이 */
.loading{position:fixed; inset:0; background:rgba(255,255,255,.85); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:saturate(180%) blur(2px)}
.loading.show{display:flex}
.loading-box{display:flex;flex-direction:column;align-items:center}
.spinner{width:44px;height:44px;border-radius:50%;border:3px solid #dbeafe;border-top-color:#2563eb;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading .msg{margin-top:12px;color:#374151;font-weight:600}

/* 왼쪽 고정 */
th.freezeL, td.freezeL{
  position:-webkit-sticky; position:sticky;
  left:0; background:#fff; z-index:9;
  box-shadow:2px 0 0 rgba(0,0,0,.06);
  border-right:1px solid var(--line);
}
thead th.freezeL{ top:0; z-index:18; }

/* 좌상단 모서리 */
th.freezeTL{
  position:-webkit-sticky; position:sticky;
  top:0; left:0; background:#fbfbfd; z-index:30;
  box-shadow:2px 0 0 rgba(0,0,0,.06), 0 2px 0 rgba(0,0,0,.06);
  border-right:1px solid var(--line); border-bottom:1px solid var(--line);
}

/* 빨간 테두리(정규~유급) */
.g-metric.g-start{border-left:2px solid #ef4444!important}
.g-metric.g-end{border-right:2px solid #ef4444!important}
thead tr.thead1 th.g-metric{border-top:2px solid #ef4444!important}
tbody tr:last-child td.g-metric{border-bottom:2px solid #ef4444!important}
</style>
</head>
<body>
  <div class="wrap">
    <div id="error" class="card err" style="display:none"></div>
    <div class="top" id="zbox"></div>

    <div class="card profile" id="pbox" style="display:none">
      <div>
        <div class="h1" id="pname"></div>
        <div class="meta" id="pmeta"></div>
      </div>
      <div class="right" id="pupdated"></div>
    </div>

    <!-- 파트 전용 컨트롤 -->
    <div class="card" id="controls" style="display:none">
      <div class="controls">
        <strong id="partlabel" style="margin-right:6px"></strong>
        <select id="datedd" class="select"></select>
        <button class="btn" id="reload">조회</button>
      </div>
      <div class="tblwrap" id="ptbl"></div>
    </div>

    <!-- 개인 전용 표 -->
    <div class="card tblwrap" id="tblwrap"></div>
  </div>

  <!-- 로딩 오버레이 -->
  <div id="loading" class="loading">
    <div class="loading-box">
      <div class="spinner"></div>
      <div class="msg">로딩 중입니다...</div>
    </div>
  </div>

<script>
  /* ===================== 설정/쿼리 ===================== */
  const GAS_URL='https://script.google.com/macros/s/AKfycbx1kIMY_49TLMKsefFCRJTKLseblboUgA9ENBFUQ5FQbW-4JCXRW7pLRd5337q-0zOxTQ/exec';

  const q=new URLSearchParams(location.search);
  const emp=q.get('emp')||'';
  const sig=q.get('sig')||'';
  const legacy=q.get('legacy')==='1' ? '1' : '0';
  const part=q.get('part')||'';
  const psig=q.get('psig')||'';
  const qdate=q.get('date')||'';

  // 백엔드 덮어쓰기 전 기본 맵
  let COL = {
    DATE:1, TYPE:4, W_IN:5, W_OUT:6, M_IN:7, M_OUT:8,
    J:9, K:10, L:11, M:12, N:13, O:14, P:15, Q:16, R:17, NOTE_U:20
  };

  (async function start(){
    if (part) { await initPartMode(); return; }
    if(!emp){ return showError('잘못된 접근(emp 누락)'); }
    await loadPersonal();
  })();

  /* ===================== 공통 헬퍼 ===================== */

  // 시간 문자열 감지 (HH:MM, HH:MM:SS, HHMM, HH.MM, 8시5분, 8시, AM/PM)
  function looksTime(v){
    const t=String(v||'').trim();
    if(!t) return false;
    if (/^([01]?\d|2[0-3]):[0-5]\d(:[0-5]\d)?$/.test(t)) return true;
    if (/^([01]?\d|2[0-3])[.:][0-5]\d$/.test(t)) return true;
    if (/^([01]?\d|2[0-3])[0-5]\d$/.test(t)) return true;
    if (/^([01]?\d|2[0-3])\s*시(\s*[0-5]?\d\s*분?)?$/.test(t)) return true;
    if (/^(am|pm)\s*([01]?\d):[0-5]\d(:[0-5]\d)?$/i.test(t)) return true;
    if (/^([01]?\d):[0-5]\d(:[0-5]\d)?\s*(am|pm)$/i.test(t)) return true;
    return false;
  }

  // 한 행의 값을 추출하고, 근무시간-비콘 자동 보정(필요 시)까지 적용
  function extractRowVals(r, C, autoSwap=true){
    // 원시값
    const raw = {
      date: safe(r[C.DATE]),
      type: safe(r[C.TYPE]),
      j: hideZero(r[C.J]), k: hideZero(r[C.K]), l: hideZero(r[C.L]),
      m: hideZero(r[C.M]), n: hideZero(r[C.N]), p: hideZero(r[C.P]), o: hideZero(r[C.O]),
      wIn: r[C.W_IN],  wOut: r[C.W_OUT],   // 근무시간(기대)
      bIn: r[C.Q],     bOut: r[C.R],       // 비콘(기대)
      mIn: r[C.M_IN],  mOut: r[C.M_OUT],   // 수정
      note: safe(r[C.NOTE_U]),
    };

    let wIn = raw.wIn, wOut = raw.wOut, bIn = raw.bIn, bOut = raw.bOut;
    if (autoSwap){
      const wLooks = looksTime(raw.wIn) || looksTime(raw.wOut);
      const bLooks = looksTime(raw.bIn) || looksTime(raw.bOut);
      // 근무시간 칸이 비고 비콘 칸에 시간처럼 보이면 스왑
      if (!wLooks && bLooks) {
        wIn = raw.bIn; wOut = raw.bOut;
        bIn = raw.wIn; bOut = raw.wOut;
      }
    }

    return {
      date: raw.date,
      type: raw.type,
      j: raw.j, k: raw.k, l: raw.l, m: raw.m, n: raw.n, p: raw.p, o: raw.o,
      wIn: safe(wIn), wOut: safe(wOut),
      bIn: hideZero(bIn), bOut: hideZero(bOut),
      mIn: safe(raw.mIn), mOut: safe(raw.mOut),
      note: raw.note
    };
  }

  function metricThC(label,total,extraCls=''){
    return (
      `<th class="center metric ${extraCls}" rowspan="2">
         <span class="full">${esc(label)}</span>
         <span class="two"><span class="t">${esc(label[0]||'')}</span><span class="b">${esc(label[1]||'')}</span></span>
         <span class="subsum">(${fmt(total)})</span>
       </th>`
    );
  }

  /* ===================== 개인 모드 ===================== */
  async function loadPersonal(){
    showLoading(true);
    try{
      const data=await apiPost({action:'workhour_read',emp,sig,legacy});
      if(!data||!data.ok) throw new Error(data&&data.error||'BAD_PAYLOAD');
      renderPersonal(data);
    }catch(e){
      const map={'BAD_SIGNATURE':'서명 오류(BAD_SIGNATURE)','NOT_FOUND':'대상자 없음(NOT_FOUND)','BAD_PAYLOAD':'데이터 로드 실패'};
      showError(map[e.message]||('네트워크/요청 오류: '+e.message));
      console.error('[workhour_read] error:', e);
    }finally{ showLoading(false); }
  }

  function renderPersonal(res){
    if (res.colmap) COL = res.colmap;
    const z=(res.zHeader||[]).filter(v=>!looksLikeSecret(v));
    document.getElementById('zbox').innerHTML=z.map(v=>'<div class="zcard">'+esc(v||'')+'</div>').join('');

    const p=res.person||{};
    const age = res.cacheAgeSec ? ` · 데이터기준 ${res.cacheAgeSec}s 전 (${esc(res.mode||'')})` : '';
    document.getElementById('pname').innerHTML=
      `${esc(p.name||'-')} <span class="badge">사번 ${esc(p.emp||'-')}</span>`;
    document.getElementById('pmeta').textContent=
      `연락처: ${p.tel||'-'} · 파트: ${p.part||'-'} · 직책: ${p.role||'-'}${age}`;
    document.getElementById('pupdated').textContent=res.updated||'';
    document.getElementById('pbox').style.display='';

    buildPersonalTable(res.rows||[]);
  }

  function buildPersonalTable(rows){
    const box=document.getElementById('tblwrap');
    document.getElementById('controls').style.display='none';
    if(!rows.length){
      box.innerHTML='<div style="padding:28px;color:#666">표시할 데이터 없음</div>';
      return;
    }

    const sorted=[...rows].sort((a,b)=>String(a[COL.DATE]||'2100-12-31').localeCompare(String(b[COL.DATE]||'2100-12-31')));

    const sum={J:0,K:0,L:0,M:0,N:0,O:0,P:0};
    sorted.forEach(r=>{
      sum.J+=toNum(r[COL.J]); sum.K+=toNum(r[COL.K]); sum.L+=toNum(r[COL.L]);
      sum.M+=toNum(r[COL.M]); sum.N+=toNum(r[COL.N]); sum.O+=toNum(r[COL.O]); sum.P+=toNum(r[COL.P]);
    });

    const headRow1 =
      '<tr class="thead1">' +
        '<th class="center freezeTL" rowspan="2">날짜</th>' +
        '<th class="type-col" rowspan="2">' +
          '<span class="t-full">근무 형태</span>' +
          '<span class="t-two">근무<br>형태</span>' +
        '</th>' +
        metricThC('정규',sum.J,'g-metric g-start') +
        metricThC('연장',sum.K,'g-metric') +
        metricThC('야근',sum.L,'g-metric') +
        metricThC('휴일',sum.M,'g-metric') +
        metricThC('휴연',sum.N,'g-metric') +
        metricThC('주휴',sum.P,'g-metric') +
        metricThC('유급',sum.O,'g-metric g-end') +
        '<th class="center" colspan="2">근무시간</th>' +
        '<th class="center" colspan="2">비콘</th>' +
        '<th class="center" colspan="2">수정</th>' +
        '<th class="note" rowspan="2">특이사항</th>' +
      '</tr>';

    const headRow2 =
      '<tr class="thead2">' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
      '</tr>';

    const body = sorted.map(r=>{
      const v = extractRowVals(r, COL, /*autoSwap=*/true); // 개인도 동일 로직 적용
      return (
        '<tr>' +
          `<td class="center freezeL">${esc(safe(r[COL.DATE]))}</td>` +
          `<td class="type-cell">${makeTypeHTML(v.type)}</td>` +
          `<td class="center metric g-metric g-start">${esc(v.j)}</td>` +
          `<td class="center metric g-metric">${esc(v.k)}</td>` +
          `<td class="center metric g-metric">${esc(v.l)}</td>` +
          `<td class="center metric g-metric">${esc(v.m)}</td>` +
          `<td class="center metric g-metric">${esc(v.n)}</td>` +
          `<td class="center metric g-metric">${esc(v.p)}</td>` +
          `<td class="center metric g-metric g-end">${esc(v.o)}</td>` +
          // === 근무시간 → 비콘 → 수정 ===
          `<td class="center time-col">${cellOrNbsp(v.wIn)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.wOut)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.bIn)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.bOut)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.mIn)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.mOut)}</td>` +
          `<td class="note">${linkify(v.note)}</td>` +
        '</tr>'
      );
    }).join('');

    document.getElementById('tblwrap').innerHTML =
      '<table><thead>'+headRow1+headRow2+'</thead><tbody>'+body+'</tbody></table>';

    fixStickyOffsets('.tblwrap');
  }

  /* ===================== 파트 모드 ===================== */
  async function initPartMode(){
    document.getElementById('pname').innerHTML=
      `${esc(part)} <span class="badge">파트</span>`;
    document.getElementById('pmeta').textContent='하루 단위 조회';
    document.getElementById('pupdated').textContent='';
    document.getElementById('pbox').style.display='';

    document.getElementById('tblwrap').style.display='none';
    document.getElementById('controls').style.display='';
    document.getElementById('partlabel').textContent='날짜 선택';

    showLoading(true);
    try{
      const meta = await apiPost({action:'part_meta', part, psig});
      if(!meta.ok) throw new Error(meta.error||'PART_META_FAIL');
      const dd=document.getElementById('datedd');
      dd.innerHTML = (meta.dates||[]).map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join('');
      if(qdate && meta.dates.includes(qdate)) dd.value=qdate;

      const fetchNow = async ()=>{
        const date = dd.value || meta.dates?.[0] || '';
        if(!date){
          document.getElementById('ptbl').innerHTML='<div style="padding:16px;color:#666">조회 가능한 날짜가 없습니다.</div>';
          return;
        }
        showLoading(true);
        try{
          const res = await apiPost({action:'part_day_read', part, date, psig});
          if(!res.ok) throw new Error(res.error||'PART_DAY_FAIL');
          renderPartDay(res);
        }catch(e){
          showError('파트 조회 실패: '+e.message);
        }finally{ showLoading(false); }
      };

      document.getElementById('reload').onclick = fetchNow;
      document.getElementById('datedd').onchange = fetchNow;

      await fetchNow();
    }catch(e){
      showError('초기화 실패: '+e.message);
    }finally{
      showLoading(false);
    }
  }

  function renderPartDay(payload){
    // 디버깅용 훅(콘솔에서 window.__last_part_payload로 확인 가능)
    window.__last_part_payload = payload;

    const C = payload.colmap || COL;
    const rows = payload.rows || [];

    if(!rows.length){
      document.getElementById('ptbl').innerHTML='<div style="padding:16px;color:#666">데이터 없음</div>';
      return;
    }

    // 집계(정규~유급/주휴)
    const sum={J:0,K:0,L:0,M:0,N:0,O:0,P:0};
    rows.forEach(rowObj=>{
      const r = rowObj.cells || rowObj;
      sum.J+=toNum(r[C.J]); sum.K+=toNum(r[C.K]); sum.L+=toNum(r[C.L]);
      sum.M+=toNum(r[C.M]); sum.N+=toNum(r[C.N]); sum.O+=toNum(r[C.O]); sum.P+=toNum(r[C.P]);
    });

    const headRow1 =
      '<tr class="thead1">' +
        '<th class="center freezeTL" rowspan="2">이름</th>' +
        '<th class="type-col" rowspan="2">' +
          '<span class="t-full">근무 형태</span>' +
          '<span class="t-two">근무<br>형태</span>' +
        '</th>' +
        metricThC('정규',sum.J,'g-metric g-start') +
        metricThC('연장',sum.K,'g-metric') +
        metricThC('야근',sum.L,'g-metric') +
        metricThC('휴일',sum.M,'g-metric') +
        metricThC('휴연',sum.N,'g-metric') +
        metricThC('주휴',sum.P,'g-metric') +
        metricThC('유급',sum.O,'g-metric g-end') +
        '<th class="center" colspan="2">근무시간</th>' +
        '<th class="center" colspan="2">비콘</th>' +
        '<th class="center" colspan="2">수정</th>' +
        '<th class="note" rowspan="2">특이사항</th>' +
      '</tr>';

    const headRow2 =
      '<tr class="thead2">' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
        '<th class="center time-col">출근</th><th class="center time-col">퇴근</th>' +
      '</tr>';

    const body = rows.map(rowObj=>{
      const name = safe(rowObj.__NAME || '');
      const r = rowObj.cells || rowObj;
      const v = extractRowVals(r, C, /*autoSwap=*/true); // 파트도 동일 로직 적용

      return (
        '<tr>' +
          `<td class="center freezeL">${esc(name)}</td>` +
          `<td class="type-cell">${makeTypeHTML(v.type)}</td>` +
          `<td class="center metric g-metric g-start">${esc(v.j)}</td>` +
          `<td class="center metric g-metric">${esc(v.k)}</td>` +
          `<td class="center metric g-metric">${esc(v.l)}</td>` +
          `<td class="center metric g-metric">${esc(v.m)}</td>` +
          `<td class="center metric g-metric">${esc(v.n)}</td>` +
          `<td class="center metric g-metric">${esc(v.p)}</td>` +
          `<td class="center metric g-metric g-end">${esc(v.o)}</td>` +
          // === 근무시간 → 비콘 → 수정 ===
          `<td class="center time-col">${cellOrNbsp(v.wIn)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.wOut)}</td>` +
          `<td class="center time-col">${cellOrNbsp(v.bIn)}</td>`  +
          `<td class="center time-col">${cellOrNbsp(v.bOut)}</td>`  +
          `<td class="center time-col">${cellOrNbsp(v.mIn)}</td>`  +
          `<td class="center time-col">${cellOrNbsp(v.mOut)}</td>`  +
          `<td class="note">${linkify(v.note)}</td>` +
        '</tr>'
      );
    }).join('');

    document.getElementById('ptbl').innerHTML =
      '<table><thead>'+headRow1+headRow2+'</thead><tbody>'+body+'</tbody></table>';

    fixStickyOffsets('#ptbl');
  }

  /* ===================== 공통 유틸 ===================== */
  async function apiPost(obj){
    const res = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams(obj)
    });
    const txt=await res.text(); let data;
    try{ data=JSON.parse(txt) }catch{ throw new Error('JSON 파싱 실패'); }
    return data;
  }

  function showLoading(on){
    const el=document.getElementById('loading');
    if(!el) return;
    if(on) el.classList.add('show'); else el.classList.remove('show');
  }

  function makeTypeHTML(v){
    const t=(v||'').trim();
    const clean=t.replace(/\s+/g,'');
    if(/\(.*\)/.test(clean)){
      const idx=clean.indexOf('(');
      const top=clean.slice(0,idx);
      const bottom=clean.slice(idx);
      return (
        `<span class="type-full">${esc(t)}</span>`+
        `<span class="type-two"><span>${esc(top)}</span><span>${esc(bottom)}</span></span>`
      );
    }
    let twoTop='',twoBottom='';
    if(clean.length===4){ twoTop=clean.slice(0,2); twoBottom=clean.slice(2,4); }
    else if(clean.length===2){ twoTop=clean; twoBottom=''; }
    else { twoTop=clean.length<=3?clean:clean.slice(0,3); twoBottom=clean.length>3?clean.slice(3):''; }
    return (
      `<span class="type-full">${esc(t)}</span>`+
      `<span class="type-two"><span>${esc(twoTop)}</span>${twoBottom?`<span>${esc(twoBottom)}</span>`:''}</span>`
    );
  }

  function toNum(v){
    let s = String(v ?? '').trim();
    if (!s) return 0;
    s = s.replace(/\s+/g, '');
    if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
    s = s.replace(/,/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function hideZero(v){ const t=String(v??'').trim(); return (t===''||/^0+(\.0+)?$/.test(t))?'':t; }
  function safe(v){ return (v==null)?'':String(v); }
  function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function looksLikeSecret(v){
    if(!v) return false;
    const t=String(v).trim();
    if(t.includes('::')) return true;
    if(/^[A-Fa-f0-9]{32,}$/.test(t)) return true;
    if(/^[A-Za-z0-9_-]{28,}$/.test(t)) return true;
    return false;
  }
  function showError(m){ const e=document.getElementById('error'); e.textContent=m; e.style.display='block'; }
  function cellOrNbsp(v){ const t=(v==null?'':String(v).trim()); return t===''?'&nbsp;':esc(t); }
  function linkify(v){
    const t=(v||'').trim();
    if(!t) return '';
    try{ const u=new URL(t); return `<a href="${esc(u.href)}" target="_blank" rel="noopener">${esc(u.href)}</a>`; }
    catch(_){ return esc(t); }
  }
  function fixStickyOffsets(sel){
    const wrap=document.querySelector(sel)?.closest('.tblwrap') || document.querySelector(sel);
    const row1=wrap?.querySelector('thead tr.thead1');
    if(!wrap||!row1) return;
    const h=row1.getBoundingClientRect().height;
    wrap.style.setProperty('--head1h',h+'px');
    requestAnimationFrame(()=>wrap.style.setProperty('--head1h',row1.getBoundingClientRect().height+'px'));
    window.addEventListener('resize', ()=>wrap.style.setProperty('--head1h',row1.getBoundingClientRect().height+'px'), {passive:true});
    window.addEventListener('orientationchange', ()=>setTimeout(()=>wrap.style.setProperty('--head1h',row1.getBoundingClientRect().height+'px'), 60), {passive:true});
  }
</script>
</body>
</html>
