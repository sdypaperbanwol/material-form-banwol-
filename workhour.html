<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê°œì¸ ê·¼íƒœ ì¡°íšŒ</title>
<style>
  :root{--ink:#222;--muted:#666;--line:#e5e7eb;--bg:#f7f8fa;--card:#fff;--shadow:0 6px 18px rgba(0,0,0,.06)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .err{padding:14px 16px;border-left:4px solid #ef4444;background:#fff0f0;color:#991b1b;margin-bottom:12px}

  .top{display:grid;gap:12px;margin-bottom:16px}
  .zcard{padding:12px 14px}

  .profile{padding:16px;display:flex;justify-content:space-between;gap:16px}
  .h1{margin:0 0 4px;font-size:18px}
  .meta{color:var(--muted);font-size:13px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3ff;color:#2651ff;font-weight:600;font-size:12px;margin-left:8px}
  .right{color:#666;font-size:12px}

  .tblwrap{overflow:auto;margin-top:16px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    background:#fbfbfd;font-weight:700;white-space:pre-line;
    border-top:1px solid var(--line);
    border-bottom:1px solid var(--line);
    border-left:1px solid var(--line);
    padding:10px 8px;
  }
  thead th:last-child{border-right:1px solid var(--line)}
  thead tr.thead1 th{position:sticky;top:0;z-index:2}
  thead tr.thead2 th{position:sticky;top:38px;z-index:2}
  .subsum{display:block;font-weight:600;color:#3b82f6;margin-top:2px}

  tbody td{
    padding:8px 8px;white-space:pre-line;
    border-bottom:1px solid var(--line);
    border-left:1px solid var(--line);
  }
  tbody td:last-child{border-right:1px solid var(--line)}
  tbody tr:nth-child(odd) td{background:#fcfcff}

  th.center, td.center{ text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <div id="error" class="card err" style="display:none"></div>

  <!-- ê³µìš© í—¤ë”(Z1:Z4) -->
  <div class="top" id="zbox"></div>

  <!-- í”„ë¡œí•„ -->
  <div class="card profile" id="pbox" style="display:none">
    <div>
      <div class="h1" id="pname"></div>
      <div class="meta" id="pmeta"></div>
    </div>
    <div class="right" id="pupdated"></div>
  </div>

  <!-- ë©”ì¸ í‘œ -->
  <div class="card tblwrap" id="tblwrap"></div>
</div>

<script>
/** ğŸ”§ ì´ê±´ "ë°ì´í„° API" ì£¼ì†Œì…ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¡œ ì§ì ‘ ì—´ë©´ JSONë§Œ ë³´ì´ëŠ” ê²Œ ì •ìƒ!
 * ë°˜ë“œì‹œ 'ë¦¬ë””ë ‰íŠ¸ëœ ìµœì¢… googleusercontent exec URL'ì„ ë„£ìœ¼ì„¸ìš”.
 * (PC í¬ë¡¬ì—ì„œ ê¸°ì¡´ exec í•œë²ˆ ì—´ê³ , ì£¼ì†Œì°½/ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ ë°”ë€ ì „ì²´ URL ë³µì‚¬)
 */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyMhj-IwILUvAlrAiM7k-JA2UyO8QyEQnkT76pd_K2EGlDlPsfnEvqcvjZxON-5yaN9YQ/exec'; // â† ìµœì¢… execë¡œ êµì²´

/** ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° (GitHub í˜ì´ì§€ë¥¼ ì´ ì£¼ì†Œë¡œ ì ‘ì†í•´ì•¼ UIê°€ ë³´ì„) */
const q   = new URLSearchParams(location.search);
const emp = q.get('emp') || '';
const sig = q.get('sig') || '';

/** ì¸ì•± ê°ì§€ */
const UA = navigator.userAgent || '';
const IS_INAPP = /KAKAOTALK|NAVER|FBAN|FBAV|Line\/|Instagram/i.test(UA);

/** ì»¬ëŸ¼ ì¸ë±ìŠ¤(A=0) â€” V(ì‹ ì²­ì„œ) ì œê±° */
const COL = {
  DATE:1, TYPE:4, W_IN:5, W_OUT:6, M_IN:7, M_OUT:8,
  J:9, K:10, L:11, M:12, N:13, O:14, P:15,
  NOTE_U:20
};

/** ì¸ì•± ì•ˆë‚´(ì„ íƒ) */
(function(){
  if (!IS_INAPP) return;
  const wrap = document.querySelector('.wrap');
  const div = document.createElement('div');
  div.className = 'card err';
  div.style.marginBottom = '12px';
  const here = encodeURIComponent(location.href);
  const chromeIntent = `intent://open#Intent;scheme=${location.protocol.replace(':','')};S.browser_fallback_url=${here};package=com.android.chrome;end`;
  div.innerHTML = `ì¹´ì¹´ì˜¤/ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ì´ ë°œìƒí•  ìˆ˜ ìˆì–´ìš”.
    <a href="${chromeIntent}" style="font-weight:700;text-decoration:underline">ì™¸ë¶€ ë¸Œë¼ìš°ì €(í¬ë¡¬)ë¡œ ì—´ê¸°</a>`;
  wrap.insertBefore(div, wrap.firstChild);
})();

/** ===== ë¡œë”: ì¸ì•±=iframe ìš°ì„ , ì¼ë°˜=JSONPâ†’iframe ===== */
(async function load(){
  if(!emp){ return showError('ì˜ëª»ëœ ì ‘ê·¼(emp ëˆ„ë½)'); }

  function loadJsonp(){
    return new Promise((resolve, reject)=>{
      const u = new URL(GAS_URL);
      u.searchParams.set('jsonp','1');
      u.searchParams.set('callback','__RENDER__');
      u.searchParams.set('emp', emp);
      if(sig) u.searchParams.set('sig', sig);
      u.searchParams.set('rnd', Date.now().toString(36));

      const s = document.createElement('script');
      s.src = u.toString();
      s.referrerPolicy = 'no-referrer';
      s.onerror = () => reject(new Error('JSONP_LOAD_FAIL'));
      document.body.appendChild(s);

      const t = setTimeout(()=>reject(new Error('JSONP_TIMEOUT')), 20000);
      window.__RENDER__ = (res)=>{ clearTimeout(t); resolve(res); };
    });
  }

  function loadIframe(){
    return new Promise((resolve, reject)=>{
      const u = new URL(GAS_URL);
      u.searchParams.set('embed','1');
      u.searchParams.set('emp', emp);
      if(sig) u.searchParams.set('sig', sig);
      u.searchParams.set('rnd', Date.now().toString(36));

      const ifr = document.createElement('iframe');
      ifr.src = u.toString();
      // â›” display:none ê¸ˆì§€ â€” ì¼ë¶€ ì¸ì•±ì€ ë¡œë“œ ìì²´ë¥¼ ì•ˆ í•¨
      ifr.style.cssText = 'position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;border:0;opacity:0;';
      ifr.setAttribute('allow','cross-origin-isolated');
      document.body.appendChild(ifr);

      const ORIG_OK = new Set([
        'https://script.googleusercontent.com',
        'https://script.google.com',
        'null' // ëª‡ëª‡ ì¸ì•±/ì›¹ë·°ëŠ” originì„ nullë¡œ ë³´ëƒ„
      ]);

      const onMsg = (ev)=>{
        try{
          const origin = ev.origin || 'null';
          if(!ORIG_OK.has(origin)) return;
          if (ev.source !== ifr.contentWindow) return;

          const res = ev.data;
          if(res && res.ok){ cleanup(); resolve(res); }
          else { cleanup(); reject(new Error(res && res.error || 'IFR_BAD_PAYLOAD')); }
        }catch(e){ cleanup(); reject(new Error('IFR_MSG_ERROR')); }
      };
      window.addEventListener('message', onMsg, false);
      const t = setTimeout(()=>{ cleanup(); reject(new Error('IFR_TIMEOUT')); }, 25000);

      function cleanup(){ window.removeEventListener('message', onMsg); clearTimeout(t); ifr.remove(); }
    });
  }

  try{
    let data;
    if (IS_INAPP) {
      try { data = await loadIframe(); }
      catch(_) { data = await loadJsonp(); }
    } else {
      try { data = await loadJsonp(); }
      catch(_) { data = await loadIframe(); }
    }
    if(!data || !data.ok) throw new Error(data && data.error || 'BAD_PAYLOAD');
    render(data);
  }catch(e){
    const map = {
      'JSONP_LOAD_FAIL':'JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨',
      'JSONP_TIMEOUT':'ë„¤íŠ¸ì›Œí¬ ì§€ì—°(JSONP)',
      'IFR_TIMEOUT':'ë„¤íŠ¸ì›Œí¬ ì§€ì—°(iframe)',
      'IFR_BAD_PAYLOAD':'iframe ì‘ë‹µ ì˜¤ë¥˜',
      'IFR_MSG_ERROR':'iframe ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜',
      'BAD_SIGNATURE':'ì„œëª… ì˜¤ë¥˜(BAD_SIGNATURE)',
      'NOT_FOUND':'ëŒ€ìƒì ì—†ìŒ(NOT_FOUND)'
    };
    showError((map[e.message] || ('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: '+e.message)) + ' [' + e.message + ']');
  }
})();

/** ====== ë Œë” ====== */
function render(res){
  if(!res || !res.ok) return showError((res && res.error)||'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

  const z = (res.zHeader||[]).filter(v => !looksLikeSecret(v));
  document.getElementById('zbox').innerHTML =
    z.map(v=>`<div class="zcard">${esc(v||'')}</div>`).join('');

  const p = res.person||{};
  document.getElementById('pname').innerHTML =
    `${esc(p.name||'-')} <span class="badge">ì‚¬ë²ˆ ${esc(p.emp||'-')}</span>`;
  document.getElementById('pmeta').textContent =
    `ì—°ë½ì²˜: ${p.tel||'-'} Â· íŒŒíŠ¸: ${p.part||'-'} Â· ì§ì±…: ${p.role||'-'}`;
  document.getElementById('pupdated').textContent = res.updated || '';
  document.getElementById('pbox').style.display = '';

  buildTable(res.rows||[]);
}

/** ====== í…Œì´ë¸” ====== */
function parseSheetDate(s){
  const t = String(s||'').trim();
  let m = t.match(/(\d{1,2})[\/\-](\d{1,2})/);
  if(m){ return new Date(2025, 9, Number(m[2])); }
  m = t.match(/10[^0-9]*(\d{1,2})/);
  if(m){ return new Date(2025, 9, Number(m[1])); }
  return new Date(2100,0,1);
}

function buildTable(rows){
  const box = document.getElementById('tblwrap');
  if(!rows.length){ box.innerHTML = '<div style="padding:28px;color:#666">í‘œì‹œí•  ë°ì´í„° ì—†ìŒ</div>'; return; }

  const sorted = [...rows].sort((a,b)=> parseSheetDate(a[COL.DATE]) - parseSheetDate(b[COL.DATE]));
  const sum = {J:0,K:0,L:0,M:0,N:0,O:0,P:0};
  sorted.forEach(r=>{
    sum.J+=toNum(r[COL.J]); sum.K+=toNum(r[COL.K]); sum.L+=toNum(r[COL.L]);
    sum.M+=toNum(r[COL.M]); sum.N+=toNum(r[COL.N]); sum.O+=toNum(r[COL.O]); sum.P+=toNum(r[COL.P]);
  });

  const headRow1 = `
    <tr class="thead1">
      <th class="center" rowspan="2">ë‚ ì§œ</th>
      <th rowspan="2">ê·¼ë¬´ í˜•íƒœ</th>
      <th class="center" colspan="2">ì¶œê·¼/í‡´ê·¼(ëŒ€ì–‘ì›ìŠ¤)</th>
      <th class="center" colspan="2">ì¶œê·¼/í‡´ê·¼(ìˆ˜ì •)</th>
      <th class="center" rowspan="2">ì •ê·œ<span class="subsum">(${fmt(sum.J)})</span></th>
      <th class="center" rowspan="2">ì—°ì¥<span class="subsum">(${fmt(sum.K)})</span></th>
      <th class="center" rowspan="2">ì•¼ê·¼<span class="subsum">(${fmt(sum.L)})</span></th>
      <th class="center" rowspan="2">íœ´ì¼<span class="subsum">(${fmt(sum.M)})</span></th>
      <th class="center" rowspan="2">íœ´ì—°<span class="subsum">(${fmt(sum.N)})</span></th>
      <th class="center" rowspan="2">ìœ ê¸‰<span class="subsum">(${fmt(sum.O)})</span></th>
      <th class="center" rowspan="2">ì£¼íœ´<span class="subsum">(${fmt(sum.P)})</span></th>
      <th rowspan="2">íŠ¹ì´ì‚¬í•­</th>
    </tr>`;
  const headRow2 = `
    <tr class="thead2">
      <th class="center">ì¶œê·¼</th><th class="center">í‡´ê·¼</th>
      <th class="center">ì¶œê·¼</th><th class="center">í‡´ê·¼</th>
    </tr>`;

  const body = sorted.map(r=>{
    const cells = [
      safe(r[COL.DATE]), safe(r[COL.TYPE]),
      safe(r[COL.W_IN]), safe(r[COL.W_OUT]),
      safe(r[COL.M_IN]), safe(r[COL.M_OUT]),
      hideZero(r[COL.J]), hideZero(r[COL.K]), hideZero(r[COL.L]),
      hideZero(r[COL.M]), hideZero(r[COL.N]), hideZero(r[COL.O]), hideZero(r[COL.P]),
      safe(r[COL.NOTE_U])
    ];
    return `
      <tr>
        <td class="center">${esc(cells[0])}</td>
        <td>${esc(cells[1])}</td>
        <td class="center">${esc(cells[2])}</td>
        <td class="center">${esc(cells[3])}</td>
        <td class="center">${esc(cells[4])}</td>
        <td class="center">${esc(cells[5])}</td>
        <td class="center">${esc(cells[6])}</td>
        <td class="center">${esc(cells[7])}</td>
        <td class="center">${esc(cells[8])}</td>
        <td class="center">${esc(cells[9])}</td>
        <td class="center">${esc(cells[10])}</td>
        <td class="center">${esc(cells[11])}</td>
        <td class="center">${esc(cells[12])}</td>
        <td>${linkify(cells[13])}</td>
      </tr>`;
  }).join('');

  document.getElementById('tblwrap').innerHTML =
    `<table><thead>${headRow1}${headRow2}</thead><tbody>${body}</tbody></table>`;
}

/** ====== ìœ í‹¸ ====== */
function toNum(v){ const t=String(v??'').replace(/[, ]/g,'').trim(); return (t===''||isNaN(Number(t)))?0:Number(t); }
function fmt(n){ return (Math.round(n*100)/100).toString(); }
function hideZero(v){ const t=String(v??'').trim(); return (t===''||/^0+(\.0+)?$/.test(t))?'':t; }
function safe(v){ return (v==null)?'':String(v); }
function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function looksLikeSecret(v){ if(!v) return false; const t=String(v).trim(); if(t.includes('::')) return true; if(/^[A-Fa-f0-9]{32,}$/.test(t)) return true; if(/^[A-Za-z0-9_-]{28,}$/.test(t)) return true; return false; }
function showError(m){ const e=document.getElementById('error'); e.textContent=m; e.style.display='block'; }
function linkify(v){
  const t=(v||'').trim();
  if(!t) return '';
  try{ const u=new URL(t); return `<a href="${esc(u.href)}" target="_blank" rel="noopener">${esc(u.href)}</a>`; }
  catch(_){ return esc(t); }
}
</script>
</body>
</html>
