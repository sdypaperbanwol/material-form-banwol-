<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>공장 내 실시간 차량 현황</title>
  <meta name="description" content="공장 내 실시간 차량 현황 – GitHub Pages용 logistics.html">
  <!-- favicon 404 방지 -->
  <link rel="icon" href="data:,">

  <style>
  :root{
    --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
    --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
    --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--ink);
        font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif; }
  .wrap{ max-width:980px; margin:24px auto; padding:0 16px }

  /* header */
  .header{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
           box-shadow:var(--shadow); padding:16px 18px; margin-bottom:16px; }
  .title{ margin:0; font-size:20px; letter-spacing:-.2px }
  .subtitle{ margin:4px 0 0 0; color:var(--muted); font-size:12.5px; display:flex; align-items:center; gap:6px }
  .mini-spinner{ display:inline-block; width:12px; height:12px; border:2px solid #cfd8ff; border-top-color:var(--brand);
                 border-radius:50%; animation:spin .8s linear infinite; vertical-align:-2px }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px }
  .badge{ background:var(--badge); border:1px solid #d9e2ff; border-radius:999px; padding:3px 8px; font-size:12px }

  /* toolbar */
  .toolbar{ display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap }
  .btn{ appearance:none; border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed }
  .btn:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06) }
  .input,.select{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; font-size:13px }

  /* view toggle */
  .view-toggle{ display:flex; gap:0; border:1px solid var(--line); border-radius:10px; overflow:hidden }
  .view-toggle .tbtn{ border:0; background:#fff; padding:8px 12px; font-size:13px; cursor:pointer }
  .view-toggle .tbtn + .tbtn{ border-left:1px solid var(--line) }
  .view-toggle .tbtn.active{ background:var(--brand); color:#fff }

  /* grid */
  .grid{ display:grid; grid-template-columns:1fr; gap:14px }
  .col{ display:grid; gap:14px }
  @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
  @media (max-width:899px){
    .grid > .col:last-child > .card:last-child{ margin-bottom:24px }
    .wrap{ padding-bottom:16px }
  }

  /* card */
  .card{ background:var(--card); border:1px solid var(--line); border-radius:0; box-shadow:var(--shadow) }
  .stripe{ height:4px }
  .stripe.cyan{ background:var(--cyan) }
  .stripe.green{ background:var(--green) }
  .card .head{ padding:16px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px }
  .card .head h3{ margin:0; font-size:15px }
  .head-right{ display:flex; align-items:center; gap:8px }
  .summary{ padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--line); font-size:12.5px }

  /* table */
  table{ width:100%; border-collapse:separate; border-spacing:0 }
  thead th{ position:sticky; top:0; background:#fafbfd; border-bottom:1px solid var(--line); color:#333; font-weight:600 }
  th,td{ padding:8px 10px; text-align:center }
  tbody tr:nth-child(odd){ background:#fcfcfe }
  tbody td{ border-bottom:1px solid #f1f1f4 }
  .empty{ padding:18px 14px; color:var(--muted) }
  tbody tr.plant-sep td{ border-top:2px solid #ff6b6b }
  td.cell-hit{ background:#fff2cc !important }
  .badge.search-pill{ background:#eef3ff; border:1px solid #d9e2ff; border-radius:999px; padding:4px 8px; font-size:12px }

  /* toast & overlay */
  .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
          padding:8px 12px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .25s; }
  .toast.show{ opacity:1 }
  .overlay{ position:fixed; inset:0; background:rgba(17,24,39,.35); display:flex; align-items:center; justify-content:center; z-index:9999;
            opacity:0; pointer-events:none; transition:opacity .2s; }
  .overlay.show{ opacity:1; pointer-events:auto }
  .overlay .panel{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
                   padding:18px 20px; display:flex; align-items:center; gap:10px; min-width:220px; justify-content:center; }
  .overlay .spinner{ width:28px; height:28px; border:3px solid #e5e7eb; border-top-color:var(--brand); border-radius:50%;
                     animation:spin 1s linear infinite; }

  /* weighing panel scroll */
  #weighingPanel{ max-height:70vh; overflow:auto }

  /* print */
  @media print{
    body{ background:#fff }
    .btn,.toast,.overlay{ display:none }
    .wrap{ max-width:1000px; margin:0; padding:0 }
    .header{ box-shadow:none; border:none }
    .grid{ grid-template-columns:1fr 1fr }
  }
  </style>

  <meta http-equiv="cache-control" content="max-age=0, no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">공장 내 실시간 차량 현황</h1>
      <p class="subtitle" id="updated">업데이트 준비 중…</p>

      <div class="badges">
        <span class="badge">신대양제지 반월/시화</span>
        <span class="badge">계근 기준</span>
      </div>

      <div class="toolbar">
        <select id="plantFilter" class="select" title="공장 필터">
          <option value="all">전체</option>
          <option value="banwol">반월만</option>
          <option value="sihwa">시화만</option>
        </select>

        <button class="btn" id="btnRefresh">새로고침</button>

        <div class="view-toggle" role="tablist" aria-label="보기 전환">
          <button class="tbtn active" id="btnViewLive"  role="tab" aria-selected="true">실시간 현황</button>
          <button class="tbtn"         id="btnViewWeigh" role="tab" aria-selected="false">금일 출고</button>
        </div>

        <input id="searchInput" class="input" placeholder="차량번호 검색" />
        <span id="searchSummary" class="badge search-pill" style="display:none"></span>
      </div>
    </section>

    <!-- 금일 출고 패널 -->
    <section class="grid" id="weighingPanel" style="display:none"></section>

    <!-- 실시간 패널 -->
    <section class="grid" id="sections"></section>
  </div>

  <!-- overlay & toast -->
  <div class="overlay" id="loadingOverlay" aria-hidden="true">
    <div class="panel" role="status" aria-live="polite">
      <div class="spinner" aria-label="로딩 중"></div>
      <div><strong>새로고침 중…</strong><br><span style="color:#666;font-size:12px">잠시만 기다려주세요</span></div>
    </div>
  </div>
  <div class="toast" id="toast">업데이트됨</div>

  <script>
  // ========= 설정 =========
  const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbzq07zXH54YJ7vwu9FQ2achwXhpUbWfxD2vWnGTtdWGTCCM7G2NjWEO0LktbdZ9SpL4/exec';
  const USE_JSONP_FALLBACK = true;

  const elUpdated  = document.getElementById('updated');
  const elSections = document.getElementById('sections');
  const btnRefresh = document.getElementById('btnRefresh');
  const toast      = document.getElementById('toast');
  const overlay    = document.getElementById('loadingOverlay');

  const LS_KEYS = { collapse:'ui.collapse.map', plant:'ui.plant', q:'ui.search' };
  let __searchCount = 0;

  function last4(s){ const d=String(s||'').replace(/\D+/g,''); return d.length>=4? d.slice(-4):''; }
  const LEFT_TITLES  = ['제품 상차중', '부자재 입차중', '컨테이너 입차중'];
  const RIGHT_TITLES = ['원료 하차중', '원료 대기'];
  function isMonoDigitPlate(s){ const d=String(s||'').replace(/\D+/g,''); if(d.length<4) return false; return d.split('').every(ch=>ch===d[0]); }
  const AUTO_REFRESH_MS = 0;
  let __loading=false, __timer=null;
  function timeLabelFromTitle(title){ return /대기/.test(title)?'등록시간':'입차시간'; }

  function fmtTimeDisplay(raw){
    if (raw == null) return '';
    const s0 = String(raw).trim(); if(!s0) return '';
    const mHM = s0.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
    if (mHM) return `${mHM[1].padStart(2,'0')}:${mHM[2]}`;
    const digits = s0.replace(/\D/g,'');
    if (digits.length >= 6) return `${digits.slice(0,2)}:${digits.slice(2,4)}`;
    if (digits.length === 4) return `${digits.slice(0,2)}:${digits.slice(2,4)}`;
    if (/GMT|^\d{4}-\d{2}-\d{2}T/.test(s0)) {
      const d = new Date(s0); if(!isNaN(d)) return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    return s0;
  }
  function showToast(msg){ toast.textContent = msg || '완료'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }
  function stripeClass(c){ c=String(c||'').toLowerCase(); return c.includes('00ff00')?'green':'cyan'; }
  function setLoading(on, src){ __loading=!!on; if(btnRefresh) btnRefresh.disabled=on;
    if(on){ if(src==='manual'){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
      elUpdated.innerHTML='<span class="mini-spinner"></span>업데이트 중…';
    }else{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); } }

  function loadCollapseMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.collapse)||'{}'); }catch(_){ return{}; } }
  function saveCollapseMap(map){ try{ localStorage.setItem(LS_KEYS.collapse, JSON.stringify(map||{})); }catch(_){ } }
  const collapseMap = loadCollapseMap();

  function renderSectionCardGrouped(sec, ctx){
    const title=sec.title||'-', color=sec.color||'#00FFFF', groups=Array.isArray(sec.groups)?sec.groups:[], timeLabel=sec.timeLabel||timeLabelFromTitle(title);
    const ban=(groups.find(g=>g.plant==='반월')?.rows)||[], sih=(groups.find(g=>g.plant==='시화')?.rows)||[];
    const banF=ban.filter(r=>!isMonoDigitPlate(r.car)), sihF=sih.filter(r=>!isMonoDigitPlate(r.car));

    const plantSel=ctx.plantSel, qq=ctx.qq, dqq=ctx.dqq, isFour=ctx.isFour;
    let merged=[...banF.map(r=>({...r,plant:'반월'})), ...sihF.map(r=>({...r,plant:'시화'}))];
    if(plantSel==='banwol') merged=merged.filter(r=>r.plant==='반월');
    if(plantSel==='sihwa')  merged=merged.filter(r=>r.plant==='시화');
    if(qq) merged=merged.filter(r=>String(r.car||'').includes(qq));

    const hits=new Map();
    if(isFour){ merged.forEach((r,i)=>{ if(last4(r.car)===dqq){ hits.set(i,true); __searchCount++; } }); } else { if(qq) __searchCount+=merged.length; }

    const bcnt=(plantSel==='sihwa')?0:banF.length; const scnt=(plantSel==='banwol')?0:sihF.length; const total=merged.length;
    let seq=1;
    const rowHTML=(r,i,sep)=>{
      const cls=[]; if(sep) cls.push('plant-sep');
      const carCellClass=(isFour && hits.get(i))?'cell-hit':'';
      const timeText=fmtTimeDisplay(r.time);
      return `<tr class="${cls.join(' ')}"><td>${seq++}</td><td class="${carCellClass}">${r.car??''}</td><td>${timeText||r.time||''}</td><td>${r.plant}</td></tr>`;
    };

    let rowsHTML='';
    if(plantSel==='all'){
      const L=merged.filter(r=>r.plant==='반월'), R=merged.filter(r=>r.plant==='시화');
      rowsHTML += L.map((r,idx)=>rowHTML(r,idx,false)).join('');
      if (L.length && R.length){
        rowsHTML += rowHTML(R[0], L.length, true) + R.slice(1).map((r,ii)=>rowHTML(r, L.length+1+ii,false)).join('');
      }else{
        rowsHTML += R.map((r,idx)=>rowHTML(r, L.length+idx, false)).join('');
      }
    }else{
      rowsHTML = merged.map((r,i)=>rowHTML(r,i,false)).join('');
    }

    const table = `
      <table>
        <thead><tr><th style="width:44px">No</th><th style="width:96px">차량</th><th style="width:74px">${timeLabel}</th><th style="width:56px">공장</th></tr></thead>
        <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(없음)</td></tr>' }</tbody>
      </table>`;

    const collapsed=!!collapseMap[title], bodyStyle=collapsed?'style="display:none"':'', toggleLabel=collapsed?'펼치기':'접기';
    const infoLine = ctx.filterActive ? `<div class="summary">※ 검색/필터가 적용된 결과입니다.</div>` : '';

    return `
    <article class="card">
      <div class="stripe ${stripeClass(color)}"></div>
      <div class="head">
        <h3>${title}</h3>
        <div class="head-right">
          <div class="summary" style="border:0;padding:0;margin-right:8px;">총 ${total}건 (반월 ${bcnt}, 시화 ${scnt})</div>
          <button class="btn" data-collapse="${encodeURIComponent(title)}">${toggleLabel}</button>
        </div>
      </div>
      ${infoLine}
      <div class="body" ${bodyStyle}>${table}</div>
    </article>`;
  }

  function render(data){
    try{
      __searchCount=0;
      const ts = data?.updatedAt || '';
      elUpdated.textContent = ts ? `업데이트: ${ts}` : '업데이트 시간 없음';

      const raw = Array.isArray(data?.sections) ? data.sections : [];
      if(!raw.length){ elSections.innerHTML='<div class="col"><div class="card"><div class="empty">데이터 없음</div></div></div>'; return; }

      const byTitle = Object.fromEntries(raw.map(s=>[s.title,s]));
      const left  = LEFT_TITLES.map(t=>byTitle[t]).filter(Boolean);
      const right = RIGHT_TITLES.map(t=>byTitle[t]).filter(Boolean);
      const used  = new Set([...left,...right].map(s=>s.title));
      raw.forEach(s=>{ if(!used.has(s.title)) left.push(s); });

      const plantSel = document.getElementById('plantFilter').value;
      const q  = (document.getElementById('searchInput').value||'').trim();
      const qq = q.replace(/\s+/g,'');
      const dqq = qq.replace(/\D+/g,'');
      const isFour = /^\d{4}$/.test(dqq);
      const filterActive = (plantSel!=='all') || !!qq;
      const ctx = { plantSel, q, qq, dqq, isFour, filterActive };

      const leftHTML  = left .map(sec=>renderSectionCardGrouped(sec,ctx)).join('');
      const rightHTML = right.map(sec=>renderSectionCardGrouped(sec,ctx)).join('');

      elSections.innerHTML = `
        <div class="col col-left">
          ${ leftHTML  || '<div class="card"><div class="empty">좌측 섹션 없음</div></div>' }
        </div>
        <div class="col col-right">
          ${ rightHTML || '<div class="card"><div class="empty">우측 섹션 없음</div></div>' }
        </div>`;

      const badge = document.getElementById('searchSummary');
      if (qq) { badge.style.display='inline-block'; badge.textContent=`${__searchCount}건 검색`; }
      else { badge.style.display='none'; badge.textContent=''; }

      elSections.querySelectorAll('button[data-collapse]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = decodeURIComponent(btn.getAttribute('data-collapse')||'');
          const body = btn.closest('.card').querySelector('.body');
          const now = body.style.display !== 'none';
          body.style.display = now ? 'none' : '';
          collapseMap[key]=now; saveCollapseMap(collapseMap);
          btn.textContent = now ? '펼치기' : '접기';
        });
      });
    }catch(err){
      console.error(err);
      elSections.innerHTML='<div class="col"><div class="card"><div class="empty">렌더링 중 오류</div></div></div>';
    }
  }

  async function loadSnapshotFetch(){
    const url = SNAPSHOT_URL + '?action=snapshot_live&_ts=' + Date.now();
    const res = await fetch(url, { method:'GET', credentials:'omit' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function triggerRefreshLive(){
    const url = SNAPSHOT_URL + '?action=refresh_live&token=DY_SCALE&_ts=' + Date.now();
    try{ await fetch(url, { method:'GET', mode:'no-cors' }); }catch(_){}
  }
  function loadSnapshotJSONP(){
    return new Promise((resolve,reject)=>{
      const cb='CB_'+Math.random().toString(36).slice(2);
      const cleanup=(s)=>{ try{ delete window[cb]; }catch(_){ } s&&s.remove(); };
      window[cb]=(data)=>{ cleanup(script); resolve(data); };
      const script=document.createElement('script');
      const url=SNAPSHOT_URL + '?action=snapshot_live&callback='+cb+'&_ts='+Date.now();
      script.src=url; script.onerror=()=>{ cleanup(script); reject(new Error('JSONP load error')); };
      document.body.appendChild(script);
    });
  }

  async function loadSnapshot(opts={source:'auto'}){
    const source=opts.source||'auto';
    if(__loading){ if(source==='manual') showToast('이미 새로고침 중…'); return; }
    try{
      setLoading(true, source);
      if(source==='manual') await triggerRefreshLive();
      let data = await loadSnapshotFetch();
      try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
      render(data); showToast('업데이트됨');
    }catch(err){
      console.warn('fetch 실패, JSONP 시도:', err);
      if(!USE_JSONP_FALLBACK){
        elSections.innerHTML='<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (CORS/권한 확인)</div></div></div>'; return;
      }
      try{
        if(source==='manual'){
          const base=SNAPSHOT_URL.split('?')[0];
          const cb='CB_'+Math.random().toString(36).slice(2);
          await new Promise((res)=>{
            const s=document.createElement('script');
            window[cb]=()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
            s.onerror=()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
            s.src=`${base}?action=refresh_live&token=DY_SCALE&callback=${cb}&_ts=${Date.now()}`;
            document.head.appendChild(s);
          });
        }
        const data = await loadSnapshotJSONP();
        try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
        render(data); showToast('업데이트됨');
      }catch(e){
        console.error(e);
        elSections.innerHTML='<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (JSONP 실패)</div></div></div>';
      }
    }finally{ setLoading(false); }
  }

  function startInterval(){ if(__timer) clearInterval(__timer); if(!AUTO_REFRESH_MS) return;
    __timer=setInterval(()=>loadSnapshot({source:'auto'}), AUTO_REFRESH_MS); }

  // 필터/검색 상태
  const plantSel = document.getElementById('plantFilter');
  const searchInput = document.getElementById('searchInput');
  plantSel.value = localStorage.getItem(LS_KEYS.plant) || 'all';
  searchInput.value = localStorage.getItem(LS_KEYS.q) || '';

  function rerenderFromCache(){ const cache=localStorage.getItem('snapshot.cache'); if(!cache) return; try{ render(JSON.parse(cache)); }catch(_){} }
  plantSel.addEventListener('change', ()=>{ localStorage.setItem(LS_KEYS.plant, plantSel.value); rerenderFromCache(); });
  searchInput.addEventListener('input', ()=>{ localStorage.setItem(LS_KEYS.q, searchInput.value); rerenderFromCache(); });
  btnRefresh.addEventListener('click', ()=> loadSnapshot({source:'manual'}));

  // ===== 금일 출고 기능 =====
  function todayKST(){ const now=new Date(); const kst=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const y=kst.getFullYear(), m=String(kst.getMonth()+1).padStart(2,'0'), d=String(kst.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }

  function pickField(obj, kind, primaryKeys = []) {
    if (!obj) return '';
    const norm = k => String(k||'').toLowerCase().replace(/[\s_]/g,'');
    const dict = {};
    Object.keys(obj).forEach(k => { dict[norm(k)] = obj[k]; });

    for (const key of primaryKeys){
      const nk = norm(key);
      if (dict[nk] !== undefined && String(dict[nk]).trim() !== '') return dict[nk];
    }

    const CANDS = {
      car: ['carnum','car_no','car','car_num','vehicleno','veh_no','truckno','truck_no','carno','vehicle_no'],
      in:  ['intime','in_time','in_date','in_datetime','in','indt','in_dt','indate','in_date_time','indttm','intm','checkintime','weighintime','weigh_in_time','in_dtm','indt_tm'],
      out: ['outtime','out_time','out_date','out_datetime','out','outdt','out_dt','outdate','out_date_time','outdttm','outtm','exittime','leavetime','departtime','checkouttime','weighouttime','weigh_out_time','out_dtm','outdtm'],
      gross: ['totalweight','totweight','gross','grossweight','gtwei','ttlwei','weighttotal','totalwt','grosswt','grtwei','grweight','grwei','totwei','total'],
      net: ['netweight','net','nw','realweight','siljung','silwei','netwt','weightnet','realwt','netwei'],
      receive: ['receiveweight','receivewei','receive','recv','recvqty','recv_qty','receiveqty','receive_qty','received','insu','insuweight','insul','acceptqty','accept_qty','acceptweight','accept_weight','acceptwei']
    };
    for (const k of (CANDS[kind] || [])) {
      const nk = norm(k);
      if (dict[nk] !== undefined && String(dict[nk]).trim() !== '') return dict[nk];
    }

    const keys = Object.keys(dict);
    const hasVal = k => dict[k] !== undefined && String(dict[k]).trim() !== '';
    const PATTERNS = {
      in:  [/(\b|_)in(?:put)?(?:_)?(time|dt|tm|datetime)?$/i, /(check|weigh).*in.*(time|dt|tm)$/i],
      out: [/(\b|_)out(?:put)?(?:_)?(time|dt|tm|datetime)?$/i, /(exit|leave|depart|checkout|weigh).*out.*(time|dt|tm)$/i],
      gross:[/(total|gross).*?(weight|wt|wei)$/i],
      net: [/(net|real|sil).*?(weight|wt|wei)$/i],
      receive:[/(receive|recv|accept|insu).*?(weight|qty|wei|amount)$/i],
      car: [/(car|veh|truck).*?(no|num|number)$/i]
    };
    const pats = PATTERNS[kind] || [];
    for (const re of pats) {
      const hit = keys.find(k => re.test(k));
      if (hit && hasVal(hit)) return dict[hit];
    }
    return '';
  }

  function buildWeighTable(title, list, query){
    const rows = Array.isArray(list)? list : [];
    const q  = String(query||'').trim();
    const qq = q.replace(/\s+/g,'');
    const dqq = qq.replace(/\D+/g,'');
    const isFour = /^\d{4}$/.test(dqq);

    const filtered = rows.filter((r)=>{
      const carStd = (r && (r.car ?? r.CARNUM ?? r.CAR_NO)) ?? '';
      const car = String(carStd || pickField(r, 'car', ['CARNUM','CAR_NO','CAR','CAR_NUM','VEHICLENO','VEH_NO','TRUCKNO','TRUCK_NO','CAR','CARNO']));
      if (!qq) return true;
      if (isFour) return car.replace(/\D/g,'').endsWith(dqq);
      return car.includes(qq);
    });

    const body = filtered.length ? filtered.map((r, i)=>{
      const rawCar = (r && (r.car ?? r.CARNUM ?? r.CAR_NO)) ??
                     pickField(r, 'car', ['CARNUM','CAR_NO','CAR','CAR_NUM','VEHICLENO','VEH_NO','TRUCKNO','TRUCK_NO','CAR','CARNO']);

      const tin  = (r && (r.in  ?? r.INTIME)) ??
                   pickField(r, 'in', ['INTIME','IN_TIME','IN_DATETIME','IN_DATE','INDTTM','INDT','IN_DT','IN_DATE_TIME']);
      const tout = (r && (r.out ?? r.OUTTIME)) ??
                   pickField(r, 'out', ['OUTTIME','OUT_TIME','OUT_DATETIME','OUT_DATE','OUTDTTM','OUTDT','OUT_DT','OUT_DATE_TIME','OUTTM']);
      const gross = (r && (r.gross ?? r.TOTALWEIGHT ?? r.GROSSWEIGHT ?? r.GROSS)) ??
                    pickField(r, 'gross', ['TOTALWEIGHT','TOTWEIGHT','GROSSWEIGHT','GROSS','TOTAL','TOTAL_WT','GROSS_WT','TTLWEI','GTWEI']);
      const net   = (r && (r.net   ?? r.NETWEIGHT ?? r.REALWEIGHT)) ??
                    pickField(r, 'net', ['NETWEIGHT','NET_WT','NET','REALWEIGHT','SILWEI']);
      const recv  = (r && (r.receive ?? r.RECEIVEWEIGHT ?? r.ACCEPTWEIGHT)) ??
                    pickField(r, 'receive', ['RECEIVEWEIGHT','RECEIVEWEI','RECEIVE','RECV','RECV_QTY','RECVQTY','RECEIVE_QTY','RECEIVEQTY','INSU','INSUWEIGHT','ACCEPT_QTY','ACCEPTWEIGHT','ACCEPT_WEIGHT','ACCEPTWEI']);

      const fmtNum = (n)=>{ const v=Number(String(n??'').toString().replace(/[^\d.-]/g,'')); return isNaN(v)?(n??''):v.toLocaleString(); };
      const fmtHM  = (raw)=> {
        if(raw==null) return '';
        const s=String(raw).trim(); if(!s) return '';
        const m=s.match(/(\d{1,2}):(\d{2})(?::\d{2})?/); if(m) return `${m[1].padStart(2,'0')}:${m[2]}`;
        const d=s.replace(/\D/g,'');
        if(d.length>=12) return `${d.slice(-6,-4)}:${d.slice(-4,-2)}`;
        if(d.length===6) return `${d.slice(0,2)}:${d.slice(2,4)}`;
        if(d.length===4) return `${d.slice(0,2)}:${d.slice(2,4)}`;
        if(/^\d{4}-\d{2}-\d{2}T/.test(s)){ const d2=new Date(s); if(!isNaN(d2)) return `${String(d2.getHours()).padStart(2,'0')}:${String(d2.getMinutes()).padStart(2,'0')}`;}
        return s;
      };

      let carHTML = rawCar;
      if (isFour && rawCar.replace(/\D/g,'').endsWith(dqq)) {
        carHTML = `<span class="cell-hit">${rawCar}</span>`;
      } else if (qq && rawCar.includes(qq)) {
        carHTML = rawCar.replace(qq, `<span class="cell-hit">${qq}</span>`);
      }

      return `<tr>
        <td>${i+1}</td>
        <td>${carHTML}</td>
        <td>${fmtHM(tin)}</td>
        <td>${fmtHM(tout)}</td>
        <td>${fmtNum(gross)}</td>
        <td>${fmtNum(net)}</td>
        <td>${fmtNum(recv)}</td>
      </tr>`;
    }).join('') : `<tr><td colspan="7" class="empty">(검색 결과 없음)</td></tr>`;

    return `
    <article class="card">
      <div class="stripe cyan"></div>
      <div class="head">
        <h3>${title}</h3>
        <div class="head-right">
          <div class="summary" style="border:0;padding:0;">총 ${filtered.length}건</div>
          <button class="btn" data-close-weigh>닫기</button>
        </div>
      </div>
      <div class="body">
        <table>
          <thead>
            <tr>
              <th style="width:44px">No</th>
              <th style="width:120px">차량번호</th>
              <th style="width:74px">입차시간</th>
              <th style="width:74px">출차시간</th>
              <th style="width:86px">총중량</th>
              <th style="width:86px">실중량</th>
              <th style="width:86px">인수량</th>
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
      </div>
    </article>`;
  }

  function renderWeighingPanel(payload){
    window.__lastWeigh = payload;
    const box=document.getElementById('weighingPanel'); if(!box) return;

    const ban = payload?.banwol ?? [];
    const sih = payload?.sihwa  ?? [];
    const updatedAt = payload?.updatedAt ? ` (업데이트: ${payload.updatedAt})` : '';

    const q = (document.getElementById('searchInput').value || '').trim();

    box.innerHTML = `
      <div class="col">${buildWeighTable('금일 출고 – 반월'+updatedAt, ban, q)}</div>
      <div class="col">${buildWeighTable('금일 출고 – 시화'+updatedAt, sih, q)}</div>`;
    box.style.display='';

    box.querySelectorAll('[data-close-weigh]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ box.innerHTML=''; box.style.display='none'; setView('live'); });
    });

    setView('weigh');
  }

  function loadWeighingJSONP(start,end){
    return new Promise((resolve,reject)=>{
      const cb='CBW_'+Math.random().toString(36).slice(2);
      const s=document.createElement('script'); const base=SNAPSHOT_URL.split('?')[0];
      window[cb]=(data)=>{ try{delete window[cb];}catch(_){} s.remove(); resolve(data); };
      s.onerror=()=>{ try{delete window[cb];}catch(_){} s.remove(); reject(new Error('JSONP 실패')); };
      s.src=`${base}?action=weighing_today&token=DY_SCALE&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&callback=${cb}&_ts=${Date.now()}`;
      document.head.appendChild(s);
    });
  }

  async function loadWeighingToday(){
    const start=todayKST(), end=start;
    const base=SNAPSHOT_URL.split('?')[0];
    const url=`${base}?action=weighing_today&token=DY_SCALE&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&_ts=${Date.now()}`;
    try{
      setLoading(true,'manual');
      const res=await fetch(url,{method:'GET',credentials:'omit'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      renderWeighingPanel(data);
      showToast('금일 출고 불러왔습니다');
    }catch(err){
      console.warn('weigh fetch 실패, JSONP 시도:', err);
      try{
        const data=await loadWeighingJSONP(start,end);
        renderWeighingPanel(data);
        showToast('금일 출고(대체경로) 불러왔습니다');
      }catch(e){
        console.error(e);
        alert('금일 출고 데이터를 불러올 수 없었습니다.');
        setView('live');
      }
    }finally{ setLoading(false); }
  }

  // ===== 뷰 전환 =====
  const elWeighPanel=document.getElementById('weighingPanel');
  const elLivePanel =document.getElementById('sections');
  const btnViewLive =document.getElementById('btnViewLive');
  const btnViewWeigh=document.getElementById('btnViewWeigh');
  function setView(mode){
    const live=(mode==='live');
    elLivePanel.style.display = live? '' : 'none';
    elWeighPanel.style.display= live? 'none' : '';
    btnViewLive.classList.toggle('active', live);
    btnViewWeigh.classList.toggle('active', !live);
    btnViewLive.setAttribute('aria-selected', String(live));
    btnViewWeigh.setAttribute('aria-selected', String(!live));
  }
  setView('live');
  btnViewLive.addEventListener('click', ()=>{ setView('live'); });
  btnViewWeigh.addEventListener('click', ()=>{ loadWeighingToday(); });

  // ===== init =====
  (function(){ loadSnapshot({source:'auto'}); startInterval(); })();
  </script>
</body>
</html>
