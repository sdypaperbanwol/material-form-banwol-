<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê³µì¥ ë‚´ ì‹¤ì‹œê°„ ì°¨ëŸ‰ í˜„í™©</title>
  <meta name="description" content="ê³µì¥ ë‚´ ì‹¤ì‹œê°„ ì°¨ëŸ‰ í˜„í™© â€“ GitHub Pagesìš© logistics.html">
  <style>
  :root{
    --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
    --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
    --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;
  }

  .wrap{ max-width:980px; margin:24px auto; padding:0 16px }

  /* ---------- í—¤ë” ---------- */
  .header{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:16px 18px; margin-bottom:16px;
  }
  .title{ margin:0; font-size:20px; letter-spacing:-.2px }
  .subtitle{
    margin:4px 0 0 0; color:var(--muted); font-size:12.5px;
    display:flex; align-items:center; gap:6px
  }
  .mini-spinner{
    display:inline-block; width:12px; height:12px;
    border:2px solid #cfd8ff; border-top-color:var(--brand);
    border-radius:50%; animation:spin .8s linear infinite; vertical-align:-2px
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .badges{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px }
  .badge{ background:var(--badge); border:1px solid #d9e2ff; border-radius:999px; padding:3px 8px; font-size:12px }

  /* ---------- íˆ´ë°” ---------- */
  .toolbar{ display:flex; align-items:center; justify-content:flex-start; gap:8px; margin-top:10px; flex-wrap:wrap }
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; border-radius:10px;
    padding:8px 12px; font-size:13px; cursor:pointer;
  }
  .btn[disabled]{ opacity:.55; cursor:not-allowed }
  .btn:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06) }
  .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }

  .input,.select{
    border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; font-size:13px
  }

  /* ---------- ê·¸ë¦¬ë“œ ---------- */
  .grid{ display:grid; grid-template-columns:1fr; gap:14px }
  .col{ display:grid; gap:14px }
  @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }

  /* ëª¨ë°”ì¼ 1ì—´ì¼ ë•Œ ë§ˆì§€ë§‰ ì¹´ë“œ ì•„ë˜ ì—¬ìœ  */
  @media (max-width:899px){
    .grid > .col:last-child > .card:last-child{ margin-bottom:24px }
    .wrap{ padding-bottom:16px }
  }

  /* ---------- ì¹´ë“œ/ìŠ¤íŠ¸ë¼ì´í”„(ëª¨ë‘ ë„¤ëª¨) ---------- */
  .card{
    background:var(--card); border:1px solid var(--line);
    border-radius:0; /* ì¹´ë“œ ë„¤ëª¨ */
    box-shadow:var(--shadow);
  }
  .stripe{
    height:4px; border-top-left-radius:0; border-top-right-radius:0; /* ë  ë„¤ëª¨ */
  }
  .stripe.cyan{ background:var(--cyan) }
  .stripe.green{ background:var(--green) }

  /* ì¹´ë“œ í—¤ë”: ì œëª©ì´ ìƒë‹¨/ì¢Œì¸¡ì— ë„ˆë¬´ ë¶™ì§€ ì•Šê²Œ íŒ¨ë”© ì—… */
  .card .head{
    padding:16px 18px;               /* ì—¬ìœ  ì¦ê°€ (ê¸°ì¡´ 12px 14px) */
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .card .head h3{ margin:0; font-size:15px }
  .head-right{ display:flex; align-items:center; gap:8px }

  .summary{ padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--line); font-size:12.5px }

  /* ---------- í‘œ ---------- */
  table{ width:100%; border-collapse:separate; border-spacing:0 }
  thead th{
    position:sticky; top:0; background:#fafbfd; border-bottom:1px solid var(--line);
    color:#333; font-weight:600;
  }
  th,td{ padding:8px 10px; text-align:center }
  tbody tr:nth-child(odd){ background:#fcfcfe }
  tbody td{ border-bottom:1px solid #f1f1f4 }

  .empty{ padding:18px 14px; color:var(--muted) }

  /* ë°˜ì›”â†’ì‹œí™” êµ¬ë¶„ì„  */
  tbody tr.plant-sep td{ border-top:2px solid #ff6b6b }

  /* ê²€ìƒ‰ ê°•ì¡° */
  td.cell-hit{ background:#fff2cc !important }
  .badge.search-pill{
    background:#eef3ff; border:1px solid #d9e2ff; border-radius:999px; padding:4px 8px; font-size:12px
  }
  .tag-hit{
    display:inline-block; margin-left:6px; font-size:11px; padding:1px 6px; border-radius:999px;
    background:#fff2cc; border:1px solid #f0e1a6;
  }

  /* ---------- í† ìŠ¤íŠ¸/ì˜¤ë²„ë ˆì´ ---------- */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#111; color:#fff; padding:8px 12px; border-radius:10px;
    opacity:0; pointer-events:none; transition:opacity .25s;
  }
  .toast.show{ opacity:1 }

  .overlay{
    position:fixed; inset:0; background:rgba(17,24,39,.35);
    display:flex; align-items:center; justify-content:center; z-index:9999;
    opacity:0; pointer-events:none; transition:opacity .2s;
  }
  .overlay.show{ opacity:1; pointer-events:auto }
  .overlay .panel{
    background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
    padding:18px 20px; display:flex; align-items:center; gap:10px; min-width:220px; justify-content:center;
  }
  .overlay .spinner{
    width:28px; height:28px; border:3px solid #e5e7eb; border-top-color:var(--brand);
    border-radius:50%; animation:spin 1s linear infinite;
  }

  /* ---------- ì¸ì‡„ ---------- */
  @media print{
    body{ background:#fff }
    .btn,.toast,.overlay{ display:none }
    .wrap{ max-width:1000px; margin:0; padding:0 }
    .header{ box-shadow:none; border:none }
    .grid{ grid-template-columns:1fr 1fr }
  }
</style>

  <!-- ìºì‹œ ë¬´ë ¥í™” ë©”íƒ€(ì„ íƒ) -->
  <meta http-equiv="cache-control" content="max-age=0, no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">ê³µì¥ ë‚´ ì‹¤ì‹œê°„ ì°¨ëŸ‰ í˜„í™©</h1>
      <p class="subtitle" id="updated">ì—…ë°ì´íŠ¸ ì¤€ë¹„ ì¤‘â€¦</p>

      <div class="badges">
        <span class="badge">ì‹ ëŒ€ì–‘ì œì§€ ë°˜ì›”/ì‹œí™”</span>
        <span class="badge">ê³„ê·¼ ê¸°ì¤€</span>
      </div>

      <!-- íˆ´ë°”: ìƒˆë¡œê³ ì¹¨ / í…”ë ˆê·¸ë¨ + (NEW) í•„í„°/ê²€ìƒ‰ -->
<div class="toolbar">
  <select id="plantFilter" class="select" title="ê³µì¥ í•„í„°">
    <option value="all">ì „ì²´</option>
    <option value="banwol">ë°˜ì›”ë§Œ</option>
    <option value="sihwa">ì‹œí™”ë§Œ</option>
  </select>

  <button class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <button class="btn" id="btnWeigh">ê¸ˆì¼ ì¶œê³ í˜„í™©</button>
  <button class="btn" id="btnLive" style="display:none">ì‹¤ì‹œê°„ ë³´ê¸°</button>

 

  <input id="searchInput" class="input" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ê²€ìƒ‰" />
  <span id="searchSummary" class="badge search-pill" style="display:none"></span>
</div> <!-- .toolbar ë -->

</section> <!-- ğŸ”§ header ì„¹ì…˜ ë‹«ê¸° -->

<section class="grid" id="sections">
  <!-- JSê°€ ì±„ì›€ -->
</section>



  <!-- ì¤‘ì•™ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div class="overlay" id="loadingOverlay" aria-hidden="true">
    <div class="panel" role="status" aria-live="polite">
      <div class="spinner" aria-label="ë¡œë”© ì¤‘"></div>
      <div><strong>ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦</strong><br><span style="color:#666;font-size:12px">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</span></div>
    </div>
  </div>

  <div class="toast" id="toast">ì—…ë°ì´íŠ¸ë¨</div>

  <script>
    // ============ ì„¤ì • ============
    const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbwPVgfsJFLPvruwvi11Iq-_rJ0QBgmjIX9i_wapH9vi12lKPd8mlJ-IY7gmSFKgn6_0/exec';
    const USE_JSONP_FALLBACK = true;

    const elUpdated  = document.getElementById('updated');
    const elSections = document.getElementById('sections');
    const btnRefresh = document.getElementById('btnRefresh');
    const toast      = document.getElementById('toast');
    const overlay    = document.getElementById('loadingOverlay');

    // NEW: ë¡œì»¬ ì €ì¥í‚¤(ì ‘ê¸° ìƒíƒœ/ê²€ìƒ‰ ìœ ì§€ìš©)
    const LS_KEYS = {
      collapse: 'ui.collapse.map',
      plant: 'ui.plant',
      q: 'ui.search'
    };

// === ë·° ëª¨ë“œ: 'live'(ê¸°ì¡´ ì‹¤ì‹œê°„) | 'weigh'(ê¸ˆì¼ ì¶œê³ í˜„í™©) ===
let __viewMode = 'live';

// ë°±ì—”ë“œ ìƒˆ ì•¡ì…˜(URL)
function weighingTodayURL() {
  const base = SNAPSHOT_URL.split('?')[0];
  return `${base}?action=weighing_today&_ts=${Date.now()}`;
}

// ìˆ«ì ì²œë‹¨ìœ„ í¬ë§·(kg)
function fmtKG(v) {
  const n = Number(String(v||'').replace(/,/g,''));
  if (isNaN(n)) return String(v||'');
  return n.toLocaleString('ko-KR');
}

    
 let __searchCount = 0;

  function last4(s){
    const d = String(s||'').replace(/\D+/g,'');
    return d.length>=4 ? d.slice(-4) : '';
  }
    
    // ì¢Œ/ìš° ë°°ì¹˜
    const LEFT_TITLES  = ['ì œí’ˆ ìƒì°¨ì¤‘', 'ë¶€ìì¬ ì…ì°¨ì¤‘', 'ì»¨í…Œì´ë„ˆ ì…ì°¨ì¤‘'];
    const RIGHT_TITLES = ['ì›ë£Œ í•˜ì°¨ì¤‘', 'ì›ë£Œ ëŒ€ê¸°'];

    // í•œ ìë¦¬ ë°˜ë³µ ë²ˆí˜¸ í•„í„°(ê°€ì§œ ë²ˆí˜¸ ì œê±°)
    function isMonoDigitPlate(s){
      const d = String(s || '').replace(/\D+/g, '');
      if (d.length < 4) return false;
      return d.split('').every(ch => ch === d[0]);
    }

    // ìë™ ìƒˆë¡œê³ ì¹¨(ì›í•˜ë©´ 0ìœ¼ë¡œ êº¼ë„ ë¨)
    const AUTO_REFRESH_MS = 0;

    let __loading = false;
    let __timer   = null;

    function timeLabelFromTitle(title){
      return /ëŒ€ê¸°/.test(title) ? 'ë“±ë¡ì‹œê°„' : 'ì…ì°¨ì‹œê°„';
    }
// ì…ì°¨ì‹œê°„=HH:MM, "ì›ë£Œ ëŒ€ê¸°" ë“±ë¡ì‹œê°„=MM:SS ì „ìš© í¬ë§·í„°
function fmtTimeDisplay(raw, timeLabel, mmssOnly=false) {
  if (raw == null) return '';
  const s0 = String(raw).trim();
  if (!s0) return '';

  // (1) ì´ë¯¸ ì½œë¡  í¬í•¨ â†’ HH:MMë§Œ ë‚¨ê¸°ê¸°
  const mHM = s0.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
  if (mHM) {
    const HH = mHM[1].padStart(2,'0');
    const MM = mHM[2];
    return `${HH}:${MM}`;
  }

  // (2) ìˆ«ìë§Œ ë“¤ì–´ì˜¨ ì¼€ì´ìŠ¤ ì²˜ë¦¬
  const digits = s0.replace(/\D/g,'');
  if (digits.length >= 6) {               // HHMMSS â†’ HH:MM
    const HH = digits.slice(0,2);
    const MM = digits.slice(2,4);
    return `${HH}:${MM}`;
  }
  if (digits.length === 4) {              // HHMM â†’ HH:MM
    const HH = digits.slice(0,2);
    const MM = digits.slice(2,4);
    return `${HH}:${MM}`;
  }

  // (3) ISO/GMT ê°™ì€ ë‚ ì§œë¬¸ìì—´ â†’ HH:MM
  if (/GMT|^\d{4}-\d{2}-\d{2}T/.test(s0)) {
    const d = new Date(s0);
    if (!isNaN(d)) {
      const HH = String(d.getHours()).padStart(2,'0');
      const MM = String(d.getMinutes()).padStart(2,'0');
      return `${HH}:${MM}`;
    }
  }

  // (4) ëª» ë§ì¶”ë©´ ì›ë³¸ ë¦¬í„´(ê°’ì´ ë¹„ì§€ ì•Šê²Œ)
  return s0;
}



    function showToast(msg){
      toast.textContent = msg || 'ì™„ë£Œ';
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    function stripeClass(color){
      const c = String(color||'').toLowerCase();
      return c.includes('00ff00') ? 'green' : 'cyan';
    }

    function setLoading(on, source){
      __loading = !!on;
       if (btnRefresh) btnRefresh.disabled = on;
      if(on){
        if(source === 'manual'){
          overlay.classList.add('show');
          overlay.setAttribute('aria-hidden','false');
        }
        elUpdated.innerHTML = '<span class="mini-spinner" aria-hidden="true"></span>ì—…ë°ì´íŠ¸ ì¤‘â€¦';
      }else{
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }
    }

    // NEW: ì ‘ê¸° ìƒíƒœ ì €ì¥/ë¡œë“œ
    function loadCollapseMap(){
      try{ return JSON.parse(localStorage.getItem(LS_KEYS.collapse) || '{}'); }catch(_){ return {}; }
    }
    function saveCollapseMap(map){
      try{ localStorage.setItem(LS_KEYS.collapse, JSON.stringify(map||{})); }catch(_){}
    }
    const collapseMap = loadCollapseMap();

    // ì„¹ì…˜ ì¹´ë“œ (í•˜ì´ë¼ì´íŠ¸ ì œê±° ë²„ì „ + NEW: ì ‘ê¸°/í•„í„°/ê²€ìƒ‰)
  // ê¸°ì¡´
// function renderSectionCardGrouped(sec){
function renderSectionCardGrouped(sec, ctx){
  const title  = sec.title || '-';
  const color  = sec.color || '#00FFFF';
  const groups = Array.isArray(sec.groups) ? sec.groups : [];
  const timeLabel = sec.timeLabel || timeLabelFromTitle(title);

  const ban = groups.find(g => g.plant === 'ë°˜ì›”')?.rows || [];
  const sih = groups.find(g => g.plant === 'ì‹œí™”')?.rows || [];

  const banF = ban.filter(r => !isMonoDigitPlate(r.car));
  const sihF = sih.filter(r => !isMonoDigitPlate(r.car));

  // â–¼â–¼ ì—¬ê¸°ë¶€í„° DOM ëŒ€ì‹  ctx ì‚¬ìš© â–¼â–¼
  const plantSel = ctx.plantSel;          // 'all' | 'banwol' | 'sihwa'
  const qq       = ctx.qq;                // ê³µë°± ì œê±°ëœ ê²€ìƒ‰ì–´
  const dqq      = ctx.dqq;               // ìˆ«ìë§Œ
  const isFour   = ctx.isFour;            // 4ìë¦¬ ìˆ«ì ê²€ìƒ‰ ì—¬ë¶€

  let merged = [
    ...banF.map(r => ({...r, plant:'ë°˜ì›”'})),
    ...sihF.map(r => ({...r, plant:'ì‹œí™”'}))
  ];
  if (plantSel === 'banwol') merged = merged.filter(r => r.plant === 'ë°˜ì›”');
  if (plantSel === 'sihwa')  merged = merged.filter(r => r.plant === 'ì‹œí™”');
  if (qq) merged = merged.filter(r => String(r.car||'').includes(qq));

  const hitsMap = new Map();
  if (isFour){
    merged.forEach((r, idx) => {
      const hit = last4(r.car) === dqq;
      if (hit) { hitsMap.set(idx, true); __searchCount++; }
    });
  } else {
    if (qq) __searchCount += merged.length;
  }

  const bcnt = (plantSel==='sihwa') ? 0 : banF.length;
  const scnt = (plantSel==='banwol') ? 0 : sihF.length;
  const total = merged.length;

  let seq = 1;
   const rowHTML = (r, i, sep) => {
    const cls = [];
    if (sep) cls.push('plant-sep');
    const carCellClass = (isFour && hitsMap.get(i)) ? 'cell-hit' : '';
    // "ì›ë£Œ ëŒ€ê¸°"ë§Œ MM:SS ê°•ì œ
    const mmssOnly = (title === 'ì›ë£Œ ëŒ€ê¸°');
    const _t = fmtTimeDisplay(r.time, timeLabel, mmssOnly);
const timeText = _t && _t.trim() ? _t : (r.time ?? '');

   return `
  <tr class="${cls.join(' ')}">
    <td>${seq++}</td>
    <td class="${carCellClass}">${r.car ?? ''}</td>
    <td>${timeText}</td>
    <td>${r.plant}</td>
  </tr>`;
  };

  let rowsHTML = '';
  if (plantSel === 'all') {
    const leftPart  = merged.filter(r=>r.plant==='ë°˜ì›”');
    const rightPart = merged.filter(r=>r.plant==='ì‹œí™”');
    rowsHTML += leftPart.map((r,idx) => rowHTML(r, idx, false)).join('');
    if (leftPart.length && rightPart.length) {
      rowsHTML += rowHTML(rightPart[0], leftPart.length, /*sep*/true)
               +  rightPart.slice(1).map((r,ii)=>rowHTML(r, leftPart.length+1+ii, false)).join('');
    } else {
      rowsHTML += rightPart.map((r,idx)=>rowHTML(r, leftPart.length+idx, false)).join('');
    }
  } else {
    rowsHTML = merged.map((r,i)=>rowHTML(r, i, false)).join('');
  }

  const table = `
    <table>
      <thead>
        <tr>
          <th style="width:44px">No</th>
          <th style="width:96px">ì°¨ëŸ‰</th>
          <th style="width:74px">${timeLabel}</th>
          <th style="width:56px">ê³µì¥</th>
        </tr>
      </thead>
      <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(ì—†ìŒ)</td></tr>' }</tbody>
    </table>`;

  const collapsed   = !!collapseMap[title];
  const bodyStyle   = collapsed ? 'style="display:none"' : '';
  const toggleLabel = collapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';

  // â–¼ ì•ˆë‚´ë¬¸ë„ ctxì—ì„œ ì˜¨ filterActive ì‚¬ìš©
  const infoLine = ctx.filterActive ? `<div class="summary">â€» ê²€ìƒ‰/í•„í„°ê°€ ì ìš©ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</div>` : '';

  return `
    <article class="card">
      <div class="stripe ${stripeClass(color)}"></div>
      <div class="head">
        <h3>${title}</h3>
        <div class="head-right">
          <div class="summary" style="border:0;padding:0;margin-right:8px;">ì´ ${total}ê±´ (ë°˜ì›” ${bcnt}, ì‹œí™” ${scnt})</div>
          <button class="btn" data-collapse="${encodeURIComponent(title)}">${toggleLabel}</button>
        </div>
      </div>
      ${infoLine}
      <div class="body" ${bodyStyle}>
        ${table}
      </div>
    </article>`;
}


   function render(data){
  try{
    __searchCount = 0;

    const ts = data && data.updatedAt ? data.updatedAt : '';
    elUpdated.textContent = ts ? `ì—…ë°ì´íŠ¸: ${ts}` : 'ì—…ë°ì´íŠ¸ ì‹œê°„ ì—†ìŒ';

    const raw = Array.isArray(data && data.sections) ? data.sections : [];
    if(!raw.length){
      elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">ë°ì´í„° ì—†ìŒ</div></div></div>';
      return;
    }

    const byTitle = Object.fromEntries(raw.map(s => [s.title, s]));
    const left  = LEFT_TITLES.map(t => byTitle[t]).filter(Boolean);
    const right = RIGHT_TITLES.map(t => byTitle[t]).filter(Boolean);
    const used = new Set([...left, ...right].map(s => s.title));
    raw.forEach(s => { if(!used.has(s.title)) left.push(s); });

    // â–¼â–¼ ì—¬ê¸°ì„œ ë‹¨ í•œë²ˆë§Œ UI ìƒíƒœ ê³„ì‚°
    const plantSel = document.getElementById('plantFilter').value; // 'all'|'banwol'|'sihwa'
    const q  = (document.getElementById('searchInput').value || '').trim();
    const qq = q.replace(/\s+/g,'');
    const dqq = qq.replace(/\D+/g,'');
    const isFour = /^\d{4}$/.test(dqq);
    const filterActive = (plantSel !== 'all') || !!qq;

    const ctx = { plantSel, q, qq, dqq, isFour, filterActive };

    const leftHTML  = left .map(sec => renderSectionCardGrouped(sec,  ctx)).join('');
    const rightHTML = right.map(sec => renderSectionCardGrouped(sec, ctx)).join('');

    elSections.innerHTML = `
      <div class="col col-left">${ leftHTML  || '<div class="card"><div class="empty">ì¢Œì¸¡ ì„¹ì…˜ ì—†ìŒ</div></div>' }</div>
      <div class="col col-right">${ rightHTML || '<div class="card"><div class="empty">ìš°ì¸¡ ì„¹ì…˜ ì—†ìŒ</div></div>' }</div>
    `;

    // ê²€ìƒ‰ ê²°ê³¼ ë±ƒì§€
    const badge = document.getElementById('searchSummary');
    if (qq) {
      badge.style.display = 'inline-block';
      badge.textContent = `${__searchCount}ê±´ ê²€ìƒ‰`;
    } else {
      badge.style.display = 'none';
      badge.textContent = '';
    }

    // ì ‘ê¸° ë²„íŠ¼ ë°”ì¸ë”© (ì¤‘ë³µ ë¸”ë¡ í•˜ë‚˜ë§Œ ë‚¨ê¸°ê¸°)
    elSections.querySelectorAll('button[data-collapse]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = decodeURIComponent(btn.getAttribute('data-collapse')||'');
        const body = btn.closest('.card').querySelector('.body');
        const now = body.style.display !== 'none';
        body.style.display = now ? 'none' : '';
        collapseMap[key] = now;
        saveCollapseMap(collapseMap);
        btn.textContent = now ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
      });
    });

  } catch(err){
    console.error(err);
    elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">ë Œë”ë§ ì¤‘ ì˜¤ë¥˜</div></div></div>';
  }
}


    async function loadSnapshotFetch(){
      const url = SNAPSHOT_URL + '?action=snapshot_live&_ts=' + Date.now();
      const res = await fetch(url, { method:'GET', credentials:'omit' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

async function triggerRefreshLive() {
  const url = SNAPSHOT_URL + '?action=refresh_live&token=DY_SCALE&_ts=' + Date.now();
  try { await fetch(url, { method:'GET', mode:'no-cors' }); } catch(_) {}
}


    function loadSnapshotJSONP(){
      return new Promise((resolve, reject)=>{
        const cbName = 'CB_' + Math.random().toString(36).slice(2);
        const cleanup = (s)=>{ try{ delete window[cbName]; s && s.remove(); }catch(e){} };
        window[cbName] = (data)=>{ cleanup(script); resolve(data); };
        const script = document.createElement('script');
        const url = SNAPSHOT_URL + '?action=snapshot_live&callback=' + cbName + '&_ts=' + Date.now();
        script.src = url;
        script.onerror = ()=>{ cleanup(script); reject(new Error('JSONP load error')); };
        document.body.appendChild(script);
      });
    }

  async function loadSnapshot(opts = {source:'auto'}){
  const source = opts.source || 'auto';
  if(__loading){
    if(source === 'manual') showToast('ì´ë¯¸ ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦');
    return;
  }
  try{
    setLoading(true, source);
    // ğŸ‘‰ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì¼ ë•Œë§Œ ë°±ì—”ë“œ ë¼ì´ë¸Œ ê°•ì œ ìƒˆë¡œê³ ì¹¨
    if (source === 'manual') { await triggerRefreshLive(); }

    let data = await loadSnapshotFetch();   // â† try ì•ˆìœ¼ë¡œ
    // ìŠ¤ëƒ…ìƒ· ìºì‹œ
    try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
    render(data);
    showToast('ì—…ë°ì´íŠ¸ë¨');
  }catch(err){
    console.warn('fetch ì‹¤íŒ¨, JSONP ì‹œë„:', err);
    if (!USE_JSONP_FALLBACK){
      elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (CORS/ê¶Œí•œ í™•ì¸)</div></div></div>';
      return;
    }
    try{
      // ìˆ˜ë™ì¼ ë•Œ ë³´ìˆ˜ì ìœ¼ë¡œ JSONP íŠ¸ë¦¬ê±°
      if (source === 'manual') {
        const base = SNAPSHOT_URL.split('?')[0];
        const cb   = 'CB_' + Math.random().toString(36).slice(2);
        await new Promise((res)=> {
          const s = document.createElement('script');
          window[cb] = ()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
          s.onerror  = ()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
          s.src = `${base}?action=refresh_live&token=DY_SCALE&callback=${cb}&_ts=${Date.now()}`;
          document.head.appendChild(s);
        });
      }
      const data = await loadSnapshotJSONP();
      try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
      render(data);
      showToast('ì—…ë°ì´íŠ¸ë¨');
    }catch(e){
      console.error(e);
      elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (JSONP ì‹¤íŒ¨)</div></div></div>';
    }
  }finally{
    setLoading(false);
  }
}


    function startInterval(){
      if(__timer) clearInterval(__timer);
      if(!AUTO_REFRESH_MS) return;
      __timer = setInterval(()=>loadSnapshot({source:'auto'}), AUTO_REFRESH_MS);
    }

    // ì´ë²¤íŠ¸
   // âœ… ìƒˆë¡œê³ ì¹¨(ëª¨ë“œ ì¸ì‹)
btnRefresh.addEventListener('click', ()=>{
  if (__viewMode === 'weigh') {
    setLoading(true, 'manual');
    loadWeighingToday().finally(()=> setLoading(false));
  } else {
    loadSnapshot({source:'manual'});
  }
});

// âœ… ëª¨ë“œ ì „í™˜ ë²„íŠ¼
const btnWeigh = document.getElementById('btnWeigh');
const btnLive  = document.getElementById('btnLive');

function switchTo(mode){
  __viewMode = mode;
  if (mode === 'weigh') {
    btnWeigh.style.display = 'none';
    btnLive.style.display  = '';
    btnRefresh.disabled    = false;
    setLoading(true, 'manual');
    loadWeighingToday().finally(()=> setLoading(false));
  } else {
    btnWeigh.style.display = '';
    btnLive.style.display  = 'none';
    setLoading(true, 'manual');
    loadSnapshot({source:'manual'}).finally(()=> setLoading(false));
  }
}

btnWeigh.addEventListener('click', ()=> switchTo('weigh'));
btnLive .addEventListener('click',  ()=> switchTo('live'));

// âœ… í•„í„°/ê²€ìƒ‰ (ëª¨ë“œì— ë§ì¶° ì¬ë Œë”)
const plantSel    = document.getElementById('plantFilter');
const searchInput = document.getElementById('searchInput');

// ì´ˆê¸° ë³µêµ¬
plantSel.value    = localStorage.getItem(LS_KEYS.plant) || 'all';
searchInput.value = localStorage.getItem(LS_KEYS.q)     || '';

// (êµì²´ë³¸) weigh ëª¨ë“œë©´ ì¬í˜¸ì¶œ, live ëª¨ë“œë©´ ìºì‹œ ì¬ë Œë”
function rerenderFromCache(){
  if (__viewMode === 'weigh') {
    loadWeighingToday();
  } else {
    const cache = localStorage.getItem('snapshot.cache');
    if (!cache) return;
    try { render(JSON.parse(cache)); } catch(_) {}
  }
}

plantSel.addEventListener('change', ()=>{
  localStorage.setItem(LS_KEYS.plant, plantSel.value);
  rerenderFromCache();
});
searchInput.addEventListener('input', ()=>{
  localStorage.setItem(LS_KEYS.q, searchInput.value);
  rerenderFromCache();
});

// âœ… init (ê¸°ë³¸ì€ ì‹¤ì‹œê°„ ë³´ê¸°)
(function(){
  loadSnapshot({source:'auto'});
  startInterval();
})();


// ë°±ì—”ë“œ ê°•ì œ ê°±ì‹  í˜¸ì¶œ (ì‘ë‹µì€ ì•ˆì¨ë„ ë¨)
async function triggerUpdateSnapshot() {
  // SNAPSHOT_URLì—ì„œ ë² ì´ìŠ¤ exec URLë§Œ ì¶”ì¶œ
  const base = SNAPSHOT_URL.split('?')[0];
  const url  = `${base}?action=update_snapshot&token=DY_SCALE&_ts=${Date.now()}`;

  // CORS í™˜ê²½ì—ì„œë„ íŠ¸ë¦¬ê±°ë§Œ ë˜ë©´ ë˜ë‹ˆ no-corsë¡œ ë°œì‚¬
  try { await fetch(url, { method: 'GET', mode: 'no-cors' }); }
  catch (_) { /* ë¬´ì‹œ: íŠ¸ë¦¬ê±°ë§Œ ë˜ë©´ OK */ }
}
async function loadWeighingToday() {
  const url = weighingTodayURL();
  // JSON ìš°ì„ , ì‹¤íŒ¨ ì‹œ JSONP í´ë°±
  try {
    const res = await fetch(url, {method:'GET', credentials:'omit'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    renderWeighingView(data);
    elUpdated.textContent = data.updatedAt ? `ì—…ë°ì´íŠ¸: ${data.updatedAt}` : 'ì—…ë°ì´íŠ¸ ì‹œê°„ ì—†ìŒ';
    showToast('ì¶œê³ í˜„í™© ì—…ë°ì´íŠ¸ë¨');
  } catch (err) {
    // JSONP í´ë°±
    try {
      const cbName = 'CB_' + Math.random().toString(36).slice(2);
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        window[cbName] = (payload)=>{ try{ delete window[cbName]; }catch(_){ } s.remove(); renderWeighingView(payload); resolve(); };
        s.onerror = ()=>{ try{ delete window[cbName]; }catch(_){ } s.remove(); reject(new Error('JSONP load error')); };
        s.src = weighingTodayURL() + `&callback=${cbName}`;
        document.head.appendChild(s);
      });
      showToast('ì¶œê³ í˜„í™© ì—…ë°ì´íŠ¸ë¨');
    } catch(e) {
      console.error(e);
      elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">ì¶œê³ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div></div>';
    }
  }
}

function renderWeighingView(payload){
  const rows = Array.isArray(payload?.rows) ? payload.rows : [];
  const plantSel = document.getElementById('plantFilter').value; // 'all'|'banwol'|'sihwa'
  const q  = (document.getElementById('searchInput').value || '').trim();
  const qq = q.replace(/\s+/g,'');
  const dqq = qq.replace(/\D+/g,'');
  const isFour = /^\d{4}$/.test(dqq);

  // í•„í„°ë§
  let view = rows.slice();
  if (plantSel === 'banwol') view = view.filter(r=> r.plant === 'ë°˜ì›”');
  if (plantSel === 'sihwa')  view = view.filter(r=> r.plant === 'ì‹œí™”');
  if (qq) view = view.filter(r => String(r.car||'').includes(qq));

  // ì¹´ìš´íŠ¸/ë±ƒì§€
  const badge = document.getElementById('searchSummary');
  if (qq) {
    badge.style.display = 'inline-block';
    badge.textContent = `${view.length}ê±´ ê²€ìƒ‰`;
  } else {
    badge.style.display = 'none';
    badge.textContent = '';
  }

  const headHTML = `
    <div class="stripe cyan"></div>
    <div class="head">
      <h3>ê¸ˆì¼ ì¶œê³ í˜„í™©</h3>
      <div class="head-right">
        <div class="summary" style="border:0;padding:0;margin-right:8px;">ì´ ${view.length}ê±´</div>
      </div>
    </div>`;

  const bodyRows = view.map((r, i) => {
    const carClass = (isFour && (r.car||'').replace(/\D/g,'').slice(-4) === dqq) ? 'cell-hit' : '';
    return `
      <tr>
        <td>${i+1}</td>
        <td>${r.date||''}</td>
        <td>${r.plant||''}</td>
        <td>${r.intime||''}</td>
        <td>${r.outtime||''}</td>
        <td class="${carClass}">${r.car||''}</td>
        <td>${fmtKG(r.gross)}</td>
        <td>${fmtKG(r.net)}</td>
        <td>${fmtKG(r.reduction)}</td>
        <td>${fmtKG(r.receipt)}</td>
      </tr>`;
  }).join('');

  const table = `
    <table>
      <thead>
        <tr>
          <th style="width:44px">No</th>
          <th style="width:92px">ì¼ì</th>
          <th style="width:56px">ê³µì¥</th>
          <th style="width:74px">ì…ì°¨ì‹œê°„</th>
          <th style="width:74px">ì¶œì°¨ì‹œê°„</th>
          <th style="width:96px">ì°¨ëŸ‰ë²ˆí˜¸</th>
          <th style="width:88px">ì´ì¤‘ëŸ‰</th>
          <th style="width:88px">ì‹¤ì¤‘ëŸ‰</th>
          <th style="width:88px">ê°ëŸ‰</th>
          <th style="width:88px">ì¸ìˆ˜ëŸ‰</th>
        </tr>
      </thead>
      <tbody>${bodyRows || '<tr><td colspan="10" class="empty">(ì—†ìŒ)</td></tr>'}</tbody>
    </table>`;

  elSections.innerHTML = `
    <div class="col">
      <article class="card">
        ${headHTML}
        <div class="body">${table}</div>
      </article>
    </div>`;
}

  </script>
</body>
</html>
