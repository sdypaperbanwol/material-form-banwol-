<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê³µì¥ ë‚´ ì°¨ëŸ‰ í˜„í™©</title>
  <meta name="description" content="ê³µì¥ ë‚´ ì°¨ëŸ‰ í˜„í™© â€“ GitHub Pagesìš© logistics.html">
  <!-- favicon 404 ë°©ì§€ -->
  <link rel="icon" href="data:,">
  <style>
  :root{
    --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
    --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
    --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  .wrap{ max-width:980px; margin:24px auto; padding:0 16px }

  /* header */
  .header{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
           box-shadow:var(--shadow); padding:16px 18px; margin-bottom:16px; }
  .title{ margin:0; font-size:20px; letter-spacing:-.2px }
  .subtitle{ margin:4px 0 0 0; color:var(--muted); font-size:12.5px; display:flex; align-items:center; gap:6px }
  .mini-spinner{ display:inline-block; width:12px; height:12px; border:2px solid #cfd8ff; border-top-color:var(--brand);
                 border-radius:50%; animation:spin .8s linear infinite; vertical-align:-2px }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px }
  .badge{ background:var(--badge); border:1px solid #d9e2ff; border-radius:999px; padding:3px 8px; font-size:12px }

  /* toolbar */
  .toolbar{ display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap }
  .btn{ appearance:none; border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed }
  .btn:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06) }
  .input,.select{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; font-size:13px }

  /* view toggle */
  .view-toggle{ display:flex; gap:0; border:1px solid var(--line); border-radius:10px; overflow:hidden }
  .view-toggle .tbtn{ border:0; background:#fff; padding:8px 12px; font-size:13px; cursor:pointer }
  .view-toggle .tbtn + .tbtn{ border-left:1px solid var(--line) }
  .view-toggle .tbtn.active{ background:var(--brand); color:#fff }

  /* grid */
  .grid{ display:grid; grid-template-columns:1fr; gap:14px }
  .col{ display:grid; gap:14px }
  @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
  @media (max-width:899px){
    .grid > .col:last-child > .card:last-child{ margin-bottom:24px }
    .wrap{ padding-bottom:16px }
  }

  /* card */
  .card{ background:var(--card); border:1px solid var(--line); border-radius:0; box-shadow:var(--shadow) }
  .stripe{ height:4px }
  .stripe.cyan{ background:var(--cyan) }
  .stripe.green{ background:var(--green) }
  .card .head{ padding:16px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px }
  .card .head h3{ margin:0; font-size:15px }
  .head-right{ display:flex; align-items:center; gap:8px }
  .summary{ padding:8px 14px; color:var(--muted); border-bottom:1px solid var(--line); font-size:12.5px }

  /* table */
  table{ width:100%; border-collapse:separate; border-spacing:0 }
  thead th{ position:sticky; top:0; background:#fafbfd; border-bottom:1px solid var(--line); color:#333; font-weight:600 }
  th,td{ padding:8px 10px; text-align:center }
  tbody tr:nth-child(odd){ background:#fcfcfe }
  tbody td{ border-bottom:1px solid #f1f1f4 }
  .empty{ padding:18px 14px; color:var(--muted) }
  tbody tr.plant-sep td{ border-top:2px solid #ff6b6b }
  td.cell-hit{ background:#fff2cc !important }
  .badge.search-pill{ background:#eef3ff; border:1px solid #d9e2ff; border-radius:999px; padding:4px 8px; font-size:12px }

  /* toast & overlay */
  .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
          padding:8px 12px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .25s; }
  .toast.show{ opacity:1 }
  .overlay{ position:fixed; inset:0; background:rgba(17,24,39,.35); display:flex; align-items:center; justify-content:center; z-index:9999;
            opacity:0; pointer-events:none; transition:opacity .2s; }
  .overlay.show{ opacity:1; pointer-events:auto }
  .overlay .panel{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
                   padding:18px 20px; display:flex; align-items:center; gap:10px; min-width:220px; justify-content:center; }
  .overlay .spinner{ width:28px; height:28px; border:3px solid #e5e7eb; border-top-color:var(--brand); border-radius:50%;
                     animation:spin 1s linear infinite; }

  /* weighing panel scroll */
  #weighingPanel{ max-height:70vh; overflow:auto }

  /* print */
  @media print{
    body{ background:#fff }
    .btn,.toast,.overlay{ display:none }
    .wrap{ max-width:1000px; margin:0; padding:0 }
    .header{ box-shadow:none; border:none }
    .grid{ grid-template-columns:1fr 1fr }
  }
  </style>

  <meta http-equiv="cache-control" content="max-age=0, no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">ê³µì¥ ë‚´ ì°¨ëŸ‰ í˜„í™©</h1>
      <p class="subtitle" id="updated">ì—…ë°ì´íŠ¸ ì¤€ë¹„ ì¤‘â€¦</p>

      <div class="badges">
        <span class="badge">ì‹ ëŒ€ì–‘ì œì§€ ë°˜ì›”/ì‹œí™”</span>
        <span class="badge">ê³„ê·¼ ê¸°ì¤€</span>
      </div>

      <div class="toolbar">
        <select id="plantFilter" class="select" title="ê³µì¥ í•„í„°">
          <option value="all">ì „ì²´</option>
          <option value="banwol">ë°˜ì›”ë§Œ</option>
          <option value="sihwa">ì‹œí™”ë§Œ</option>
        </select>

        <button class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>

        <div class="view-toggle" role="tablist" aria-label="ë³´ê¸° ì „í™˜">
          <button class="tbtn active" id="btnViewLive"  role="tab" aria-selected="true">ê³„ê·¼ í˜„í™©</button>
          <button class="tbtn"         id="btnViewWeigh" role="tab" aria-selected="false">ì¶œê³  í˜„í™©(ì œí’ˆ)</button>
        </div>

        <input id="searchInput" class="input" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ê²€ìƒ‰" />
        <span id="searchSummary" class="badge search-pill" style="display:none"></span>
      </div>
    </section>

    <!-- ì¶œê³  í˜„í™©(ì œí’ˆ) íŒ¨ë„ -->
    <section class="grid" id="weighingPanel" style="display:none"></section>

    <!-- ê³„ê·¼ í˜„í™© íŒ¨ë„ -->
    <section class="grid" id="sections"></section>
  </div>

  <!-- overlay & toast -->
  <div class="overlay" id="loadingOverlay" aria-hidden="true">
    <div class="panel" role="status" aria-live="polite">
      <div class="spinner" aria-label="ë¡œë”© ì¤‘"></div>
      <div><strong>ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦</strong><br><span style="color:#666;font-size:12px">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</span></div>
    </div>
  </div>
  <div class="toast" id="toast">ì—…ë°ì´íŠ¸ë¨</div>

  <script>
  // ========= ì„¤ì • =========
  const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbyoQp0rC7-audYDxaF6mCKVGiCQ4OGglKMhfYGOEsasRFEbMiJn_OAb7pbreKkdumbc/exec';
  const USE_JSONP_FALLBACK = true;

  const elUpdated  = document.getElementById('updated');
  const elSections = document.getElementById('sections');
  const btnRefresh = document.getElementById('btnRefresh');
  const toast      = document.getElementById('toast');
  const overlay    = document.getElementById('loadingOverlay');

  const LS_KEYS = { collapse:'ui.collapse.map', plant:'ui.plant', q:'ui.search' };
  let __searchCount = 0;

  function last4(s){ const d=String(s||'').replace(/\D+/g,''); return d.length>=4? d.slice(-4):''; }
  const LEFT_TITLES  = ['ì œí’ˆ ìƒì°¨ì¤‘', 'ë¶€ìì¬ ì…ì°¨ì¤‘', 'ì»¨í…Œì´ë„ˆ ì…ì°¨ì¤‘'];
  const RIGHT_TITLES = ['ì›ë£Œ í•˜ì°¨ì¤‘', 'ì›ë£Œ ëŒ€ê¸°'];
  function isMonoDigitPlate(s){ const d=String(s||'').replace(/\D+/g,''); if(d.length<4) return false; return d.split('').every(ch=>ch===d[0]); }
  const AUTO_REFRESH_MS = 0;
  let __loading=false, __timer=null;
  function timeLabelFromTitle(title){ return /ëŒ€ê¸°/.test(title)?'ë“±ë¡ì‹œê°„':'ì…ì°¨ì‹œê°„'; }

  function fmtTimeDisplay(raw){
    if (raw == null) return '';
    const s0 = String(raw).trim(); if(!s0) return '';
    const mHM = s0.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
    if (mHM) return `${mHM[1].padStart(2,'0')}:${mHM[2]}`;
    const digits = s0.replace(/\D/g,'');
    if (digits.length >= 6) return `${digits.slice(0,2)}:${digits.slice(2,4)}`;
    if (digits.length === 4) return `${digits.slice(0,2)}:${digits.slice(2,4)}`;
    if (/GMT|^\d{4}-\d{2}-\d{2}T/.test(s0)) {
      const d = new Date(s0); if(!isNaN(d)) return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    return s0;
  }

  function firstNonEmpty(...vals){
    for (const v of vals){
      if (v !== undefined && v !== null && String(v).trim() !== '') return v;
    }
    return '';
  }

  function showToast(msg){ toast.textContent = msg || 'ì™„ë£Œ'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }
  function stripeClass(c){ c=String(c||'').toLowerCase(); return c.includes('00ff00')?'green':'cyan'; }
  function setLoading(on, src){ __loading=!!on; if(btnRefresh) btnRefresh.disabled=on;
    if(on){ if(src==='manual'){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
      elUpdated.innerHTML='<span class="mini-spinner"></span>ì—…ë°ì´íŠ¸ ì¤‘â€¦';
    }else{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
  }

  function loadCollapseMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.collapse)||'{}'); }catch(_){ return{}; } }
  function saveCollapseMap(map){ try{ localStorage.setItem(LS_KEYS.collapse, JSON.stringify(map||{})); }catch(_){ } }
  const collapseMap = loadCollapseMap();

  function renderSectionCardGrouped(sec, ctx){
    const title=sec.title||'-', color=sec.color||'#00FFFF', groups=Array.isArray(sec.groups)?sec.groups:[], timeLabel=sec.timeLabel||timeLabelFromTitle(title);
    const ban=(groups.find(g=>g.plant==='ë°˜ì›”')?.rows)||[], sih=(groups.find(g=>g.plant==='ì‹œí™”')?.rows)||[];
    const banF=ban.filter(r=>!isMonoDigitPlate(r.car)), sihF=sih.filter(r=>!isMonoDigitPlate(r.car));

    const plantSel=ctx.plantSel, qq=ctx.qq, dqq=ctx.dqq, isFour=ctx.isFour;
    let merged=[...banF.map(r=>({...r,plant:'ë°˜ì›”'})), ...sihF.map(r=>({...r,plant:'ì‹œí™”'}))];
    if(plantSel==='banwol') merged=merged.filter(r=>r.plant==='ë°˜ì›”');
    if(plantSel==='sihwa')  merged=merged.filter(r=>r.plant==='ì‹œí™”');
    if(qq) merged=merged.filter(r=>String(r.car||'').includes(qq));

    const hits=new Map();
    if(isFour){ merged.forEach((r,i)=>{ if(last4(r.car)===dqq){ hits.set(i,true); __searchCount++; } }); }
    else { if(qq) __searchCount+=merged.length; }

    const bcnt=(plantSel==='sihwa')?0:banF.length; const scnt=(plantSel==='banwol')?0:sihF.length; const total=merged.length;
    let seq=1;
    const rowHTML=(r,i,sep)=>{
      const cls=[]; if(sep) cls.push('plant-sep');
      const carCellClass=(isFour && hits.get(i))?'cell-hit':'';
      const timeText=fmtTimeDisplay(r.time);
      return `<tr class="${cls.join(' ')}"><td>${seq++}</td><td class="${carCellClass}">${r.car??''}</td><td>${timeText||r.time||''}</td><td>${r.plant}</td></tr>`;
    };

    let rowsHTML='';
    if(plantSel==='all'){
      const L=merged.filter(r=>r.plant==='ë°˜ì›”'), R=merged.filter(r=>r.plant==='ì‹œí™”');
      rowsHTML += L.map((r,idx)=>rowHTML(r,idx,false)).join('');
      if (L.length && R.length){
        rowsHTML += rowHTML(R[0], L.length, true) + R.slice(1).map((r,ii)=>rowHTML(r, L.length+1+ii,false)).join('');
      }else{
        rowsHTML += R.map((r,idx)=>rowHTML(r, L.length+idx, false)).join('');
      }
    }else{
      rowsHTML = merged.map((r,i)=>rowHTML(r,i,false)).join('');
    }

    const table = `
      <table>
        <thead><tr><th style="width:44px">No</th><th style="width:96px">ì°¨ëŸ‰</th><th style="width:74px">${timeLabel}</th><th style="width:56px">ê³µì¥</th></tr></thead>
        <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(ì—†ìŒ)</td></tr>' }</tbody>
      </table>`;

    const collapsed=!!collapseMap[title], bodyStyle=collapsed?'style="display:none"':'', toggleLabel=collapsed?'í¼ì¹˜ê¸°':'ì ‘ê¸°';
    const infoLine = ctx.filterActive ? `<div class="summary">â€» ê²€ìƒ‰/í•„í„°ê°€ ì ìš©ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</div>` : '';

    return `
    <article class="card">
      <div class="stripe ${stripeClass(color)}"></div>
      <div class="head">
        <h3>${title}</h3>
        <div class="head-right">
          <div class="summary" style="border:0;padding:0;margin-right:8px;">ì´ ${total}ê±´ (ë°˜ì›” ${bcnt}, ì‹œí™” ${scnt})</div>
          <button class="btn" data-collapse="${encodeURIComponent(title)}">${toggleLabel}</button>
        </div>
      </div>
      ${infoLine}
      <div class="body" ${bodyStyle}>${table}</div>
    </article>`;
  }

  function render(data){
    try{
      __searchCount=0;
      const ts = data?.updatedAt || '';
      elUpdated.textContent = ts ? `ì—…ë°ì´íŠ¸: ${ts}` : 'ì—…ë°ì´íŠ¸ ì‹œê°„ ì—†ìŒ';

      const raw = Array.isArray(data?.sections) ? data.sections : [];
      if(!raw.length){ elSections.innerHTML='<div class="col"><div class="card"><div class="empty">ë°ì´í„° ì—†ìŒ</div></div></div>'; return; }

      const byTitle = Object.fromEntries(raw.map(s=>[s.title,s]));
      const left  = LEFT_TITLES.map(t=>byTitle[t]).filter(Boolean);
      const right = RIGHT_TITLES.map(t=>byTitle[t]).filter(Boolean);
      const used  = new Set([...left,...right].map(s=>s.title));
      raw.forEach(s=>{ if(!used.has(s.title)) left.push(s); });

      const plantSel = document.getElementById('plantFilter').value;
      const q  = (document.getElementById('searchInput').value||'').trim();
      const qq = q.replace(/\s+/g,'');
      const dqq = qq.replace(/\D+/g,'');
      const isFour = /^\d{4}$/.test(dqq);
      const filterActive = (plantSel!=='all') || !!qq;
      const ctx = { plantSel, q, qq, dqq, isFour, filterActive };

      const leftHTML  = left .map(sec=>renderSectionCardGrouped(sec,ctx)).join('');
      const rightHTML = right.map(sec=>renderSectionCardGrouped(sec,ctx)).join('');

      elSections.innerHTML = `
        <div class="col col-left">
          ${ leftHTML  || '<div class="card"><div class="empty">ì¢Œì¸¡ ì„¹ì…˜ ì—†ìŒ</div></div>' }
        </div>
        <div class="col col-right">
          ${ rightHTML || '<div class="card"><div class="empty">ìš°ì¸¡ ì„¹ì…˜ ì—†ìŒ</div></div>' }
        </div>`;

      const badge = document.getElementById('searchSummary');
      if (qq) { badge.style.display='inline-block'; badge.textContent=`${__searchCount}ê±´ ê²€ìƒ‰`; }
      else { badge.style.display='none'; badge.textContent=''; }

      elSections.querySelectorAll('button[data-collapse]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = decodeURIComponent(btn.getAttribute('data-collapse')||'');
          const body = btn.closest('.card').querySelector('.body');
          const now = body.style.display !== 'none';
          body.style.display = now ? 'none' : '';
          collapseMap[key]=now; saveCollapseMap(collapseMap);
          btn.textContent = now ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
        });
      });
    }catch(err){
      console.error(err);
      elSections.innerHTML='<div class="col"><div class="card"><div class="empty">ë Œë”ë§ ì¤‘ ì˜¤ë¥˜</div></div></div>';
    }
  }

  async function loadSnapshotFetch(){
    const url = SNAPSHOT_URL + '?action=snapshot_live&_ts=' + Date.now();
    const res = await fetch(url, { method:'GET', credentials:'omit' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function triggerRefreshLive(){
    const url = SNAPSHOT_URL + '?action=refresh_live&token=DY_SCALE&_ts=' + Date.now();
    try{ await fetch(url, { method:'GET', mode:'no-cors' }); }catch(_){}
  }
  function loadSnapshotJSONP(){
    return new Promise((resolve,reject)=>{
      const cb='CB_'+Math.random().toString(36).slice(2);
      const cleanup=(s)=>{ try{ delete window[cb]; }catch(_){ } s&&s.remove(); };
      window[cb]=(data)=>{ cleanup(script); resolve(data); };
      const script=document.createElement('script');
      const url=SNAPSHOT_URL + '?action=snapshot_live&callback='+cb+'&_ts='+Date.now();
      script.src=url; script.onerror=()=>{ cleanup(script); reject(new Error('JSONP load error')); };
      document.body.appendChild(script);
    });
  }

  async function loadSnapshot(opts={source:'auto'}){
    const source=opts.source||'auto';
    if(__loading){ if(source==='manual') showToast('ì´ë¯¸ ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦'); return; }
    try{
      setLoading(true, source);
      if(source==='manual') await triggerRefreshLive();
      let data = await loadSnapshotFetch();
      try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
      render(data); showToast('ì—…ë°ì´íŠ¸ë¨');
    }catch(err){
      console.warn('fetch ì‹¤íŒ¨, JSONP ì‹œë„:', err);
      if(!USE_JSONP_FALLBACK){
        elSections.innerHTML='<div class="col"><div class="card"><div class="empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (CORS/ê¶Œí•œ í™•ì¸)</div></div></div>'; return;
      }
      try{
        if(source==='manual'){
          const base=SNAPSHOT_URL.split('?')[0];
          const cb='CB_'+Math.random().toString(36).slice(2);
          await new Promise((res)=>{
            const s=document.createElement('script');
            window[cb]=()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
            s.onerror=()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); res(); };
            s.src=`${base}?action=refresh_live&token=DY_SCALE&callback=${cb}&_ts=${Date.now()}`;
            document.head.appendChild(s);
          });
        }
        const data = await loadSnapshotJSONP();
        try{ localStorage.setItem('snapshot.cache', JSON.stringify(data)); }catch(_){}
        render(data); showToast('ì—…ë°ì´íŠ¸ë¨');
      }catch(e){
        console.error(e);
        elSections.innerHTML='<div class="col"><div class="card"><div class="empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (JSONP ì‹¤íŒ¨)</div></div></div>';
      }
    }finally{ setLoading(false); }
  }

  function startInterval(){ if(__timer) clearInterval(__timer); if(!AUTO_REFRESH_MS) return;
    __timer=setInterval(()=>loadSnapshot({source:'auto'}), AUTO_REFRESH_MS); }

  // í•„í„°/ê²€ìƒ‰ ìƒíƒœ
  const plantSel = document.getElementById('plantFilter');
  const searchInput = document.getElementById('searchInput');
  plantSel.value = localStorage.getItem(LS_KEYS.plant) || 'all';
  searchInput.value = localStorage.getItem(LS_KEYS.q) || '';

  function rerenderFromCache(){
    const cache=localStorage.getItem('snapshot.cache');
    if(!cache) return;
    try{ render(JSON.parse(cache)); }catch(_){}
  }

  // ğŸ”§ ê²€ìƒ‰/í•„í„° ì´ë²¤íŠ¸: ì¶œê³  í˜„í™©(ì œí’ˆ) í™”ë©´ì—ì„œë„ ì¦‰ì‹œ ë°˜ì˜
  plantSel.addEventListener('change', ()=>{
    localStorage.setItem(LS_KEYS.plant, plantSel.value);
    if (btnViewLive.classList.contains('active')) rerenderFromCache();
  });
  searchInput.addEventListener('input', ()=>{
    localStorage.setItem(LS_KEYS.q, searchInput.value);
    if (btnViewWeigh.classList.contains('active') && window.__lastWeigh){
      renderWeighingPanel(window.__lastWeigh);
    }else{
      rerenderFromCache();
    }
  });

  // ===== ì¶œê³  í˜„í™©(ì œí’ˆ) ê¸°ëŠ¥ =====
  function todayKST(){
    const now=new Date();
    const kst=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const y=kst.getFullYear(), m=String(kst.getMonth()+1).padStart(2,'0'), d=String(kst.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  // â¬‡ï¸ ì¶œê³  í˜„í™©(ì œí’ˆ) í‘œ: ìš”êµ¬ì‚¬í•­ì— ë§ì¶° CARNUM/INTIME/OUTIME/TOTWEI/SILWEIë§Œ ì‚¬ìš© (6ì—´)
  function buildWeighTable(title, list, query){
    const rows = Array.isArray(list)? list : [];
    const q  = String(query||'').trim();
    const qq = q.replace(/\s+/g,'');
    const dqq = qq.replace(/\D+/g,'');
    const isFour = /^\d{4}$/.test(dqq);

    const fmtHM = (raw)=>{
      if(raw==null) return '';
      let s = String(raw).trim();
      if(!s) return '';
      const m = s.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
      if(m) return `${m[1].padStart(2,'0')}:${m[2]}`;
      const d = s.replace(/\D/g,'');
      if(d.length >= 6) return `${d.slice(0,2)}:${d.slice(2,4)}`;
      if(d.length === 4) return `${d.slice(0,2)}:${d.slice(2,4)}`;
      if(/^\d{4}-\d{2}-\d{2}T/.test(s)){ const dt=new Date(s); if(!isNaN(dt)) return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; }
      s = s.replace(/ì‹œ|ë¶„|ì´ˆ/g, m => ({'ì‹œ':':','ë¶„':':','ì´ˆ':''}[m]));
      const m2 = s.match(/(\d{1,2}):(\d{2})/);
      if(m2) return `${m2[1].padStart(2,'0')}:${m2[2]}`;
      return s;
    };

    const filtered = rows.filter((r)=>{
      const car = String(r?.CARNUM ?? '').trim();
      if (!qq) return true;
      if (isFour) return car.replace(/\D/g,'').endsWith(dqq);
      return car.includes(qq);
    });

    const body = filtered.length ? filtered.map((r, i)=>{
      const car   = String(r?.CARNUM ?? '').trim();
      const tin   = fmtHM(r?.INTIME);
      const tout  = fmtHM(r?.OUTIME); // â€» OUTIME (OUTTIME ì•„ë‹˜)
      const tot   = (r?.TOTWEI ?? '') + '';
      const sil   = (r?.SILWEI ?? '') + '';

      let carHTML = car;
      if (isFour && car.replace(/\D/g,'').endsWith(dqq)) {
        carHTML = `<span class="cell-hit">${car}</span>`;
      } else if (qq && car.includes(qq)) {
        carHTML = car.replace(qq, `<span class="cell-hit">${qq}</span>`);
      }

      return `<tr>
        <td>${i+1}</td>
        <td>${carHTML}</td>
        <td>${tin}</td>
        <td>${tout}</td>
        <td>${tot}</td>
        <td>${sil}</td>
      </tr>`;
    }).join('') : `<tr><td colspan="6" class="empty">(ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ)</td></tr>`;

    return `
      <article class="card">
        <div class="stripe cyan"></div>
        <div class="head">
          <h3>${title}</h3>
          <div class="head-right">
            <div class="summary" style="border:0;padding:0;">ì´ ${filtered.length}ê±´</div>
            <button class="btn" data-close-weigh>ë‹«ê¸°</button>
          </div>
        </div>
        <div class="body">
          <table>
            <thead>
              <tr>
                <th style="width:44px">No</th>
                <th style="width:120px; white-space:nowrap; word-break:keep-all">ì°¨ëŸ‰ë²ˆí˜¸</th>
                <th style="width:74px;  white-space:nowrap; word-break:keep-all">ì…ì°¨ì‹œê°„</th>
                <th style="width:74px;  white-space:nowrap; word-break:keep-all">ì¶œì°¨ì‹œê°„</th>
                <th style="width:84px">ì´ì¤‘ëŸ‰</th>
                <th style="width:84px">ì‹¤ì¤‘ëŸ‰</th>
              </tr>
            </thead>
            <tbody>${body}</tbody>
          </table>
        </div>
      </article>`;
  }

  // â¬‡ï¸ ì œëª©ì—ì„œ (ì—…ë°ì´íŠ¸: â€¦) ì œê±°í•œ ìƒíƒœë¡œ ë Œë”
  function renderWeighingPanel(payload){
    window.__lastWeigh = payload;
    const box=document.getElementById('weighingPanel'); if(!box) return;

    const ban = payload?.banwol ?? [];
    const sih = payload?.sihwa  ?? [];
    const q = (document.getElementById('searchInput').value || '').trim();

    box.innerHTML = `
      <div class="col">${buildWeighTable('ì¶œê³  í˜„í™©(ì œí’ˆ) â€“ ë°˜ì›”', ban, q)}</div>
      <div class="col">${buildWeighTable('ì¶œê³  í˜„í™©(ì œí’ˆ) â€“ ì‹œí™”', sih, q)}</div>`;
    box.style.display='';

    box.querySelectorAll('[data-close-weigh]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ box.innerHTML=''; box.style.display='none'; setView('live'); });
    });

    setView('weigh');
  }

  function loadWeighingJSONP(start,end){
    return new Promise((resolve,reject)=>{
      const cb='CBW_'+Math.random().toString(36).slice(2);
      const s=document.createElement('script'); const base=SNAPSHOT_URL.split('?')[0];
      window[cb]=(data)=>{ try{delete window[cb];}catch(_){ } s.remove(); resolve(data); };
      s.onerror=()=>{ try{delete window[cb];}catch(_){ } s.remove(); reject(new Error('JSONP ì‹¤íŒ¨')); };
      s.src=`${base}?action=weighing_today&token=DY_SCALE&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&callback=${cb}&_ts=${Date.now()}`;
      document.head.appendChild(s);
    });
  }

  async function loadWeighingToday(){
    const start=todayKST(), end=start;
    const base=SNAPSHOT_URL.split('?')[0];
    const url=`${base}?action=weighing_today&token=DY_SCALE&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&_ts=${Date.now()}`;
    try{
      setLoading(true,'manual');
      const res=await fetch(url,{method:'GET',credentials:'omit'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      renderWeighingPanel(data);
      showToast('ì¶œê³  í˜„í™©(ì œí’ˆ) ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    }catch(err){
      console.warn('weigh fetch ì‹¤íŒ¨, JSONP ì‹œë„:', err);
      try{
        const data=await loadWeighingJSONP(start,end);
        renderWeighingPanel(data);
        showToast('ì¶œê³  í˜„í™©(ì œí’ˆ)(ëŒ€ì²´ê²½ë¡œ) ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
      }catch(e){
        console.error(e);
        alert('ì¶œê³  í˜„í™©(ì œí’ˆ) ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.');
        setView('live');
      }
    }finally{ setLoading(false); }
  }

  // ===== ë·° ì „í™˜ =====
  const elWeighPanel=document.getElementById('weighingPanel');
  const elLivePanel =document.getElementById('sections');
  const btnViewLive =document.getElementById('btnViewLive');
  const btnViewWeigh=document.getElementById('btnViewWeigh');
  function setView(mode){
    const live=(mode==='live');
    elLivePanel.style.display = live? '' : 'none';
    elWeighPanel.style.display= live? 'none' : '';
    btnViewLive.classList.toggle('active', live);
    btnViewWeigh.classList.toggle('active', !live);
    btnViewLive.setAttribute('aria-selected', String(live));
    btnViewWeigh.setAttribute('aria-selected', String(!live));
  }
  setView('live');
  btnViewLive.addEventListener('click', ()=>{ setView('live'); });
  btnViewWeigh.addEventListener('click', ()=>{ loadWeighingToday(); });

  // ===== init =====
  (function(){ loadSnapshot({source:'auto'}); startInterval(); })();
  </script>
</body>
</html>
