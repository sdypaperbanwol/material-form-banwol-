<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>대양통운 공내 실시간 차량 현황</title>
  <meta name="description" content="대양통운 공내 실시간 차량 현황 뷰어 – GitHub Pages용 logistics.html">
  <style>
    :root{
      --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
      --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
      --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}

    .header{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 18px;margin-bottom:16px}
    .title{margin:0;font-size:20px;letter-spacing:-.2px}
    .subtitle{margin:4px 0 0 0;color:var(--muted);font-size:12.5px}
    .badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .badge{background:var(--badge);border:1px solid #d9e2ff;border-radius:999px;padding:3px 8px;font-size:12px}
    .badges .btn{margin-left:6px}

    .toolbar{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}

    /* === 2-베이 레이아웃 === */
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .col{display:grid;gap:14px}
    @media (min-width:900px){
      .grid{grid-template-columns:1fr 1fr}
    }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .card .head h3{margin:0;font-size:15px}
    .stripe{height:4px;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .stripe.cyan{background:var(--cyan)}
    .stripe.green{background:var(--green)}

    .summary{padding:8px 14px;color:var(--muted);border-bottom:1px solid var(--line);font-size:12.5px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fafbfd;border-bottom:1px solid var(--line);color:#333;font-weight:600}
    th,td{padding:8px 10px;text-align:center}
    tbody tr:nth-child(odd){background:#fcfcfe}
    tbody td{border-bottom:1px solid #f1f1f4}

    .empty{padding:18px 14px;color:var(--muted)}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}

    @media print{
      body{background:#fff}
      .btn,.toast{display:none}
      .wrap{max-width:1000px;margin:0;padding:0}
      .header{box-shadow:none;border:none}
      .grid{grid-template-columns:1fr 1fr}
    }
/* 반월→시화 구간 구분선 */
tbody tr.plant-sep td{
  border-top: 2px solid #ff6b6b;   /* 빨간 선 */
}

  

  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">대양통운 공내 실시간 차량 현황</h1>
      <p class="subtitle" id="updated">업데이트 준비 중…</p>

      <!-- 배지 2개만 유지 + 텔레그램 버튼을 바로 옆에 -->
      <div class="badges">
        <span class="badge">범위: 공내</span>
        <span class="badge">대양통운 전용</span>
        <span class="badge">계근 기준</span>
        <a class="btn" href="https://t.me/Logistics_Vehicle_List_bot" target="_blank" rel="noopener">텔레그램 열기</a>
      </div>

      <!-- 툴바: 새로고침/간격/인쇄만 -->
      <div class="toolbar">
        <select id="interval" class="btn" title="새로고침 간격">
          <option value="30">30초</option>
          <option value="60" selected>60초</option>
          <option value="120">120초</option>
        </select>
        <button class="btn" id="btnRefresh">새로고침</button>
        <button class="btn primary" id="btnPrint">인쇄/PDF</button>
      </div>
    </section>

    <!-- 2베이 컨테이너: 좌(제품 상차 진행) / 우(원료 하차 진행 + 원료 하차대기) -->
    <section class="grid" id="sections">
      <!-- JS가 채움 -->
    </section>
  </div>

  <div class="toast" id="toast">업데이트됨</div>

  <script>
    // =============================
    //  설정: GAS 스냅샷 엔드포인트
    // =============================
    const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbyyf1E9o4qBqxy_f2SxjV_vjkJUrYjgTkL83JL9dTvMd6bYn3iaMcvmXu7O-jCSRLaOJg/exec?api=snapshot';
    const USE_JSONP_FALLBACK = true;

    const elUpdated  = document.getElementById('updated');
    const elSections = document.getElementById('sections');
    const elInterval = document.getElementById('interval');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnPrint   = document.getElementById('btnPrint');
    const toast      = document.getElementById('toast');
    
function timeLabelFromTitle(title){
  return /대기/.test(title) ? '등록시간' : '입차시간';
}

    
    
    function showToast(msg){
      toast.textContent = msg || '완료';
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    function stripeClass(color){
      const c = String(color||'').toLowerCase();
      return c.includes('00ff00') ? 'green' : 'cyan';
    }

 // (A) 새 함수: 연속번호 + 구분헤더
function renderSectionCardGrouped(sec){
  const title  = sec.title || '-';
  const color  = sec.color || '#00FFFF';
  const groups = Array.isArray(sec.groups) ? sec.groups : [];
   const timeLabel = sec.timeLabel || timeLabelFromTitle(title);

  const ban = groups.find(g => g.plant === '반월')?.rows || [];
  const sih = groups.find(g => g.plant === '시화')?.rows || [];

  const bcnt = ban.length, scnt = sih.length, total = bcnt + scnt;

  let seq = 1;
  const rowHTML = (r, plant, sep) => `
    <tr${sep ? ' class="plant-sep"' : ''}>
      <td>${seq++}</td>
      <td>${r.car ?? ''}</td>
      <td>${r.time ?? ''}</td>
      <td>${plant}</td>
    </tr>`;

  // 반월 → 시화 순으로 출력, 시화 첫 행에만 구분선
  const rowsHTML =
    ban.map(r => rowHTML(r, '반월', false)).join('') +
    sih.map((r, i) => rowHTML(r, '시화', !!ban.length && i === 0)).join('');

  const table = `
    <table>
      <thead>
        <tr>
          <th style="width:44px">No</th>
          <th style="width:96px">차량</th>
         <th style="width:74px">${timeLabel}</th>
          <th style="width:56px">공장</th>
        </tr>
      </thead>
      <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(없음)</td></tr>' }</tbody>
    </table>`;

  return `
    <article class="card">
      <div class="stripe ${stripeClass(color)}"></div>
      <div class="head"><h3>${title}</h3></div>
      <div class="summary">총 ${total}건 (반월 ${bcnt}, 시화 ${scnt})</div>
      ${table}
    </article>`;
}



    // 섹션 찾기(타이틀 매칭), 없으면 null
    function pickByTitle(sections, keyword){
      return sections.find(s => (s.title||'').includes(keyword)) || null;
    }

    function render(data){
      try{
        const ts = data && data.updatedAt ? data.updatedAt : '';
        elUpdated.textContent = ts ? `업데이트: ${ts} (KST)` : '업데이트 시간 없음';

        const sections = Array.isArray(data && data.sections) ? data.sections : [];
        if(!sections.length){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터 없음</div></div></div>';
          return;
        }

        // 기대 순서: [제품 상차 진행, 원료 하차 진행, 원료 하차대기]
        const secProd = pickByTitle(sections, '제품 상차 진행') || sections[0] || null;
        const secRawP = pickByTitle(sections, '원료 하차 진행') || sections[1] || null;
        const secRawW = pickByTitle(sections, '원료 하차대기') || sections[2] || null;

       const leftHTML  = secProd ? renderSectionCardGrouped(secProd) : '';
const rightHTML = [secRawP, secRawW].filter(Boolean).map(renderSectionCardGrouped).join('');

        // 2베이 컨테이너 구성 (모바일: 1열로 col-left → col-right 순서)
        elSections.innerHTML = `
          <div class="col col-left">
            ${ leftHTML || '<div class="card"><div class="empty">(제품 상차 진행 없음)</div></div>' }
          </div>
          <div class="col col-right">
            ${ rightHTML || '<div class="card"><div class="empty">(원료 하차 섹션 없음)</div></div>' }
          </div>
        `;
      }catch(err){
        console.error(err);
        elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">렌더링 중 오류</div></div></div>';
      }
    }

    async function loadSnapshotFetch(){
      const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now(); // 캐시 회피
      const res = await fetch(url, { method:'GET', credentials:'omit' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function loadSnapshotJSONP(){
      return new Promise((resolve, reject)=>{
        const cbName = 'CB_' + Math.random().toString(36).slice(2);
        const cleanup = (s)=>{ try{ delete window[cbName]; s && s.remove(); }catch(e){} };
        window[cbName] = (data)=>{ cleanup(script); resolve(data); };
        const script = document.createElement('script');
        const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + 'callback=' + cbName + '&_ts=' + Date.now();
        script.src = url;
        script.onerror = ()=>{ cleanup(script); reject(new Error('JSONP load error')); };
        document.body.appendChild(script);
      });
    }

    async function loadSnapshot(){
      try{
        let data = await loadSnapshotFetch();
        render(data); showToast('업데이트됨');
      }catch(err){
        console.warn('fetch 실패, JSONP 시도:', err);
        if (!USE_JSONP_FALLBACK){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (CORS/권한 확인)</div></div></div>';
          return;
        }
        try{
          const data = await loadSnapshotJSONP();
          render(data); showToast('업데이트됨');
        }catch(e){
          console.error(e);
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (JSONP 실패)</div></div></div>';
        }
      }
    }

    elInterval.addEventListener('change', ()=>{
      if (window.__timer) clearInterval(window.__timer);
      const sec = Number(elInterval.value || 60);
      window.__timer = setInterval(loadSnapshot, sec * 1000);
    });
    btnRefresh.addEventListener('click', loadSnapshot);
    btnPrint.addEventListener('click', ()=> window.print());

    // init
    (function(){
      loadSnapshot();
      const sec = Number(elInterval.value || 60);
      window.__timer = setInterval(loadSnapshot, sec * 1000);
    })();
  </script>
</body>
</html>
