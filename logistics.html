<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>공장 내 실시간 차량 현황</title>
  <meta name="description" content="공장 내 실시간 차량 현황 – GitHub Pages용 logistics.html">
  <style>
    :root{
      --ink:#222; --muted:#666; --line:#e6e6e6; --bg:#f7f8fa; --card:#fff;
      --cyan:#00FFFF; --green:#00FF00; --badge:#eef3ff; --chip:#f0f3f7;
      --brand:#0f62fe; --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}

    .header{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 18px;margin-bottom:16px}
    .title{margin:0;font-size:20px;letter-spacing:-.2px}
    .subtitle{margin:4px 0 0 0;color:var(--muted);font-size:12.5px;display:flex;align-items:center;gap:6px}
    .mini-spinner{display:inline-block;width:12px;height:12px;border:2px solid #cfd8ff;border-top-color:var(--brand);border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .badge{background:var(--badge);border:1px solid #d9e2ff;border-radius:999px;padding:3px 8px;font-size:12px}
    .badges .btn{margin-left:6px}

    .toolbar{display:flex;align-items:center;justify-content:flex-start;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}

    /* === 2-베이 레이아웃 === */
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .col{display:grid;gap:14px}
    @media (min-width:900px){
      .grid{grid-template-columns:1fr 1fr}
    }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .card .head h3{margin:0;font-size:15px}
    .stripe{height:4px;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .stripe.cyan{background:var(--cyan)}
    .stripe.green{background:var(--green)}
    .stripe.sub{background:var(--sub)}
    .stripe.orange{background:var(--cont)}

    .summary{padding:8px 14px;color:var(--muted);border-bottom:1px solid var(--line);font-size:12.5px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fafbfd;border-bottom:1px solid var(--line);color:#333;font-weight:600}
    th,td{padding:8px 10px;text-align:center}
    tbody tr:nth-child(odd){background:#fcfcfe}
    tbody td{border-bottom:1px solid #f1f1f4}

    .empty{padding:18px 14px;color:var(--muted)}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}

    /* 로딩 오버레이 */
    .overlay{position:fixed;inset:0;background:rgba(17,24,39,.35);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s}
    .overlay.show{opacity:1;pointer-events:auto}
    .overlay .panel{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:18px 20px;display:flex;align-items:center;gap:10px;min-width:220px;justify-content:center}
    .overlay .spinner{width:28px;height:28px;border:3px solid #e5e7eb;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}

    @media print{
      body{background:#fff}
      .btn,.toast,.overlay{display:none}
      .wrap{max-width:1000px;margin:0;padding:0}
      .header{box-shadow:none;border:none}
      .grid{grid-template-columns:1fr 1fr}
    }
    /* 반월→시화 구간 구분선 */
    tbody tr.plant-sep td{ border-top: 2px solid #ff6b6b; }
    tbody tr.hit td{ background:#fff2cc !important; }

    #manageModal{ z-index:10000; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1 class="title">공장 내 실시간 차량 현황</h1>
      <p class="subtitle" id="updated">업데이트 준비 중…</p>

      <div class="badges">
        <span class="badge">신대양제지 반월/시화</span>
        <span class="badge">계근 기준</span>
      </div>

      <!-- 툴바: 새로고침 / 통운차량 관리 / 텔레그램 열기만 유지 -->
      <div class="toolbar">
        <button class="btn" id="btnRefresh">새로고침</button>
        <button class="btn" id="btnManage">통운차량 관리</button>
        <a class="btn" href="https://t.me/Logistics_Vehicle_List_bot" target="_blank" rel="noopener">텔레그램 열기</a>
      </div>

      <!-- 통운차량 관리 모달 -->
      <div class="overlay" id="manageModal" aria-hidden="true">
        <div class="panel" style="min-width:420px;flex-direction:column;align-items:stretch">
          <div style="font-weight:600;margin-bottom:8px">통운차량 관리 (마지막 4자리)</div>
          <textarea id="markerInput" rows="8" style="width:100%;resize:vertical"
            placeholder="예) 1234&#10;5678&#10;9012"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button class="btn" id="btnCancelManage">취소</button>
            <button class="btn primary" id="btnSaveManage">저장</button>
          </div>
          <div style="color:#777;font-size:12px;margin-top:6px">
            • 숫자/공백/쉼표 구분, 마지막 4자리만 저장됩니다.<br/>
            • 저장 후 목록에 포함된 차량만 음영 표시됩니다. (제품 상차중은 제외)
          </div>
        </div>
      </div>
    </section>

    <section class="grid" id="sections">
      <!-- JS가 채움 -->
    </section>
  </div>

  <!-- 중앙 로딩 오버레이 -->
  <div class="overlay" id="loadingOverlay" aria-hidden="true">
    <div class="panel" role="status" aria-live="polite">
      <div class="spinner" aria-label="로딩 중"></div>
      <div><strong>새로고침 중…</strong><br><span style="color:#666;font-size:12px">잠시만 기다려주세요</span></div>
    </div>
  </div>

  <div class="toast" id="toast">업데이트됨</div>

  <script>
    // =============================
    //  설정: GAS 스냅샷 엔드포인트
    // =============================
    const SNAPSHOT_URL = 'https://script.google.com/macros/s/AKfycbyTlFkyvYoWaFbxlo0irFw0mZeT5RJLXPhiZsblAWKBw0HjB3rdN9IA8P0UN0zFxlzmAw/exec?api=snapshot';
    const USE_JSONP_FALLBACK = true;

    const elUpdated  = document.getElementById('updated');
    const elSections = document.getElementById('sections');
    const btnRefresh = document.getElementById('btnRefresh');
    const toast      = document.getElementById('toast');
    const overlay    = document.getElementById('loadingOverlay');

    // 좌/우 배치
    const LEFT_TITLES  = ['제품 상차중', '부자재 입차중', '컨테이너 입차중'];
    const RIGHT_TITLES = ['원료 하차중', '원료 대기'];

    // 하이라이트(음영) 제외할 섹션
    const NO_HIT_TITLES = new Set(['제품 상차중']);

    // '1111 / 22222 / 0000 …' 같은 한 자리 반복 번호 필터
    function isMonoDigitPlate(s){
      const d = String(s || '').replace(/\D+/g, '');
      if (d.length < 4) return false;           // 4자리 미만은 필터 안함
      return d.split('').every(ch => ch === d[0]);
    }

    // 자동 새로고침 주기(고정). 0으로 두면 자동 새로고침 끔.
    const AUTO_REFRESH_MS = 60000; // 60초

    // 중복 호출 방지 플래그
    let __loading = false;
    let __timer   = null;

    function timeLabelFromTitle(title){
      return /대기/.test(title) ? '등록시간' : '입차시간';
    }

    function showToast(msg){
      toast.textContent = msg || '완료';
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    function stripeClass(color){
      const c = String(color||'').toLowerCase();
      return c.includes('00ff00') ? 'green' : 'cyan';
    }

    // 로딩 상태 토글 (manual은 오버레이, auto는 헤더 스피너만)
    function setLoading(on, source){
      __loading = !!on;
      // 컨트롤 비활성화
      btnRefresh.disabled = on;
      if(on){
        if(source === 'manual'){
          overlay.classList.add('show');
          overlay.setAttribute('aria-hidden','false');
        }
        elUpdated.innerHTML = '<span class="mini-spinner" aria-hidden="true"></span>업데이트 중…';
      }else{
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }
    }

    // (A) 새 함수: 연속번호 + 구분헤더
    function renderSectionCardGrouped(sec){
      const title  = sec.title || '-';
      const color  = sec.color || '#00FFFF';
      const groups = Array.isArray(sec.groups) ? sec.groups : [];
      const timeLabel = sec.timeLabel || timeLabelFromTitle(title);

      const ban = groups.find(g => g.plant === '반월')?.rows || [];
      const sih = groups.find(g => g.plant === '시화')?.rows || [];

      // ① 한 자리 반복 번호 제거
      const banF = ban.filter(r => !isMonoDigitPlate(r.car));
      const sihF = sih.filter(r => !isMonoDigitPlate(r.car));

      const bcnt = banF.length, scnt = sihF.length, total = bcnt + scnt;

      let seq = 1;
      const rowHTML = (r, plant, sep) => {
        const cls = [];
        if (sep) cls.push('plant-sep');
        // ② 백엔드가 내려준 r.hit 사용, '제품 상차중'은 제외
        if (r.hit && !NO_HIT_TITLES.has(title)) cls.push('hit');
        const classAttr = cls.length ? ` class="${cls.join(' ')}"` : '';
        return `
          <tr${classAttr}>
            <td>${seq++}</td>
            <td>${r.car ?? ''}</td>
            <td>${r.time ?? ''}</td>
            <td>${plant}</td>
          </tr>`;
      };

      const rowsHTML =
        banF.map(r => rowHTML(r, '반월', false)).join('') +
        sihF.map((r, i) => rowHTML(r, '시화', !!banF.length && i === 0)).join('');

      const table = `
        <table>
          <thead>
            <tr>
              <th style="width:44px">No</th>
              <th style="width:96px">차량</th>
              <th style="width:74px">${timeLabel}</th>
              <th style="width:56px">공장</th>
            </tr>
          </thead>
          <tbody>${ total ? rowsHTML : '<tr><td colspan="4" class="empty">(없음)</td></tr>' }</tbody>
        </table>`;

      return `
        <article class="card">
          <div class="stripe ${stripeClass(color)}"></div>
          <div class="head"><h3>${title}</h3></div>
          <div class="summary">총 ${total}건 (반월 ${bcnt}, 시화 ${scnt})</div>
          ${table}
        </article>`;
    }

    // 섹션 찾기(타이틀 매칭), 없으면 null
    function pickByTitle(sections, keyword){
      return sections.find(s => (s.title||'').includes(keyword)) || null;
    }

    function render(data){
      try{
        const ts = data && data.updatedAt ? data.updatedAt : '';
        elUpdated.textContent = ts ? `업데이트: ${ts} (KST)` : '업데이트 시간 없음';

        const raw = Array.isArray(data && data.sections) ? data.sections : [];
        if(!raw.length){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터 없음</div></div></div>';
          return;
        }

        // 제목 → 섹션 맵
        const byTitle = Object.fromEntries(raw.map(s => [s.title, s]));

        // 좌/우 컬럼 구성
        const left  = LEFT_TITLES.map(t => byTitle[t]).filter(Boolean);   // 제품·부자재·컨테이너
        const right = RIGHT_TITLES.map(t => byTitle[t]).filter(Boolean);  // 원하·원대

        // 혹시 API가 추가 섹션을 내려보내면 좌측 맨 아래에 붙이기
        const used = new Set([...left, ...right].map(s => s.title));
        raw.forEach(s => { if(!used.has(s.title)) left.push(s); });

        const leftHTML  = left.map(renderSectionCardGrouped).join('');
        const rightHTML = right.map(renderSectionCardGrouped).join('');

        elSections.innerHTML = `
          <div class="col col-left">${ leftHTML || '<div class="card"><div class="empty">좌측 섹션 없음</div></div>' }</div>
          <div class="col col-right">${ rightHTML || '<div class="card"><div class="empty">우측 섹션 없음</div></div>' }</div>
        `;
      }catch(err){
        console.error(err);
        elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">렌더링 중 오류</div></div></div>';
      }
    }

    async function loadSnapshotFetch(){
      const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now(); // 캐시 회피
      const res = await fetch(url, { method:'GET', credentials:'omit' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function loadSnapshotJSONP(){
      return new Promise((resolve, reject)=>{
        const cbName = 'CB_' + Math.random().toString(36).slice(2);
        const cleanup = (s)=>{ try{ delete window[cbName]; s && s.remove(); }catch(e){} };
        window[cbName] = (data)=>{ cleanup(script); resolve(data); };
        const script = document.createElement('script');
        const url = SNAPSHOT_URL + (SNAPSHOT_URL.includes('?') ? '&' : '?') + 'callback=' + cbName + '&_ts=' + Date.now();
        script.src = url;
        script.onerror = ()=>{ cleanup(script); reject(new Error('JSONP load error')); };
        document.body.appendChild(script);
      });
    }

    // source: 'manual' | 'auto'
    async function loadSnapshot(opts = {source:'auto'}){
      const source = opts.source || 'auto';

      // 이미 로딩 중이면: manual은 토스트 안내, auto는 조용히 스킵
      if(__loading){
        if(source === 'manual') showToast('이미 새로고침 중…');
        return;
      }

      try{
        setLoading(true, source);
        let data = await loadSnapshotFetch();
        render(data);
        showToast('업데이트됨');
      }catch(err){
        console.warn('fetch 실패, JSONP 시도:', err);
        if (!USE_JSONP_FALLBACK){
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (CORS/권한 확인)</div></div></div>';
          return;
        }
        try{
          const data = await loadSnapshotJSONP();
          render(data);
          showToast('업데이트됨');
        }catch(e){
          console.error(e);
          elSections.innerHTML = '<div class="col"><div class="card"><div class="empty">데이터를 불러올 수 없습니다. (JSONP 실패)</div></div></div>';
        }
      }finally{
        setLoading(false);
      }
    }

    function startInterval(){
      if(__timer) clearInterval(__timer);
      if(!AUTO_REFRESH_MS) return; // 0이면 자동 새로고침 비활성화
      __timer = setInterval(()=>loadSnapshot({source:'auto'}), AUTO_REFRESH_MS);
    }

    // 이벤트
    btnRefresh.addEventListener('click', ()=> loadSnapshot({source:'manual'}));

    // init
    (function(){
      loadSnapshot({source:'auto'});
      startInterval();
    })();

    // === 관리용 API ===
    const EXEC_BASE = SNAPSHOT_URL.split('?')[0];     // .../exec
    const API_SECRET = 'CHANGE_ME_1234';              // GAS에 설정한 값(설정 안했으면 빈 문자열로 둬도 됨)

    // JSONP
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb = 'CB_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const cleanup = ()=>{ try{ delete window[cb]; s.remove(); }catch(e){} };
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb + '&_ts=' + Date.now();
        document.body.appendChild(s);
      });
    }

    // 모달 열기/닫기
    const manageModal = document.getElementById('manageModal');
    const markerInput = document.getElementById('markerInput');

    document.getElementById('btnManage').addEventListener('click', async ()=>{
      // 서버에서 현재 목록 로드
      try{
        const data = await jsonp(EXEC_BASE + '?api=hit_get');
        const arr = Array.isArray(data && data.markers) ? data.markers : [];
        markerInput.value = arr.join('\n');
      }catch(e){
        markerInput.value = '';
      }
      manageModal.classList.add('show');
      manageModal.setAttribute('aria-hidden','false');
    });

    document.getElementById('btnCancelManage').addEventListener('click', ()=>{
      manageModal.classList.remove('show');
      manageModal.setAttribute('aria-hidden','true');
    });

    document.getElementById('btnSaveManage').addEventListener('click', async ()=>{
      // 입력 파싱(숫자만, 마지막 4자리)
      const raw = markerInput.value || '';
      const parts = raw.split(/[\s,]+/).filter(Boolean);
      const last4 = [...new Set(parts.map(s=>{
        const d = String(s).replace(/\D+/g,'');
        return d.length>=4 ? d.slice(-4) : '';
      }).filter(Boolean))];

      try{
        const q = new URLSearchParams({
          api:'hit_set',
          list:last4.join(','),
          secret: API_SECRET || ''
        });
        const res = await jsonp(EXEC_BASE + '?' + q.toString());
        if (!(res && res.ok)){
          showToast('저장 실패: ' + (res && res.error || '오류'));
          return;
        }
        showToast('저장 완료 ('+res.count+'건)');
        manageModal.classList.remove('show');
        manageModal.setAttribute('aria-hidden','true');

        // 새 목록 기준으로 다시 스냅샷 로드 → 화면 음영 즉시 반영
        loadSnapshot({source:'manual'});
      }catch(e){
        showToast('저장 오류');
      }
    });
  </script>
</body>
</html>
