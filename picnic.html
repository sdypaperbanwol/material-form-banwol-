<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°˜ë³„ ì•ˆë‚´ë¬¸</title>
 <style>
  :root{
    --brand:#e53935; --ink:#222; --muted:#666; --line:#ddd; --bg:#f7f7f9;
    --soft:#f2f5fa; --sec:#eef3ff; --sec-line:#d9e2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}

  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
  .card h2{margin:0;padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .card .body{padding:18px}

  .sec{display:grid;gap:12px;padding:14px 12px;border:1px solid var(--line);border-radius:14px;background:#fff}
  .sec + .sec{margin-top:14px}
  .sec-title{
    font-weight:900;font-size:13px;letter-spacing:.2px;color:#1a237e;
    background:linear-gradient(180deg,#f7f9ff,#eef3ff);
    border:1px solid var(--sec-line);border-radius:999px;
    display:inline-block;padding:6px 12px;
  }
.toolbar label { white-space: nowrap; }
#exportWidth { min-width: 160px; }
  .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:start;
    padding:10px;border:1px dashed #eee;border-radius:12px;background:#fafbff}
  .row + .row{margin-top:8px}
  .row label{
    font-weight:800;padding:8px 10px;border-radius:10px;border:1px solid #e7eaf6;
    background:#f7f9ff;color:#243b6b;display:inline-flex;align-items:center;gap:6px
  }
  .badge-req{font-size:11px;font-weight:900;color:#b71c1c;background:#ffebee;border:1px solid #ffcdd2;padding:2px 6px;border-radius:999px;}
  input[type=text], input[type=date], textarea, select{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
  }
  textarea{min-height:110px;resize:vertical}
  .row:focus-within{background:#ffffff;border-color:#cfd8ff; box-shadow:0 0 0 3px rgba(63,81,181,.08)}
  input:focus, textarea:focus, select:focus{border-color:#9fa8da;box-shadow:0 0 0 2px rgba(63,81,181,.12) inset}

  .chip-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;padding:6px 14px;font-weight:700;min-width:44px;text-align:center;user-select:none;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .chip.selected{border-color:var(--brand); color:#fff; background:var(--brand)}

  #notesPresets .chip{border-radius:8px;padding:8px 12px;font-size:13px;text-align:left;line-height:1.4;white-space:normal;min-height:36px;display:flex;align-items:center}

  #busBadge{position:fixed; right:16px; bottom:16px; z-index:9999;background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 10px;font-weight:800; box-shadow:0 4px 12px rgba(0,0,0,.12); display:none}

  #loadingOverlay{position:fixed; inset:0; background:rgba(255,255,255,.7); z-index:10000;display:none; align-items:center; justify-content:center; flex-direction:column; gap:14px;backdrop-filter:saturate(1.2) blur(2px)}
  .spinner{width:48px; height:48px; border-radius:50%;border:4px solid rgba(0,0,0,.08); border-top-color: var(--brand);animation: spin 1s linear infinite}
  @keyframes spin{ to{ transform: rotate(360deg);} }
  .loading-text{font-weight:700; color:#333}
  .loading-sub{font-size:12px; color:#777}
  .toolbar [disabled]{opacity:.6; cursor:not-allowed}

  .toolbar{display: grid; gap: 12px; margin: 24px 0; padding: 16px;border: 1px solid var(--line); border-radius: 16px; background: #fff;box-shadow: 0 2px 8px rgba(0,0,0,0.06)}
  .toolbar button{padding: 14px; font-size: 15px; font-weight: 700; border-radius: 12px;transition: all .2s; border:1px solid var(--line); background:#fff; cursor:pointer}
  #btnShare { border-color:#90caf9; background:#e3f2fd; color:#1565c0 }
  #btnShare:hover { background:#bbdefb }
  #btnCopyText { border-color:#a5d6a7; background:#e8f5e9; color:#2e7d32 }
  #btnCopyText:hover { background:#c8e6c9 }
  #btnSubmit { border-color:#ef9a9a; background:#ffebee; color:#c62828 }
  #btnSubmit:hover { background:#ffcdd2 }
  #btnExportIMG { border-color:#ffd54f;background:#fff8e1;color:#ff6f00 }
  #btnExportIMG:hover { background:#ffe082 }

  #previewModal[hidden]{ display:none !important }
  #previewModal{ position:fixed !important; inset:0 !important; z-index:20000 !important; display:flex !important; align-items:center; justify-content:center; background:rgba(0,0,0,.45); padding:20px }
  .preview-card{ background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.18); padding:16px }
  .preview-actions{ display:flex; gap:8px; align-items:center }
  .preview-toast{display:none;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:#2e7d32;background:#e8f5e9;border:1px solid #a5d6a7}
  .preview-toast.show{display:inline-block}

  .export-title{ font-weight:900; font-size:20px; margin:0 0 10px }
  .export-meta{ margin:10px 0 16px; padding:10px 12px; background:#f7f9ff; border:1px solid #e6ebff; border-radius:10px }
  .export-meta b{ display:inline-block; width:56px; color:#1a237e }
  .export-sec-title{ margin:18px 0 8px; font-weight:800; color:#1a237e; border-left:4px solid #1a237e; padding-left:8px }
  .export-list{ margin:6px 0 0 0; padding-left:18px; list-style-type:none }
  .export-list li{ margin:4px 0 }

  .place-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .place-picked{font-size:12px;color:#1565c0}
  .place-picked a{color:#1565c0; text-decoration:underline}

  /* ì¥ì†Œì„ íƒ ëª¨ë‹¬ */
  #placeModal[hidden]{display:none !important}
  #placeModal{position:fixed; inset:0; z-index:21000; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.45); padding:20px}
  .place-card{ background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.18); padding:16px; width:min(680px, 92vw) }
  .place-head{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:10px}
  .place-list{max-height:56vh; overflow:auto; border:1px solid #eee; border-radius:12px}
  .place-item{padding:12px; border-bottom:1px solid #f0f0f0; cursor:pointer}
  .place-item:hover{background:#f7faff}
  .place-item b{display:block}
  .place-item small{display:block; color:#666}
  .empty{padding:16px; text-align:center; color:#777}

  @media (max-width: 640px) {
    .row { grid-template-columns: 1fr; gap: 6px; padding:12px }
    .row label { padding:6px 10px }
    .row > * + * { margin-top: 2px }
    .sec { padding:12px 10px }
    .sec-title{ font-size:12px }

    /* âœ… ëª¨ë°”ì¼ì—ì„œ ì¥ì†Œì„ íƒ ëª¨ë‹¬ í—¤ë” ì„¸ë¡œ ë°°ì¹˜ */
    .place-head {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
    .place-head > div {
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      gap: 8px;
    }
    #placeQuery {
      grid-column: 1 / -1;
      width: 100%;
    }
    #placeSearchBtn { grid-column: 1; }
    #placeCloseBtn  { grid-column: 2; }
    #placeSearchBtn, #placeCloseBtn {
      min-height: 40px;
    }
  }

  @media print{
    .no-print, .toolbar, #busBadge, #loadingOverlay, #previewModal, #placeModal { display:none !important }
    body{ background:#fff }
    .wrap{ max-width:900px }
    pre, textarea { font-family: inherit; font-size: 14px }
  }
  #exportDoc.card-narrow #exportInner { padding:22px 24px }
  #exportDoc.card-narrow .export-title { font-size:18px; margin-bottom:8px }
  #exportDoc.card-narrow .export-meta { padding:8px 10px }
  #exportDoc.card-narrow .export-meta b { width:48px }
  #exportDoc.card-narrow .export-sec-title { font-size:14px; margin-top:14px }
  #exportDoc.card-narrow .export-list li { margin:3px 0 }
/* ========= Export ì „ìš© 2ë‹¨ ë ˆì´ì•„ì›ƒ ========= */
#exportDoc .export-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:20px;
}
#exportDoc.wide .export-grid{
  grid-template-columns: 1fr 380px; /* ì™¼ìª½ ë³¸ë¬¸ / ì˜¤ë¥¸ìª½ ì§€ë„ */
  gap:24px;
}
#exportDoc .export-map{ align-self:start }
#exportDoc .export-map img{
  width:100%; height:auto;
  border:1px solid #ddd; border-radius:8px;
}

/* ë©”íƒ€ ë°•ìŠ¤ ê¸¸ì´ ì¤„ì´ê¸° */
/* ê¸°ì¡´ 720px â†’ 560px ê¶Œì¥ */
#exportDoc .export-meta{ max-width:560px; margin-right:auto; }


/* ë³¸ë¬¸ ì„¹ì…˜ì„ ì¹´ë“œ+ê·¸ë¦¬ë“œë¡œ (ì¢Œìš° ê· í˜•) */
#exportDoc .export-sections{
  display:grid;
  grid-template-columns: 1fr; 
  gap:14px;
}
#exportDoc.wide .export-sections{ grid-template-columns: 1fr 1fr; }

#exportDoc .export-card{
  border:1px solid #e6ebff;
  background:#f7f9ff;
  border-radius:12px;
  padding:12px 14px;
}
#exportDoc .export-card .export-sec-title{
  margin:0 0 6px;
  font-weight:800; color:#1a237e;
  border-left:4px solid #1a237e; padding-left:8px;
}

   #btnReset { border-color:#cfd8dc; background:#eceff1; color:#455a64 }
#btnReset:hover { background:#e0e7ec }

   /* wide ëª¨ë“œì¼ ë•Œ: ì„¹ì…˜ 2ì—´ + 'ì¼ì • ìš”ì•½'ì€ ê°€ë¡œ ì „ì²´(span 2) */
#exportDoc.wide .export-sections { grid-template-columns: 1fr 1fr; }
/* ê¸°ì¡´: ì¼ì • ìš”ì•½ì„ í•­ìƒ ê°€ë¡œ ì „ì²´(span 2) â†’ ë°˜í­ìœ¼ë¡œ ë°”ê¿ˆ */
#exportDoc.wide .export-sections .card-schedule { grid-column: auto; }
/* ===== EXPORT LAYOUT OVERRIDE (paste at end) ===== */

/* A4 ê°€ë¡œ(=wide)ì¼ ë•Œ: ì™¼ìª½ ë³¸ë¬¸ 1, ì˜¤ë¥¸ìª½ ì§€ë„ ê³ ì •í­ */
#exportDoc.wide .export-grid {
  grid-template-columns: 1fr 420px; /* ì§€ë„ í­ ì¡°ì •ì€ ì—¬ê¸° ìˆ«ì */
  gap: 24px;
}

/* ë©”íƒ€(ëŒ€ìƒ/ì¼ì‹œ/ì¥ì†Œ/ì£¼ì†Œ/ë²„ìŠ¤/ë¬¸ì˜)ê°€ ì™¼ìª½ ì¹¼ëŸ¼ ê°€ë¡œë¥¼ ê½‰ ì“°ë„ë¡ */
#exportDoc.wide .export-meta {
  max-width: 100%;
  width: 100%;
}

/* ì•„ë˜ ì„¹ì…˜ì€ í•­ìƒ ë°˜ë°˜(0.5/0.5) */
#exportDoc.wide .export-sections {
  grid-template-columns: 1fr 1fr;
}

/* ì¼ì • ìš”ì•½ì´ ê°€ë¡œ ì „ì²´ë¡œ í¼ì§€ì§€ ì•Šë„ë¡(ë°˜í­ ìœ ì§€) */
#exportDoc.wide .export-sections .card-schedule {
  grid-column: auto !important;
}
/* ==== FINAL OVERRIDE (place at the very end) ==== */

/* ì˜¤ë¥¸ìª½ ì§€ë„ ì¹¼ëŸ¼ í­ í™•ì • (í•„ìš”í•˜ë©´ 420 ìˆ«ìë§Œ ë°”ê¾¸ì„¸ìš”) */
#exportDoc.wide .export-grid{
  grid-template-columns: 1fr 420px !important;
  gap: 24px !important;
}

/* ì•„ë˜ ì„¹ì…˜ì€ ë°˜ë°˜(0.5/0.5) */
#exportDoc.wide .export-sections{
  grid-template-columns: 1fr 1fr !important;
}

/* ì¼ì • ìš”ì•½ì´ ì „ì²´ í­ìœ¼ë¡œ í¼ì§€ì§€ ì•Šê²Œ */
#exportDoc.wide .export-sections .card-schedule{
  grid-column: auto !important;
}

/* ë©”íƒ€(ëŒ€ìƒ/ì¼ì‹œ/ì¥ì†Œ/ì£¼ì†Œ/ë²„ìŠ¤/ë¬¸ì˜) í­ì€ ì™¼ìª½ ì¹¼ëŸ¼ ì „ì²´ ì‚¬ìš© */
#exportDoc.wide .export-meta{
  max-width: 100% !important;
  width: 100% !important;
}
/* === í‘œì‹œ í† ê¸€ ê³µí†µ ìŠ¤íƒ€ì¼ === */
.field-toggle{
  display:flex; justify-content:flex-end; align-items:center;
  gap:6px; margin-bottom:6px; color:#243b6b; font-weight:700;
}
.field-toggle input{ transform: translateY(1px); }


</style>

</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card no-print">
        <h2>ì•ˆë‚´ë¬¸ ì‘ì„±</h2>
        <div class="body">
          <!-- ì°¸ì—¬ ëŒ€ìƒ -->
          <div class="sec">
            <div class="sec-title">ì°¸ì—¬ ëŒ€ìƒ</div>
           <div class="row">
  <label>ëŒ€ìƒ</label>
  <div>
    <div class="field-toggle"><label><input id="showTeam" type="checkbox" checked> í‘œì‹œ</label></div>

    <input id="team" type="hidden" value="">
    <div class="chip-group" id="teamChips" role="group" aria-label="ëŒ€ìƒ">
      <div class="chip" data-val="A">Aë°˜</div>
      <div class="chip" data-val="B">Bë°˜</div>
      <div class="chip" data-val="C">Cë°˜</div>
      <div class="chip" data-val="D">Dë°˜</div>
      <div class="chip" data-val="ê¸°íƒ€">ê¸°íƒ€</div>
      <input id="teamCustom" type="text" placeholder="ì§ì ‘ ì…ë ¥"
             style="display:none; margin-left:6px; padding:6px 10px; border-radius:8px; border:1px solid #ccc;"/>
    </div>
    <small style="color:var(--muted)">ì—¬ëŸ¬ ë°˜ ì„ íƒ ê°€ëŠ¥</small>
  </div>
</div>

          </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
<div class="sec">
  <div class="sec-title">ê¸°ë³¸ ì •ë³´</div>

 <div class="row">
  <label for="title">ì œëª©</label>
  <div>
    <div class="field-toggle"><label><input id="showTitle" type="checkbox" checked> í‘œì‹œ</label></div>
    <input id="title" type="text" placeholder="ì˜ˆ) ì•¼ìœ íšŒ ì•ˆë‚´" />
  </div>
</div>


  <div class="row">
  <label for="date">ì¼ì</label>
  <div>
    <div class="field-toggle"><label><input id="showDate" type="checkbox" checked> í‘œì‹œ</label></div>
    <input id="date" type="date" />
  </div>
</div>

  
<div class="row">
  <label for="time">ì‹œê°„</label>
  <div>
    <div class="field-toggle"><label><input id="showTime" type="checkbox" checked> í‘œì‹œ</label></div>
    <input id="time" type="time" />
  </div>
</div>


  <div class="row">
  <label for="place">ì¥ì†Œ</label>
  <div>
    <div class="field-toggle"><label><input id="showPlace" type="checkbox" checked> í‘œì‹œ</label></div>

    <div class="place-actions" style="display:flex; gap:8px; align-items:center;">
      <input id="place" type="text" placeholder="ì˜ˆ) ê³ ì”ë™ XXì‹ë‹¹ (ì£¼ì†Œ/ì§€ì ëª… ê°€ëŠ¥)" style="flex:1" />
      <button type="button" id="btnPickPlace" title="ë„¤ì´ë²„ì—ì„œ ì§€ì  í›„ë³´ ê²€ìƒ‰í•´ ì„ íƒ">ì¥ì†Œ ì°¾ê¸°(ê²€ì¦)</button>
    </div>

    <input id="placeUrl" type="hidden" value="" />
    <input id="placeAddr" type="hidden" value="" />
    <input id="placeTel"  type="hidden" value="" />
    <input id="placeLink" type="hidden" value="" />

    <div id="placeThumb" style="display:none; margin-top:6px">
      <img id="placeThumbImg" alt="ì§€ë„ ë¯¸ë¦¬ë³´ê¸°"
           style="max-width:220px;border:1px solid var(--line);border-radius:8px">
    </div>

    <input id="placeLat" type="hidden" value="" />
    <input id="placeLng" type="hidden" value="" />
    <input id="placeMapImg" type="hidden" value="" />

    <div id="placePicked" class="place-picked" style="display:none; margin-top:6px; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff;"></div>

    <small style="color:var(--muted)">ì§€ì  ì„ íƒ ì‹œ ìœ„ ì¹¸ì— í™•ì •ëœ ì§€ì  ì •ë³´ê°€ í‘œì‹œë˜ê³ , ì•ˆë‚´ë¬¸ì—ëŠ” í•´ë‹¹ ë§í¬ë§Œ ì²¨ë¶€ë©ë‹ˆë‹¤.</small>
  </div>
</div>



          <!-- ìš´ì˜ ì •ë³´ -->
          <div class="sec">
            <div class="sec-title">ìš´ì˜ ì •ë³´</div>
           <div class="row">
  <label for="schedule">ì¼ì • ìš”ì•½</label>
  <div>
    <div class="field-toggle"><label><input id="showSchedule" type="checkbox" checked> í‘œì‹œ</label></div>
    <textarea id="schedule" placeholder="ì˜ˆì‹œ)
- 09:00 ì§‘ê²° ë° í™œë™
- 12:30 ì ì‹¬ ì‹ì‚¬
- 15:00 ê·€ê°€"></textarea>
  </div>
</div>


           <div class="row">
  <label for="bus">ë²„ìŠ¤ ëŒ€ì ˆ</label>
  <div>
    <div class="field-toggle"><label><input id="showBus" type="checkbox" checked> í‘œì‹œ</label></div>

    <input id="bus" type="hidden" value="" />
    <div class="chip-group" id="busChips" role="radiogroup" aria-label="ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€">
      <div class="chip" role="radio" tabindex="0" aria-checked="false" data-val="O">O</div>
      <div class="chip" role="radio" tabindex="-1" aria-checked="false" data-val="X">X</div>
    </div>

    <small style="color:var(--muted)">ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€(O/X)ëŠ” ì œì¶œ ì‹œì—ëŠ” í•­ìƒ ì €ì¥ë©ë‹ˆë‹¤.</small>
  </div>
</div>

           <div class="row">
  <label for="notes">íŠ¹ì´ì‚¬í•­</label>
  <div>
    <div class="field-toggle"><label><input id="showNotes" type="checkbox" checked> í‘œì‹œ</label></div>

    <div class="chip-group" id="notesPresets" role="group" aria-label="íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿"></div>
    <small style="color:var(--muted)">í´ë¦­ ì‹œ íŠ¹ì´ì‚¬í•­ì— ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤(ì¤‘ë³µ ë°©ì§€)</small>
    <textarea id="notes" placeholder="ì˜ˆ)
- í¸í•œ ë³µì¥ ë° ìš´ë™í™” ê¶Œì¥
- ê°œì¸ ë¬¼/ìš°ì˜ ë“± ì¤€ë¹„
- ì¼ë¶€ êµ¬ê°„ ë„ë³´ ì´ë™ ì˜ˆì •"></textarea>
  </div>
</div>


        <div class="row">
  <label for="contact">ë¬¸ì˜ì²˜</label>
  <div>
    <div class="field-toggle"><label><input id="showContact" type="checkbox" checked> í‘œì‹œ</label></div>
    <input id="contact" type="text" placeholder="ì˜ˆ) Aë°˜ í™ê¸¸ë™ (010-0000-0000)" />
  </div>
</div>

          </div>
        </div>
      </div>
    </div>

    <div class="toolbar no-print">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label style="font-weight:700;color:#243b6b;display:inline-flex;gap:6px;align-items:center;">
          ì´ë¯¸ì§€ í­
          <select id="exportWidth">
            <option value="auto" selected>ìë™(ë‚´ìš©ì— ë§ì¶¤)</option>
             <!-- <option value="794">A4(794px, ê¸°ë³¸)</option> -->
            <option value="1123">A4 ê°€ë¡œ(1123px)</option>
             <!-- <option value="680">ì»´íŒ©íŠ¸(680px)</option> -->
             <!-- <option value="560">ì¹´ë“œí˜•(560px)</option>> -->
          </select>
        </label>
          <!-- âœ… ì—¬ê¸°ì— ì¶”ê°€ -->
    
        <!-- âœ… QR í† ê¸€ì´ ìˆë‹¤ë©´, ê·¸ ì˜†ì´ë‚˜ ì•„ë˜ì— ë‘¬ë„ ë©ë‹ˆë‹¤ -->
          </div>
      <button id="btnReset" type="button" title="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
      <button id="btnShare">ì„ì‹œ ì €ì¥í•˜ê¸°</button>
      <button id="btnCopyText">ì•ˆë‚´ë¬¸(í…ìŠ¤íŠ¸)</button>
      <button id="btnExportIMG">ì•ˆë‚´ë¬¸(ì´ë¯¸ì§€)</button>
      <button id="btnSubmit">ì¸ì‚¬ì§€ì›íŒ€ ì œì¶œ</button>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¡¤ ë°°ì§€ -->
  <div id="busBadge" aria-hidden="true">ë²„ìŠ¤: <span id="busBadgeVal">-</span></div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text" id="loadingText">ì§„í–‰ ì¤‘â€¦</div>
    <div class="loading-sub" id="loadingSub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
  </div>

  <!-- ê³µìœ  í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div id="previewModal" hidden role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-card" role="document">
      <div class="preview-head"><h3 id="previewTitle">ì•ˆë‚´ë¬¸ ë¯¸ë¦¬ë³´ê¸°</h3></div>
      <textarea id="previewTa"></textarea>
      <div class="preview-hint">ë°°í¬ìš©ìœ¼ë¡œ ììœ  ìˆ˜ì • ê°€ëŠ¥í•˜ë‚˜, ì¸ì‚¬ì§€ì›íŒ€ ì œì¶œ ì‹œì—ëŠ” ì…ë ¥í•œ ì›ë³¸ ë‚´ìš©ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.</div>
      <div class="preview-actions">
        <span id="previewToast" class="preview-toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
        <button type="button" id="previewCopy">ë³µì‚¬í•˜ê¸°</button>
        <button type="button" id="previewClose2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì¥ì†Œ ì„ íƒ ëª¨ë‹¬ -->
  <div id="placeModal" hidden role="dialog" aria-modal="true" aria-labelledby="placeTitle">
    <div class="place-card" role="document">
      <div class="place-head">
        <h3 id="placeTitle" style="margin:0">ì¥ì†Œ ì„ íƒ</h3>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="placeQuery" type="text" placeholder="ì§€ì ëª…/ì£¼ì†Œë¡œ ì¬ê²€ìƒ‰" style="width: min(360px, 60vw)">
          <button id="placeSearchBtn" type="button">ê²€ìƒ‰</button>
          <button id="placeCloseBtn" type="button">ë‹«ê¸°</button>
        </div>
      </div>
      <div id="placeList" class="place-list"><div class="empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div></div>
    </div>
  </div>

  <!-- LZ-String (êµ¬ ê³µìœ ì½”ë“œ í˜¸í™˜) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyyfpi6rIDX1gDBUtnWIoubN-X_9s-zXmX7oatqfWVzYFYmq5MCdueTaYZBZO_IWr4p/exec';

  /* fetch íƒ€ì„ì•„ì›ƒ */
  async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);
    try { return await fetch(url, {...opts, signal: controller.signal}); }
    finally { clearTimeout(timer); }
  }

  /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
  let loadingCount = 0, loadingTimer = null;
  function setToolbarDisabled(disabled){
    document.querySelectorAll('.toolbar button').forEach(btn => btn.disabled = disabled);
    document.querySelectorAll('input, textarea').forEach(el => el.readOnly = disabled);
    document.querySelectorAll('select').forEach(el => el.disabled = disabled);
  }
  function showLoading(main='ì§„í–‰ ì¤‘â€¦', sub='ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”', minMs=500){
    loadingCount++;
    const ov = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = main;
    document.getElementById('loadingSub').textContent = sub;
    ov.style.display = 'flex';
    setToolbarDisabled(true);
    clearTimeout(loadingTimer);
    loadingTimer = setTimeout(()=>{ loadingTimer = null; }, minMs);
  }
  function hideLoading(){
    if (loadingCount > 0) loadingCount--;
    const finish = ()=>{
      if (loadingCount === 0){
        document.getElementById('loadingOverlay').style.display = 'none';
        setToolbarDisabled(false);
      }
    };
    if (loadingTimer){ setTimeout(()=>finish(), 120); loadingTimer = null; }
    else { finish(); }
  }
function setSelectedPlace(item){
  // item: GAS naver_local ì‘ë‹µì˜ ë‹¨ì¼ í•­ëª© {title, roadAddress, address, telephone, link}
  document.getElementById('place').value     = item.title || '';
  document.getElementById('placeAddr').value = item.roadAddress || item.address || '';
  document.getElementById('placeTel').value  = item.telephone || '';
  document.getElementById('placeLink').value = resolveNaverLink(item);

  // í…ìŠ¤íŠ¸ ê³µìœ  ì‹œ ë¶ˆí•„ìš”í•œ ìë™ ê²€ìƒ‰ ë§í¬ëŠ” ë” ì´ìƒ ë„£ì§€ ì•Šìœ¼ë‹ˆ,
  // buildMapSearchLinks ì‚¬ìš© ë¶€ë¶„ì€ ì œê±°/ì£¼ì„ ì²˜ë¦¬í•´ë„ ë©ë‹ˆë‹¤.
}

  /* ìœ í‹¸ */
  function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
  function legacyCopy(text){
    try{
      const ta = document.createElement('textarea');
      ta.value = text; ta.setAttribute('readonly', '');
      ta.style.position = 'fixed'; ta.style.top = '-9999px'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      const ok = document.execCommand('copy'); document.body.removeChild(ta);
      return ok;
    }catch(_){ return false; }
  }
  async function safeDistribute({title='', text='', url='', pureText=false, forceManual=false}) {
    const toCopy =
      text
        ? (title ? (title + '\n' + text) : text) + (url ? '\n' + url : '')
        : (title ? (title + (url ? '\n' : '')) : '') + (url || '');
    if (forceManual) { openPreviewModal(toCopy); return { method: 'manual-forced' }; }
    const shouldSkipWebShare = pureText === true;
    if (!shouldSkipWebShare && isMobile() && navigator.share) {
      try {
        const payload = {}; if (title) payload.title = title; if (text) payload.text = text; if (url) payload.url = url;
        await navigator.share(payload); return { method:'share' };
      } catch(_) {}
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      try { await navigator.clipboard.writeText(toCopy); return { method:'clipboard' }; } catch(_){}
    }
    if (legacyCopy(toCopy)) return { method:'legacy' };
    alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    return { method:'manual' };
  }
function resetAll() {
  if (!confirm('ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í•˜ê³ , ì£¼ì†Œì˜ k/code íŒŒë¼ë¯¸í„°ë„ ì œê±°í• ê¹Œìš”?')) return;

  // 1) í…ìŠ¤íŠ¸/íˆë“  ì…ë ¥ê°’ ì´ˆê¸°í™” (+ time, ì¢Œí‘œ/ì§€ë„ ì´ë¯¸ì§€ ì¶”ê°€)
  const ids = [
    'team','title','date','time','schedule','bus',
    'place','placeUrl','placeAddr','placeTel','placeLink',
    'placeLat','placeLng','placeMapImg',  // âœ… ì¢Œí‘œ/ì§€ë„
    'notes','contact'
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // 2) íŠ¹ì´ì‚¬í•­ ì¹© ìƒíƒœë„ í•¨ê»˜ í•´ì œ
  //    (ê°’ë§Œ ë¹„ìš°ë©´ ì¹© class(selected) ì•ˆ í’€ë¦¬ë¯€ë¡œ ì•„ë˜ í˜¸ì¶œ í•„ìš”)
  if (typeof setNotesLines === 'function') {
    setNotesLines([]); // textarea ë¹„ìš°ê³  ì¹© selectionë„ ë™ê¸°í™”
  } else if (typeof syncNotesPresetSelection === 'function') {
    syncNotesPresetSelection();
  }

  // 3) íŒ€ ì¹©/ê¸°íƒ€ ì…ë ¥ ì´ˆê¸°í™”
  setTeamHiddenFromArray([]);
  renderTeamChips();
  restoreCustomTeamFromTeamValue(); // ê¸°íƒ€ ì…ë ¥ì¹¸ ì ‘ê¸°

  // 4) ë²„ìŠ¤ ì„ íƒ/ë°°ì§€/ì²´í¬ ì´ˆê¸°í™”
  setBus('');
  // âœ… í‘œì‹œ í† ê¸€ë“¤ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
['showTeam','showTitle','showDate','showTime','showPlace','showSchedule','showBus','showNotes','showContact']
  .forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });


  // 5) ì¥ì†Œ ë¯¸ë¦¬ë³´ê¸°/ì¸ë„¤ì¼ ë°•ìŠ¤ ë¹„ìš°ê¸°
  setPickedPlaceLink('', '');
  setMapPreview(''); // âœ… ì¸ë„¤ì¼ ìˆ¨ê¹€

  // 6) URLì˜ k/code íŒŒë¼ë¯¸í„° ì œê±°
  const url = new URL(location.href);
  url.searchParams.delete('k');
  url.searchParams.delete('code');
  history.replaceState(null, '', url.origin + url.pathname);

  // 7) ìŠ¤í¬ë¡¤/ë°°ì§€ ë“± UI ë§ˆë¬´ë¦¬
  updateBusBadgeVisibility();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


document.getElementById('btnReset')?.addEventListener('click', resetAll);

  /* ë‚ ì§œ/ëŒ€ìƒ í¬ë§· */
  function weekdayKR(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr+'T00:00:00');
    const yo = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
    return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼(${yo})`;
  }
  function parseTeams(str){ return (str || '').split(',').map(s => s.trim()).filter(Boolean); }
  function teamsToString(arr){ return Array.from(new Set(arr)).join(','); }
  function getTeamsArray(){ return parseTeams(document.getElementById('team').value); }
  function setTeamHiddenFromArray(arr){ document.getElementById('team').value = teamsToString(arr); }
  function hasAnyCustomTeam(){ return getTeamsArray().some(v => v==='ê¸°íƒ€' || v.startsWith('ê¸°íƒ€:')); }
  function formatTarget(teamStr){
    const arr = (teamStr || '').split(',').map(s => s.trim()).filter(Boolean);
    if (!arr.length) return '';
    const mapped = arr.map(v => (/^ê¸°íƒ€:/.test(v) ? v.replace(/^ê¸°íƒ€:/,'') : (/^[A-D]$/i.test(v) ? v+'ë°˜' : v)));
    return Array.from(new Set(mapped)).join(', ');
  }
  function renderTeamChips(){
    const arr = getTeamsArray();
    document.querySelectorAll('#teamChips .chip').forEach(chip=>{
      const val = chip.dataset.val;
      chip.classList.toggle('selected', val==='ê¸°íƒ€' ? hasAnyCustomTeam() : arr.includes(val));
    });
  }
  function toggleTeam(val){
    const arr = getTeamsArray();
    const i = arr.indexOf(val);
    if (i >= 0) arr.splice(i,1); else arr.push(val);
    setTeamHiddenFromArray(arr); renderTeamChips();
  }
  (function bindTeamChips(){
    const g = document.getElementById('teamChips'); if(!g) return;
    g.addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      if (chip.dataset.val === 'ê¸°íƒ€') return;
      toggleTeam(chip.dataset.val);
    });
  })();
  function removeAllCustomTeamFromArray(arr){ return (arr||[]).filter(v => v!=='ê¸°íƒ€' && !v.startsWith('ê¸°íƒ€:')); }
  function restoreCustomTeamFromTeamValue(){
    const arr = getTeamsArray(); const custom = arr.find(v => v.startsWith('ê¸°íƒ€:'));
    const input = document.getElementById('teamCustom'); if (!input) return;
    if (custom){ input.style.display='inline-block'; input.value = custom.split(':').slice(1).join(':'); }
    else { input.style.display='none'; input.value=''; }
    renderTeamChips();
  }
    function isNaverPlaceUrl(u){
  try{
    const url = new URL(u);
    const host = url.hostname;
    const path = url.pathname || '';
    // naver.me(ê³µìœ  ë‹¨ì¶•) í—ˆìš©
    if (/naver\.me$/.test(host)) return true;
    // naver ì§€ë„/í”Œë ˆì´ìŠ¤ ë„ë©”ì¸ë§Œ í—ˆìš©
    if (!/(^|\.)naver\.com$/.test(host)) return false;
    // ì§€ë„/í”Œë ˆì´ìŠ¤ ê´€ë ¨ ê²½ë¡œë§Œ í—ˆìš©
    return /^(\/v5|\/p\/entry|\/entry\/place|\/map|\/place)/.test(path);
  }catch(_){ return false; }
}

function resolveNaverLink(item){
  const link = item.link || item.url || '';
  try{
    const u = new URL(link);
    const host = u.hostname;
    const path = u.pathname || '';
    if (/naver\.me$/.test(host) || (/(^|\.)naver\.com$/.test(host) && /^(\/v5|\/place|\/p\/entry|\/entry\/place|\/map)/.test(path))) {
      return link; // ë„¤ì´ë²„ ì§€ë„/í”Œë ˆì´ìŠ¤ë§Œ í—ˆìš©
    }
  }catch(_){}

  // fallback: ìƒí˜¸ëª…+ì£¼ì†Œ ê²€ìƒ‰
  return buildNaverSearchLink(item.title || '', item.roadAddress || item.address || '');
}



  (function bindCustomTeam(){
    const chips = document.getElementById('teamChips'); const customInput = document.getElementById('teamCustom');
    if(!chips || !customInput) return;
    chips.addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      if(chip.dataset.val === 'ê¸°íƒ€'){
        const opening = (customInput.style.display === 'none' || customInput.style.display === '');
        if(opening){ customInput.style.display='inline-block'; customInput.focus(); }
        else{
          const arr = removeAllCustomTeamFromArray(getTeamsArray());
          setTeamHiddenFromArray(arr); customInput.value=''; customInput.style.display='none'; renderTeamChips();
        }
      }
    });
    customInput.addEventListener('input', ()=>{
      const val = customInput.value.trim();
      let arr = removeAllCustomTeamFromArray(getTeamsArray());
      if(val){ arr.push('ê¸°íƒ€:'+val); }
      setTeamHiddenFromArray(arr); renderTeamChips();
    });
  })();
  (function bindTeamChipsA11y(){
    const g = document.getElementById('teamChips'); if(!g) return;
    g.querySelectorAll('.chip[data-val]:not([data-val="ê¸°íƒ€"])').forEach(chip=>{ chip.tabIndex=0; chip.setAttribute('role','button'); });
    g.addEventListener('keydown', e=>{
      if (e.key!=='Enter' && e.key!==' ') return;
      const chip = e.target.closest('.chip'); if(!chip || chip.dataset.val==='ê¸°íƒ€') return;
      e.preventDefault(); toggleTeam(chip.dataset.val);
    });
  })();

  /* ===== ì¥ì†Œ(ë„¤ì´ë²„) ì²˜ë¦¬: ê²€ì¦ URL ì„ íƒ íë¦„ ===== */
  function isUrl(s){ return /^https?:\/\//i.test((s||'').trim()); }
// ìƒí˜¸ëª…ë§Œ ìš°ì„ , ì£¼ì†ŒëŠ” ë™/êµ¬ê¹Œì§€ë§Œ ì˜ë¼ ë³´ì¡°
function buildNaverSearchLink(rawName, rawAddr=''){
  const name = (rawName||'').trim();
  const addr = (rawAddr||'').trim()
    // ë²ˆì§€ë¶€í„° ì˜ë¼ë‚´ê¸° (ì˜ˆ: "ê´‘ë•ì„œë¡œ 78 ëŒ€í•œë²•ì¡°" â†’ "ê´‘ë•ì„œë¡œ")
    .replace(/\s+\d.*$/, '')
    // "ëŒ€í•œë²•ì¡°" ê°™ì€ ê±´ë¬¼ëª…ì€ ê²€ìƒ‰ì— ë°©í•´ë˜ëŠ” ê²½ìš°ê°€ ë§ì•„ ì œê±°
    .replace(/ëŒ€í•œë²•ì¡°|ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°|ìƒê°€|ì•„íŒŒíŠ¸|ì˜¤í”¼ìŠ¤í…”|Mall|ëª°/gi, '')
    .trim();

  const q = name || addr || '';
  return 'https://map.naver.com/p/search/' + encodeURIComponent(q);
}

  function setPickedPlaceLink(url, label){
    const box = document.getElementById('placePicked');
    const hidden = document.getElementById('placeUrl');
    hidden.value = url || '';
    if(url){
      box.innerHTML = `ì„ íƒëœ ì§€ë„ ë§í¬: <a href="${url}" target="_blank" rel="noopener">${label||'ì—´ê¸°'}</a>`;
      box.style.display = 'block';
    }else{
      box.innerHTML = ''; box.style.display = 'none';
    }
  }

  // í›„ë³´ ê²€ìƒ‰ ëª¨ë‹¬
  const placeModal = {
    el: null, listEl: null, queryEl: null, open(initQ=''){
      if(!this.el){
        this.el = document.getElementById('placeModal');
        this.listEl = document.getElementById('placeList');
        this.queryEl = document.getElementById('placeQuery');
        document.getElementById('placeCloseBtn').addEventListener('click', ()=> this.close());
        document.getElementById('placeSearchBtn').addEventListener('click', ()=> this.search());
        this.queryEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') this.search(); });
        this.el.addEventListener('click', (e)=>{ if(e.target===this.el) this.close(); });
      }
      this.queryEl.value = (initQ||'').trim();
      this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ ì¤‘â€¦</div>';
      this.el.hidden = false;
      this.search();
    },
    close(){ if(this.el) this.el.hidden = true; },
    async search(){
      const q = (this.queryEl.value||'').trim();
      if(!q){ this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>'; return; }
      try{
        const url = `${GAS_URL}?mode=naver_local&query=${encodeURIComponent(q)}`;
        const res = await fetchWithTimeout(url);
        const json = await res.json();
        if(!res.ok) throw new Error(json && json.error || ('HTTP '+res.status));
        const rows = Array.isArray(json.items||json.results||json) ? (json.items||json.results||json) : [];
        if(!rows.length){ this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      const mapRow = (r) => ({
  name: r.name || r.title || r.place_name || '',
  road: r.roadAddress || r.road_address || r.road || '',
  jibun: r.jibunAddress || r.jibun_address || r.address || '',
  tel : r.telephone || r.tel || '',
  url : r.mapUrl || r.link || r.url || '',
  mapx: r.mapx || r.x || r.lng || '',
  mapy: r.mapy || r.y || r.lat || ''
});

       // this.listEl.innerHTML ìƒì„± ë¶€ë¶„ êµì²´
this.listEl.innerHTML = rows.map(r=>{
  const x = mapRow(r);
  const addr = (x.road || x.jibun || '').trim() || (x.name || '');

  return `<div class="place-item"
              data-url="${encodeURIComponent(x.url)}"
              data-name="${encodeURIComponent(x.name)}"
              data-addr="${encodeURIComponent(addr)}"
              data-tel="${encodeURIComponent(x.tel)}"
              data-link="${encodeURIComponent(x.url)}"
              data-x="${encodeURIComponent(x.mapx)}"
              data-y="${encodeURIComponent(x.mapy)}">
            <b>${escapeHTML(x.name)}</b>
            <small>${escapeHTML(addr)}</small>
          </div>`;
}).join('');


 // âœ… ì¥ì†Œ í´ë¦­ ì‹œ ì¢Œí‘œ í™•ì • â†’ Static Map ìƒì„± (ì§€ì˜¤ì½”ë”© ìš°ì„ )
// âœ… ì¥ì†Œ í´ë¦­ ì‹œ ì¢Œí‘œ í™•ì • â†’ Static Map ìƒì„± (ì§€ì˜¤ì½”ë”© ìš°ì„  + ë‹¤ë‹¨ê³„ ë³´ê°•)
this.listEl.querySelectorAll('.place-item').forEach(el=>{
  el.addEventListener('click', ()=>{
    const name = decodeURIComponent(el.getAttribute('data-name')||'');
    const addr = decodeURIComponent(el.getAttribute('data-addr')||'');
    const tel  = decodeURIComponent(el.getAttribute('data-tel')||'');
    const raw  = decodeURIComponent(el.getAttribute('data-link')||'');
    const mapx = decodeURIComponent(el.getAttribute('data-x')||''); // Local API ì›ì‹œ ì¢Œí‘œ(ì‹ ë¢°X)
    const mapy = decodeURIComponent(el.getAttribute('data-y')||'');

    const finalUrl = resolveNaverLink({
      title: name, roadAddress: addr, address: addr,
      telephone: tel, link: raw, mapx, mapy
    });

    setSelectedPlace({
      title: name, roadAddress: addr, address: addr,
      telephone: tel, link: finalUrl, mapx, mapy
    });
    setPickedPlaceLink(finalUrl, name || 'ì§€ë„ì—´ê¸°');
    if (name) document.getElementById('place').value = name;

    (async ()=>{
      // ë””ë²„ê¹…ìš©: ë‹¨ê³„ë³„ ì‹œë„ ê²°ê³¼ë¥¼ ì½˜ì†”ë¡œ
      const dbg = { name, addr, mapx, mapy, steps: [] };

      try {
        // 1) ì§€ì˜¤ì½”ë”©(ê°€ì¥ ì •í™•)
        let lat='', lng='';
        const tryGeocode = async (q) => {
          if (!q) return null;
          const url = `${GAS_URL}?mode=geocode&q=${encodeURIComponent(q)}`;
          const r   = await fetchWithTimeout(url);
          let j;
 try {
   j = await r.json();
 } catch (e) {
   console.warn('[geocode] non-JSON:', await r.text());
   dbg.steps.push({ step:'geocode', q, ok:false, http:r.status, nonJson:true });
   return null;
 }
 console.log('[geocode]', q, j); // â˜… ì›ë¬¸ ê·¸ëŒ€ë¡œ í™•ì¸
 dbg.steps.push({ step:'geocode', q, ok:(j && j.status==='ok' && j.found), http:r.status, j });
 if (j && j.status==='ok' && j.found && Number.isFinite(j.lat) && Number.isFinite(j.lng)) {
   return { lat: j.lat, lng: j.lng };
 }
          return null;
        };

        // ì§€ì˜¤ì½”ë”© ì‹œë„ ìˆœì„œ: (ë„ë¡œëª…/ì§€ë²ˆì£¼ì†Œ) â†’ (ìƒí˜¸ + ì£¼ì†Œ) â†’ (ìƒí˜¸ë§Œ)
       // ğŸ”§ ì§€ì˜¤ì½”ë”© ì‹œë„ ë³´ê°•
const variants = [];
const clean = (s='') => s
  .replace(/\((?:[^()]|\([^()]*\))*\)/g, '')     // ê´„í˜¸ ë‚´ìš© í†µì§¸ ì œê±°
  .replace(/\s+\d+[-~]?\d*(?:í˜¸|ë²ˆì§€|ì¸µ|F|ë™|í˜¸ì‹¤)?/g, '') // ë²ˆì§€/í˜¸/ì¸µ ë“± ì œê±°
  .replace(/ëŒ€í•œë²•ì¡°|ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°|ìƒê°€|ì•„íŒŒíŠ¸|ì˜¤í”¼ìŠ¤í…”|Mall|ëª°/gi, '')
  .replace(/\s{2,}/g, ' ')
  .trim();

 // 0) ì›ë³¸ ë¨¼ì €(ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ì‹œë„)
 const addrRaw = (addr || '').trim();
 const nameRaw = (name || '').trim();
 const addrC   = clean(addrRaw);
 const nameC   = clean(nameRaw);
 const adminOnly = addrRaw.split(/\s+/).slice(0, 3).join(' ').trim(); // ì‹œ/êµ¬/ë™ ì •ë„

 [
   addrRaw,                               // â˜… ì›ë³¸ ì£¼ì†Œ(ë²ˆì§€ í¬í•¨) ìµœìš°ì„ 
   (nameRaw && addrRaw) ? `${nameRaw} ${addrRaw}` : '', // ì›ë³¸ ìƒí˜¸+ì£¼ì†Œ
   addrC,                                 // ì •ì œ ì£¼ì†Œ(ì°¨ì„ )
   (nameC && addrC) ? `${nameC} ${addrC}` : '',
   adminOnly && `${adminOnly} ${nameRaw || nameC || ''}`.trim(),
   nameRaw || nameC,                      // ìƒí˜¸ë§Œ(ìµœí›„)
   addrRaw && `ëŒ€í•œë¯¼êµ­ ${addrRaw}`,      // êµ­ê°€ ì ‘ë‘(ìµœí›„)
 ].forEach(q => { if (q && !variants.includes(q)) variants.push(q); });
let g = null;
for (const q of variants) {
  const r = await tryGeocode(q);
  dbg.steps.push({ step:'geocode', q, ok: !!r });
  if (r) { g = r; break; }
}

lat = g?.lat ?? ''; lng = g?.lng ?? '';

// ğŸ‘‰ ê·¸ë˜ë„ ë¶ˆë°œì´ë©´ ì—¬ê¸°ì„œ ëë‚´ì§€ ë§ê³ , ë§ˆì§€ë§‰ ë³´í˜¸ ì¥ì¹˜ë¡œ ì‹œ/êµ¬/ë™ë§Œìœ¼ë¡œ ì¬ì‹œë„
if ((!lat || !lng) && adminOnly) {
  const r2 = await tryGeocode(adminOnly);
  dbg.steps.push({ step:'geocode_adminOnly', q: adminOnly, ok: !!r2 });
  if (r2) { lat = r2.lat; lng = r2.lng; }
}


        if (g) { lat = g.lat; lng = g.lng; }

        // 2) ë³´ì •: Local API ì¢Œí‘œê°€ ì´ë¯¸ ìœ„ê²½ë„ ë²”ìœ„ë©´ ì‚¬ìš©
        if ((!lat || !lng) && mapx && mapy) {
          const fx = parseFloat(mapx), fy = parseFloat(mapy);
          // (a) ê·¸ëŒ€ë¡œ ìœ„ê²½ë„ì¼ ê°€ëŠ¥ì„±
          if (isFinite(fx) && isFinite(fy) && fy>=30 && fy<=40 && fx>=124 && fx<=132) {
            lat = fy; lng = fx;
            dbg.steps.push({ step:'fallback_direct_ll', used:true, fx, fy });
          }
          // (b) í˜¹ì‹œ x/yê°€ ë’¤ë°”ë€ ê²½ìš°
          else if (isFinite(fx) && isFinite(fy) && fx>=30 && fx<=40 && fy>=124 && fy<=132) {
            lat = fx; lng = fy;
            dbg.steps.push({ step:'fallback_swapped_ll', used:true, fx, fy });
          }
        }

        if (!lat || !lng) throw new Error('ì¢Œí‘œ ì¶”ì¶œ ì‹¤íŒ¨ (ì§€ì˜¤ì½”ë”©/ë³´ì • ëª¨ë‘ ì‹¤íŒ¨)');

        // hidden ì €ì¥
        document.getElementById('placeLat').value = lat;
        document.getElementById('placeLng').value = lng;

        // 3) Static Map ìƒì„±
        const level = 19; // ìˆ«ì â†‘ = ëœ í™•ëŒ€(ë” ë„“ê²Œ)
        const api = `${GAS_URL}?mode=static_map&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&w=300&h=200`;
        const res = await fetchWithTimeout(api);
        const json = await res.json();
        dbg.steps.push({ step:'static_map', ok:(json && json.status==='ok'), json_status: json && json.status });

        if (json.status === 'ok' && json.dataUrl) {
          document.getElementById('placeMapImg').value = json.dataUrl;
          setMapPreview(json.dataUrl); // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
        } else {
          throw new Error('StaticMap ìƒì„± ì‹¤íŒ¨');
        }
     } catch (err) {
  console.error('[static map error]', err, dbg);
  setMapPreview('');
  document.getElementById('placeLat').value = '';
  document.getElementById('placeLng').value = '';
  document.getElementById('placeMapImg').value = '';

  // ğŸ” ì–´ë–¤ ë‹¨ê³„ì—ì„œ ë§‰í˜”ëŠ”ì§€ ëˆˆì— ë³´ì´ê²Œ
  const last = (dbg && dbg.steps && dbg.steps[dbg.steps.length - 1]) || {};
  let hint = 'ì›ì¸ ë¯¸ìƒ';
 if (dbg && Array.isArray(dbg.steps)) {
   const gFails = dbg.steps.filter(s => s.step==='geocode');
   if (gFails.length) {
     const lastG = gFails[gFails.length-1];
     const j = lastG && lastG.j;
     if (j && j.status && j.status!=='ok') hint = `ì§€ì˜¤ì½”ë”© ì‘ë‹µ(status=${j.status})`;
     else if (j && j.error)                hint = `ì§€ì˜¤ì½”ë”© ì˜¤ë¥˜: ${j.error}`;
     else                                  hint = 'ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨(ë§¤ì¹­ ì•ˆë¨)';
   } else if (last.step === 'static_map') {
     hint = `ì •ì ì§€ë„ ì‹¤íŒ¨(status=${last.json_status ?? '?'})`;
   }
 }

  alert(
    'ì§€ë„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n' +
    'ì‚¬ìœ : ' + hint + '\n\n' +
    'â€¢ ì£¼ì†Œë¥¼ ë„ë¡œëª…ìœ¼ë¡œ ë°”ê¿” ì¬ê²€ìƒ‰í•´ ë³´ì„¸ìš”.\n' +
    'â€¢ ê´€ë¦¬ì ì½˜ì†”ì—ì„œ NCP API í‚¤/ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.'
  );
} finally {
  placeModal.close();
}

    })();
  });
});





      }catch(err){
        console.error(err);
        this.listEl.innerHTML = `<div class="empty">ê²€ìƒ‰ ì˜¤ë¥˜: ${escapeHTML(err.message||'ì•Œ ìˆ˜ ì—†ìŒ')}</div>`;
      }
    }
  };

  document.getElementById('btnPickPlace').addEventListener('click', ()=>{
    const seed = document.getElementById('place').value;
    placeModal.open(seed);
  });

  // ì‚¬ìš©ìê°€ ì¥ì†Œ í…ìŠ¤íŠ¸ë¥¼ ë°”ê¾¸ë©´ ì´ì „ ì„ íƒ URLì€ ë¬´íš¨í™”(ì˜¤ë™ì‘ ë°©ì§€)
 document.getElementById('place').addEventListener('input', ()=>{
  setPickedPlaceLink('', '');
  document.getElementById('placeLat').value = '';
  document.getElementById('placeLng').value = '';
  document.getElementById('placeMapImg').value = '';
  setMapPreview('');
});


  /* íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿ */
  const NOTES_PRESETS = [
    '- í¸í•œ ë³µì¥ê³¼ ê°œì¸ ë¬¼Â·ìš°ì˜ ë“±ì„ ì¤€ë¹„í•´ ì£¼ì„¸ìš”.',
    '- ë²„ìŠ¤ ëŒ€ì ˆ, ì¡°ê¸ˆ ì—¬ìœ  ìˆê²Œ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
    '- ìì°¨Â·ëŒ€ì¤‘êµí†µì„ ì´ìš©í•´ ê°œë³„ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
    '- ìì°¨ëŠ” ê³µì˜Â·ë…¸ìƒ ì£¼ì°¨ì¥ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.',
    '- ì¥ì†Œì— ë”°ë¼ ë‚´ë¶€ ì£¼ì°¨ì¥ì´ ë§ˆë ¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
  ];
  function getNotesLines(){
    const raw = (document.getElementById('notes').value || '')
      .split('\n').map(s => s.trim()).filter(Boolean);
    return raw;
  }
  function setNotesLines(lines){
    const ta = document.getElementById('notes');
    ta.value = (lines || []).join('\n');
    syncNotesPresetSelection();
  }
  function toggleNotePreset(text){
    const lines = getNotesLines();
    const i = lines.indexOf(text);
    if (i >= 0) lines.splice(i, 1);
    else lines.push(text);
    setNotesLines(lines);
  }
  function renderNotesPresets(){
    const box = document.getElementById('notesPresets'); if (!box) return;
    box.innerHTML = '';
    NOTES_PRESETS.forEach(txt => {
      const chip = document.createElement('div');
      chip.className = 'chip'; chip.textContent = txt; chip.tabIndex = 0;
      chip.setAttribute('role','button'); chip.setAttribute('data-text', txt);
      box.appendChild(chip);
    });
    box.addEventListener('click', e => {
      const c = e.target.closest('.chip'); if (!c) return;
      toggleNotePreset(c.getAttribute('data-text'));
    });
    box.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        const c = e.target.closest('.chip'); if (!c) return;
        e.preventDefault(); toggleNotePreset(c.getAttribute('data-text'));
      }
    });
    syncNotesPresetSelection();
  }
  function syncNotesPresetSelection(){
    const selected = new Set(getNotesLines());
    document.querySelectorAll('#notesPresets .chip').forEach(chip => {
      const t = chip.getAttribute('data-text');
      chip.classList.toggle('selected', selected.has(t));
    });
  }
  (function bindNotesInputSync(){
    const ta = document.getElementById('notes'); if (!ta) return;
    ta.addEventListener('input', () => { syncNotesPresetSelection(); });
  })();
  renderNotesPresets();

  /* í¼ ìˆ˜ì§‘ */
function collect(){
  const val = id => document.getElementById(id)?.value || '';
  const on  = id => {
    const el = document.getElementById(id);
    // ì €ì¥ ë°ì´í„°ì— í† ê¸€ì´ ì—†ë˜ ì˜ˆì „ í‚¤ë¥¼ ë³µì›í•´ë„ í•­ìƒ 'í‘œì‹œ'ê°€ ê¸°ë³¸ì´ ë˜ë„ë¡
    return (el ? !!el.checked : true);
  };

  return {
    team: val('team'),
    title: val('title'),
    date: val('date'),
    time: val('time'),
    schedule: val('schedule'),
    bus: val('bus'),

    place: val('place'),
    placeAddr: val('placeAddr'),
    placeTel:  val('placeTel'),
    placeLink: val('placeLink'),
    placeUrl:  val('placeUrl'),

    placeLat:   val('placeLat'),
    placeLng:   val('placeLng'),
    placeMapImg: val('placeMapImg'),

    notes: val('notes'),
    contact: val('contact'),

    // âœ… ìƒˆ í† ê¸€ë“¤
    showTeam:     on('showTeam'),
    showTitle:    on('showTitle'),
    showDate:     on('showDate'),
    showTime:     on('showTime'),
    showPlace:    on('showPlace'),
    showSchedule: on('showSchedule'),
    showBus:      on('showBus'),
    showNotes:    on('showNotes'),
    showContact:  on('showContact'),
  };
}




  /* ê³µìœ  í…ìŠ¤íŠ¸ */
  function decodeShare(b64){
    try{ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    catch(e){ alert('ê³µìœ  ì½”ë“œ í•´ì„ ì‹¤íŒ¨'); return null }
  }
  function makeShareTitle(d){
    const target = formatTarget(d.team);
    const dateTxt = d.date ? weekdayKR(d.date) : '';
    const rawTitle = (d.title || '').trim();
    if (rawTitle) return rawTitle;
    return [dateTxt, target, 'ì•¼ìœ íšŒ'].filter(Boolean).join(' ');
  }

  function resolvedMapLink(d){
    const place = (d.place||'').trim();
    const picked = (d.placeUrl||'').trim();
    if(picked) return picked;                 // ê²€ì¦ëœ ì§€ì  URL
    if(isUrl(place)) return place;            // ì‚¬ìš©ìê°€ URL ì§ì ‘ ì…ë ¥
    return buildNaverSearchLink(place);       // ë§ˆì§€ë§‰ ì•ˆì „ì¥ì¹˜: ê²€ìƒ‰ ë§í¬
  }

function buildShareText(){
  const d = collect();
  const dateStr  = d.date ? weekdayKR(d.date) : '-';
  const timeStr  = (d.time || '').trim();
  const lines = [];

  // ì œëª©
  if (d.showTitle) {
    const header = makeShareTitle(d) || 'ì•ˆë‚´ë¬¸';
    lines.push(header, '');
  }

  // ëŒ€ìƒ
  if (d.showTeam) {
    const target = formatTarget(d.team);
    if (target) lines.push(`ğŸ¯ [ëŒ€ìƒ] ${target}`, '');
  }

  // ì¼ì / ì‹œê°„ (ë¶„ë¦¬)
  const dateTimeLines = [];
  if (d.showDate) dateTimeLines.push(`ğŸ“… [ì¼ì] ${dateStr}`);
  if (d.showTime && timeStr) dateTimeLines.push(`â° [ì‹œê°„] ${timeStr}`);
  if (dateTimeLines.length) lines.push(...dateTimeLines, '');

  // ì¥ì†Œ
  if (d.showPlace) {
    lines.push(`ğŸ“ [ì¥ì†Œ] ${d.place || '-'}`, '');
    if (d.placeAddr) lines.push(`ğŸ  (ì£¼ì†Œ) ${d.placeAddr}`, '');
    if (d.placeTel)  lines.push(`â˜ï¸ (ì „í™”) ${d.placeTel}`, '');
    if (d.placeLink) lines.push(`ğŸ”— (ë„¤ì´ë²„) ${d.placeLink}`, '');
  }

  // ì¼ì • ìš”ì•½
  if (d.showSchedule) {
    lines.push('ğŸ“ [ì¼ì • ìš”ì•½]');
    const schedule = (d.schedule || '').split('\n').filter(Boolean);
    if (schedule.length) lines.push(...schedule);
    else lines.push('-');
    lines.push('');
  }

  // ë²„ìŠ¤
  if (d.showBus && (d.bus||'').trim()) {
    lines.push(`ğŸšŒ [ë²„ìŠ¤ ëŒ€ì ˆ] ${d.bus}`, '');
  }

  // íŠ¹ì´ì‚¬í•­
  if (d.showNotes && (d.notes || '').trim()){
    lines.push('âš ï¸ [íŠ¹ì´ì‚¬í•­]');
    lines.push(...d.notes.split('\n').filter(Boolean));
    lines.push('');
  }

  // ë¬¸ì˜
  if (d.showContact) {
    lines.push(`ğŸ“ [ë¬¸ì˜ì²˜] ${d.contact || '-'}`);
  }

  return lines.join('\n');
}

async function buildMapThumbByLatLng(lat, lng){
  try{
    const url = `${GAS_URL}?mode=static_map&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&w=440&h=300&level=19`;
    const res = await fetchWithTimeout(url);
    const json = await res.json();
    if (!res.ok || json.status !== 'ok' || !json.dataUrl) throw new Error('static_map failed');
    return json.dataUrl; // data:image/png;base64,...
  }catch(e){
    console.warn('Static map error:', e);
    return '';
  }
}

async function geocodeToLatLng(name, road, jibun){
  const q = (road || jibun || name || '').trim();
  if (!q) return null;
  try{
    const url = `${GAS_URL}?mode=geocode&q=${encodeURIComponent(q)}`;
    const res = await fetchWithTimeout(url);
    const json = await res.json();
    if (!res.ok || json.status !== 'ok' || !json.found) return null;
    return { lat: json.lat, lng: json.lng };
  }catch(e){
    console.warn('Geocode error:', e);
    return null;
  }
}

function setMapPreview(dataUrl){
  const img = document.getElementById('placeThumbImg');
  const box = document.getElementById('placeThumb');
  if (dataUrl){
    img.src = dataUrl;
    box.style.display = 'block';
  } else {
    img.removeAttribute('src');
    box.style.display = 'none';
  }
}
// âœ… html2canvas ìº¡ì²˜ ì „ì— ëª¨ë“  ì´ë¯¸ì§€ ë¡œë”©ì„ ê¸°ë‹¤ë¦¬ëŠ” ìœ í‹¸
async function waitForImagesLoaded(root){
  const imgs = Array.from(root.querySelectorAll('img'));
  const pendings = imgs.filter(img => !img.complete || img.naturalWidth === 0);
  if (!pendings.length) return;
  await Promise.all(pendings.map(img => new Promise(res => {
    img.addEventListener('load',  res, { once:true });
    img.addEventListener('error', res, { once:true });
  })));
}




  /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
  (function setupPreviewModal(){
    const modal = document.getElementById('previewModal');
    const ta = document.getElementById('previewTa');
    const btnClose2 = document.getElementById('previewClose2');
    const btnCopy = document.getElementById('previewCopy');
    const toast = document.getElementById('previewToast');

    function openPreviewModal(text){
      if (!modal || !ta) return;
      ta.value = text || '';
      ta.style.height = 'auto';
      ta.style.height = Math.max(220, Math.min(420, ta.scrollHeight)) + 'px';
      toast?.classList.remove('show');
      modal.hidden = false;
      setTimeout(()=>{ ta.focus(); ta.select(); }, 0);
      document.addEventListener('keydown', onEsc, { once: true });
      modal.addEventListener('click', onBackdropClick);
    }
    function closePreviewModal(){ if (!modal) return; modal.hidden = true; modal.removeEventListener('click', onBackdropClick); }
    function onBackdropClick(e){ if (e.target === modal) closePreviewModal(); }
    function onEsc(e){ if (e.key === 'Escape') closePreviewModal(); }
    async function copyPreviewText(){
      const text = ta.value || '';
      if (navigator.clipboard && navigator.clipboard.writeText){ try{ await navigator.clipboard.writeText(text); showToast(); return; } catch(_){} }
      try{ ta.select(); const ok = document.execCommand('copy'); if (ok) { showToast(); return; } }catch(_){}
      alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    }
    function showToast(){ if (!toast) return; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 3000); }
    window.openPreviewModal = openPreviewModal;
    window.closePreviewModal = closePreviewModal;
    btnCopy?.addEventListener('click', copyPreviewText);
    btnClose2?.addEventListener('click', closePreviewModal);
  })();

  /* ë²„íŠ¼ ë™ì‘ */
  document.getElementById('btnCopyText').addEventListener('click', async ()=>{
    showLoading('í…ìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘â€¦', 'ê³µìœ ìš© ë¬¸ì¥ì„ ì •ë¦¬í•©ë‹ˆë‹¤', 300);
    try{ const text = buildShareText(); openPreviewModal(text); }
    finally{ hideLoading(); }
  });

  document.getElementById('btnShare').addEventListener('click', async ()=>{
    showLoading('ì„ì‹œ ì €ì¥ ì¤‘â€¦', 'ì§§ì€ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤');
    try{
      const res = await fetchWithTimeout(GAS_URL, { method:'POST', body: JSON.stringify({ mode:'share', data: collect() })});
      let json; try{ json = await res.json(); } catch{ const t = await res.text(); throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }
      if(res.ok && json.status==='ok' && json.key){
        const url = new URL(location.href);
        url.searchParams.delete('code'); url.searchParams.set('k', json.key);
        history.replaceState(null, '', url.toString());
       const d = collect();
const titleText = d.showTitle ? makeShareTitle(d) : '';
const shareText = titleText ? `${titleText}\n${url.toString()}` : url.toString();

        openPreviewModal(shareText);
      }else{ alert('ì„ì‹œ ì €ì¥ ì‹¤íŒ¨: ' + (json.error || res.status)); }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
      alert('ì„ì‹œ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + msg);
    }finally{ hideLoading(); }
  });

  /* ì œì¶œ */
  async function submitToSheet(){
    showLoading('ì „ì†¡ ì¤‘â€¦', 'ì¸ì‚¬ì§€ì›íŒ€ ì ‘ìˆ˜ ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤');
    try{
      const data = collect();
      const todayStr = new Date().toISOString().slice(0,10);

      // (ê¸°íƒ€ ì…ë ¥ ê°•ì œ)
      const customOpen = document.getElementById('teamCustom')?.style.display !== 'none';
      const customVal  = document.getElementById('teamCustom')?.value.trim();
      if (customOpen && !customVal) {
        alert('ëŒ€ìƒ(ê¸°íƒ€)ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        document.getElementById('teamCustom').focus();
        hideLoading(); return;
      }

      // í•„ìˆ˜ ì²´í¬
      const invalid = [];
      if(!data.team) invalid.push(() => document.querySelector('#teamChips .chip')?.focus());
      if(!data.title.trim()) invalid.push(() => document.getElementById('title').focus());
      if (data.date && data.date < todayStr) {
        alert('ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); hideLoading();
        document.getElementById('date').focus(); return;
      }
      if(!data.date) invalid.push(() => document.getElementById('date').focus());
      if(!data.place.trim()) invalid.push(() => document.getElementById('place').focus());
      if(!(data.schedule||'').trim()) invalid.push(() => document.getElementById('schedule').focus());
      if(!data.bus) invalid.push(() => document.querySelector('#busChips .chip')?.focus());
      if(!data.contact.trim()) invalid.push(() => document.getElementById('contact').focus());
      if (invalid.length){ alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥/ì„ íƒí•´ ì£¼ì„¸ìš”.'); invalid[0](); hideLoading(); return; }

      // 1) ì£¼ì†Œì°½ì— ?k= ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìë™ ì„ì‹œì €ì¥
      let shareKey='', clientUrl='';
      const urlObj = new URL(location.href);
      const existingKey = urlObj.searchParams.get('k') || '';

      if (existingKey) {
        shareKey = existingKey; clientUrl = urlObj.toString();
      } else {
        try {
          const shareRes = await fetchWithTimeout(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ mode:'share', data })
          });
          let shareJson; try{ shareJson = await shareRes.json(); }
          catch{ const t = await shareRes.text(); throw new Error('ì„ì‹œì €ì¥ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }
          if (shareRes.ok && shareJson.status==='ok' && shareJson.key){
            shareKey = shareJson.key;
            urlObj.searchParams.delete('code');
            urlObj.searchParams.set('k', shareKey);
            clientUrl = urlObj.toString();
            history.replaceState(null, '', clientUrl);
          } else { clientUrl = location.href; }
        } catch{ clientUrl = location.href; }
      }

      // 2) ì œì¶œ payload
      const payload = {
        ...data,
        submitted_at: new Date().toISOString(),
        client_url: clientUrl,
        share_key: shareKey,
        mode: 'append'
      };

      // 3) ì œì¶œ
      const res = await fetchWithTimeout(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
      let json; try{ json = await res.json(); } catch{ const t = await res.text(); throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }
      if(res.ok && (json.status==='ok' || json.result==='ok')){
        alert(`ì œì¶œ ì™„ë£Œ! ì ‘ìˆ˜ë²ˆí˜¸: ${json.id||json.row||'í™•ì¸ë¨'}`);
      }else{
        alert(`ì œì¶œ ì‹¤íŒ¨: ${json.error||res.status}`);
      }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
      alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜: ' + msg);
    }finally{ hideLoading(); }
  }
  document.getElementById('btnSubmit').addEventListener('click', submitToSheet);

  /* ë²„ìŠ¤ ì¹© + ë°°ì§€ */
  function setBus(val){
    const hidden = document.getElementById('bus');
    const chips = document.querySelectorAll('#busChips .chip');
    hidden.value = val || '';
    chips.forEach(c => c.classList.toggle('selected', c.getAttribute('data-val') === val));
    document.getElementById('busBadgeVal').textContent = hidden.value || '-';
    updateBusBadgeVisibility();
  }
  const showAfter = 200;
 function updateBusBadgeVisibility(){
  const badge = document.getElementById('busBadge');
  const v = document.getElementById('bus').value || '';
  const showBus = document.getElementById('showBus')?.checked ?? true; // ê¸°ë³¸ true
  if(window.scrollY > showAfter && v && showBus){
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

  window.addEventListener('scroll', updateBusBadgeVisibility, {passive:true});
  window.addEventListener('resize', updateBusBadgeVisibility);
  (function bindBusChips(){
    const g = document.getElementById('busChips'); if(!g) return;
    g.addEventListener('click', (e)=>{
      const target = e.target.closest('.chip'); if(!target) return;
      setBus(target.getAttribute('data-val'));
    });
  })();
  (function bindBusChipsA11y(){
    const g = document.getElementById('busChips'); if(!g) return;
    g.querySelectorAll('.chip').forEach(chip=>{ chip.tabIndex=0; chip.setAttribute('role','radio'); });
    g.addEventListener('keydown', e=>{
      if (e.key!=='Enter' && e.key!==' ') return;
      const chip = e.target.closest('.chip'); if(!chip) return;
      e.preventDefault(); setBus(chip.getAttribute('data-val'));
    });
  })();

  /* ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œ ì„ íƒ ê¸ˆì§€ */
  (function lockPastDate(){
    const el = document.getElementById('date'); if(!el) return;
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    el.min = `${yyyy}-${mm}-${dd}`;
  })();

  /* init */
(async function init(){
  const p = new URLSearchParams(location.search);
  const k = p.get('k'); 
  const code = p.get('code');

  if (k) { 
    try { await loadByKey(k); } catch(_) {}
  } 
  else if (code) {
    const data = decodeShare(code);
    if (data) {
      document.getElementById('team').value = data.team || '';
      renderTeamChips(); restoreCustomTeamFromTeamValue();
      document.getElementById('title').value = data.title||'';
      document.getElementById('date').value = data.date||'';
      document.getElementById('time').value  = data.time || '';   // â† ì—¬ê¸° ì¶”ê°€
      document.getElementById('schedule').value = data.schedule||'';
      document.getElementById('bus').value = data.bus || ''; 
      setBus(document.getElementById('bus').value || '');

      document.getElementById('place').value = data.place||'';
      document.getElementById('placeUrl').value = data.placeUrl||'';
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place||'ì§€ë„');

      // âœ… hidden ë³µì›
      document.getElementById('placeAddr').value = data.placeAddr || '';
      document.getElementById('placeTel').value  = data.placeTel  || '';
      document.getElementById('placeLink').value = data.placeLink || '';
// â‘  ì¢Œí‘œ/ì§€ë„ ì´ë¯¸ì§€ê¹Œì§€ ë³µì›
document.getElementById('placeLat').value    = data.placeLat    || '';
document.getElementById('placeLng').value    = data.placeLng    || '';
document.getElementById('placeMapImg').value = data.placeMapImg || '';

// â‘¡ ì¸ë„¤ì¼ ë°•ìŠ¤ ê°±ì‹ 
if (data.placeMapImg) setMapPreview(data.placeMapImg);

// â‘¢ ì„ íƒëœ ì§€ë„ ë§í¬ ë°•ìŠ¤ë„ í•¨ê»˜ ë³´ì´ë„ë¡(ì´ë¯¸ ìˆìœ¼ë‚˜ ì•ˆì „í•˜ê²Œ)
if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');

      document.getElementById('notes').value = data.notes||'';
      document.getElementById('contact').value = data.contact||'';
      // âœ… í‘œì‹œ í† ê¸€ ë³µì› (ì—†ìœ¼ë©´ ê¸°ë³¸ true)
const setOn = (id, v) => {
  const el = document.getElementById(id);
  if (el) el.checked = (v === undefined ? true : !!v);
};
setOn('showTeam',     data.showTeam);
setOn('showTitle',    data.showTitle);
setOn('showDate',     data.showDate);
setOn('showTime',     data.showTime);
setOn('showPlace',    data.showPlace);
setOn('showSchedule', data.showSchedule);
setOn('showBus',      data.showBus);
setOn('showNotes',    data.showNotes);
setOn('showContact',  data.showContact);

    }
  } 
  else {
    document.getElementById('title').value = 'ì•¼ìœ íšŒ ì•ˆë‚´';
    document.getElementById('team').value = '';
    renderTeamChips(); restoreCustomTeamFromTeamValue();
  }

  updateBusBadgeVisibility();
})();


  /* ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° */
 async function loadByKey(k){
  showLoading('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦', 'ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤');
  try{
    const url = `${GAS_URL}?mode=load&key=${encodeURIComponent(k)}`;
    const res = await fetchWithTimeout(url);
    let json; 
    try { json = await res.json(); } 
    catch { 
      const t = await res.text(); 
      throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); 
    }

    if (json.status === 'ok' && json.data){
      const data = json.data;

      document.getElementById('team').value = data.team || '';
      renderTeamChips(); restoreCustomTeamFromTeamValue();
      document.getElementById('title').value = data.title||'';
      document.getElementById('date').value = data.date||'';
      document.getElementById('time').value  = data.time || '';   // â† ì—¬ê¸° ì¶”ê°€
      document.getElementById('schedule').value = data.schedule||'';
      document.getElementById('bus').value = data.bus || ''; 
      setBus(document.getElementById('bus').value || '');

      document.getElementById('place').value = data.place||'';
      document.getElementById('placeUrl').value = data.placeUrl||'';
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place||'ì§€ë„');

      // âœ… hidden ë³µì›
      document.getElementById('placeAddr').value = data.placeAddr || '';
      document.getElementById('placeTel').value  = data.placeTel  || '';
      document.getElementById('placeLink').value = data.placeLink || '';
document.getElementById('placeLat').value    = data.placeLat    || '';
document.getElementById('placeLng').value    = data.placeLng    || '';
document.getElementById('placeMapImg').value = data.placeMapImg || '';

// â‘¡ ì¸ë„¤ì¼ ë°•ìŠ¤ ê°±ì‹ 
if (data.placeMapImg) setMapPreview(data.placeMapImg);

// â‘¢ ì„ íƒëœ ì§€ë„ ë§í¬ ë°•ìŠ¤ë„ í•¨ê»˜ ë³´ì´ë„ë¡(ì´ë¯¸ ìˆìœ¼ë‚˜ ì•ˆì „í•˜ê²Œ)
if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');
      document.getElementById('notes').value = data.notes||'';
      document.getElementById('contact').value = data.contact||'';
      // âœ… í‘œì‹œ í† ê¸€ ë³µì› (ì—†ìœ¼ë©´ ê¸°ë³¸ true)
const setOn = (id, v) => {
  const el = document.getElementById(id);
  if (el) el.checked = (v === undefined ? true : !!v);
};
setOn('showTeam',     data.showTeam);
setOn('showTitle',    data.showTitle);
setOn('showDate',     data.showDate);
setOn('showTime',     data.showTime);
setOn('showPlace',    data.showPlace);
setOn('showSchedule', data.showSchedule);
setOn('showBus',      data.showBus);
setOn('showNotes',    data.showNotes);
setOn('showContact',  data.showContact);

    } 
    else {
      alert('ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (json.error||'ì•Œ ìˆ˜ ì—†ìŒ'));
    }
  } catch(err){
    const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ' + msg);
  } finally { 
    hideLoading(); 
  }
}


  /* ì•ˆë‚´ë¬¸ ì´ë¯¸ì§€ ë Œë”ìš© */
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- ì•ˆë‚´ë¬¸ ì´ë¯¸ì§€ ë Œë”ìš© íˆë“  DOM -->
  <div id="exportDoc" style="position:absolute; left:-99999px; top:-99999px; width:794px; background:#fff;">
    <div id="exportInner" style="padding:28px 32px; font:14px/1.7 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, sans-serif; color:#222;"></div>
  </div>

  <script>
function escapeHTML(s){ return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]) ); }

function buildExportHTML(){
  const d = collect();
  const dateStr  = d.date ? weekdayKR(d.date) : '-';
  const timeStr  = (d.time || '').trim();
  const teamLine = formatTarget(d.team);
  const scheduleLines = (d.schedule || '').split('\n').map(s=>s.trim()).filter(Boolean);
  const notesLines    = (d.notes    || '').split('\n').map(s=>s.trim()).filter(Boolean);
  const busVal        = (d.bus || '').trim();

  const toList = (arr)=> arr.length
    ? '<ul class="export-list">' + arr.map(li=>`<li>${escapeHTML(li)}</li>`).join('') + '</ul>'
    : '<ul class="export-list"><li>-</li></ul>';

  // ë©”íƒ€(ì™¼ìª½ ìƒë‹¨ ìƒì) í–‰ë“¤
  const meta = [];
  if (d.showTeam) meta.push(`<div><b>ëŒ€ìƒ</b> ${escapeHTML(teamLine || '-')}</div>`);
  if (d.showDate) meta.push(`<div><b>ì¼ì</b> ${escapeHTML(dateStr)}</div>`);
  if (d.showTime && timeStr) meta.push(`<div><b>ì‹œê°„</b> ${escapeHTML(timeStr)}</div>`);
  if (d.showPlace) {
    meta.push(`<div><b>ì¥ì†Œ</b> ${escapeHTML(d.place || '-')}</div>`);
    if (d.placeAddr) meta.push(`<div><b>ì£¼ì†Œ</b> ${escapeHTML(d.placeAddr)}</div>`);
    if (d.placeTel)  meta.push(`<div><b>ì „í™”</b> ${escapeHTML(d.placeTel)}</div>`);
  }
  if (d.showBus && busVal) meta.push(`<div><b>ë²„ìŠ¤</b> ${escapeHTML(busVal)}</div>`);
  if (d.showContact) meta.push(`<div><b>ë¬¸ì˜</b> ${escapeHTML(d.contact || '-')}</div>`);

  // ë³¸ë¬¸ ì„¹ì…˜ ì¹´ë“œ
  const sectionCards = [];
  if (d.showSchedule) {
    sectionCards.push(`
      <div class="export-card card-schedule">
        <div class="export-sec-title">ì¼ì • ìš”ì•½</div>
        ${toList(scheduleLines)}
      </div>
    `);
  }
  if (d.showNotes && notesLines.length){
    sectionCards.push(`
      <div class="export-card">
        <div class="export-sec-title">íŠ¹ì´ì‚¬í•­</div>
        ${toList(notesLines)}
      </div>
    `);
  }

  // ì œëª©ì€ í† ê¸€ ì‹œ ê°ì¶¤
  const titleHtml = d.showTitle
    ? `<div class="export-title">${escapeHTML(d.title || 'ì•¼ìœ íšŒ ì•ˆë‚´')}</div>`
    : '';

  // ì§€ë„ëŠ” ì¥ì†Œ í‘œì‹œ ONì¼ ë•Œë§Œ ë…¸ì¶œ
  const mapHtml = (d.showPlace && d.placeMapImg)
    ? `<div class="export-map"><img src="${d.placeMapImg}" alt="ì§€ë„ ë¯¸ë¦¬ë³´ê¸°"></div>`
    : '';

  return `
    ${titleHtml}
    <div class="export-grid">
      <div>
        ${ meta.length ? `<div class="export-meta">${meta.join('')}</div>` : '' }
        <div class="export-sections">
          ${sectionCards.join('')}
        </div>
      </div>
      ${mapHtml}
    </div>
  `;
}







  function fillExportDom(){
    const inner = document.getElementById('exportInner');
    if(!inner) return;
    inner.innerHTML = buildExportHTML();
  }

  async function exportAsImage(){
    showLoading('ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
    try{
      fillExportDom();
      const target = document.getElementById('exportDoc');
      const inner  = document.getElementById('exportInner');
      const sel    = document.getElementById('exportWidth');
      const choice = sel ? sel.value : 'auto';

      const prevWidth = target.style.width;
      const hadNarrow = target.classList.contains('card-narrow');

      let pxWidth;
      if (choice === 'auto') {
        target.style.width = 'auto';
        const measured = inner.scrollWidth || 0;
        pxWidth = Math.max(420, Math.min(560, measured + 12));
      } else {
        pxWidth = parseInt(choice, 10) || 560;
      }
      target.style.width = pxWidth + 'px';
      if (pxWidth <= 560) target.classList.add('card-narrow'); else target.classList.remove('card-narrow');

      const isWide = (choice === '1123' || pxWidth >= 980); // A4 ê°€ë¡œ ì„ íƒ ì‹œ
    target.classList.toggle('wide', isWide);
      
// âœ… ë‚´ë³´ë‚´ê¸°ìš© íˆë“  DOM ì•ˆì˜ ëª¨ë“  <img> ë¡œë“œ ëŒ€ê¸°
await waitForImagesLoaded(target);

      const canvas = await html2canvas(target, {backgroundColor:'#fff', scale:2, useCORS:true});
      const dataURL = canvas.toDataURL('image/png');

      const a = document.createElement('a');
      a.href = dataURL;
      a.download = (collect().title || 'ì•ˆë‚´ë¬¸') + `.png`;
      document.body.appendChild(a); a.click(); a.remove();

      target.style.width = prevWidth;
      if (!hadNarrow) target.classList.remove('card-narrow');
    } finally { hideLoading(); }
  }
  document.getElementById('btnExportIMG')?.addEventListener('click', exportAsImage);
  </script>
</body>
</html>
