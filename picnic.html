<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>반별 안내문</title>
  <style>
    :root{
      --brand:#e53935; --ink:#222; --muted:#666; --line:#ddd; --bg:#f7f7f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .card h2{margin:0;padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .card .body{padding:18px}
    .f{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:start}
    .row label{font-weight:700;padding-top:6px}
    input[type=text], input[type=date], textarea, select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
    }
    textarea{min-height:110px;resize:vertical}

    /* 모바일 라벨/입력 세로 정렬 */
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; gap: 6px; }
      .row label { padding-top: 0; }
      .row > * + * { margin-top: 2px; }
    }

    /* 버스 대절 O/X 토글 */
    .chip-group{display:flex;gap:8px;align-items:center}
    .chip{
      border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;
      padding:6px 14px;font-weight:700;min-width:44px;text-align:center;user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .chip.selected{border-color:var(--brand); color:#fff; background:var(--brand)}

    /* 우하단 배지 */
    #busBadge{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 10px;
      font-weight:800; box-shadow:0 4px 12px rgba(0,0,0,.12); display:none;
    }

    /* 로딩 오버레이 */
    #loadingOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,.7); z-index:10000;
      display:none; align-items:center; justify-content:center; flex-direction:column; gap:14px;
      backdrop-filter:saturate(1.2) blur(2px);
    }
    .spinner{
      width:48px; height:48px; border-radius:50%;
      border:4px solid rgba(0,0,0,.08); border-top-color: var(--brand);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .loading-text{font-weight:700; color:#333}
    .loading-sub{font-size:12px; color:#777}
    .toolbar [disabled]{opacity:.6; cursor:not-allowed}

    /* 하단 툴바를 카드처럼 + 세로 버튼 */
    .toolbar {
      display: grid;
      gap: 12px;
      margin: 24px 0;
      padding: 16px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .toolbar button{
      padding: 14px;
      font-size: 15px;
      font-weight: 700;
      border-radius: 12px;
      transition: all .2s;
      border:1px solid var(--line);
      background:#fff;
    }
    #btnShare { border-color:#90caf9; background:#e3f2fd; color:#1565c0; }
    #btnShare:hover { background:#bbdefb; }
    #btnCopyText { border-color:#a5d6a7; background:#e8f5e9; color:#2e7d32; }
    #btnCopyText:hover { background:#c8e6c9; }
    #btnSubmit { border-color:#ef9a9a; background:#ffebee; color:#c62828; }
    #btnSubmit:hover { background:#ffcdd2; }

    /* 수동 복사 박스 */
    #copySheetBox{
      display:none; margin:8px 0; padding:12px; border:1px dashed #ccc; border-radius:10px; background:#fafafa;
      overscroll-behavior: contain; /* 부모로 스크롤 전파 방지 */
    }
    .copy-hint {
      display: none;
      margin-top: 6px;
      font-size: 12px;
      color: #888;
    }
    #copySheetTa{
      width: 100%;
      height: 200px;                 /* 기본 높이 */
      max-height: 400px;             /* 최대 높이 */
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font: 14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;
      resize: vertical;              /* 직접 세로 크기 조절 가능 */
      overflow-y: auto;              /* 내용 많으면 내부 스크롤 */
      overscroll-behavior: contain;  /* 부모로 스크롤 전파 방지 */
      -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
    }

    /* 프린트 강화 */
    @media print{
      .no-print, .toolbar, #copySheetBox, #busBadge, #loadingOverlay { display:none !important; }
      body{ background:#fff }
      .wrap{ max-width:900px }
      pre, textarea { font-family: inherit; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card no-print">
        <h2>아래 항목을 작성해주세요</h2>
        <div class="body">
          <div class="f">
            <div class="row">
              <label for="team">반 선택</label>
              <select id="team">
                <option value="A">A반</option>
                <option value="B">B반</option>
                <option value="C">C반</option>
                <option value="D">D반</option>
              </select>
            </div>
            <div class="row">
              <label for="title">제목(선택)</label>
              <input id="title" type="text" placeholder="예) 야유회 안내" />
            </div>
            <div class="row">
              <label for="date">일자</label>
              <input id="date" type="date" />
            </div>
            <div class="row">
              <label for="place">장소</label>
              <input id="place" type="text" placeholder="예) XXX (주소는 선택사항)" />
            </div>
            <div class="row">
              <label for="schedule">일정 요약</label>
              <textarea id="schedule" placeholder="예시)
- 06:00 화랑유원지 집결
- 06:30 버스 출발
- 11:00 XX 관람 시작
- 12:30 점심 식사
- 15:00 귀가"></textarea>
            </div>

            <!-- 버스 대절 O/X -->
            <div class="row">
              <label>버스 대절</label>
              <div>
                <input id="bus" type="hidden" value="" />
                <div class="chip-group" id="busChips" role="radiogroup" aria-label="버스 대절 여부">
                  <div class="chip" role="radio" tabindex="0" aria-checked="false" data-val="O">O</div>
                  <div class="chip" role="radio" tabindex="-1" aria-checked="false" data-val="X">X</div>
                </div>
                <small style="color:var(--muted)">버스 대절 여부를 선택하세요 (O/X)</small>
              </div>
            </div>

            <div class="row">
              <label for="notes">특이사항</label>
              <textarea id="notes" placeholder="예) 
- 편한 복장 및 운동화 권장
- 개인 물/우의 등 준비
- 전세버스 대절 (개별 집결 없음)
- 일부 구간은 도보 이동 예정"></textarea>
            </div>
            <div class="row">
              <label for="contact">문의처</label>
              <input id="contact" type="text" placeholder="예) A반 홍길동 (010-0000-0000)" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 툴바 -->
    <div class="toolbar no-print">
      <button id="btnShare">임시저장(수정용 링크)</button>
      <button id="btnCopyText">안내문(공유용 텍스트)</button>
      <button id="btnSubmit">제출(인사지원팀)</button>
    </div>

    <!-- 수동 복사용 박스 -->
    <div id="copySheetBox" class="no-print" style="margin-bottom:24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-weight:700;">아래 내용을 길게 눌러 복사하세요.</div>
        <button id="copySheetClose" style="border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">닫기</button>
      </div>
      <textarea id="copySheetTa"></textarea>
      <div id="copyHint" class="copy-hint">내용이 길면 이 상자 안을 스크롤하세요 ↕</div>
    </div>
  </div>

  <!-- 스크롤 배지 -->
  <div id="busBadge" aria-hidden="true">버스: <span id="busBadgeVal">-</span></div>

  <!-- 로딩 오버레이 -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text" id="loadingText">진행 중…</div>
    <div class="loading-sub" id="loadingSub">잠시만 기다려주세요</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZVROE3X1C1LywBB1jfrOC6yxCKTVIPmuZ_yA3V-c84Q1DBXIrLc2parM_gsHJLAY/exec';

  /* ===== fetch 타임아웃 유틸 ===== */
  async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);
    try { return await fetch(url, {...opts, signal: controller.signal}); }
    finally { clearTimeout(timer); }
  }

  /* ===== 로딩 오버레이 ===== */
  let loadingCount = 0;
  let loadingTimer = null;

  function setToolbarDisabled(disabled){
    document.querySelectorAll('.toolbar button').forEach(btn => btn.disabled = disabled);
    document.querySelectorAll('input, textarea').forEach(el => el.readOnly = disabled);
    document.querySelectorAll('select').forEach(el => el.disabled = disabled);
  }
  function showLoading(main='진행 중…', sub='잠시만 기다려주세요', minMs=500){
    loadingCount++;
    const ov = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = main;
    document.getElementById('loadingSub').textContent = sub;
    ov.style.display = 'flex';
    setToolbarDisabled(true);
    clearTimeout(loadingTimer);
    loadingTimer = setTimeout(()=>{ loadingTimer = null; }, minMs);
  }
  function hideLoading(){
    if (loadingCount > 0) loadingCount--;
    const finish = ()=>{
      if (loadingCount === 0){
        document.getElementById('loadingOverlay').style.display = 'none';
        setToolbarDisabled(false);
      }
    };
    if (loadingTimer){ setTimeout(()=>finish(), 120); loadingTimer = null; }
    else { finish(); }
  }

  /* ===== 인앱 감지 ===== */
  function isInAppBrowser(){
    const ua = navigator.userAgent || '';
    return /(KAKAOTALK|FB_IAB|Instagram|NAVER|DaumApp|Line|Whale)/i.test(ua);
  }

  /* ===== 수동 복사 박스 ===== */
  function showCopySheet(text){
    const box = document.getElementById('copySheetBox');
    const ta  = document.getElementById('copySheetTa');
    const hint = document.getElementById('copyHint');
    if (!box || !ta) return;

    box.style.display = 'block';
    ta.value = text;

    // 초기 높이 200~400 사이로 보정
    ta.style.height = 'auto';
    const targetH = Math.max(200, Math.min(400, ta.scrollHeight));
    ta.style.height = targetH + 'px';

    // 포커스/선택 → 내부 스크롤 활성화에 도움
    setTimeout(()=>{
      ta.focus();
      ta.select();
    }, 0);

    // 스크롤 가능 여부에 따라 힌트 표시
    if (hint) hint.style.display = (ta.scrollHeight > ta.clientHeight) ? 'block' : 'none';

    // 스크롤 시작하면 힌트 숨김
    ta.addEventListener('scroll', () => {
      if (hint) hint.style.display = 'none';
    }, { passive: true });
  }
  function hideCopySheet(){
    const box = document.getElementById('copySheetBox');
    if (box) box.style.display = 'none';
  }
  document.getElementById('copySheetClose')?.addEventListener('click', hideCopySheet);

  /* ===== 모바일 친화적 공유/복사 ===== */
  function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
  async function tryWebShare({title, text, url}){
    if (navigator.share) { try{ await navigator.share({ title, text, url }); return true; } catch(_){ return false; } }
    return false;
  }
  function legacyCopy(text){
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(_){ return false; }
  }

  // 기존 safeDistribute 대체
async function safeDistribute({title='', text='', url='', pureText=false, forceManual=false}) {
  const toCopy =
    text
      ? (title ? (title + '\n' + text) : text) + (url ? '\n' + url : '')
      : (title ? (title + (url ? '\n' : '')) : '') + (url || '');

  // <<<< 여기: 강제 수동 모드면 즉시 수동 복사 박스만
  if (forceManual) {
    showCopySheet(toCopy);
    return { method: 'manual-forced' };
  }

  // (나머지는 기존 로직 유지 — 링크 공유에서 사용)
  const shouldSkipWebShare = pureText === true;

  if (isInAppBrowser() && !navigator.share){
    showCopySheet(toCopy);
    return { method:'manual' };
  }

  if (!shouldSkipWebShare && isMobile() && navigator.share) {
    try {
      const payload = {};
      if (title) payload.title = title;
      if (text)  payload.text  = text;
      if (url)   payload.url   = url; // 빈 문자열은 넣지 않음
      await navigator.share(payload);
      return { method:'share' };
    } catch(_) {}
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    try { await navigator.clipboard.writeText(toCopy); hideCopySheet(); return { method:'clipboard' }; }
    catch(_) {}
  }

  if (legacyCopy(toCopy)) { hideCopySheet(); return { method:'legacy' }; }

  showCopySheet(toCopy);
  return { method:'manual' };
}


  /* ===== 날짜 포맷 ===== */
  function weekdayKR(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr+'T00:00:00');
    const yo = ['일','월','화','수','목','금','토'][d.getDay()];
    return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일(${yo})`;
  }

  /* ===== 폼 수집 ===== */
  function collect(){
    return {
      team: document.getElementById('team').value,
      title: document.getElementById('title').value,
      date: document.getElementById('date').value,
      schedule: document.getElementById('schedule').value,
      bus: document.getElementById('bus').value,
      place: document.getElementById('place').value,
      notes: document.getElementById('notes').value,
      contact: document.getElementById('contact').value,
    };
  }

  /* ===== 버스 토글/배지 ===== */
  function setBus(val){
    const hidden = document.getElementById('bus');
    const chips = document.querySelectorAll('#busChips .chip');
    hidden.value = val || '';
    chips.forEach(c => c.classList.toggle('selected', c.getAttribute('data-val') === val));
    document.getElementById('busBadgeVal').textContent = hidden.value || '-';
    updateBusBadgeVisibility();
  }
  const showAfter = 200;
  function updateBusBadgeVisibility(){
    const badge = document.getElementById('busBadge');
    if(window.scrollY > showAfter){
      const v = document.getElementById('bus').value || '';
      badge.style.display = v ? 'block' : 'none';
    }else{
      badge.style.display = 'none';
    }
  }
  window.addEventListener('scroll', updateBusBadgeVisibility, {passive:true});
  window.addEventListener('resize', updateBusBadgeVisibility);
  (function bindBusChips(){
    const group = document.getElementById('busChips');
    if(!group) return;
    group.addEventListener('click', (e)=>{
      const target = e.target.closest('.chip');
      if(!target) return;
      setBus(target.getAttribute('data-val'));
    });
  })();

  /* ===== 제목 생성 ===== */
  function makeShareTitle(d){
    const teamLabel = d.team ? `${d.team}반` : '';
    const dateTxt = d.date ? weekdayKR(d.date) : '';
    const rawTitle = (d.title || '').trim();
    if (rawTitle) return rawTitle;                 // 제목은 자유 입력
    return [dateTxt, teamLabel, '야유회'].filter(Boolean).join(' ');
  }

  /* ===== 공유용 텍스트 생성 ===== */
  function buildShareText(){
    const d = collect();
    const lines = [];
    const dateStr = d.date ? weekdayKR(d.date) : '-';
    const header = makeShareTitle(d) || (d.team ? `${d.team}반 안내문` : '안내문');

    lines.push(header, '');
    if (d.team) lines.push(`[반] ${d.team}`);
    lines.push(`[일자] ${dateStr}`);
    lines.push(`[장소] ${d.place || '-'}`);
    lines.push('[일정 요약]');
    lines.push(...(d.schedule || '').split('\n').filter(Boolean));
    if ((d.bus || '').trim()) lines.push(`[버스 대절] ${d.bus}`);
    if ((d.notes || '').trim()){
      lines.push('[특이사항]');
      lines.push(...d.notes.split('\n').filter(Boolean));
    }
    lines.push(`[문의처] ${d.contact || '-'}`);

    return lines.join('\n');
  }

  /* ===== 버튼: 임시저장(수정용 링크) ===== */
  document.getElementById('btnShare').addEventListener('click', async ()=>{
    showLoading('임시 저장 중…', '짧은 링크를 생성합니다');
    try{
      const res = await fetchWithTimeout(GAS_URL, {
        method:'POST',
        body: JSON.stringify({ mode:'share', data: collect() })
      });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
      }
      if(res.ok && json.status==='ok' && json.key){
        const url = new URL(location.href);
        url.searchParams.delete('code');
        url.searchParams.set('k', json.key);
        history.replaceState(null, '', url.toString());

        const titleText = makeShareTitle(collect());
        const dist = await safeDistribute({ title: titleText, text: '', url: url.toString() });
        if (dist.method === 'share') {
          alert('공유 시트로 전송했습니다.');
        } else if (dist.method === 'clipboard' || dist.method === 'legacy') {
          alert('짧은 공유 링크가 복사되었습니다.');
        }
      }else{
        alert('임시 저장 실패: ' + (json.error || res.status));
      }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? '네트워크 지연으로 요청이 취소되었습니다.' : err.message;
      alert('임시 저장 중 오류: ' + msg);
    }finally{
      hideLoading();
    }
  });

  /* ===== 버튼: 안내문(공유용 텍스트) ===== */
  document.getElementById('btnCopyText').addEventListener('click', async ()=>{
  showLoading('텍스트 준비 중…', '공유용 문장을 정리합니다', 400);
  try{
    const text = buildShareText();
    // 무조건 수동 복사 박스만 띄움 (카톡/크롬 동일 동작, URL 절대 포함 X)
    await safeDistribute({
      title: '',
      text,
      url: '',           // 주소 포함 금지
      pureText: true,    // Web Share 우회
      forceManual: true  // <<<< 핵심: 무조건 아래 복사 박스
    });
    // 별도 alert 불필요—복사 박스 자체가 안내 역할
  }finally{
    hideLoading();
  }
});

  /* ===== 제출(인사지원팀) ===== */
  async function submitToSheet(){
    showLoading('전송 중…', '인사지원팀 접수 기록을 저장합니다');
    try{
      const data = collect();
      if(!data.date){ alert('일자를 입력해주세요.'); return; }
      if(!(data.schedule||'').trim()){ alert('일정 요약을 입력해주세요.'); return; }
      if(!data.contact){ alert('문의처를 입력해주세요.'); return; }

      const payload = { ...data, submitted_at: new Date().toISOString(), mode:'append' };

      const res = await fetchWithTimeout(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
      }

      if(res.ok && (json.status==='ok' || json.result==='ok')){
        alert(`제출 완료! 접수번호: ${json.id||json.row||'확인됨'}`);
      }else{
        alert(`제출 실패: ${json.error||res.status}`);
      }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? '네트워크 지연으로 요청이 취소되었습니다.' : err.message;
      alert('제출 중 오류: ' + msg);
    }finally{
      hideLoading();
    }
  }
  document.getElementById('btnSubmit').addEventListener('click', submitToSheet);

  /* ===== 저장값 불러오기 ===== */
  async function loadByKey(k){
    showLoading('불러오는 중…', '임시 저장된 내용을 가져옵니다');
    try{
      const url = `${GAS_URL}?mode=load&key=${encodeURIComponent(k)}`;
      const res = await fetchWithTimeout(url);
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
      }
      if(json.status === 'ok' && json.data){
        const data = json.data;
        document.getElementById('team').value = data.team||'A';
        document.getElementById('title').value = data.title||'';
        document.getElementById('date').value = data.date||'';
        document.getElementById('schedule').value = data.schedule||'';
        document.getElementById('bus').value = data.bus || '';
        setBus(document.getElementById('bus').value || '');
        document.getElementById('place').value = data.place||'';
        document.getElementById('notes').value = data.notes||'';
        document.getElementById('contact').value = data.contact||'';
      }else{
        alert('임시 저장 불러오기 실패: ' + (json.error||'알 수 없음'));
      }
    } catch(err){
      const msg = (err && err.name === 'AbortError') ? '네트워크 지연으로 요청이 취소되었습니다.' : err.message;
      alert('불러오기 오류: ' + msg);
    } finally{
      hideLoading();
    }
  }

  /* ===== 오늘 이전 날짜 금지(선택) ===== */
  (function lockPastDate(){
    const el = document.getElementById('date');
    if(!el) return;
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    el.min = `${yyyy}-${mm}-${dd}`;
  })();

  /* ===== init ===== */
  (async function init(){
    const p = new URLSearchParams(location.search);
    const k = p.get('k');
    const code = p.get('code');

    if(k){
      try{ await loadByKey(k); }catch(_){}
    }else if(code){
      try{
        const parsed = JSON.parse(decodeURIComponent(escape(atob(code))));
        document.getElementById('team').value = parsed.team||'A';
        document.getElementById('title').value = parsed.title||'';
        document.getElementById('date').value = parsed.date||'';
        document.getElementById('schedule').value = parsed.schedule||'';
        document.getElementById('bus').value = parsed.bus || '';
        setBus(document.getElementById('bus').value || '');
        document.getElementById('place').value = parsed.place||'';
        document.getElementById('notes').value = parsed.notes||'';
        document.getElementById('contact').value = parsed.contact||'';
      }catch(_){}
    }else{
      document.getElementById('title').value = '야유회 안내';
    }

    updateBusBadgeVisibility();
  })();
  </script>
</body>
</html>
