<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•ˆë‚´ë¬¸ ì‘ì„±í¼</title>
  <style>
  /* === (ìƒëµ ì—†ì´ ë„ˆê°€ ì¤€ CSS ê·¸ëŒ€ë¡œ ìœ ì§€) === */
  /* ... ì „ë¶€ ë™ì¼ ... */
  /* ë„ˆê°€ ì¤€ <style> ë¸”ë¡ì„ ê·¸ëŒ€ë¡œ ë‘ì—ˆìŒ */
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="card no-print">
      <h2>ì•ˆë‚´ë¬¸ ì‘ì„±</h2>
      <div class="body">

        <!-- ì°¸ì—¬ ëŒ€ìƒ -->
        <div class="sec" data-kind="target">
          <div class="sec-title">ì°¸ì—¬ ëŒ€ìƒ</div>

          <div class="row">
            <label>
              ëŒ€ìƒ
              <span class="field-toggle-inline">
                <input id="showTeam" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <input id="team" type="hidden" value="">
              <div class="chip-group" id="teamChips" role="group" aria-label="ëŒ€ìƒ">
                <div class="chip" data-val="A">Aë°˜</div>
                <div class="chip" data-val="B">Bë°˜</div>
                <div class="chip" data-val="C">Cë°˜</div>
                <div class="chip" data-val="D">Dë°˜</div>
                <div class="chip" data-val="ê¸°íƒ€">ê¸°íƒ€</div>
                <input id="teamCustom" type="text" placeholder="ì§ì ‘ ì…ë ¥"
                       style="display:none; margin-left:6px; padding:6px 10px; border-radius:8px; border:1px solid #ccc;"/>
              </div>
              <small style="color:var(--muted)">ì—¬ëŸ¬ ë°˜ ì„ íƒ ê°€ëŠ¥</small>
            </div>
          </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="sec" data-kind="basic">
          <div class="sec-title">ê¸°ë³¸ ì •ë³´</div>

          <!-- ì œëª© -->
          <div class="row">
            <label for="title">
              ì œëª©
              <span class="field-toggle-inline">
                <input id="showTitle" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <input id="title" type="text" placeholder="ì˜ˆ) ì•¼ìœ íšŒ ì•ˆë‚´" />
            </div>
          </div>

          <div class="row">
            <label for="date">
              ì¼ì
              <span class="field-toggle-inline">
                <input id="showDate" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div><input id="date" type="date" /></div>
          </div>

          <div class="row">
            <label for="time">
              ì‹œê°„
              <span class="field-toggle-inline">
                <input id="showTime" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div><input id="time" type="time" /></div>
          </div>

          <div class="row">
            <label for="placeName">
              ì¥ì†Œ
              <span class="field-toggle-inline">
                <input id="showPlace" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <input id="placeName" type="text" placeholder="ì˜ˆ) OOì²´ìœ¡ë¬¸í™”ì„¼í„° 2ì²´ìœ¡ê´€, ì¤‘ì•™ê´‘ì¥, ì¡±êµ¬ì¥ ë“±" />
            </div>
          </div>

          <div class="row">
            <label for="place">
              ì£¼ì†Œ
              <span class="field-toggle-inline">
                <input id="showAddress" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í‘œì‹œ">
                <span class="toggle-label">í‘œì‹œ</span>
              </span>
            </label>
            <div>
              <div class="place-actions" style="display:flex; gap:8px; align-items:center;">
                <input id="place" type="text" placeholder="ì˜ˆ) ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬ ê³ ì”ë¡œ 00 (ë„ë¡œëª…/ì§€ë²ˆ ê°€ëŠ¥)" style="flex:1" />
                <button type="button" id="btnPickPlace"
                        title="ë„¤ì´ë²„ì—ì„œ ì£¼ì†Œ/ì§€ì ì„ ê²€ì¦í•´ ë§í¬ë¥¼ ë§Œë“¤ê³ , (ì£¼ì†Œ í‘œì‹œ ON + ì§€ë„ ì¤€ë¹„ ì‹œ) ì´ë¯¸ì§€ì— ì§€ë„ ì¸ë„¤ì¼ì„ ë„£ìŠµë‹ˆë‹¤">
                  ì¥ì†Œ ì°¾ê¸°(ê²€ì¦)
                </button>
              </div>

              <!-- hidden/ì§€ë„ ì¸ë„¤ì¼/ì„ íƒë°•ìŠ¤ -->
              <input id="placeUrl" type="hidden" value="" />
              <input id="placeAddr" type="hidden" value="" />
              <input id="placeTel"  type="hidden" value="" />
              <input id="placeLink" type="hidden" value="" />

              <div id="placeThumb" style="display:none; margin-top:6px">
                <img id="placeThumbImg" alt="ì§€ë„ ë¯¸ë¦¬ë³´ê¸°"
                     style="max-width:220px;border:1px solid var(--line);border-radius:8px">
              </div>

              <input id="placeLat" type="hidden" value="" />
              <input id="placeLng" type="hidden" value="" />
              <input id="placeMapImg" type="hidden" value="" />

              <div id="placePicked" class="place-picked" style="display:none; margin-top:6px; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff;"></div>

              <small style="color:var(--muted)">
                ì§€ì  ì„ íƒ â†’ ë§í¬ ìƒì„±. ë¬¸êµ¬ì—” ë§í¬ í¬í•¨, ì´ë¯¸ì§€ëŠ” <b>ì£¼ì†Œ í‘œì‹œ</b>+ì§€ë„ ì¤€ë¹„ ì‹œì—ë§Œ ì¸ë„¤ì¼ í¬í•¨.
              </small>
            </div>
          </div>
        </div>

        <!-- ì§€ë„ ìŠ¤íƒ€ì¼ -->
        <div class="row">
          <label>
            ì§€ë„ ìŠ¤íƒ€ì¼
            <small style="font-weight:700;color:#777;margin-left:6px;">(í•­ê³µì€ ë ˆì´ë¸” í¬í•¨)</small>
          </label>
          <div>
            <div id="mapTypeChips" class="chip-group" role="radiogroup" aria-label="ì§€ë„ ìŠ¤íƒ€ì¼">
              <div class="chip selected" data-type="basic"  role="radio" aria-checked="true"  tabindex="0">ê¸°ë³¸</div>
              <div class="chip"          data-type="hybrid" role="radio" aria-checked="false" tabindex="-1">í•­ê³µ(ë ˆì´ë¸”)</div>
            </div>
            <input id="mapType" type="hidden" value="basic" />
          </div>
        </div>

        <!-- ìš´ì˜ ì •ë³´ -->
        <div class="sec" data-kind="ops">
          <div class="sec-title">ìš´ì˜ ì •ë³´</div>

          <div class="row">
            <label for="schedule">
              ì¼ì •
              <span class="field-toggle-inline">
                <input id="showSchedule" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <textarea id="schedule" placeholder="ì˜ˆì‹œ)
- 09:00 ì§‘ê²° ë° í™œë™
- 12:30 ì ì‹¬ ì‹ì‚¬
- 15:00 ê·€ê°€"></textarea>
            </div>
          </div>

          <div class="row">
            <label for="bus">
              ë²„ìŠ¤
              <span class="field-toggle-inline">
                <input id="showBus" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <input id="bus" type="hidden" value="" />
              <div class="chip-group" id="busChips" role="radiogroup" aria-label="ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€">
                <div class="chip" role="radio" tabindex="0" aria-checked="false" data-val="O">O</div>
                <div class="chip" role="radio" tabindex="-1" aria-checked="false" data-val="X">X</div>
              </div>
              <small style="color:var(--muted)">ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€(O/X)ëŠ” ì œì¶œ ì‹œì—ëŠ” í•­ìƒ ì €ì¥ë©ë‹ˆë‹¤.</small>
            </div>
          </div>

          <div class="row">
            <label for="notes">
              íŠ¹ì´ì‚¬í•­
              <span class="field-toggle-inline">
                <input id="showNotes" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <div class="chip-group" id="notesPresets" role="group" aria-label="íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿"></div>
              <small style="color:var(--muted)">í´ë¦­ ì‹œ íŠ¹ì´ì‚¬í•­ì— ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤(ì¤‘ë³µ ë°©ì§€)</small>
              <textarea id="notes" placeholder="ì˜ˆ)
- í¸í•œ ë³µì¥ ë° ìš´ë™í™” ê¶Œì¥
- ê°œì¸ ë¬¼/ìš°ì˜ ë“± ì¤€ë¹„
- ì¼ë¶€ êµ¬ê°„ ë„ë³´ ì´ë™ ì˜ˆì •"></textarea>
            </div>
          </div>

          <div class="row">
            <label for="contact">
              ë¬¸ì˜ì²˜
              <span class="field-toggle-inline">
                <input id="showContact" type="checkbox" checked aria-label="ì•ˆë‚´ë¬¸ì— í¬í•¨">
                <span class="toggle-label">í¬í•¨</span>
              </span>
            </label>
            <div>
              <input id="contact" type="text" placeholder="ì˜ˆ) Aë°˜ í™ê¸¸ë™ (010-0000-0000)" />
            </div>
          </div>
        </div><!-- /.sec -->
      </div><!-- /.body -->
    </div><!-- /.card -->
  </div><!-- /.grid -->
</div><!-- /.wrap -->

<!-- TOOLBAR -->
<div class="toolbar no-print">
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <label style="font-weight:700;color:#243b6b;display:inline-flex;gap:6px;align-items:center;">
      ì´ë¯¸ì§€ í­
      <select id="exportWidth">
        <option value="auto" selected>ìë™(ë‚´ìš©ì— ë§ì¶¤)</option>
        <option value="1123">A4 ê°€ë¡œ(1123px)</option>
      </select>
    </label>
  </div>

  <div class="toolbar-actions">
    <button id="btnShare" title="í˜„ì¬ ì…ë ¥ì„ ì„œë²„ì— ì„ì‹œ ì €ì¥í•˜ê³  ë³µì›ìš© ë§í¬ë¥¼ ë§Œë“­ë‹ˆë‹¤">ì„ì‹œ ì €ì¥(ë§í¬ ìƒì„±)</button>

    <!-- ë‚´ë³´ë‚´ê¸° ìŠ¤í”Œë¦¿ -->
    <div class="split" id="exportSplit">
      <button id="btnExportMain"   class="btn-export-main"  title="ë°”ë¡œ ì¶œë ¥">ë‚´ë³´ë‚´ê¸°</button>
      <button id="btnExportToggle" class="btn-export-toggle" aria-haspopup="menu" aria-expanded="false" title="ë‚´ë³´ë‚´ê¸° ì˜µì…˜ ì—´ê¸°">â–¾</button>
      <div id="exportMenu" class="menu" role="menu" hidden>
        <button type="button" id="mnuCopyText" role="menuitem">ë¬¸êµ¬ ë³µì‚¬</button>
        <button type="button" id="mnuSavePNG" role="menuitem">ì´ë¯¸ì§€ ì €ì¥(PNG)</button>
        <button type="button" id="mnuPrint"   role="menuitem">ì¶œë ¥</button>
      </div>
    </div>
  </div>

  <button id="btnSubmit" title="ì¸ì‚¬ì§€ì›íŒ€ ì‹œíŠ¸ì— ì ‘ìˆ˜ ê¸°ë¡ì„ ë‚¨ê¹ë‹ˆë‹¤">ì¸ì‚¬ì§€ì›íŒ€ ì œì¶œ(ì ‘ìˆ˜)</button>
  <button id="btnReset"  title="ëª¨ë“  ì…ë ¥ì„ ì§€ìš°ê³  ì²˜ìŒ ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤">ì´ˆê¸°í™”</button>
</div>

<!-- ìŠ¤í¬ë¡¤ ë°°ì§€ -->
<div id="busBadge" aria-hidden="true">ë²„ìŠ¤: <span id="busBadgeVal">-</span></div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" role="status" aria-live="polite">
  <div class="spinner" aria-hidden="true"></div>
  <div class="loading-text" id="loadingText">ì§„í–‰ ì¤‘â€¦</div>
  <div class="loading-sub"  id="loadingSub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
</div>

<!-- ê³µìœ  í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="previewModal" hidden role="dialog" aria-modal="true" aria-labelledby="previewTitle">
  <div class="preview-card" role="document">
    <div class="preview-head"><h3 id="previewTitle">ì•ˆë‚´ë¬¸ ë¯¸ë¦¬ë³´ê¸°</h3></div>
    <textarea id="previewTa"></textarea>
    <div class="preview-hint">ë°°í¬ìš©ìœ¼ë¡œ ììœ  ìˆ˜ì • ê°€ëŠ¥í•˜ë‚˜, ì¸ì‚¬ì§€ì›íŒ€ ì œì¶œ ì‹œì—ëŠ” ì…ë ¥í•œ ì›ë³¸ ë‚´ìš©ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.</div>
    <div class="preview-actions">
      <span id="previewToast" class="preview-toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
      <button type="button" id="previewCopy">ë³µì‚¬í•˜ê¸°</button>
      <button type="button" id="previewClose2">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ì¥ì†Œ ì„ íƒ ëª¨ë‹¬ -->
<div id="placeModal" hidden role="dialog" aria-modal="true" aria-labelledby="placeTitle">
  <div class="place-card" role="document">
    <div class="place-head">
      <h3 id="placeTitle" style="margin:0">ì¥ì†Œ ì„ íƒ</h3>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="placeQuery" type="text" placeholder="ì§€ì ëª…/ì£¼ì†Œë¡œ ì¬ê²€ìƒ‰" style="width: min(360px, 60vw)">
        <button id="placeSearchBtn" type="button">ê²€ìƒ‰</button>
        <button id="placeCloseBtn"  type="button">ë‹«ê¸°</button>
      </div>
    </div>
    <div id="placeList" class="place-list"><div class="empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div></div>
  </div>
</div>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- íˆë“  Export DOM -->
<div id="exportDoc" style="position:absolute; left:-99999px; top:-99999px; width:794px; background:#fff;">
  <div id="exportInner" style="padding:28px 32px; font:14px/1.7 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic, Malgun Gothic, sans-serif; color:#222;"></div>
</div>

<script>
/* ======================= ê³µí†µ ìƒìˆ˜/ìœ í‹¸ ======================= */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwox-65FQnmcMX2SOrg_wh1FRQPbELk0Z-0hH1WCz_oM5BxuKryhndBHHVj1Z-jaIc6/exec';
function escapeHTML(s){ return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]) ); }
function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
function isUrl(s){ return /^https?:\/\//i.test((s||'').trim()); }
function mmToPx(mm){ return Math.round(mm * 3.7795275591); } // 96dpi
function weekdayKR(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr+'T00:00:00');
  const yo = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
  return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼(${yo})`;
}
async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), timeoutMs);
  try { return await fetch(url, {...opts, signal: controller.signal}); }
  finally { clearTimeout(timer); }
}

/* ======================= ë¡œë”© ì˜¤ë²„ë ˆì´ ======================= */
let loadingCount = 0, loadingTimer = null;
function setToolbarDisabled(disabled){
  document.querySelectorAll('.toolbar button').forEach(btn => btn.disabled = disabled);
  document.querySelectorAll('input, textarea').forEach(el => el.readOnly = disabled);
  document.querySelectorAll('select').forEach(el => el.disabled = disabled);
}
function showLoading(main='ì§„í–‰ ì¤‘â€¦', sub='ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”', minMs=500){
  loadingCount++;
  const ov = document.getElementById('loadingOverlay');
  document.getElementById('loadingText').textContent = main;
  document.getElementById('loadingSub').textContent  = sub;
  ov.style.display = 'flex';
  setToolbarDisabled(true);
  clearTimeout(loadingTimer);
  loadingTimer = setTimeout(()=>{ loadingTimer = null; }, minMs);
}
function hideLoading(){
  if (loadingCount > 0) loadingCount--;
  const finish = ()=>{
    if (loadingCount === 0){
      document.getElementById('loadingOverlay').style.display = 'none';
      setToolbarDisabled(false);
    }
  };
  if (loadingTimer){ setTimeout(()=>finish(), 120); loadingTimer = null; }
  else { finish(); }
}

/* ======================= íŒ€(ëŒ€ìƒ) ======================= */
function parseTeams(str){ return (str || '').split(',').map(s => s.trim()).filter(Boolean); }
function teamsToString(arr){ return Array.from(new Set(arr)).join(','); }
function getTeamsArray(){ return parseTeams(document.getElementById('team').value); }
function setTeamHiddenFromArray(arr){ document.getElementById('team').value = teamsToString(arr); }
function hasAnyCustomTeam(){ return getTeamsArray().some(v => v==='ê¸°íƒ€' || v.startsWith('ê¸°íƒ€:')); }
function formatTarget(teamStr){
  const arr = (teamStr || '').split(',').map(s => s.trim()).filter(Boolean);
  if (!arr.length) return '';
  const mapped = arr.map(v => (/^ê¸°íƒ€:/.test(v) ? v.replace(/^ê¸°íƒ€:/,'') : (/^[A-D]$/i.test(v) ? v+'ë°˜' : v)));
  return Array.from(new Set(mapped)).join(', ');
}
function renderTeamChips(){
  const arr = getTeamsArray();
  document.querySelectorAll('#teamChips .chip').forEach(chip=>{
    const val = chip.dataset.val;
    chip.classList.toggle('selected', val==='ê¸°íƒ€' ? hasAnyCustomTeam() : arr.includes(val));
  });
}
function toggleTeam(val){
  const arr = getTeamsArray();
  const i = arr.indexOf(val);
  if (i >= 0) arr.splice(i,1); else arr.push(val);
  setTeamHiddenFromArray(arr); renderTeamChips();
}
(function bindTeamChips(){
  const g = document.getElementById('teamChips'); if(!g) return;
  g.addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    if (chip.dataset.val === 'ê¸°íƒ€') return;
    toggleTeam(chip.dataset.val);
  });
})();
function removeAllCustomTeamFromArray(arr){ return (arr||[]).filter(v => v!=='ê¸°íƒ€' && !v.startsWith('ê¸°íƒ€:')); }
function restoreCustomTeamFromTeamValue(){
  const arr = getTeamsArray(); const custom = arr.find(v => v.startsWith('ê¸°íƒ€:'));
  const input = document.getElementById('teamCustom'); if (!input) return;
  if (custom){ input.style.display='inline-block'; input.value = custom.split(':').slice(1).join(':'); }
  else { input.style.display='none'; input.value=''; }
  renderTeamChips();
}
(function bindCustomTeam(){
  const chips = document.getElementById('teamChips'); const customInput = document.getElementById('teamCustom');
  if(!chips || !customInput) return;
  chips.addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    if(chip.dataset.val === 'ê¸°íƒ€'){
      const opening = (customInput.style.display === 'none' || customInput.style.display === '');
      if(opening){ customInput.style.display='inline-block'; customInput.focus(); }
      else{
        const arr = removeAllCustomTeamFromArray(getTeamsArray());
        setTeamHiddenFromArray(arr); customInput.value=''; customInput.style.display='none'; renderTeamChips();
      }
    }
  });
  customInput.addEventListener('input', ()=>{
    const val = customInput.value.trim();
    let arr = removeAllCustomTeamFromArray(getTeamsArray());
    if(val){ arr.push('ê¸°íƒ€:'+val); }
    setTeamHiddenFromArray(arr); renderTeamChips();
  });
})();
(function bindTeamChipsA11y(){
  const g = document.getElementById('teamChips'); if(!g) return;
  g.querySelectorAll('.chip[data-val]:not([data-val="ê¸°íƒ€"])').forEach(chip=>{ chip.tabIndex=0; chip.setAttribute('role','button'); });
  g.addEventListener('keydown', e=>{
    if (e.key!=='Enter' && e.key!==' ') return;
    const chip = e.target.closest('.chip'); if(!chip || chip.dataset.val==='ê¸°íƒ€') return;
    e.preventDefault(); toggleTeam(chip.dataset.val);
  });
})();

/* ======================= ì¥ì†Œ/ì§€ë„ ë§í¬ & ì¸ë„¤ì¼ ======================= */
function isNaverPlaceUrl(u){
  try{
    const url = new URL(u);
    const host = url.hostname;
    const path = url.pathname || '';
    if (/naver\.me$/.test(host)) return true;
    if (!/(^|\.)naver\.com$/.test(host)) return false;
    return /^(\/v5|\/p\/entry|\/entry\/place|\/map|\/place)/.test(path);
  }catch(_){ return false; }
}
function buildNaverSearchLink(rawName, rawAddr=''){
  const name = (rawName||'').trim();
  const addr = (rawAddr||'').trim()
    .replace(/\s+\d.*$/, '')
    .replace(/ëŒ€í•œë²•ì¡°|ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°|ìƒê°€|ì•„íŒŒíŠ¸|ì˜¤í”¼ìŠ¤í…”|Mall|ëª°/gi, '')
    .trim();
  const q = name || addr || '';
  return 'https://map.naver.com/p/search/' + encodeURIComponent(q);
}
function resolveNaverLink(item){
  const link = item.link || item.url || '';
  try{
    const u = new URL(link);
    const host = u.hostname;
    const path = u.pathname || '';
    if (/naver\.me$/.test(host) || (/(^|\.)naver\.com$/.test(host) && /^(\/v5|\/place|\/p\/entry|\/entry\/place|\/map)/.test(path))) {
      return link;
    }
  }catch(_){}
  return buildNaverSearchLink(item.title || '', item.roadAddress || item.address || '');
}
function setPickedPlaceLink(url, label){
  const box = document.getElementById('placePicked');
  const hidden = document.getElementById('placeUrl');
  hidden.value = url || '';
  if(url){
    box.innerHTML = `ì„ íƒëœ ì§€ë„ ë§í¬: <a href="${url}" target="_blank" rel="noopener">${label||'ì—´ê¸°'}</a>`;
    box.style.display = 'block';
  }else{
    box.innerHTML = ''; box.style.display = 'none';
  }
}
function setSelectedPlace(item){
  const name = (item.title || item.name || '').trim();
  const addr = (
    item.roadAddress || item.road_address ||
    item.address     || item.jibunAddress || item.jibun_address || ''
  ).trim();
  const tel  = (item.telephone || item.tel || '').trim();
  const link = resolveNaverLink(item);

  document.getElementById('placeName').value = name;
  document.getElementById('place').value     = addr;

  document.getElementById('placeAddr').value = addr;
  document.getElementById('placeTel').value  = tel;
  document.getElementById('placeLink').value = link;
}

/* ì§€ë„ íƒ€ì… ì„ íƒ */
function getMapType(){
  const hid = document.getElementById('mapType')?.value;
  return (hid || localStorage.getItem('mapType') || 'basic') === 'hybrid' ? 'hybrid' : 'basic';
}
function setMapType(type, {silent=false} = {}){
  const val = (type === 'hybrid') ? 'hybrid' : 'basic';
  const hid = document.getElementById('mapType');
  if (hid) hid.value = val;
  localStorage.setItem('mapType', val);
  renderMapTypeChips();
  if (!silent){
    const lat = document.getElementById('placeLat')?.value;
    const lng = document.getElementById('placeLng')?.value;
    if (lat && lng) regenMapThumbDebounced();
  }
}
function renderMapTypeChips(){
  const box = document.getElementById('mapTypeChips');
  if (!box) return;
  const cur = getMapType();
  box.querySelectorAll('.chip').forEach(c=>{
    const t = c.getAttribute('data-type');
    const sel = (t === cur);
    c.classList.toggle('selected', sel);
    c.setAttribute('aria-checked', String(sel));
    c.tabIndex = sel ? 0 : -1;
  });
}
(function bindMapTypeChips(){
  const box = document.getElementById('mapTypeChips'); if (!box) return;
  const initial = localStorage.getItem('mapType') || 'basic';
  setMapType(initial, {silent:true});
  box.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if (!chip) return;
    setMapType(chip.getAttribute('data-type') === 'hybrid' ? 'hybrid' : 'basic');
  });
  box.addEventListener('keydown', (e)=>{
    if (e.key !== ' ' && e.key !== 'Enter') return;
    const chip = e.target.closest('.chip'); if (!chip) return;
    e.preventDefault();
    setMapType(chip.getAttribute('data-type') === 'hybrid' ? 'hybrid' : 'basic');
  });
  renderMapTypeChips();
})();

/* ì •ì ì§€ë„ ì¸ë„¤ì¼ */
async function buildMapThumbByLatLng(lat, lng, type = getMapType()){
  const tryOnce = async (t) => {
    const url = `${GAS_URL}?mode=static_map&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&w=440&h=300&level=19&type=${t}`;
    const res = await fetchWithTimeout(url);
    let json; try { json = await res.json(); } catch { return null; }
    if (res.ok && json && json.status === 'ok' && json.dataUrl) return json.dataUrl;
    return null;
  };
  if (type === 'hybrid'){
    const h = await tryOnce('hybrid'); if (h) return h;
    const b = await tryOnce('basic');  if (b) return b;
    return '';
  } else {
    const b = await tryOnce('basic');  if (b) return b;
    return '';
  }
}
const regenMapThumbDebounced = (() => {
  let t = null;
  return () => {
    clearTimeout(t);
    t = setTimeout(async () => {
      const lat = document.getElementById('placeLat')?.value;
      const lng = document.getElementById('placeLng')?.value;
      if (!lat || !lng) return;
      const dataUrl = await buildMapThumbByLatLng(lat, lng, getMapType());
      if (dataUrl){
        document.getElementById('placeMapImg').value = dataUrl;
        setMapPreview(dataUrl);
      }
    }, 150);
  };
})();

/* ì§€ì˜¤ì½”ë”© */
async function geocodeToLatLng(name, road, jibun){
  const q = (road || jibun || name || '').trim();
  if (!q) return null;
  try{
    const url = `${GAS_URL}?mode=geocode&q=${encodeURIComponent(q)}`;
    const res = await fetchWithTimeout(url);
    const json = await res.json();
    if (!res.ok || json.status !== 'ok' || !json.found) return null;
    return { lat: json.lat, lng: json.lng };
  }catch(e){
    console.warn('Geocode error:', e);
    return null;
  }
}
function setMapPreview(dataUrl){
  const img = document.getElementById('placeThumbImg');
  const box = document.getElementById('placeThumb');
  if (dataUrl){
    img.src = dataUrl;
    box.style.display = 'block';
  } else {
    img.removeAttribute('src');
    box.style.display = 'none';
  }
}
async function waitForImagesLoaded(root){
  const imgs = Array.from(root.querySelectorAll('img'));
  const pendings = imgs.filter(img => !img.complete || img.naturalWidth === 0);
  if (!pendings.length) return;
  await Promise.all(pendings.map(img => new Promise(res => {
    img.addEventListener('load',  res, { once:true });
    img.addEventListener('error', res, { once:true });
  })));
}

/* ì£¼ì†Œ ì§ì… ì§„ì… */
function looksLikeKrAddress(s=''){
  s = (s||'').trim();
  return /\d/.test(s) && /(ë¡œ|ê¸¸|ë²ˆê¸¸|ë™|ì|ë©´|ë¦¬|ë¡œ\d+ë²ˆê¸¸)/.test(s);
}
async function useAddressDirect(addrStr){
  const addr = (addrStr||'').trim();
  if(!addr) return;
  showLoading('ì£¼ì†Œ í™•ì¸ ì¤‘â€¦','ì§€ë„ ì¢Œí‘œë¥¼ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤');
  try{
    const geo = await geocodeToLatLng('', addr, '');
    if(!geo){
      alert('ì´ ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì² ì/í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      return;
    }
    document.getElementById('placeAddr').value = addr;
    document.getElementById('placeLat').value  = geo.lat;
    document.getElementById('placeLng').value  = geo.lng;

    const dataUrl = await buildMapThumbByLatLng(geo.lat, geo.lng, getMapType());
    document.getElementById('placeMapImg').value = dataUrl || '';
    setMapPreview(dataUrl || '');

    const searchLink = buildNaverSearchLink('', addr);
    document.getElementById('placeLink').value = searchLink;
    setPickedPlaceLink(searchLink, 'ë„¤ì´ë²„ ì§€ë„');

    // ì¥ì†Œëª…ì´ ë¹„ì–´ìˆìœ¼ë©´ ì£¼ì†Œë¡œ ìœ ì¶”
    const nameEl = document.getElementById('placeName');
    if (!nameEl.value.trim()) {
      nameEl.value = derivePlaceTitleFromAddress(addr);
    }
  } finally{
    hideLoading();
  }
}

/* ì¥ì†Œ ì°¾ê¸°(ëª¨ë‹¬) */
const placeModal = {
  el: null, listEl: null, queryEl: null,
  open(initQ=''){
    if(!this.el){
      this.el = document.getElementById('placeModal');
      this.listEl = document.getElementById('placeList');
      this.queryEl = document.getElementById('placeQuery');
      document.getElementById('placeCloseBtn').addEventListener('click', ()=> this.close());
      document.getElementById('placeSearchBtn').addEventListener('click', ()=> this.search());
      this.queryEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') this.search(); });
      this.el.addEventListener('click', (e)=>{ if(e.target===this.el) this.close(); });
    }
    this.queryEl.value = (initQ||'').trim();
    this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ ì¤‘â€¦</div>';
    this.el.hidden = false;
    this.search();
  },
  close(){ if(this.el) this.el.hidden = true; },
  async search(){
    const q = (this.queryEl.value||'').trim();
    if(!q){ this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>'; return; }
    try{
      const url = `${GAS_URL}?mode=naver_local&query=${encodeURIComponent(q)}`;
      const res = await fetchWithTimeout(url);
      const json = await res.json();
      if(!res.ok) throw new Error(json && json.error || ('HTTP '+res.status));
      const rows = Array.isArray(json.items||json.results||json) ? (json.items||json.results||json) : [];
      if(!rows.length){ this.listEl.innerHTML = '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      const mapRow = (r) => ({
        name: r.name || r.title || r.place_name || '',
        road: r.roadAddress || r.road_address || r.road || '',
        jibun: r.jibunAddress || r.jibun_address || r.address || '',
        tel : r.telephone || r.tel || '',
        url : r.mapUrl || r.link || r.url || '',
        mapx: r.mapx || r.x || r.lng || '',
        mapy: r.mapy || r.y || r.lat || ''
      });

      this.listEl.innerHTML = rows.map(r=>{
        const x = mapRow(r);
        const addr = (x.road || x.jibun || '').trim() || (x.name || '');
        return `<div class="place-item"
                  data-url="${encodeURIComponent(x.url)}"
                  data-name="${encodeURIComponent(x.name)}"
                  data-addr="${encodeURIComponent(addr)}"
                  data-tel="${encodeURIComponent(x.tel)}"
                  data-link="${encodeURIComponent(x.url)}"
                  data-x="${encodeURIComponent(x.mapx)}"
                  data-y="${encodeURIComponent(x.mapy)}">
                <b>${escapeHTML(x.name)}</b>
                <small>${escapeHTML(addr)}</small>
              </div>`;
      }).join('');

      // í›„ë³´ í´ë¦­ í•¸ë“¤ëŸ¬
      this.listEl.querySelectorAll('.place-item').forEach(el=>{
        el.addEventListener('click', async ()=>{
          const name = decodeURIComponent(el.getAttribute('data-name')||'');
          const addr = decodeURIComponent(el.getAttribute('data-addr')||'');
          const tel  = decodeURIComponent(el.getAttribute('data-tel')||'');
          const raw  = decodeURIComponent(el.getAttribute('data-link')||'');
          const mapx = decodeURIComponent(el.getAttribute('data-x')||'');
          const mapy = decodeURIComponent(el.getAttribute('data-y')||'');

          const finalUrl = resolveNaverLink({
            title: name, roadAddress: addr, address: addr, telephone: tel, link: raw, mapx, mapy
          });

          setSelectedPlace({
            title: name, roadAddress: addr, address: addr,
            telephone: tel, link: finalUrl, mapx, mapy
          });
          setPickedPlaceLink(finalUrl, name || 'ì§€ë„ì—´ê¸°');

          // ì¢Œí‘œ í™•ë³´ â†’ ì¸ë„¤ì¼ ìƒì„±
          try{
            // 1) ì§€ì˜¤ì½”ë”© ìš°ì„ 
            let geo = await geocodeToLatLng(name, addr, '');
            // 2) ë¡œì»¬ API ì¢Œí‘œê°€ ìœ„ê²½ë„ ë²”ìœ„ë©´ ë³´ì • ì‚¬ìš©
            if ((!geo || !geo.lat || !geo.lng) && mapx && mapy){
              const fx = parseFloat(mapx), fy = parseFloat(mapy);
              if (isFinite(fx) && isFinite(fy) && fy>=30 && fy<=40 && fx>=124 && fx<=132) geo = {lat: fy, lng: fx};
              else if (isFinite(fx) && isFinite(fy) && fx>=30 && fx<=40 && fy>=124 && fy<=132) geo = {lat: fx, lng: fy};
            }
            if (!geo) throw new Error('ì¢Œí‘œ ì¶”ì¶œ ì‹¤íŒ¨');

            document.getElementById('placeLat').value = geo.lat;
            document.getElementById('placeLng').value = geo.lng;

            const dataUrl = await buildMapThumbByLatLng(geo.lat, geo.lng, getMapType());
            if (dataUrl){
              document.getElementById('placeMapImg').value = dataUrl;
              setMapPreview(dataUrl);
            }else{
              throw new Error('ì •ì ì§€ë„ ìƒì„± ì‹¤íŒ¨');
            }
            placeModal.close();
          }catch(e){
            alert('ì§€ë„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : ' + (e?.message || 'ì•Œ ìˆ˜ ì—†ìŒ') + '\n\nâ€¢ ì£¼ì†Œë¥¼ ë„ë¡œëª…ìœ¼ë¡œ ë°”ê¿” ì¬ê²€ìƒ‰í•´ ë³´ì„¸ìš”.\nâ€¢ ê´€ë¦¬ì ì½˜ì†”ì—ì„œ NCP API í‚¤/ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            placeModal.close();
          }
        });
      });
    }catch(err){
      console.error(err);
      this.listEl.innerHTML = `<div class="empty">ê²€ìƒ‰ ì˜¤ë¥˜: ${escapeHTML(err.message||'ì•Œ ìˆ˜ ì—†ìŒ')}</div>`;
    }
  }
};

document.getElementById('btnPickPlace').addEventListener('click', async ()=>{
  const seed = (document.getElementById('place').value || '').trim();

  // â‘  ë„¤ì´ë²„ ì§€ë„/í”Œë ˆì´ìŠ¤ URL ì§ì ‘ ì…ë ¥
  if (isUrl(seed) && isNaverPlaceUrl(seed)) {
    document.getElementById('placeLink').value = seed;
    setPickedPlaceLink(seed, 'ë„¤ì´ë²„ ì§€ë„');

    const nameGuess = (document.getElementById('placeName').value || '').trim();
    const addrGuess = (document.getElementById('place').value || '').trim();
    const q = looksLikeKrAddress(addrGuess) ? addrGuess : nameGuess;
    if (q) { await useAddressDirect(q); }
    return;
  }

  // â‘¡ ì£¼ì†Œì²˜ëŸ¼ ë³´ì´ë©´ ì§€ì˜¤ì½”ë”©
  if (looksLikeKrAddress(seed)) {
    await useAddressDirect(seed);
    return;
  }

  // â‘¢ ê·¸ ì™¸(ìƒí˜¸ëª… ë“±) â†’ í›„ë³´ ê²€ìƒ‰
  placeModal.open(seed);
});

// ì¥ì†Œ í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ë§í¬/ì¢Œí‘œ/ì¸ë„¤ì¼ ì´ˆê¸°í™”
document.getElementById('place').addEventListener('input', ()=>{
  setPickedPlaceLink('', '');
  document.getElementById('placeLat').value = '';
  document.getElementById('placeLng').value = '';
  document.getElementById('placeMapImg').value = '';
  setMapPreview('');
});

/* ======================= íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿ ======================= */
const NOTES_PRESETS = [
  '- í¸í•œ ë³µì¥, ë¬¼Â·ìš°ì˜ ì¤€ë¹„í•´ ì£¼ì„¸ìš”.',
  '- ë²„ìŠ¤ ëŒ€ì ˆ, ì¡°ê¸ˆ ì—¬ìœ  ìˆê²Œ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
  '- ìì°¨Â·ëŒ€ì¤‘êµí†µìœ¼ë¡œ ê°œë³„ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
  '- ìì°¨ëŠ” ê³µì˜Â·ë…¸ìƒ ì£¼ì°¨ì¥ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.',
  '- ì¥ì†Œë³„ ë‚´ë¶€ ì£¼ì°¨ì¥ ë§ˆë ¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
];
function getNotesLines(){
  const raw = (document.getElementById('notes').value || '')
    .split('\n').map(s => s.trim()).filter(Boolean);
  return raw;
}
function setNotesLines(lines){
  const ta = document.getElementById('notes');
  ta.value = (lines || []).join('\n');
  syncNotesPresetSelection();
}
function toggleNotePreset(text){
  const lines = getNotesLines();
  const i = lines.indexOf(text);
  if (i >= 0) lines.splice(i, 1);
  else lines.push(text);
  setNotesLines(lines);
}
function renderNotesPresets(){
  const box = document.getElementById('notesPresets'); if (!box) return;
  box.innerHTML = '';
  NOTES_PRESETS.forEach(txt => {
    const chip = document.createElement('div');
    chip.className = 'chip'; chip.textContent = txt; chip.tabIndex = 0;
    chip.setAttribute('role','button'); chip.setAttribute('data-text', txt);
    box.appendChild(chip);
  });
  box.addEventListener('click', e => {
    const c = e.target.closest('.chip'); if (!c) return;
    toggleNotePreset(c.getAttribute('data-text'));
  });
  box.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      const c = e.target.closest('.chip'); if (!c) return;
      e.preventDefault(); toggleNotePreset(c.getAttribute('data-text'));
    }
  });
  syncNotesPresetSelection();
}
function syncNotesPresetSelection(){
  const selected = new Set(getNotesLines());
  document.querySelectorAll('#notesPresets .chip').forEach(chip => {
    const t = chip.getAttribute('data-text');
    chip.classList.toggle('selected', selected.has(t));
  });
}
(function bindNotesInputSync(){
  const ta = document.getElementById('notes'); if (!ta) return;
  ta.addEventListener('input', () => { syncNotesPresetSelection(); });
})();
renderNotesPresets();

/* ======================= ë²„ìŠ¤ ì¹© + ë°°ì§€ ======================= */
function setBus(val){
  const hidden = document.getElementById('bus');
  const chips = document.querySelectorAll('#busChips .chip');
  hidden.value = val || '';
  chips.forEach(c => c.classList.toggle('selected', c.getAttribute('data-val') === val));
  document.getElementById('busBadgeVal').textContent = hidden.value || '-';
  updateBusBadgeVisibility();
}
const showAfter = 200;
function updateBusBadgeVisibility(){
  const badge = document.getElementById('busBadge');
  const v = document.getElementById('bus').value || '';
  const showBus = document.getElementById('showBus')?.checked ?? true;
  if(window.scrollY > showAfter && v && showBus){
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}
window.addEventListener('scroll', updateBusBadgeVisibility, {passive:true});
window.addEventListener('resize', updateBusBadgeVisibility);
(function bindBusChips(){
  const g = document.getElementById('busChips'); if(!g) return;
  g.addEventListener('click', (e)=>{
    const target = e.target.closest('.chip'); if(!target) return;
    setBus(target.getAttribute('data-val'));
  });
})();
(function bindBusChipsA11y(){
  const g = document.getElementById('busChips'); if(!g) return;
  g.querySelectorAll('.chip').forEach(chip=>{ chip.tabIndex=0; chip.setAttribute('role','radio'); });
  g.addEventListener('keydown', e=>{
    if (e.key!=='Enter' && e.key!==' ') return;
    const chip = e.target.closest('.chip'); if(!chip) return;
    e.preventDefault(); setBus(chip.getAttribute('data-val'));
  });
})();

/* ======================= í‘œì‹œ í† ê¸€ ë¼ë²¨ ======================= */
const TOGGLE_IDS = [
 'showTeam','showTitle','showDate','showTime',
 'showPlace','showSchedule','showBus','showNotes','showContact','showAddress'
];
function refreshToggleLabels(){
  TOGGLE_IDS.forEach(id=>{
    const cb = document.getElementById(id);
    if(!cb) return;
    const labelEl = cb.parentElement?.querySelector?.('.toggle-label');
    if(!labelEl) return;
    const on = !!cb.checked;
    labelEl.textContent = on ? 'í‘œì‹œ' : 'ìˆ¨ê¹€';
    labelEl.classList.toggle('off', !on);
    labelEl.setAttribute('role', 'switch');
    labelEl.setAttribute('aria-checked', String(on));
    labelEl.title = 'ë¬¸êµ¬ ë³µì‚¬/ì´ë¯¸ì§€ ì €ì¥ ì‹œ ' + (on ? 'í‘œì‹œë©ë‹ˆë‹¤' : 'í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
    cb.setAttribute('aria-label', on ? 'ì•ˆë‚´ë¬¸ì— í‘œì‹œ' : 'ì•ˆë‚´ë¬¸ì—ì„œ ìˆ¨ê¹€');
    if (id === 'showBus') updateBusBadgeVisibility();
  });
}
(function bindToggleLabelClicks(){
  document.querySelectorAll('.field-toggle-inline').forEach(box=>{
    const cb = box.querySelector('input[type="checkbox"]');
    const tl = box.querySelector('.toggle-label');
    if(!cb || !tl) return;
    tl.tabIndex = 0;
    const flip = (e)=>{
      e.preventDefault(); e.stopPropagation();
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change', { bubbles:true }));
      refreshToggleLabels();
    };
    tl.addEventListener('click', flip);
    tl.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter') flip(e); });
  });
})();
TOGGLE_IDS.forEach(id=>{ document.getElementById(id)?.addEventListener('change', refreshToggleLabels); });
refreshToggleLabels();

/* ======================= ê³µìœ /ìˆ˜ì§‘ ======================= */
function getValue(id){ return document.getElementById(id)?.value || ''; }
function isOn(id){ const el = document.getElementById(id); return (el ? !!el.checked : true); }

function collect(){
  return {
    team: getValue('team'),
    title: getValue('title'),
    date: getValue('date'),
    time: getValue('time'),
    schedule: getValue('schedule'),
    bus: getValue('bus'),
    mapType: getMapType(),

    placeName: getValue('placeName'),
    place: getValue('place'),

    placeAddr: getValue('placeAddr'),
    placeTel:  getValue('placeTel'),
    placeLink: getValue('placeLink'),
    placeUrl:  getValue('placeUrl'),
    placeLat:  getValue('placeLat'),
    placeLng:  getValue('placeLng'),
    placeMapImg: getValue('placeMapImg'),

    notes: getValue('notes'),
    contact: getValue('contact'),

    showTeam: isOn('showTeam'),
    showTitle: isOn('showTitle'),
    showDate: isOn('showDate'),
    showTime: isOn('showTime'),
    showPlace: isOn('showPlace'),
    showAddress: isOn('showAddress'),
    showSchedule: isOn('showSchedule'),
    showBus: isOn('showBus'),
    showNotes: isOn('showNotes'),
    showContact: isOn('showContact'),
  };
}
function collectForShare(){
  const d = collect();
  d.placeMapImg = ''; // ì„ì‹œì €ì¥ ì „ì—ëŠ” ë¹„ì›€
  return d;
}
function makeShareTitle(d){
  const target = formatTarget(d.team);
  const dateTxt = d.date ? weekdayKR(d.date) : '';
  const rawTitle = (d.title || '').trim();
  if (rawTitle) return rawTitle;
  return [dateTxt, target, 'ì•¼ìœ íšŒ'].filter(Boolean).join(' ');
}
function buildShareText(){
  const d = collect();
  const dateStr = d.date ? weekdayKR(d.date) : '-';
  const timeStr = (d.time || '').trim();
  const blocks = [];

  if (d.showTitle) blocks.push(makeShareTitle(d) || 'ì•ˆë‚´ë¬¸');
  if (d.showTeam){
    const target = formatTarget(d.team);
    if (target) blocks.push(`ğŸ¯ [ëŒ€ìƒ] ${target}`);
  }
  if (d.showDate) blocks.push(`ğŸ“… [ì¼ì] ${dateStr}`);
  if (d.showTime && timeStr) blocks.push(`â° [ì‹œê°„] ${timeStr}`);

  if (d.showPlace){
    const placeName = (d.placeName || '').trim();
    if (placeName) blocks.push(`ğŸ“ [ì¥ì†Œ] ${placeName}`);
    if ((d.placeLink || '').trim()) blocks.push(`ğŸ”— (ë„¤ì´ë²„) ${d.placeLink.trim()}`);
    if ((d.placeTel  || '').trim()) blocks.push(`â˜ï¸ (ì „í™”) ${d.placeTel.trim()}`);
  }
  const addrLine = (d.place || d.placeAddr || '').trim();
  if (d.showAddress && addrLine) blocks.push(`ğŸ  [ì£¼ì†Œ] ${addrLine}`);

  if (d.showSchedule){
    const schedule = (d.schedule || '').split('\n').filter(Boolean);
    blocks.push(['ğŸ“ [ì¼ì • ìš”ì•½]', ...(schedule.length ? schedule : ['-'])].join('\n'));
  }
  if (d.showBus && (d.bus || '').trim()){
    blocks.push(`ğŸšŒ [ë²„ìŠ¤ ëŒ€ì ˆ] ${d.bus.trim()}`);
  }
  if (d.showNotes && (d.notes || '').trim()){
    const notes = d.notes.split('\n').filter(Boolean);
    blocks.push(['âš ï¸ [íŠ¹ì´ì‚¬í•­]', ...notes].join('\n'));
  }
  if (d.showContact){
    blocks.push(`ğŸ“ [ë¬¸ì˜ì²˜] ${d.contact || '-'}`);
  }
  return blocks.filter(Boolean).join('\n\n');
}

/* ======================= ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬(ë¬¸êµ¬ ë³µì‚¬) ======================= */
(function setupPreviewModal(){
  const modal = document.getElementById('previewModal');
  const ta = document.getElementById('previewTa');
  const btnClose2 = document.getElementById('previewClose2');
  const btnCopy = document.getElementById('previewCopy');
  const toast = document.getElementById('previewToast');

  function openPreviewModal(text){
    if (!modal || !ta) return;
    ta.value = text || '';
    ta.style.height = 'auto';
    ta.style.height = Math.max(220, Math.min(420, ta.scrollHeight)) + 'px';
    toast?.classList.remove('show');
    modal.hidden = false;
    setTimeout(()=>{ ta.focus(); ta.select(); }, 0);
    document.addEventListener('keydown', onEsc, { once: true });
    modal.addEventListener('click', onBackdropClick);
  }
  function closePreviewModal(){ if (!modal) return; modal.hidden = true; modal.removeEventListener('click', onBackdropClick); }
  function onBackdropClick(e){ if (e.target === modal) closePreviewModal(); }
  function onEsc(e){ if (e.key === 'Escape') closePreviewModal(); }
  async function copyPreviewText(){
    const text = ta.value || '';
    if (navigator.clipboard && navigator.clipboard.writeText){ try{ await navigator.clipboard.writeText(text); showToast(); return; } catch(_){} }
    try{ ta.select(); const ok = document.execCommand('copy'); if (ok) { showToast(); return; } }catch(_){}
    alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
  }
  function showToast(){ if (!toast) return; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 3000); }
  window.openPreviewModal = openPreviewModal;
  window.closePreviewModal = closePreviewModal;
  btnCopy?.addEventListener('click', copyPreviewText);
  btnClose2?.addEventListener('click', closePreviewModal);
})();

/* ======================= ë‚´ë³´ë‚´ê¸°(ìŠ¤í”Œë¦¿) ======================= */
(function setupExportSplit(){
  const main   = document.getElementById('btnExportMain');
  const toggle = document.getElementById('btnExportToggle');
  const menu   = document.getElementById('exportMenu');
  const split  = document.getElementById('exportSplit');
  if(!main || !toggle || !menu || !split) return;

  let lastAction = localStorage.getItem('exportAction') || 'print';
  const idMap    = { text:'mnuCopyText', png:'mnuSavePNG', print:'mnuPrint' };

  function openMenu(){ menu.hidden = false; toggle.setAttribute('aria-expanded','true'); }
  function closeMenu(){ menu.hidden = true;  toggle.setAttribute('aria-expanded','false'); }

  function applySelectionUI(){
    [...menu.querySelectorAll('[role="menuitem"]')].forEach(btn=>{
      const isSel = btn.id === idMap[lastAction];
      btn.setAttribute('aria-checked', String(isSel));
      btn.classList.toggle('selected', isSel);
    });
    const labelMap = { text:'ë¬¸êµ¬ ë³µì‚¬', png:'ì´ë¯¸ì§€ ì €ì¥(PNG)', print:'ì¶œë ¥' };
    main.title = `${labelMap[lastAction]} ì‹¤í–‰`;
    main.textContent = `ë‚´ë³´ë‚´ê¸° (${labelMap[lastAction]})`;
    toggle.textContent = 'ì˜µì…˜ â–¾';
  }

  menu.addEventListener('click', e=>{
    const btn = e.target.closest('[role="menuitem"]'); if(!btn) return;
    if (btn.id === 'mnuCopyText')      lastAction = 'text';
    else if (btn.id === 'mnuSavePNG')  lastAction = 'png';
    else                               lastAction = 'print';
    localStorage.setItem('exportAction', lastAction);
    applySelectionUI();
    closeMenu();
  });

  main.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (lastAction === 'text'){
      showLoading('í…ìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘â€¦','ê³µìœ ìš© ë¬¸ì¥ì„ ì •ë¦¬í•©ë‹ˆë‹¤',300);
      try { openPreviewModal(buildShareText()); }
      finally { hideLoading(); }
    } else if (lastAction === 'png'){
      await exportAsImage();
    } else {
      await printExport();
    }
  });

  toggle.addEventListener('click', (e)=>{ e.stopPropagation(); menu.hidden ? openMenu() : closeMenu(); });
  document.addEventListener('click',  (e)=>{ if(!menu.hidden && !split.contains(e.target)) closeMenu(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

  applySelectionUI();
})();

/* ======================= Export/Print êµ¬í˜„ ======================= */
function buildExportHTML(){
  const d = collect();
  const dateStr  = d.date ? weekdayKR(d.date) : '-';
  const timeStr  = (d.time || '').trim();
  const teamLine = formatTarget(d.team);
  const scheduleLines = (d.schedule || '').split('\n').map(s=>s.trim()).filter(Boolean);
  const notesLines    = (d.notes    || '').split('\n').map(s=>s.trim()).filter(Boolean);
  const busVal        = (d.bus || '').trim();

  const toList = (arr)=> arr.length
    ? '<ul class="export-list">' + arr.map(li=>`<li>${escapeHTML(li)}</li>`).join('') + '</ul>'
    : '<ul class="export-list"><li>-</li></ul>';

  const meta = [];
  if (d.showTeam) meta.push(`<div><b>ëŒ€ìƒ</b> ${escapeHTML(teamLine || '-')}</div>`);
  if (d.showDate) meta.push(`<div><b>ì¼ì</b> ${escapeHTML(dateStr)}</div>`);
  if (d.showTime && timeStr) meta.push(`<div><b>ì‹œê°„</b> ${escapeHTML(timeStr)}</div>`);
  if (d.showPlace) {
    const placeName = (d.placeName || '').trim();
    if (placeName) meta.push(`<div><b>ì¥ì†Œ</b> ${escapeHTML(placeName)}</div>`);
    if (d.placeTel) meta.push(`<div><b>ì „í™”</b> ${escapeHTML(d.placeTel)}</div>`);
  }
  const addrLine = (d.place || d.placeAddr || '').trim();
  if (d.showAddress && addrLine) meta.push(`<div><b>ì£¼ì†Œ</b> ${escapeHTML(addrLine)}</div>`);
  if (d.showBus && busVal) meta.push(`<div><b>ë²„ìŠ¤</b> ${escapeHTML(busVal)}</div>`);
  if (d.showContact) meta.push(`<div><b>ë¬¸ì˜</b> ${escapeHTML(d.contact || '-')}</div>`);

  const sectionCards = [];
  if (d.showSchedule) {
    sectionCards.push(`
      <div class="export-card card-schedule">
        <div class="export-sec-title">ì¼ì • ìš”ì•½</div>
        ${toList(scheduleLines)}
      </div>
    `);
  }
  if (d.showNotes && notesLines.length){
    sectionCards.push(`
      <div class="export-card">
        <div class="export-sec-title">íŠ¹ì´ì‚¬í•­</div>
        ${toList(notesLines)}
      </div>
    `);
  }

  const titleHtml = d.showTitle
    ? `<div class="export-title">${escapeHTML(d.title || 'ì•¼ìœ íšŒ ì•ˆë‚´')}</div>`
    : '';

  const mapHtml = (d.showAddress && d.placeMapImg)
    ? `<div class="export-map"><img src="${d.placeMapImg}" alt="ì§€ë„ ë¯¸ë¦¬ë³´ê¸°"></div>`
    : '';

  return `
    ${titleHtml}
    <div class="export-grid">
      <div>
        ${ meta.length ? `<div class="export-meta">${meta.join('')}</div>` : '' }
        <div class="export-sections">
          ${sectionCards.join('')}
        </div>
      </div>
      ${mapHtml}
    </div>
  `;
}
function fillExportDom(){
  const inner = document.getElementById('exportInner');
  if(!inner) return;
  inner.innerHTML = buildExportHTML();
}
async function exportAsImage(){
  showLoading('ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
  try{
    fillExportDom();
    const target = document.getElementById('exportDoc');
    const inner  = document.getElementById('exportInner');
    const sel    = document.getElementById('exportWidth');
    const choice = sel ? sel.value : 'auto';

    const prevWidth = target.style.width;
    const hadNarrow = target.classList.contains('card-narrow');

    let pxWidth;
    if (choice === 'auto') {
      target.style.width = 'auto';
      const measured = inner.scrollWidth || 0;
      pxWidth = Math.max(420, Math.min(560, measured + 12));
    } else {
      pxWidth = parseInt(choice, 10) || 560;
    }
    target.style.width = pxWidth + 'px';
    if (pxWidth <= 560) target.classList.add('card-narrow'); else target.classList.remove('card-narrow');

    const isWide = (choice === '1123' || pxWidth >= 980);
    target.classList.toggle('wide', isWide);

    await waitForImagesLoaded(target);

    const canvas = await html2canvas(target, {backgroundColor:'#fff', scale:2, useCORS:true});
    const dataURL = canvas.toDataURL('image/png');

    const a = document.createElement('a');
    a.href = dataURL;
    a.download = (collect().title || 'ì•ˆë‚´ë¬¸') + `.png`;
    document.body.appendChild(a); a.click(); a.remove();

    target.style.width = prevWidth;
    if (!hadNarrow) target.classList.remove('card-narrow');
  } finally { hideLoading(); }
}
async function printExport(){
  showLoading('ì¸ì‡„ ì¤€ë¹„ ì¤‘â€¦', 'ë ˆì´ì•„ì›ƒì„ êµ¬ì„±í•©ë‹ˆë‹¤', 300);
  try{
    fillExportDom();

    const target = document.getElementById('exportDoc');
    const inner  = document.getElementById('exportInner');
    const sel    = document.getElementById('exportWidth');
    const choice = sel ? sel.value : 'auto';

    const prev = {
      position: target.style.position,
      left: target.style.left,
      top: target.style.top,
      margin: target.style.margin,
      width: target.style.width,
      zoom: target.style.zoom,
      wide: target.classList.contains('wide'),
      narrow: target.classList.contains('card-narrow')
    };

    let pxWidth;
    if (choice === 'auto') {
      target.style.width = 'auto';
      const measured = inner.scrollWidth || 0;
      pxWidth = Math.max(420, Math.min(560, measured + 12));
    } else {
      pxWidth = parseInt(choice, 10) || 560;
    }
    target.style.width = pxWidth + 'px';

    const isWide = (choice === '1123' || pxWidth >= 980);
    target.classList.toggle('wide', isWide);
    if (pxWidth <= 560) target.classList.add('card-narrow');
    else target.classList.remove('card-narrow');

    const pageWmm = isWide ? (297 - 20) : (210 - 20);
    const pageHmm = isWide ? (210 - 20) : (297 - 20);
    const pageHpx = Math.round(pageHmm * 3.7795275591);

    target.style.position = 'static';
    target.style.left = 'auto';
    target.style.top  = 'auto';
    target.style.margin = '0 auto';
    target.style.width = `${pageWmm}mm`;

    await waitForImagesLoaded(target);
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    const contentH = target.getBoundingClientRect().height;
    if (contentH > pageHpx) {
      const zoom = Math.max(0.85, (pageHpx / contentH) * 0.995);
      target.style.zoom = String(zoom);
    }

    const restore = () => {
      target.style.position = prev.position;
      target.style.left = prev.left;
      target.style.top  = prev.top;
      target.style.margin = prev.margin;
      target.style.width = prev.width;
      target.style.zoom = prev.zoom;
      target.classList.toggle('wide', prev.wide);
      target.classList.toggle('card-narrow', prev.narrow);
      window.removeEventListener('afterprint', restore);
      hideLoading();
    };
    window.addEventListener('afterprint', restore);

    window.print();
  } catch(e){
    hideLoading();
    alert('ì¸ì‡„ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
  }
}

/* ======================= ê³µìœ /ì œì¶œ/ì´ˆê¸°í™” ======================= */
function legacyCopy(text){
  try{
    const ta = document.createElement('textarea');
    ta.value = text; ta.setAttribute('readonly', '');
    ta.style.position = 'fixed'; ta.style.top = '-9999px'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.focus(); ta.select();
    const ok = document.execCommand('copy'); document.body.removeChild(ta);
    return ok;
  }catch(_){ return false; }
}
async function safeDistribute({title='', text='', url='', pureText=false, forceManual=false}) {
  const toCopy = text ? (title ? (title + '\n' + text) : text) + (url ? '\n' + url : '')
                      : (title ? (title + (url ? '\n' : '')) : '') + (url || '');
  if (forceManual) { openPreviewModal(toCopy); return { method: 'manual-forced' }; }
  const shouldSkipWebShare = pureText === true;
  if (!shouldSkipWebShare && isMobile() && navigator.share) {
    try { const payload = {}; if (title) payload.title = title; if (text) payload.text = text; if (url) payload.url = url;
      await navigator.share(payload); return { method:'share' }; } catch(_) {}
  }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    try { await navigator.clipboard.writeText(toCopy); return { method:'clipboard' }; } catch(_){}
  }
  if (legacyCopy(toCopy)) return { method:'legacy' };
  alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
  return { method:'manual' };
}

document.getElementById('btnShare').addEventListener('click', async ()=>{
  showLoading('ì„ì‹œ ì €ì¥ ì¤‘â€¦', 'ì§§ì€ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤');
  try{
    const cur = new URL(location.href);
    const currentKey = cur.searchParams.get('k') || '';
    const res = await fetchWithTimeout(GAS_URL, {
      method:'POST',
      body: JSON.stringify({ mode:'share', key: currentKey, data: collectForShare() })
    });
    const json = await res.json();
    if(res.ok && json.status==='ok' && json.key){
      cur.searchParams.set('k', json.key);
      cur.searchParams.delete('code');
      history.replaceState(null, '', cur.toString());

      const d = collect();
      const titleText = d.showTitle ? makeShareTitle(d) : '';
      const linkText = cur.toString();
      openPreviewModal(titleText ? `${titleText}\n${linkText}` : linkText);
    }else{
      alert('ì„ì‹œ ì €ì¥ ì‹¤íŒ¨: ' + (json.error || res.status));
    }
  }catch(err){
    alert('ì„ì‹œ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (err?.message || err));
  }finally{ hideLoading(); }
});

async function submitToSheet(){
  showLoading('ì „ì†¡ ì¤‘â€¦', 'ì¸ì‚¬ì§€ì›íŒ€ ì ‘ìˆ˜ ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤');
  try{
    const data = collect();
    const resolvedAddress = (data.place || data.placeAddr || '').trim();
    const todayStr = new Date().toISOString().slice(0,10);

    const customOpen = document.getElementById('teamCustom')?.style.display !== 'none';
    const customVal  = document.getElementById('teamCustom')?.value.trim();
    if (customOpen && !customVal) {
      alert('ëŒ€ìƒ(ê¸°íƒ€)ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      document.getElementById('teamCustom').focus();
      hideLoading(); return;
    }

    const invalid = [];
    if(!data.team) invalid.push(() => document.querySelector('#teamChips .chip')?.focus());
    if(!data.title.trim()) invalid.push(() => document.getElementById('title').focus());
    if (data.date && data.date < todayStr) {
      alert('ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); hideLoading();
      document.getElementById('date').focus(); return;
    }
    if(!data.date) invalid.push(() => document.getElementById('date').focus());
    if(!data.place.trim()) invalid.push(() => document.getElementById('place').focus());
    if(!(data.schedule||'').trim()) invalid.push(() => document.getElementById('schedule').focus());
    if(!data.bus) invalid.push(() => document.querySelector('#busChips .chip')?.focus());
    if(!data.contact.trim()) invalid.push(() => document.getElementById('contact').focus());
    if (invalid.length){ alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥/ì„ íƒí•´ ì£¼ì„¸ìš”.'); invalid[0](); hideLoading(); return; }

    // 1) ê³µìœ  í‚¤ í™•ë³´
    let shareKey='', clientUrl='';
    const urlObj = new URL(location.href);
    const existingKey = urlObj.searchParams.get('k') || '';
    if (existingKey) {
      shareKey = existingKey; clientUrl = urlObj.toString();
    } else {
      try {
        const shareRes = await fetchWithTimeout(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ mode:'share', data })
        });
        let shareJson; try{ shareJson = await shareRes.json(); }
        catch{ const t = await shareRes.text(); throw new Error('ì„ì‹œì €ì¥ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }
        if (shareRes.ok && shareJson.status==='ok' && shareJson.key){
          shareKey = shareJson.key;
          urlObj.searchParams.delete('code');
          urlObj.searchParams.set('k', shareKey);
          clientUrl = urlObj.toString();
          history.replaceState(null, '', clientUrl);
        } else { clientUrl = location.href; }
      } catch{ clientUrl = location.href; }
    }

    const payload = {
      ...data,
      place_name: (data.placeName || '').trim(),
      address: resolvedAddress,
      place: (data.placeName || '').trim(),  // ë°±ì—”ë“œ í˜¸í™˜
      submitted_at: new Date().toISOString(),
      client_url: clientUrl,
      share_key: shareKey,
      mode: 'append'
    };

    const res = await fetchWithTimeout(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
    let json; try{ json = await res.json(); }
    catch{ const t = await res.text(); throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }

    if(res.ok && (json.status==='ok' || json.result==='ok')){
      alert(`ì œì¶œ ì™„ë£Œ! ì ‘ìˆ˜ë²ˆí˜¸: ${json.id||json.row||'í™•ì¸ë¨'}`);
    }else{
      alert(`ì œì¶œ ì‹¤íŒ¨: ${json.error||res.status}`);
    }
  }catch(err){
    const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
    alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜: ' + msg);
  }finally{ hideLoading(); }
}
document.getElementById('btnSubmit').addEventListener('click', submitToSheet);

function derivePlaceTitleFromAddress(addr='') {
  addr = (addr||'').trim();
  const roadMatch = addr.match(/([^\s]+?(?:ë¡œ|ê¸¸)\d*(?:-\d+)?)[\s,]+(\d+(?:-\d+)?)/);
  if (roadMatch) return `${roadMatch[1]} ${roadMatch[2]}`;
  const jibunMatch = addr.match(/([^\s]+?(ë™|ì|ë©´|ë¦¬))[\s,]+(\d+(?:-\d+)?)/);
  if (jibunMatch) return `${jibunMatch[1]} ${jibunMatch[3]}`;
  const tokens = addr.split(/\s+/).filter(Boolean);
  if (tokens.length >= 3){
    for (let i=0;i<tokens.length;i++){
      if (/[ë™ìë©´ë¦¬]$/.test(tokens[i])) {
        const next = tokens[i+1] || '';
        if (next) return `${tokens[i]} ${next}`;
        return tokens[i];
      }
    }
  }
  return tokens.slice(0,2).join(' ') || addr;
}

/* ======================= ì´ˆê¸°í™”/ë³µì› ======================= */
function resetAll() {
  if (!confirm('ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í•˜ê³ , ì£¼ì†Œì˜ k/code íŒŒë¼ë¯¸í„°ë„ ì œê±°í• ê¹Œìš”?')) return;

  const ids = [
    'team','title','date','time','schedule','bus',
    'placeName','place','placeUrl','placeAddr','placeTel','placeLink',
    'placeLat','placeLng','placeMapImg','notes','contact'
  ];
  ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

  if (typeof setNotesLines === 'function') setNotesLines([]);
  else if (typeof syncNotesPresetSelection === 'function') syncNotesPresetSelection();

  setTeamHiddenFromArray([]); renderTeamChips(); restoreCustomTeamFromTeamValue();
  setMapType('basic');

  ['showTeam','showTitle','showDate','showTime','showPlace','showSchedule','showBus','showNotes','showContact','showAddress']
    .forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
  refreshToggleLabels();

  setPickedPlaceLink('', '');
  setMapPreview('');

  const url = new URL(location.href);
  url.searchParams.delete('k'); url.searchParams.delete('code');
  history.replaceState(null, '', url.origin + url.pathname);

  updateBusBadgeVisibility();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
document.getElementById('btnReset')?.addEventListener('click', resetAll);

/* ì¸ë„¤ì¼ ë³µì› í—¬í¼(ì¢Œí‘œë§Œ ìˆì„ ë•Œ) */
async function restoreMapIfNeededFromData(d){
  if (!d) return;
  if (d.placeMapImg && d.placeMapImg.startsWith('data:image/')) return;
  if (d.placeLat && d.placeLng){
    try{
      const dataUrl = await buildMapThumbByLatLng(d.placeLat, d.placeLng, d.mapType || getMapType());
      if (dataUrl){
        document.getElementById('placeMapImg').value = dataUrl;
        setMapPreview(dataUrl);
      }
    }catch(e){
      console.warn('ì§€ë„ ë³µì› ì‹¤íŒ¨', e);
    }
  }
}

/* ======================= init & loadByKey ======================= */
(async function init(){
  const p = new URLSearchParams(location.search);
  const k    = p.get('k'); 
  const code = p.get('code');

  if (k) { 
    try { await loadByKey(k); } catch(_) {}
  } 
  else if (code) {
    const data = (function decodeShare(b64){
      try{ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
      catch(e){ alert('ê³µìœ  ì½”ë“œ í•´ì„ ì‹¤íŒ¨'); return null }
    })(code);

    if (data) {
      document.getElementById('team').value = data.team || '';
      renderTeamChips(); 
      restoreCustomTeamFromTeamValue();

      document.getElementById('title').value    = data.title   || '';
      document.getElementById('date').value     = data.date    || '';
      document.getElementById('time').value     = data.time    || '';
      document.getElementById('schedule').value = data.schedule||'';

      document.getElementById('bus').value = data.bus || ''; 
      setBus(document.getElementById('bus').value || '');

      document.getElementById('placeName').value = (data.placeName || data.place_name || data.place || '').trim();
      document.getElementById('place').value     = data.place || '';
      if (!document.getElementById('placeName').value.trim()) {
        const guessAddr = data.placeAddr || (looksLikeKrAddress(data.place||'') ? data.place : '');
        if (guessAddr) document.getElementById('placeName').value = derivePlaceTitleFromAddress(guessAddr);
      }

      document.getElementById('placeUrl').value = data.placeUrl || '';
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');

      document.getElementById('placeAddr').value   = data.placeAddr   || '';
      document.getElementById('placeTel').value    = data.placeTel    || '';
      document.getElementById('placeLink').value   = data.placeLink   || '';
      document.getElementById('placeLat').value    = data.placeLat    || '';
      document.getElementById('placeLng').value    = data.placeLng    || '';
      document.getElementById('placeMapImg').value = data.placeMapImg || '';

      if (data.placeMapImg) setMapPreview(data.placeMapImg);
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');

      document.getElementById('notes').value   = data.notes   || '';
      document.getElementById('contact').value = data.contact || '';

      // ì§€ë„ íƒ€ì… ë³µì›
      setMapType((data.mapType || 'basic'), {silent:true});
      renderMapTypeChips();

      await restoreMapIfNeededFromData(data);
      refreshToggleLabels();
    }
  } 
  else {
    document.getElementById('title').value = 'ì•¼ìœ íšŒ ì•ˆë‚´';
    document.getElementById('team').value = '';
    renderTeamChips(); 
    restoreCustomTeamFromTeamValue();
  }
  refreshToggleLabels();
  updateBusBadgeVisibility();
})();

async function loadByKey(k){
  showLoading('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦', 'ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤');
  try{
    const url = `${GAS_URL}?mode=load&key=${encodeURIComponent(k)}`;
    const res = await fetchWithTimeout(url);
    let json; 
    try { json = await res.json(); } 
    catch { const t = await res.text(); throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200)); }

    if (json.status === 'ok' && json.data){
      const data = json.data;

      document.getElementById('team').value = data.team || '';
      renderTeamChips(); 
      restoreCustomTeamFromTeamValue();

      document.getElementById('title').value    = data.title   || '';
      document.getElementById('date').value     = data.date    || '';
      document.getElementById('time').value     = data.time    || '';
      document.getElementById('schedule').value = data.schedule||'';

      document.getElementById('bus').value = data.bus || ''; 
      setBus(document.getElementById('bus').value || '');

      document.getElementById('placeName').value = (data.placeName || data.place_name || data.place || '').trim();
      document.getElementById('place').value     = data.place || '';
      if (!document.getElementById('placeName').value.trim()) {
        const guessAddr = data.placeAddr || (looksLikeKrAddress(data.place||'') ? data.place : '');
        if (guessAddr) document.getElementById('placeName').value = derivePlaceTitleFromAddress(guessAddr);
      }

      document.getElementById('placeUrl').value = data.placeUrl || '';
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');

      document.getElementById('placeAddr').value   = data.placeAddr   || '';
      document.getElementById('placeTel').value    = data.placeTel    || '';
      document.getElementById('placeLink').value   = data.placeLink   || '';
      document.getElementById('placeLat').value    = data.placeLat    || '';
      document.getElementById('placeLng').value    = data.placeLng    || '';
      document.getElementById('placeMapImg').value = data.placeMapImg || '';

      if (data.placeMapImg) setMapPreview(data.placeMapImg);
      if (data.placeUrl) setPickedPlaceLink(data.placeUrl, data.place || 'ì§€ë„');

      document.getElementById('notes').value   = data.notes   || '';
      document.getElementById('contact').value = data.contact || '';

      // ì§€ë„ íƒ€ì… ë³µì›
      setMapType((data.mapType || 'basic'), {silent:true});
      renderMapTypeChips();

      await restoreMapIfNeededFromData(data);
    } 
    else {
      alert('ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (json.error||'ì•Œ ìˆ˜ ì—†ìŒ'));
    }
  } catch(err){
    const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ' + msg);
  } finally { hideLoading(); }
}
</script>
</body>
</html>
