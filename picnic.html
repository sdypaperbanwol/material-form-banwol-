<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>반별 야유회 안내문 생성기</title>
  <style>
    :root{
      --brand:#e53935; --ink:#222; --muted:#666; --line:#ddd; --bg:#f7f7f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .toolbar button{
      border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
    }
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .card h2{margin:0;padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .card .body{padding:18px}
    .f{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:start}
    .row label{font-weight:700;padding-top:6px}
    input[type=text], input[type=date], textarea, select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    @media print{ .no-print, .toolbar{display:none !important} body{background:#fff} .wrap{max-width:900px} }

    /* ▼ 모바일에서 라벨/입력을 세로로 쌓기 */
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; gap: 6px; }
      .row label { padding-top: 0; }
      .row > * + * { margin-top: 2px; }
    }

    /* ▼ 버스 대절 O/X 토글 */
    .chip-group{display:flex;gap:8px;align-items:center}
    .chip{
      border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;
      padding:6px 14px;font-weight:700;min-width:44px;text-align:center;user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .chip.selected{border-color:var(--brand); color:#fff; background:var(--brand)}

    /* ▼ 스크롤 시 우하단 배지 */
    #busBadge{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 10px;
      font-weight:800; box-shadow:0 4px 12px rgba(0,0,0,.12); display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar no-print">
      <button id="btnShare">저장(링크 주소)</button>
      <button id="btnCopyText">공유(텍스트)</button>
      <button id="btnSubmit">전송(인사지원팀)</button>
      <!-- ▼ 공유 링크 표시 -->
      <input id="shareLink" readonly
            style="flex:1; min-width:260px; max-width:560px; padding:6px 10px; border:1px solid #ddd; border-radius:6px;"
            placeholder="공유 링크가 여기 표시됩니다" />
    </div>

    <div class="grid">
      <div class="card no-print">
        <h2>아래 항목을 작성해주세요</h2>
        <div class="body">
          <div class="f">
            <div class="row">
              <label for="team">반 선택</label>
              <select id="team">
                <option value="A">A반</option>
                <option value="B">B반</option>
                <option value="C">C반</option>
                <option value="D">D반</option>
              </select>
            </div>
            <div class="row">
              <label for="title">제목(선택)</label>
              <input id="title" type="text" placeholder="예) 야유회 안내" />
            </div>
            <div class="row">
              <label for="date">일자</label>
              <input id="date" type="date" />
            </div>
            <div class="row">
              <label for="place">장소</label>
              <input id="place" type="text" placeholder="예) XXX (주소는 선택사항)" />
            </div>
            <div class="row">
              <label for="schedule">일정 요약</label>
              <textarea id="schedule" placeholder="예시)
- 06:00 화랑유원지 집결
- 06:30 버스 출발
- 11:00 XX 관람 시작
- 12:30 점심 식사
- 15:00 귀가"></textarea>
            </div>

            <!-- ▼ 버스 대절 O/X -->
            <div class="row">
              <label>버스 대절</label>
              <div>
                <input id="bus" type="hidden" value="" />
                <div class="chip-group" id="busChips">
                  <div class="chip" data-val="O">O</div>
                  <div class="chip" data-val="X">X</div>
                </div>
                <small style="color:var(--muted)">버스 대절 여부를 선택하세요 (O/X)</small>
              </div>
            </div>

            <div class="row">
              <label for="notes">특이사항</label>
              <textarea id="notes" placeholder="예) 
- 편한 복장 및 운동화 권장
- 개인 물/우의 등 준비
- 전세버스 대절 (개별 집결 없음)
- 일부 구간은 도보 이동 예정"></textarea>
            </div>
            <div class="row">
              <label for="contact">문의처</label>
              <input id="contact" type="text" placeholder="예) A반 홍길동 (010-0000-0000)" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 스크롤 배지 -->
  <div id="busBadge" aria-hidden="true">버스: <span id="busBadgeVal">-</span></div>

  <!-- LZ-String: URI용 압축/복원 (구 공유코드 호환용) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <script>
  // ⚠️ 최신 /exec URL로 교체해 사용
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZVROE3X1C1LywBB1jfrOC6yxCKTVIPmuZ_yA3V-c84Q1DBXIrLc2parM_gsHJLAY/exec';

  function weekdayKR(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr+'T00:00:00');
    const yo = ['일','월','화','수','목','금','토'][d.getDay()];
    return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일(${yo})`;
  }

  function collect(){
    return {
      team: document.getElementById('team').value,
      title: document.getElementById('title').value,
      date: document.getElementById('date').value,
      schedule: document.getElementById('schedule').value,
      bus: document.getElementById('bus').value,
      place: document.getElementById('place').value,
      notes: document.getElementById('notes').value,
      contact: document.getElementById('contact').value,
    };
  }

  // (구방식) base64 인코딩/디코딩 유지 호환
  function encodeShare(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodeShare(b64){
    try{ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    catch(e){ alert('공유 코드 해석 실패'); return null }
  }

  // ▼ 버스 토글/배지
  function setBus(val){
    const hidden = document.getElementById('bus');
    const chips = document.querySelectorAll('#busChips .chip');
    hidden.value = val || '';
    chips.forEach(c => c.classList.toggle('selected', c.getAttribute('data-val') === val));
    document.getElementById('busBadgeVal').textContent = hidden.value || '-';
    // 배지 표시 상태 갱신
    updateBusBadgeVisibility();
  }

  // 스크롤 시 배지 노출 제어
  const showAfter = 200; // px
  function updateBusBadgeVisibility(){
    const badge = document.getElementById('busBadge');
    if(window.scrollY > showAfter){
      const v = document.getElementById('bus').value || '';
      badge.style.display = v ? 'block' : 'none';
    }else{
      badge.style.display = 'none';
    }
  }
  window.addEventListener('scroll', updateBusBadgeVisibility, {passive:true});
  window.addEventListener('resize', updateBusBadgeVisibility);

  // 버스 칩 바인딩
  (function bindBusChips(){
    const group = document.getElementById('busChips');
    if(!group) return;
    group.addEventListener('click', (e)=>{
      const target = e.target.closest('.chip');
      if(!target) return;
      setBus(target.getAttribute('data-val'));
    });
  })();

  // ▼ 표시만 예쁘게(방법 2): 제목 생성 유틸
  function makeShareTitle(d){
    const team = d.team ? `${d.team}반` : '';
    const dateTxt = d.date ? weekdayKR(d.date) : '';
    const t = (d.title || '').trim();
    if (t) return t; // 사용자가 직접 입력한 제목 우선
    // 미입력 시 기본 형태: "YYYY년 M월 D일(요일) A반 야유회"
    return [dateTxt, team, '야유회'].filter(Boolean).join(' ');
  }

  // 임시 저장: GAS에 data 저장 → key 발급 → ?k= 로 짧은 링크 생성
  document.getElementById('btnShare').addEventListener('click', async ()=>{
    try{
      const res = await fetch(GAS_URL, {
        method:'POST',
        body: JSON.stringify({ mode:'share', data: collect() })
      });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
      }
      if(res.ok && json.status==='ok' && json.key){
        const url = new URL(location.href);
        url.searchParams.delete('code'); // 구방식 제거
        url.searchParams.set('k', json.key); // 신방식 키만 유지 (t 파라미터는 안붙임)

        history.replaceState(null, '', url.toString());

        // 표시용 예쁜 문자열: "제목 — URL"
        const titleText = makeShareTitle(collect());
        const shareEl = document.getElementById('shareLink');
        if (shareEl) shareEl.value = `${titleText} — ${url.toString()}`;

        // 복사 문자열은 "제목\nURL" (메신저 가독성 ↑)
        await navigator.clipboard.writeText(`${titleText}\n${url.toString()}`);
        alert('짧은 공유 링크가 복사되었습니다.');
      }else{
        alert('임시 저장 실패: ' + (json.error || res.status));
      }
    }catch(err){
      alert('임시 저장 중 오류: ' + err.message);
    }
  });

  // 텍스트 복사
  document.getElementById('btnCopyText').addEventListener('click', ()=>{
    const d = collect();
    const lines = [];
    const dateStr = d.date ? weekdayKR(d.date) : '-';
    const header = makeShareTitle(d) || (d.team+"반 야유회");
    lines.push(header);
    lines.push('');
    lines.push(`[일자] ${dateStr}`);
    lines.push('[일정 요약]');
    lines.push(...(d.schedule||'').split('\n').filter(Boolean));
    if ((d.bus||'').trim()) lines.push(`[버스 대절] ${d.bus}`);
    lines.push(`[장소] ${d.place||'-'}`);
    if((d.notes||'').trim()){
      lines.push('[특이사항]');
      lines.push(...d.notes.split('\n').filter(Boolean));
    }
    lines.push(`[문의처] ${d.contact||'-'}`);
    const text = lines.join('\n');
    navigator.clipboard.writeText(text).then(()=>{
      alert('텍스트가 복사되었습니다.');
    }).catch(()=>{
      prompt('복사 실패. 아래 내용을 수동 복사하세요.', text);
    });
  });

  // 제출(전송)
  async function submitToSheet(){
    try{
      const data = collect();
      if(!data.date){ alert('일자를 입력해주세요.'); return; }
      if(!(data.schedule||'').trim()){ alert('일정 요약을 입력해주세요.'); return; }
      if(!data.contact){ alert('문의처를 입력해주세요.'); return; }

      const payload = { ...data, submitted_at: new Date().toISOString(), mode:'append' };

      const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
      }

      if(res.ok && (json.status==='ok' || json.result==='ok')){
        alert(`제출 완료! 접수번호: ${json.id||json.row||'확인됨'}`);
      }else{
        alert(`제출 실패: ${json.error||res.status}`);
      }
    }catch(err){
      alert('제출 중 오류: '+ err.message);
    }
  }
  document.getElementById('btnSubmit').addEventListener('click', submitToSheet);

  // ?k=키 → GAS에서 불러오기 / ?code=…(구방식)도 호환
  async function loadByKey(k){
    const url = `${GAS_URL}?mode=load&key=${encodeURIComponent(k)}`;
    const res = await fetch(url);
    let json;
    try{ json = await res.json(); }
    catch{
      const t = await res.text();
      throw new Error('서버 응답이 JSON이 아님: ' + t.slice(0,200));
    }
    if(json.status === 'ok' && json.data){
      const data = json.data;
      document.getElementById('team').value = data.team||'A';
      document.getElementById('title').value = data.title||'';
      document.getElementById('date').value = data.date||'';
      document.getElementById('schedule').value = data.schedule||'';
      document.getElementById('bus').value = data.bus || '';
      setBus(document.getElementById('bus').value || '');
      document.getElementById('place').value = data.place||'';
      document.getElementById('notes').value = data.notes||'';
      document.getElementById('contact').value = data.contact||'';
    }else{
      alert('임시 저장 불러오기 실패: ' + (json.error||'알 수 없음'));
    }
  }

  (async function init(){
    const p = new URLSearchParams(location.search);
    const k = p.get('k');
    const code = p.get('code');
    if(k){
      try{ await loadByKey(k); }
      catch(e){ alert('불러오기 오류: ' + e.message); }
    }else if(code){
      const data = decodeShare(code);
      if(data){
        document.getElementById('team').value = data.team||'A';
        document.getElementById('title').value = data.title||'';
        document.getElementById('date').value = data.date||'';
        document.getElementById('schedule').value = data.schedule||'';
        document.getElementById('bus').value = data.bus || '';
        setBus(document.getElementById('bus').value || '');
        document.getElementById('place').value = data.place||'';
        document.getElementById('notes').value = data.notes||'';
        document.getElementById('contact').value = data.contact||'';
      }
    }else{
      document.getElementById('title').value = '야유회 안내';
    }

    // 최초 배지 상태 갱신
    updateBusBadgeVisibility();

    // ▼ 추가: 로드 완료 후 shareLink 표시에 "제목 — URL" 세팅
    try{
      const shareEl = document.getElementById('shareLink');
      if (shareEl) {
        const urlNow = new URL(location.href);
        // k가 있을 때만 표시(= 임시 저장 한 뒤)
        if (urlNow.searchParams.get('k')) {
          const titleText = makeShareTitle(collect());
          shareEl.value = `${titleText} — ${urlNow.toString()}`;
        }
      }
    }catch(_){ }
  })();
  </script>
</body>
</html>
