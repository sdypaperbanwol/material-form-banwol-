<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°˜ë³„ ì•ˆë‚´ë¬¸</title>
  <style>
    :root{
      --brand:#e53935; --ink:#222; --muted:#666; --line:#ddd; --bg:#f7f7f9;
      --soft:#f2f5fa; --sec:#eef3ff; --sec-line:#d9e2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .card h2{margin:0;padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .card .body{padding:18px}

    /* === ì„¹ì…˜ êµ¬ë¶„ === */
    .sec{display:grid;gap:12px;padding:14px 12px;border:1px solid var(--line);border-radius:14px;background:#fff}
    .sec + .sec{margin-top:14px}
    .sec-title{
      font-weight:900;font-size:13px;letter-spacing:.2px;color:#1a237e;
      background:linear-gradient(180deg,#f7f9ff,#eef3ff);
      border:1px solid var(--sec-line);border-radius:999px;
      display:inline-block;padding:6px 12px;
    }

    /* === í¼ ë¡œìš° === */
    .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:start;
      padding:10px;border:1px dashed #eee;border-radius:12px;background:#fafbff}
    .row + .row{margin-top:8px}
    .row label{
      font-weight:800;padding:8px 10px;border-radius:10px;border:1px solid #e7eaf6;
      background:#f7f9ff;color:#243b6b;display:inline-flex;align-items:center;gap:6px
    }
    .badge-req{
      font-size:11px;font-weight:900;color:#b71c1c;background:#ffebee;border:1px solid #ffcdd2;
      padding:2px 6px;border-radius:999px;
    }
    input[type=text], input[type=date], textarea, select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
    }
    textarea{min-height:110px;resize:vertical}

    /* í¬ì»¤ìŠ¤/ì—ëŸ¬ */
    .row:focus-within{
      background:#ffffff;border-color:#cfd8ff; box-shadow:0 0 0 3px rgba(63,81,181,.08);
    }
    input:focus, textarea:focus, select:focus{
      border-color:#9fa8da;box-shadow:0 0 0 2px rgba(63,81,181,.12) inset;
    }

    /* ì¹© ê³µí†µ (ë°˜, ë²„ìŠ¤) */
    .chip-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;
      padding:6px 14px;font-weight:700;min-width:44px;text-align:center;user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .chip.selected{border-color:var(--brand); color:#fff; background:var(--brand)}

    /* íŠ¹ì´ì‚¬í•­ ì¹© ì „ìš© ìŠ¤íƒ€ì¼ (ë„¤ëª¨, ì¢Œì¸¡ ì •ë ¬, í•­ìƒ 2ì¤„ ë†’ì´) */
   #notesPresets .chip {
  border-radius:8px;
  padding:8px 12px;     /* ì¢Œìš° padding ì¤„ì—¬ì„œ ê³µê°„ í™•ë³´ */
  font-size:13px;       /* ì‚´ì§ ì¤„ì—¬ì„œ í•œ ì¤„ì— ë“¤ì–´ê°€ê¸° ì‰½ê²Œ */
  text-align:left;
  line-height:1.4;
  white-space:normal;   /* ê¸¸ë©´ ì¤„ë°”ê¿ˆ í—ˆìš© */
  min-height:36px;      /* ì¤„ì—¬ë„ ë³´ê¸° ì¢‹ê²Œ */
  display:flex;
  align-items:center;
}


    /* ìš°í•˜ë‹¨ ë°°ì§€ */
    #busBadge{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 10px;
      font-weight:800; box-shadow:0 4px 12px rgba(0,0,0,.12); display:none;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loadingOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,.7); z-index:10000;
      display:none; align-items:center; justify-content:center; flex-direction:column; gap:14px;
      backdrop-filter:saturate(1.2) blur(2px);
    }
    .spinner{
      width:48px; height:48px; border-radius:50%;
      border:4px solid rgba(0,0,0,.08); border-top-color: var(--brand);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .loading-text{font-weight:700; color:#333}
    .loading-sub{font-size:12px; color:#777}
    .toolbar [disabled]{opacity:.6; cursor:not-allowed}

    /* í•˜ë‹¨ íˆ´ë°” */
    .toolbar {
      display: grid; gap: 12px; margin: 24px 0; padding: 16px;
      border: 1px solid var(--line); border-radius: 16px; background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .toolbar button{
      padding: 14px; font-size: 15px; font-weight: 700; border-radius: 12px;
      transition: all .2s; border:1px solid var(--line); background:#fff; cursor:pointer;
    }
    #btnShare { border-color:#90caf9; background:#e3f2fd; color:#1565c0; }
    #btnShare:hover { background:#bbdefb; }
    #btnCopyText { border-color:#a5d6a7; background:#e8f5e9; color:#2e7d32; }
    #btnCopyText:hover { background:#c8e6c9; }
    #btnSubmit { border-color:#ef9a9a; background:#ffebee; color:#c62828; }
    #btnSubmit:hover { background:#ffcdd2; }

/* ì•ˆë‚´ë¬¸ PDF/ì´ë¯¸ì§€ìš© íƒ€ì´í‹€/ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
.export-title{
  font-weight:900; font-size:20px; margin:0 0 10px;
}
.export-meta{ margin:10px 0 16px; padding:10px 12px; background:#f7f9ff; border:1px solid #e6ebff; border-radius:10px; }
.export-meta b{ display:inline-block; width:56px; color:#1a237e; }
.export-sec-title{
  margin:18px 0 8px; font-weight:800; color:#1a237e; border-left:4px solid #1a237e; padding-left:8px;
}
.export-list{ margin:6px 0 0 0; padding-left:18px; }
.export-list li{ margin:4px 0; }

    
    /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
    #previewModal[hidden] { display: none; }
    #previewModal {
      position: fixed; inset: 0; z-index: 20000;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45);
      padding: 20px;
    }
    .preview-card{
      width: min(720px, 94vw);
      background:#fff; border:1px solid var(--line); border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      display:flex; flex-direction:column; gap:12px; padding:16px;
    }
    .preview-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .preview-head h3{ margin:0; font-size:18px }
    .preview-actions{ display:flex; gap:8px; justify-content:flex-end }
    .preview-actions button{
      border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    #previewTa{
      width:100%; min-height:220px; max-height:420px;
      padding:10px; border:1px solid #ddd; border-radius:10px;
      font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;
      resize:vertical; overflow-y:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch;
    }
    .preview-hint{ font-size:12px; color:#777 }
    .preview-toast{ display:none; align-self:flex-start; font-size:12px; color:#2e7d32; font-weight:700; }
    .preview-toast.show{ display:inline-block; }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; gap: 6px; padding:12px }
      .row label { padding:6px 10px }
      .row > * + * { margin-top: 2px; }
      .sec { padding:12px 10px }
      .sec-title{ font-size:12px }
    }

    @media print{
      .no-print, .toolbar, #busBadge, #loadingOverlay, #previewModal { display:none !important; }
      body{ background:#fff }
      .wrap{ max-width:900px }
      pre, textarea { font-family: inherit; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card no-print">
        <h2>ì•ˆë‚´ë¬¸ ì‘ì„±</h2>
        <div class="body">
          <!-- === ì„¹ì…˜: ì°¸ì—¬ ëŒ€ìƒ === -->
          <div class="sec">
            <div class="sec-title">ì°¸ì—¬ ëŒ€ìƒ</div>
            <div class="row">
              <label>ë°˜ ì„ íƒ <span class="badge-req">í•„ìˆ˜</span></label>
              <div>
                <input id="team" type="hidden" value="">
                <div class="chip-group" id="teamChips" role="group" aria-label="ë°˜ ì„ íƒ">
                  <div class="chip" data-val="A">Aë°˜</div>
                  <div class="chip" data-val="B">Bë°˜</div>
                  <div class="chip" data-val="C">Cë°˜</div>
                  <div class="chip" data-val="D">Dë°˜</div>
                  <div class="chip" data-val="ê¸°íƒ€">ê¸°íƒ€</div>
                  <!-- ê¸°íƒ€ ì…ë ¥ì¹¸ (ì´ˆê¸° ìˆ¨ê¹€) -->
                  <input id="teamCustom" type="text" placeholder="ì§ì ‘ ì…ë ¥"
                         style="display:none; margin-left:6px; padding:6px 10px; border-radius:8px; border:1px solid #ccc;"/>
                </div>
                <small style="color:var(--muted)">ì—¬ëŸ¬ ë°˜ ì„ íƒ ê°€ëŠ¥</small>
              </div>
            </div>
          </div>

          <!-- === ì„¹ì…˜: ê¸°ë³¸ ì •ë³´ === -->
          <div class="sec">
            <div class="sec-title">ê¸°ë³¸ ì •ë³´</div>
            <div class="row">
              <label for="title">ì œëª© <span class="badge-req">í•„ìˆ˜</span></label>
              <input id="title" type="text" placeholder="ì˜ˆ) ì•¼ìœ íšŒ ì•ˆë‚´" />
            </div>
            <div class="row">
              <label for="date">ì¼ì <span class="badge-req">í•„ìˆ˜</span></label>
              <input id="date" type="date" />
            </div>
            <div class="row">
              <label for="place">ì¥ì†Œ <span class="badge-req">í•„ìˆ˜</span></label>
              <input id="place" type="text" placeholder="ì˜ˆ) XXX (ì£¼ì†ŒëŠ” ì„ íƒì‚¬í•­)" />
            </div>
          </div>

          <!-- === ì„¹ì…˜: ìš´ì˜ ì •ë³´ === -->
          <div class="sec">
            <div class="sec-title">ìš´ì˜ ì •ë³´</div>
            <div class="row">
              <label for="schedule">ì¼ì • ìš”ì•½ <span class="badge-req">í•„ìˆ˜</span></label>
              <textarea id="schedule" placeholder="ì˜ˆì‹œ)
- 06:00 í™”ë‘ìœ ì›ì§€ ì§‘ê²°
- 06:30 ë²„ìŠ¤ ì¶œë°œ
- 11:00 XX ê´€ëŒ ì‹œì‘
- 12:30 ì ì‹¬ ì‹ì‚¬
- 15:00 ê·€ê°€"></textarea>
            </div>

            <div class="row">
              <label for="bus">ë²„ìŠ¤ ëŒ€ì ˆ <span class="badge-req">í•„ìˆ˜</span></label>
              <div>
                <input id="bus" type="hidden" value="" />
                <div class="chip-group" id="busChips" role="radiogroup" aria-label="ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€">
                  <div class="chip" role="radio" tabindex="0" aria-checked="false" data-val="O">O</div>
                  <div class="chip" role="radio" tabindex="-1" aria-checked="false" data-val="X">X</div>
                </div>
                <small style="color:var(--muted)">ë²„ìŠ¤ ëŒ€ì ˆ ì—¬ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš” (O/X)</small>
              </div>
            </div>

            <div class="row">
              <label for="notes">íŠ¹ì´ì‚¬í•­</label>
              <div>
                <div class="chip-group" id="notesPresets" role="group" aria-label="íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿"></div>
                <small style="color:var(--muted)">í´ë¦­ ì‹œ íŠ¹ì´ì‚¬í•­ì— ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤(ì¤‘ë³µ ë°©ì§€)</small>
                <textarea id="notes" placeholder="ì˜ˆ)
- í¸í•œ ë³µì¥ ë° ìš´ë™í™” ê¶Œì¥
- ê°œì¸ ë¬¼/ìš°ì˜ ë“± ì¤€ë¹„
- ì „ì„¸ë²„ìŠ¤ ëŒ€ì ˆ(ê°œë³„ ì§‘ê²° ì—†ìŒ)
- ì¼ë¶€ êµ¬ê°„ì€ ë„ë³´ ì´ë™ ì˜ˆì •"></textarea>
              </div>
            </div>
          </div>

          <!-- === ì„¹ì…˜: ë¬¸ì˜ === -->
          <div class="sec">
            <div class="sec-title">ë¬¸ì˜</div>
            <div class="row">
              <label for="contact">ë¬¸ì˜ì²˜ <span class="badge-req">í•„ìˆ˜</span></label>
              <input id="contact" type="text" placeholder="ì˜ˆ) Aë°˜ í™ê¸¸ë™ (010-0000-0000)" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ íˆ´ë°” -->
    <div class="toolbar no-print">
      <button id="btnShare">ì„ì‹œ ì €ì¥í•˜ê¸°</button>
      <button id="btnCopyText">ì•ˆë‚´ë¬¸ ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="btnSubmit">ì¸ì‚¬ì§€ì›íŒ€ ì œì¶œ</button>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¡¤ ë°°ì§€ -->
  <div id="busBadge" aria-hidden="true">ë²„ìŠ¤: <span id="busBadgeVal">-</span></div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text" id="loadingText">ì§„í–‰ ì¤‘â€¦</div>
    <div class="loading-sub" id="loadingSub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
  </div>

  <!-- ê³µìœ  í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div id="previewModal" hidden role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-card" role="document">
      <div class="preview-head">
        <h3 id="previewTitle">ì•ˆë‚´ë¬¸ ë¯¸ë¦¬ë³´ê¸°</h3>
      </div>
      <textarea id="previewTa"></textarea>
      <div class="preview-hint">ë°°í¬ìš©ìœ¼ë¡œ ììœ  ìˆ˜ì • ê°€ëŠ¥í•˜ë‚˜, ì¸ì‚¬ì§€ì›íŒ€ ì „ì†¡ ì‹œì—ëŠ” ì…ë ¥í•œ ì›ë³¸ ë‚´ìš©ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.</div>
      <div class="preview-actions">
        <span id="previewToast" class="preview-toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
        <button type="button" id="previewCopy">ë³µì‚¬í•˜ê¸°</button>
        <button type="button" id="previewClose2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- LZ-String (êµ¬ ê³µìœ ì½”ë“œ í˜¸í™˜) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZVROE3X1C1LywBB1jfrOC6yxCKTVIPmuZ_yA3V-c84Q1DBXIrLc2parM_gsHJLAY/exec';

  /* ===== fetch íƒ€ì„ì•„ì›ƒ ìœ í‹¸ ===== */
  async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);
    try { return await fetch(url, {...opts, signal: controller.signal}); }
    finally { clearTimeout(timer); }
  }

  /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
  let loadingCount = 0;
  let loadingTimer = null;
  function setToolbarDisabled(disabled){
    document.querySelectorAll('.toolbar button').forEach(btn => btn.disabled = disabled);
    document.querySelectorAll('input, textarea').forEach(el => el.readOnly = disabled);
    document.querySelectorAll('select').forEach(el => el.disabled = disabled);
  }
  function showLoading(main='ì§„í–‰ ì¤‘â€¦', sub='ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”', minMs=500){
    loadingCount++;
    const ov = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = main;
    document.getElementById('loadingSub').textContent = sub;
    ov.style.display = 'flex';
    setToolbarDisabled(true);
    clearTimeout(loadingTimer);
    loadingTimer = setTimeout(()=>{ loadingTimer = null; }, minMs);
  }
  function hideLoading(){
    if (loadingCount > 0) loadingCount--;
    const finish = ()=>{
      if (loadingCount === 0){
        document.getElementById('loadingOverlay').style.display = 'none';
        setToolbarDisabled(false);
      }
    };
    if (loadingTimer){ setTimeout(()=>finish(), 120); loadingTimer = null; }
    else { finish(); }
  }

  /* ===== ì¸ì•± ê°ì§€ ===== */
  function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

  /* ===== ë³µì‚¬ ìœ í‹¸ ===== */
  function legacyCopy(text){
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(_){ return false; }
  }

  async function safeDistribute({title='', text='', url='', pureText=false, forceManual=false}) {
    const toCopy =
      text
        ? (title ? (title + '\n' + text) : text) + (url ? '\n' + url : '')
        : (title ? (title + (url ? '\n' : '')) : '') + (url || '');

    if (forceManual) {
      openPreviewModal(toCopy);
      return { method: 'manual-forced' };
    }

    const shouldSkipWebShare = pureText === true;
    if (!shouldSkipWebShare && isMobile() && navigator.share) {
      try {
        const payload = {};
        if (title) payload.title = title;
        if (text)  payload.text  = text;
        if (url)   payload.url   = url;
        await navigator.share(payload);
        return { method:'share' };
      } catch(_) {}
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
      try { await navigator.clipboard.writeText(toCopy); return { method:'clipboard' }; }
      catch(_) {}
    } // â† ëˆ„ë½ë˜ì—ˆë˜ ë‹«ëŠ” ì¤‘ê´„í˜¸ ë³´ì™„

    if (legacyCopy(toCopy)) { return { method:'legacy' }; }

    alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    return { method:'manual' };
  }

  /* ===== ë‚ ì§œ í¬ë§· ===== */
  function weekdayKR(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr+'T00:00:00');
    const yo = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
    return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼(${yo})`;
  }

  /* ===== íŒ€ ì¹© ìœ í‹¸ ===== */
  function parseTeams(str){ return (str || '').split(',').map(s => s.trim()).filter(Boolean); }
  function teamsToString(arr){ return Array.from(new Set(arr)).join(','); }
  function getTeamsArray(){ return parseTeams(document.getElementById('team').value); }
  function setTeamHiddenFromArray(arr){ document.getElementById('team').value = teamsToString(arr); }
  function hasAnyCustomTeam(){ return getTeamsArray().some(v => v==='ê¸°íƒ€' || v.startsWith('ê¸°íƒ€:')); }
  function renderTeamChips(){
    const arr = getTeamsArray();
    document.querySelectorAll('#teamChips .chip').forEach(chip=>{
      const val = chip.dataset.val;
      if(val === 'ê¸°íƒ€'){ chip.classList.toggle('selected', hasAnyCustomTeam()); }
      else { chip.classList.toggle('selected', arr.includes(val)); }
    });
  }
  function toggleTeam(val){
    const arr = getTeamsArray();
    const i = arr.indexOf(val);
    if (i >= 0) arr.splice(i,1);
    else arr.push(val);
    setTeamHiddenFromArray(arr);
    renderTeamChips();
  }

  /* ì¼ë°˜ ë°˜ ì¹© í´ë¦­ */
  (function bindTeamChips(){
    const group = document.getElementById('teamChips');
    if(!group) return;
    group.addEventListener('click', e=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      if (chip.dataset.val === 'ê¸°íƒ€') return; // ê¸°íƒ€ëŠ” ë³„ë„ ì²˜ë¦¬
      toggleTeam(chip.dataset.val);
    });
  })();

  /* ===== ê¸°íƒ€ ì§ì ‘ì…ë ¥ ===== */
  function removeAllCustomTeamFromArray(arr){ return (arr||[]).filter(v => v!=='ê¸°íƒ€' && !v.startsWith('ê¸°íƒ€:')); }
  function restoreCustomTeamFromTeamValue(){
    const arr = getTeamsArray();
    const custom = arr.find(v => v.startsWith('ê¸°íƒ€:'));
    const input = document.getElementById('teamCustom');
    if (!input) return;
    if (custom){
      input.style.display = 'inline-block';
      input.value = custom.split(':').slice(1).join(':');
    } else {
      input.style.display = 'none';
      input.value = '';
    }
    renderTeamChips();
  }
  (function bindCustomTeam(){
    const chips = document.getElementById('teamChips');
    const customInput = document.getElementById('teamCustom');
    if(!chips || !customInput) return;

    chips.addEventListener('click', e=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      if(chip.dataset.val === 'ê¸°íƒ€'){
        const opening = (customInput.style.display === 'none' || customInput.style.display === '');
        if(opening){
          customInput.style.display = 'inline-block';
          customInput.focus();
        }else{
          const arr = removeAllCustomTeamFromArray(getTeamsArray());
          setTeamHiddenFromArray(arr);
          customInput.value = '';
          customInput.style.display = 'none';
          renderTeamChips();
        }
      }
    });

    customInput.addEventListener('input', ()=>{
      const val = customInput.value.trim();
      let arr = removeAllCustomTeamFromArray(getTeamsArray());
      if(val){ arr.push('ê¸°íƒ€:'+val); }
      setTeamHiddenFromArray(arr);
      renderTeamChips();
    });
  })();

// íŒ€ ì¹© í‚¤ë³´ë“œ í† ê¸€
(function bindTeamChipsA11y(){
  const group = document.getElementById('teamChips');
  if(!group) return;
  group.querySelectorAll('.chip[data-val]:not([data-val="ê¸°íƒ€"])').forEach(chip=>{
    chip.tabIndex = 0;
    chip.setAttribute('role','button');
  });
  group.addEventListener('keydown', e=>{
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const chip = e.target.closest('.chip');
    if(!chip || chip.dataset.val === 'ê¸°íƒ€') return;
    e.preventDefault();
    toggleTeam(chip.dataset.val);
  });
})();

// ë²„ìŠ¤ ì¹© í‚¤ë³´ë“œ í† ê¸€
(function bindBusChipsA11y(){
  const group = document.getElementById('busChips');
  if(!group) return;
  group.querySelectorAll('.chip').forEach(chip=>{
    chip.tabIndex = 0;
    chip.setAttribute('role','radio');
  });
  group.addEventListener('keydown', e=>{
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const chip = e.target.closest('.chip');
    if(!chip) return;
    e.preventDefault();
    setBus(chip.getAttribute('data-val'));
  });
})();

    
  /* ===== ë²„ìŠ¤ ì¹© ===== */
  function setBus(val){
    const hidden = document.getElementById('bus');
    const chips = document.querySelectorAll('#busChips .chip');
    hidden.value = val || '';
    chips.forEach(c => c.classList.toggle('selected', c.getAttribute('data-val') === val));
    document.getElementById('busBadgeVal').textContent = hidden.value || '-';
    updateBusBadgeVisibility();
  }
  const showAfter = 200;
  function updateBusBadgeVisibility(){
    const badge = document.getElementById('busBadge');
    if(window.scrollY > showAfter){
      const v = document.getElementById('bus').value || '';
      badge.style.display = v ? 'block' : 'none';
    }else{
      badge.style.display = 'none';
    }
  }
  window.addEventListener('scroll', updateBusBadgeVisibility, {passive:true});
  window.addEventListener('resize', updateBusBadgeVisibility);
  (function bindBusChips(){
    const group = document.getElementById('busChips');
    if(!group) return;
    group.addEventListener('click', (e)=>{
      const target = e.target.closest('.chip');
      if(!target) return;
      setBus(target.getAttribute('data-val'));
    });
  })();

  /* ===== íŠ¹ì´ì‚¬í•­ í…œí”Œë¦¿(ì¹©) ===== */
  const NOTES_PRESETS = [
    '- í¸í•œ ë³µì¥ê³¼ ê°œì¸ ë¬¼Â·ìš°ì˜ ë“±ì„ ì¤€ë¹„í•´ ì£¼ì„¸ìš”.',
    '- ë²„ìŠ¤ ëŒ€ì ˆ, ì¡°ê¸ˆ ì—¬ìœ  ìˆê²Œ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
    '- ìì°¨Â·ëŒ€ì¤‘êµí†µì„ ì´ìš©í•´ ê°œë³„ ì§‘ê²°í•´ ì£¼ì„¸ìš”.',
    '- ìì°¨ëŠ” ê³µì˜Â·ë…¸ìƒ ì£¼ì°¨ì¥ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.',
    '- ì¥ì†Œì— ë”°ë¼ ë‚´ë¶€ ì£¼ì°¨ì¥ì´ ë§ˆë ¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
  ];
  function getNotesLines(){
    const raw = (document.getElementById('notes').value || '')
      .split('\n').map(s => s.trim()).filter(Boolean);
    return raw;
  }
  function setNotesLines(lines){
    const ta = document.getElementById('notes');
    ta.value = (lines || []).join('\n');
    syncNotesPresetSelection();
  }
  function toggleNotePreset(text){
    const lines = getNotesLines();
    const i = lines.indexOf(text);
    if (i >= 0) lines.splice(i, 1);
    else lines.push(text);
    setNotesLines(lines);
  }
  function renderNotesPresets(){
    const box = document.getElementById('notesPresets');
    if (!box) return;
    box.innerHTML = '';
    NOTES_PRESETS.forEach(txt => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = txt;
      chip.tabIndex = 0;
      chip.setAttribute('role', 'button');
      chip.setAttribute('data-text', txt);
      box.appendChild(chip);
    });
    box.addEventListener('click', e => {
      const c = e.target.closest('.chip'); if (!c) return;
      toggleNotePreset(c.getAttribute('data-text'));
    });
    box.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        const c = e.target.closest('.chip'); if (!c) return;
        e.preventDefault();
        toggleNotePreset(c.getAttribute('data-text'));
      }
    });
    syncNotesPresetSelection();
  }
  function syncNotesPresetSelection(){
    const selected = new Set(getNotesLines());
    document.querySelectorAll('#notesPresets .chip').forEach(chip => {
      const t = chip.getAttribute('data-text');
      chip.classList.toggle('selected', selected.has(t));
    });
  }
  (function bindNotesInputSync(){
    const ta = document.getElementById('notes');
    if (!ta) return;
    ta.addEventListener('input', () => { syncNotesPresetSelection(); });
  })();
  renderNotesPresets();

  /* ===== í¼ ìˆ˜ì§‘ ===== */
  function collect(){
    return {
      team: document.getElementById('team').value,
      title: document.getElementById('title').value,
      date: document.getElementById('date').value,
      schedule: document.getElementById('schedule').value,
      bus: document.getElementById('bus').value,
      place: document.getElementById('place').value,
      notes: document.getElementById('notes').value,
      contact: document.getElementById('contact').value,
    };
  }

  // (êµ¬ë°©ì‹) base64 ë””ì½”ë”© (í˜¸í™˜)
  function decodeShare(b64){
    try{ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    catch(e){ alert('ê³µìœ  ì½”ë“œ í•´ì„ ì‹¤íŒ¨'); return null }
  }

  /* ===== ì œëª©/ê³µìœ  í…ìŠ¤íŠ¸ ===== */
function makeShareTitle(d){
  // teamê°’ì—ì„œ "ê¸°íƒ€:" ì ‘ë‘ì–´ ì œê±°
  const cleanTeam = (d.team || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .map(v => v.startsWith('ê¸°íƒ€:') ? v.slice(3) : v) // "ê¸°íƒ€:" ì œê±°
    .join(',');
  const teamLabel = cleanTeam ? `${cleanTeam}ë°˜` : '';
  const dateTxt = d.date ? weekdayKR(d.date) : '';
  const rawTitle = (d.title || '').trim();
  if (rawTitle) return rawTitle;
  return [dateTxt, teamLabel, 'ì•¼ìœ íšŒ'].filter(Boolean).join(' ');
}

  function buildShareText(){
    const d = collect();
    const lines = [];
    const dateStr = d.date ? weekdayKR(d.date) : '-';
    const header = makeShareTitle(d) || (d.team ? `${d.team}ë°˜ ì•ˆë‚´ë¬¸` : 'ì•ˆë‚´ë¬¸');

    lines.push(header, '');

    // [ë°˜] ì¤„ì—ì„œ 'ê¸°íƒ€:' ì ‘ë‘ì–´ ì œê±°í•´ì„œ ì¶œë ¥
    if (d.team) {
      const arr = d.team.split(',').map(s=>s.trim()).filter(Boolean);
      const teamLabel = arr.map(v => v.startsWith('ê¸°íƒ€:') ? v.replace(/^ê¸°íƒ€:/,'') : v).join(', ');
      lines.push(`[ë°˜] ${teamLabel}`);
    }

    lines.push(`[ì¼ì] ${dateStr}`);
    lines.push(`[ì¥ì†Œ] ${d.place || '-'}`);
    lines.push('[ì¼ì • ìš”ì•½]');
    lines.push(...(d.schedule || '').split('\n').filter(Boolean));
    if ((d.bus || '').trim()) lines.push(`[ë²„ìŠ¤ ëŒ€ì ˆ] ${d.bus}`);
    if ((d.notes || '').trim()){
      lines.push('[íŠ¹ì´ì‚¬í•­]');
      lines.push(...d.notes.split('\n').filter(Boolean));
    }
    lines.push(`[ë¬¸ì˜ì²˜] ${d.contact || '-'}`);

    return lines.join('\n');
  }

  /* ===== ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ===== */
  (function setupPreviewModal(){
    const modal = document.getElementById('previewModal');
    const ta = document.getElementById('previewTa');
    const btnClose2 = document.getElementById('previewClose2');
    const btnCopy = document.getElementById('previewCopy');
    const toast = document.getElementById('previewToast');

    function openPreviewModal(text){
      if (!modal || !ta) return;
      ta.value = text || '';
      ta.style.height = 'auto';
      ta.style.height = Math.max(220, Math.min(420, ta.scrollHeight)) + 'px';
      modal.hidden = false;
      setTimeout(()=>{ ta.focus(); ta.select(); }, 0);
      document.addEventListener('keydown', onEsc, { once: true });
      modal.addEventListener('click', onBackdropClick);
    }
    function closePreviewModal(){
      if (!modal) return;
      modal.hidden = true;
      modal.removeEventListener('click', onBackdropClick);
    }
    function onBackdropClick(e){ if (e.target === modal) closePreviewModal(); }
    function onEsc(e){ if (e.key === 'Escape') closePreviewModal(); }
    async function copyPreviewText(){
      const text = ta.value || '';
      if (navigator.clipboard && navigator.clipboard.writeText){
        try{ await navigator.clipboard.writeText(text); showToast(); return; }
        catch(_){}
      }
      try{
        ta.select();
        const ok = document.execCommand('copy');
        if (ok) { showToast(); return; }
      }catch(_){}
      alert('ìë™ ë³µì‚¬ê°€ ì œí•œë˜ì–´ ìˆì–´ìš”. í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    }
    function showToast(){
      if (!toast) return;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1500);
    }
    window.openPreviewModal = openPreviewModal;
    window.closePreviewModal = closePreviewModal;
    btnCopy?.addEventListener('click', copyPreviewText);
    btnClose2?.addEventListener('click', closePreviewModal);
  })();

  /* ===== ë²„íŠ¼ ë™ì‘ ===== */
  document.getElementById('btnCopyText').addEventListener('click', async ()=>{
    showLoading('í…ìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘â€¦', 'ê³µìœ ìš© ë¬¸ì¥ì„ ì •ë¦¬í•©ë‹ˆë‹¤', 300);
    try{
      const text = buildShareText();
      openPreviewModal(text);
    }finally{ hideLoading(); }
  });

  document.getElementById('btnShare').addEventListener('click', async ()=>{
    showLoading('ì„ì‹œ ì €ì¥ ì¤‘â€¦', 'ì§§ì€ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤');
    try{
      const res = await fetchWithTimeout(GAS_URL, {
        method:'POST',
        body: JSON.stringify({ mode:'share', data: collect() })
      });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200));
      }
      if(res.ok && json.status==='ok' && json.key){
        const url = new URL(location.href);
        url.searchParams.delete('code');
        url.searchParams.set('k', json.key);
        history.replaceState(null, '', url.toString());

        const titleText = makeShareTitle(collect());
        const shareText = `${titleText}\n${url.toString()}`;
        openPreviewModal(shareText);
      }else{
        alert('ì„ì‹œ ì €ì¥ ì‹¤íŒ¨: ' + (json.error || res.status));
      }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
      alert('ì„ì‹œ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + msg);
    }finally{ hideLoading(); }
  });

  async function submitToSheet(){
    showLoading('ì „ì†¡ ì¤‘â€¦', 'ì¸ì‚¬ì§€ì›íŒ€ ì ‘ìˆ˜ ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤');
    try{
      const data = collect();
      const todayStr = new Date().toISOString().slice(0,10);

       // (ì—¬ê¸° ì¶”ê°€ ğŸ‘‡)
    const customOpen = document.getElementById('teamCustom')?.style.display !== 'none';
    const customVal = document.getElementById('teamCustom')?.value.trim();
    if (customOpen && !customVal) {
      alert('ë°˜(ê¸°íƒ€)ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      document.getElementById('teamCustom').focus();
      hideLoading();
      return;
    }
      
      // í•„ìˆ˜ ì²´í¬ (íŠ¹ì´ì‚¬í•­ì€ ì„ íƒ)
     // í•„ìˆ˜ ì²´í¬ (íŠ¹ì´ì‚¬í•­ì€ ì„ íƒ)
const invalid = [];

// ë°˜ ì„ íƒ
if(!data.team) {
  invalid.push(() => document.querySelector('#teamChips .chip')?.focus());
}

// ì œëª©
if(!data.title.trim()) {
  invalid.push(() => document.getElementById('title').focus());
}

// ë‚ ì§œ (ì˜¤ëŠ˜ ì´ì „ì´ë©´ ë°”ë¡œ ë¦¬í„´)
if (data.date && data.date < todayStr) { 
  alert('ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); 
  hideLoading(); 
  document.getElementById('date').focus(); 
  return; 
}

// ë‚ ì§œ ë¯¸ì…ë ¥
if(!data.date) {
  invalid.push(() => document.getElementById('date').focus());
}

// ì¥ì†Œ
if(!data.place.trim()) {
  invalid.push(() => document.getElementById('place').focus());
}

// ì¼ì • ìš”ì•½
if(!(data.schedule||'').trim()) {
  invalid.push(() => document.getElementById('schedule').focus());
}

// ë²„ìŠ¤ ì—¬ë¶€
if(!data.bus) {
  invalid.push(() => document.querySelector('#busChips .chip')?.focus());
}

// ë¬¸ì˜ì²˜
if(!data.contact.trim()) {
  invalid.push(() => document.getElementById('contact').focus());
}

// í•˜ë‚˜ë¼ë„ ë¬¸ì œ ìˆìœ¼ë©´ ì²˜ë¦¬
if (invalid.length){
  alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥/ì„ íƒí•´ ì£¼ì„¸ìš”.');
  invalid[0](); // ì²« ë²ˆì§¸ ë¬¸ì œ ìˆëŠ” í•„ë“œì— í¬ì»¤ìŠ¤
  hideLoading();
  return;
}


      const payload = { ...data, submitted_at: new Date().toISOString(), mode:'append' };
      const res = await fetchWithTimeout(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200));
      }
      if(res.ok && (json.status==='ok' || json.result==='ok')){
        alert(`ì œì¶œ ì™„ë£Œ! ì ‘ìˆ˜ë²ˆí˜¸: ${json.id||json.row||'í™•ì¸ë¨'}`);
      }else{
        alert(`ì œì¶œ ì‹¤íŒ¨: ${json.error||res.status}`);
      }
    }catch(err){
      const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
      alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜: ' + msg);
    }finally{
      hideLoading();
    }
  }
  document.getElementById('btnSubmit').addEventListener('click', submitToSheet);

  /* ===== ì €ì¥ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ===== */
  async function loadByKey(k){
    showLoading('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦', 'ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤');
    try{
      const url = `${GAS_URL}?mode=load&key=${encodeURIComponent(k)}`;
      const res = await fetchWithTimeout(url);
      let json;
      try{ json = await res.json(); }
      catch{
        const t = await res.text();
        throw new Error('ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: ' + t.slice(0,200));
      }
      if(json.status === 'ok' && json.data){
        const data = json.data;
        document.getElementById('team').value = data.team || '';
        renderTeamChips();
        restoreCustomTeamFromTeamValue();

        document.getElementById('title').value = data.title||'';
        document.getElementById('date').value = data.date||'';
        document.getElementById('schedule').value = data.schedule||'';
        document.getElementById('bus').value = data.bus || '';
        setBus(document.getElementById('bus').value || '');
        document.getElementById('place').value = data.place||'';
        document.getElementById('notes').value = data.notes||'';
        document.getElementById('contact').value = data.contact||'';
      }else{
        alert('ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (json.error||'ì•Œ ìˆ˜ ì—†ìŒ'));
      }
    } catch(err){
      const msg = (err && err.name === 'AbortError') ? 'ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : err.message;
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ' + msg);
    } finally{
      hideLoading();
    }
  }

  /* ===== ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œ ì„ íƒ ê¸ˆì§€ ===== */
  (function lockPastDate(){
    const el = document.getElementById('date');
    if(!el) return;
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    el.min = `${yyyy}-${mm}-${dd}`;
  })();

  /* ===== init ===== */
  (async function init(){
    const p = new URLSearchParams(location.search);
    const k = p.get('k');
    const code = p.get('code');

    if(k){
      try{ await loadByKey(k); }catch(_){}
    }else if(code){
      const data = decodeShare(code);
      if(data){
        document.getElementById('team').value = data.team || '';
        renderTeamChips();
        restoreCustomTeamFromTeamValue();

        document.getElementById('title').value = data.title||'';
        document.getElementById('date').value = data.date||'';
        document.getElementById('schedule').value = data.schedule||'';
        document.getElementById('bus').value = data.bus || '';
        setBus(document.getElementById('bus').value || '');
        document.getElementById('place').value = data.place||'';
        document.getElementById('notes').value = data.notes||'';
        document.getElementById('contact').value = data.contact||'';
      }
    }else{
      document.getElementById('title').value = 'ì•¼ìœ íšŒ ì•ˆë‚´';
      document.getElementById('team').value = '';
      renderTeamChips();
      restoreCustomTeamFromTeamValue();
    }

    updateBusBadgeVisibility();
  })();

<!-- ì•ˆë‚´ë¬¸ PDF/ì´ë¯¸ì§€ìš© ë¯¸ë¦¬ë³´ê¸° DOM (í™”ë©´ì— ì•ˆ ë³´ì„) -->
<div id="exportDoc" style="position:absolute; left:-99999px; top:-99999px; width:794px; background:#fff;">
  <!-- 794px = A4 width @96dpi. ë†’ì´ëŠ” ë‚´ìš©ì— ë”°ë¼ ìë™ -->
  <div id="exportInner" style="padding:28px 32px; font:14px/1.7 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, sans-serif; color:#222;">
    <!-- JSì—ì„œ ë‚´ìš©ì´ ì±„ì›Œì§ -->
  </div>
</div>
<script>
// ì•ˆë‚´ë¬¸ìš© DOMì„ ì±„ìš°ëŠ” í•¨ìˆ˜
function buildExportHTML(){
  const d = collect();
  const dateStr = d.date ? weekdayKR(d.date) : '-';

  // team ë¬¸ìì—´ì—ì„œ 'ê¸°íƒ€:' ì œê±°í•´ í‘œì‹œ
  let teamLine = '-';
  if (d.team) {
    const arr = d.team.split(',').map(s=>s.trim()).filter(Boolean);
    teamLine = arr.map(v => v.startsWith('ê¸°íƒ€:') ? v.replace(/^ê¸°íƒ€:/,'') : v).join(', ');
  }

  // ì¼ì •/íŠ¹ì´ì‚¬í•­ ë¼ì¸ ê°€ê³µ
  const scheduleLines = (d.schedule || '').split('\n').map(s=>s.trim()).filter(Boolean);
  const notesLines    = (d.notes    || '').split('\n').map(s=>s.trim()).filter(Boolean);

  // í—¤ë” íƒ€ì´í‹€
  const title = (d.title || '').trim() || ([dateStr, teamLine && (teamLine+'ë°˜'), 'ì•¼ìœ íšŒ'].filter(Boolean).join(' '));

  // HTML êµ¬ì„±
  return `
    <div class="export-title">${title}</div>

    <div class="export-meta">
      <div><b>ë°˜</b> ${teamLine || '-'}</div>
      <div><b>ì¼ì</b> ${dateStr}</div>
      <div><b>ì¥ì†Œ</b> ${d.place || '-'}</div>
      ${ (d.bus||'').trim() ? `<div><b>ë²„ìŠ¤</b> ${d.bus}</div>` : '' }
      <div><b>ë¬¸ì˜</b> ${d.contact || '-'}</div>
    </div>

    <div class="export-sec-title">ì¼ì • ìš”ì•½</div>
    ${scheduleLines.length
      ? `<ul class="export-list">${scheduleLines.map(li => `<li>${escapeHTML(li)}</li>`).join('')}</ul>`
      : `<div style="color:#999">-</div>`}

    ${notesLines.length
      ? `
        <div class="export-sec-title">íŠ¹ì´ì‚¬í•­</div>
        <ul class="export-list">${notesLines.map(li => `<li>${escapeHTML(li)}</li>`).join('')}</ul>
      ` : '' }
  `;
}

// ê°„ë‹¨ ì´ìŠ¤ì¼€ì´í”„
function escapeHTML(s){
  return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

// DOM ì±„ìš°ê¸°
function fillExportDom(){
  const inner = document.getElementById('exportInner');
  if(!inner) return;
  inner.innerHTML = buildExportHTML();
}

// ì´ë¯¸ì§€ë¡œ ì €ì¥ (PNG)
async function exportAsImage(){
  showLoading('ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
  try{
    fillExportDom();
    const target = document.getElementById('exportDoc');
    // ë” ì„ ëª…í•˜ê²Œ (scale=2)
    const canvas = await html2canvas(target, {backgroundColor:'#fff', scale:2, useCORS:true});
    const dataURL = canvas.toDataURL('image/png');

    // ë‹¤ìš´ë¡œë“œ
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = (collect().title || 'ì•ˆë‚´ë¬¸') + '.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  } finally {
    hideLoading();
  }
}

// PDFë¡œ ì €ì¥ (A4, ì„¸ë¡œ)
async function exportAsPDF(){
  showLoading('PDF ìƒì„± ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
  try{
    fillExportDom();
    const target = document.getElementById('exportDoc');
    const canvas = await html2canvas(target, {backgroundColor:'#fff', scale:2, useCORS:true});
    const imgData = canvas.toDataURL('image/jpeg', 0.95);

    // A4(px) @ 96dpi ê¸°ì¤€: 794 x 1123 ì •ë„. jsPDFëŠ” mm ë‹¨ìœ„ ì‚¬ìš©.
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:'p', unit:'mm', format:'a4'});

    const pageWidth = pdf.internal.pageSize.getWidth();   // 210mm
    const pageHeight = pdf.internal.pageSize.getHeight(); // 297mm

    // ì´ë¯¸ì§€ ë¹„ìœ¨ì— ë§ì¶° í­ì„ A4 ê°€ë¡œí­ì— ë§ì¶¤
    const imgW = pageWidth;
    const imgH = (canvas.height / canvas.width) * imgW;

    pdf.addImage(imgData, 'JPEG', 0, 0, imgW, imgH);
    pdf.save((collect().title || 'ì•ˆë‚´ë¬¸') + '.pdf');
  } finally {
    hideLoading();
  }
}

// ë²„íŠ¼ ë°”ì¸ë”©
document.getElementById('btnExportIMG')?.addEventListener('click', exportAsImage);
document.getElementById('btnExportPDF')?.addEventListener('click', exportAsPDF);
</script>

    
    <!-- html2canvas: DOMì„ ì´ë¯¸ì§€ë¡œ ìº¡ì³ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- jsPDF: ì´ë¯¸ì§€ë¥¼ PDFë¡œ ì €ì¥ -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  </script>
</body>
</html>
